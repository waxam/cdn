import{html,Polymer}from"@polymer/polymer/polymer-legacy.js";import{dom}from"@polymer/polymer/lib/legacy/polymer.dom.js";import"@polymer/iron-flex-layout/iron-flex-layout-classes.js";import"@polymer/iron-icons/iron-icons.js";import"@polymer/iron-icons/editor-icons.js";import"@polymer/paper-icon-button/paper-icon-button.js";import"paper-collapse-item/paper-collapse-item.js";import"paper-collapse-item/paper-collapse-group.js";import"@polymer/app-localize-behavior/app-localize-behavior.js";import"./eco-json-schema-boolean.js";import"./eco-json-schema-enum.js";import"./eco-json-schema-input.js";import"./eco-json-schema-object.js";import"./eco-json-schema-file.js";Polymer({is:"eco-json-schema-array",_template:html`
    <custom-style>
      <style is="custom-style" include="iron-flex iron-flex-alignment">
        paper-input {
          padding: 2px;

          --paper-input-container-label: {
            white-space: normal;
            position: static;
            font-size: 22px;
            color: #212121;
          }
        }

        paper-collapse-item {
          --paper-collapse-item-header: {
            font-weight: bold;
            padding: 8px 0 0 8px;
          }
        }

        #form {
          border: 1px solid #aaaaaa;
        }

        #form div:nth-child(odd) {
          background-color: #f2f2f2;
          padding: 4px;
        }

        #form div:nth-child(even) {
          background-color: #e2e2e2;
          border-top: 1px solid #aaaaaa;
          border-bottom: 1px solid #aaaaaa;
          padding: 4px;
        }

        #form div:focus,
        #form div:hover,
        #form div:active {
          background-color: #ffffff !important;
        }

        paper-icon-button {
          float: right;
          border-radius: 50%;
        }

        .array-add {
          color: #34e79a;
          background-color: #f8f8f8;
        }

        .array-remove-element {
          color: #f44336;
          background-color: #f8f8f8;
        }

        .label {
          @apply --paper-input-container-label;
          white-space: normal;
          position: static;
          font-size: 22px;
          color: #212121;
        }

        :host {
          display: block;
        }
        .label {
          white-space: normal;
          position: static;
          font-size: 22px;
          color: #212121;
          @apply --paper-input-container-label;
        }
      </style>
    </custom-style>
    <div class="horizontal layout">
      <div class="flex" hidden\$="[[!label]]">[[label]]</div>
      <paper-icon-button
        id="addarray"
        title="Add another item"
        class="array-add"
        icon="add"
        on-click="_onAddItem"
        role="button"
        aria-label="Add another item"
      ></paper-icon-button>
    </div>

    <paper-collapse-group
      id="form"
      class="vertical flex layout"
    ></paper-collapse-group>
  `,properties:{schema:{type:Object,observer:"_schemaChanged"},label:{type:String},value:{type:Array,notify:!0,value:function(){return[]},observer:"_valueChanged"},error:{type:Object,observer:"_errorChanged"},_schemaArrayItems:{type:Array,notify:!0,value:function(){return[]}}},observers:["_schemaArraySplicesChanged(_schemaArrayItems.splices)"],_valueChanged:function(a,b){a!==b&&typeof a!==typeof void 0&&typeof this.schema!==typeof void 0&&setTimeout(()=>{for(var c in this._buildSchemaArrayItems(),a)this._onAddItemWithValue(a[c],parseInt(c))},100)},ready:function(){},detached:function(){this._clearForm()},_buildSchemaArrayItems:function(){this._schemaArrayItems=[]},_setValue:function(){this.value=[],this.value=this._schemaArrayItems.map(function(a){return a.value})},_schemaArraySplicesChanged:function(a){if(!a)return console.warn("detail is undefined");var b=this;a.keySplices&&console.warn("Got keySplices, don't know what to do with them!"),a.indexSplices.forEach(function(c){var d=["value",c.index,c.removed.length];if(c.removed&&c.removed.length)for(var f=c.index,g=c.index+c.removed.length;f<g;f++)b._removeArrayEl(b.$.form.children[f]);if(c.addedCount)for(var f=c.index,g=c.index+c.addedCount;f<g;f++){var h=c.object[f],j=b.create(h.component.name,{label:h.label,schema:h.schema,schemaArrayItem:h}),k=b.create("paper-collapse-item",{header:"Item "+(f+1)}),l=b.create("paper-icon-button",{icon:"remove",title:"Remove item"});b.listen(l,"tap","_onRemoveItem"),l.classList.add("array-remove-element"),j.classList.add("flex","horizontal","layout"),dom(k).appendChild(j),dom(k).appendChild(l);var m=b.$.form.children[f];m?dom(b.$.form).insertBefore(k,m):dom(b.$.form).appendChild(k),b.listen(j,h.component.valueProperty.replace(/([A-Z])/g,"-$1").toLowerCase()+"-changed","_schemaArrayItemChanged"),d.push(b._deepClone(j[h.component.valueProperty]))}b.splice.apply(b,d)})},_schemaArrayItemChanged:function(a,b){if(!(b.path&&/\.length$/.test(b.path))){var c=this,d=a.target.schemaArrayItem,f=this._schemaArrayItems.indexOf(d),g=["value",f];b.path&&/\.splices$/.test(b.path)?(g=g.concat(b.path.split(".").slice(1,-1)),b.value.keySplices&&console.warn("Got keySplices, don't know what to do with them!"),b.value.indexSplices.forEach(function(h){var j=[g.join("."),h.index,h.removed.length];if(h.addedCount)for(var k=h.index,l=h.index+h.addedCount;k<l;k++)j.push(c._deepClone(h.object[k]));c.splice.apply(c,j)})):b.path?(g=g.concat(b.path.split(".").slice(1)),this.set(g,this._deepClone(b.value)),this.notifyPath("path")):(this.splice("value",f,1,this._deepClone(b.value)),this.notifyPath("value.1"))}},_removeArrayEl:function(a){var b=dom(a);typeof b.childNodes[0]!==typeof void 0&&(this.unlisten(b.childNodes[0],b.firstChild.schemaArrayItem.component.valueProperty.replace(/([A-Z])/g,"-$1").toLowerCase()+"-changed","_schemaArrayItemChanged"),typeof b.childNodes[1]!==typeof void 0&&this.unlisten(b.childNodes[1],"tap","_onRemoveItem")),a.schemaArrayItem=null,dom(this.$.form).removeChild(a)},_clearForm:function(){for(var a=dom(this.$.form);a.firstChild;)this._removeArrayEl(a.firstChild)},_schemaChanged:function(){this._clearForm(),this._buildSchemaArrayItems(),this._setValue()},_errorChanged:function(){var a=this;dom(this.$.form).childNodes.forEach(function(b,c){dom(b).childNodes[0].error=a.error&&a.error[c]?a.error[c]:null})},_onAddItemWithValue:function(a){var c=this.schema.items;if(typeof a!=="undefined")for(var d in a)"undefined"!==typeof c.properties[d]&&(c.properties[d].value=a[d]);var f={label:c.title,schema:c,component:c.component||{}};if(f.component.valueProperty||(f.component.valueProperty="value"),!f.component.name)if(this._isSchemaEnum(c))f.component.name="eco-json-schema-enum";else if(this._isSchemaBoolean(c.type))f.component.name="eco-json-schema-boolean";else if(this._isSchemaFile(c.type))f.component.name="eco-json-schema-file";else if(this._isSchemaValue(c.type))f.component.name="eco-json-schema-input";else if(this._isSchemaObject(c.type))f.component.name="eco-json-schema-object";else if(this._isSchemaArray(c.type))f.component.name="eco-json-schema-array";else return console.error("Unknown item type %s",c.type);var g=this,h=g.create(f.component.name,{label:f.label,schema:f.schema,schemaArrayItem:f}),j=g.create("paper-collapse-item",{header:"Item "+(d+1)}),k=g.create("paper-icon-button",{icon:"remove",title:"Remove item"});g.listen(k,"tap","_onRemoveItem"),k.classList.add("array-remove-element"),h.classList.add("flex","horizontal","layout"),dom(j).appendChild(h),dom(j).appendChild(k);var l=g.$.form.children[d];l?dom(g.$.form).insertBefore(j,l):dom(g.$.form).appendChild(j),g.listen(h,f.component.valueProperty.replace(/([A-Z])/g,"-$1").toLowerCase()+"-changed","_schemaArrayItemChanged"),this._schemaArrayItems.push(f)},_onAddItem:function(){var a=this.schema.items,b={label:a.title,schema:a,component:a.component||{}};if(b.component.valueProperty||(b.component.valueProperty="value"),!b.component.name)if(this._isSchemaEnum(a))b.component.name="eco-json-schema-enum";else if(this._isSchemaBoolean(a.type))b.component.name="eco-json-schema-boolean";else if(this._isSchemaFile(a.type))b.component.name="eco-json-schema-file";else if(this._isSchemaValue(a.type))b.component.name="eco-json-schema-input";else if(this._isSchemaObject(a.type))b.component.name="eco-json-schema-object";else if(this._isSchemaArray(a.type))b.component.name="eco-json-schema-array";else return console.error("Unknown item type %s",a.type);this.push("_schemaArrayItems",b)},_onRemoveItem:function(a){var b=dom(a).localTarget.previousSibling.schemaArrayItem,c=this._schemaArrayItems.indexOf(b);this.splice("_schemaArrayItems",c,1)},_deepClone:function(a){return JSON.parse(JSON.stringify(a))},_isSchemaValue:function(a){return this._isSchemaBoolean(a)||this._isSchemaNumber(a)||this._isSchemaString(a)||this._isSchemaFile(a)},_isSchemaFile:function(a){return Array.isArray(a)?-1!==a.indexOf("file"):"file"===a},_isSchemaBoolean:function(a){return Array.isArray(a)?-1!==a.indexOf("boolean"):"boolean"===a},_isSchemaEnum:function(a){return!!a.enum},_isSchemaNumber:function(a){return Array.isArray(a)?-1!==a.indexOf("number")||-1!==a.indexOf("integer"):"number"===a||"integer"===a},_isSchemaString:function(a){return Array.isArray(a)?-1!==a.indexOf("string"):"string"===a},_isSchemaObject:function(a){return"object"===a},_isSchemaArray:function(a){return"array"===a}});