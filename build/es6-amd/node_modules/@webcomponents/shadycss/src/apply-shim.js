define(["exports","./style-util.js","./common-regex.js","./common-utils.js","./css-parse.js"],(function(t,e,r,s,l){
/**
  @license
  Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
  This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
  The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
  The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
  Code distributed by Google as part of the polymer project is also
  subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
  */
"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const i=/;\s*/m,n=/^\s*(initial)|(inherit)\s*$/,o=/\s*!important/;class MixinMap{constructor(){this._map={}}set(t,e){t=t.trim(),this._map[t]={properties:e,dependants:{}}}get(t){return t=t.trim(),this._map[t]||null}}let p=null;class ApplyShim{constructor(){this._currentElement=null,this._measureElement=null,this._map=new MixinMap}detectMixin(t){return(0,s.detectMixin)(t)}gatherStyles(t){const r=(0,e.gatherStyleText)(t.content);if(r){const e=document.createElement("style");return e.textContent=r,t.content.insertBefore(e,t.content.firstChild),e}return null}transformTemplate(t,e){void 0===t._gatheredStyle&&(t._gatheredStyle=this.gatherStyles(t));const r=t._gatheredStyle;return r?this.transformStyle(r,e):null}transformStyle(t,r=""){let s=(0,e.rulesForStyle)(t);return this.transformRules(s,r),t.textContent=(0,e.toCssText)(s),s}transformCustomStyle(t){let r=(0,e.rulesForStyle)(t);return(0,e.forEachRule)(r,t=>{":root"===t.selector&&(t.selector="html"),this.transformRule(t)}),t.textContent=(0,e.toCssText)(r),r}transformRules(t,r){this._currentElement=r,(0,e.forEachRule)(t,t=>{this.transformRule(t)}),this._currentElement=null}transformRule(t){t.cssText=this.transformCssText(t.parsedCssText,t),":root"===t.selector&&(t.selector=":host > *")}transformCssText(t,e){return t=t.replace(r.VAR_ASSIGN,(t,r,s,l)=>this._produceCssProperties(t,r,s,l,e)),this._consumeCssProperties(t,e)}_getInitialValueForProperty(t){return this._measureElement||(this._measureElement=document.createElement("meta"),this._measureElement.setAttribute("apply-shim-measure",""),this._measureElement.style.all="initial",document.head.appendChild(this._measureElement)),window.getComputedStyle(this._measureElement).getPropertyValue(t)}_fallbacksFromPreviousRules(t){let r=t;for(;r.parent;)r=r.parent;const s={};let l=!1;return(0,e.forEachRule)(r,e=>{l=l||e===t,l||e.selector===t.selector&&Object.assign(s,this._cssTextToMap(e.parsedCssText))}),s}_consumeCssProperties(t,e){let s=null;for(;s=r.MIXIN_MATCH.exec(t);){let l=s[0],i=s[1],n=s.index,o=n+l.indexOf("@apply"),p=n+l.length,a=t.slice(0,o),m=t.slice(p),u=e?this._fallbacksFromPreviousRules(e):{};Object.assign(u,this._cssTextToMap(a));let h=this._atApplyToCssProperties(i,u);t=`${a}${h}${m}`,r.MIXIN_MATCH.lastIndex=n+h.length}return t}_atApplyToCssProperties(t,e){t=t.replace(i,"");let r=[],s=this._map.get(t);if(s||(this._map.set(t,{}),s=this._map.get(t)),s){let l,i,n;this._currentElement&&(s.dependants[this._currentElement]=!0);const p=s.properties;for(l in p)n=e&&e[l],i=[l,": var(",t,"_-_",l],n&&i.push(",",n.replace(o,"")),i.push(")"),o.test(p[l])&&i.push(" !important"),r.push(i.join(""))}return r.join("; ")}_replaceInitialOrInherit(t,e){let r=n.exec(e);return r&&(e=r[1]?this._getInitialValueForProperty(t):"apply-shim-inherit"),e}_cssTextToMap(t,e=!1){let r,s,l=t.split(";"),i={};for(let n,o,p=0;p<l.length;p++)n=l[p],n&&(o=n.split(":"),o.length>1&&(r=o[0].trim(),s=o.slice(1).join(":"),e&&(s=this._replaceInitialOrInherit(r,s)),i[r]=s));return i}_invalidateMixinEntry(t){if(p)for(let e in t.dependants)e!==this._currentElement&&p(e)}_produceCssProperties(t,r,s,l,i){if(s&&(0,e.processVariableAndFallback)(s,(t,e)=>{e&&this._map.get(e)&&(l=`@apply ${e};`)}),!l)return t;let n=this._consumeCssProperties(""+l,i),o=t.slice(0,t.indexOf("--")),p=this._cssTextToMap(n,!0),a=p,m=this._map.get(r),u=m&&m.properties;u?a=Object.assign(Object.create(u),p):this._map.set(r,a);let h,c,y=[],_=!1;for(h in a)c=p[h],void 0===c&&(c="initial"),!u||h in u||(_=!0),y.push(`${r}_-_${h}: ${c}`);return _&&this._invalidateMixinEntry(m),m&&(m.properties=a),s&&(o=`${t};${o}`),`${o}${y.join("; ")};`}}ApplyShim.prototype.detectMixin=ApplyShim.prototype.detectMixin,ApplyShim.prototype.transformStyle=ApplyShim.prototype.transformStyle,ApplyShim.prototype.transformCustomStyle=ApplyShim.prototype.transformCustomStyle,ApplyShim.prototype.transformRules=ApplyShim.prototype.transformRules,ApplyShim.prototype.transformRule=ApplyShim.prototype.transformRule,ApplyShim.prototype.transformTemplate=ApplyShim.prototype.transformTemplate,ApplyShim.prototype._separator="_-_",Object.defineProperty(ApplyShim.prototype,"invalidCallback",{get:()=>p,set(t){p=t}});var a=ApplyShim;t.default=a}));