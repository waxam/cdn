define(["exports","./resolver/resolver.js","./resolver/generateUrls.js","./triggers/setNavigationTriggers.js","./transitions/animate.js","./utils.js"],(function(e,t,r,n,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Router=void 0,t=babelHelpers.interopRequireDefault(t),r=babelHelpers.interopRequireDefault(r),n=babelHelpers.interopRequireDefault(n),i=babelHelpers.interopRequireDefault(i);function isResultNotEmpty(e){return null!=e}function createLocation({pathname:e="",search:t="",hash:r="",chain:n=[],params:i={},redirectFrom:o,resolver:a},s){const l=n.map(e=>e.route);return{baseUrl:a&&a.baseUrl||"",pathname:e,search:t,hash:r,routes:l,route:s||l.length&&l[l.length-1]||null,params:i,redirectFrom:o,getUrl:(e={})=>getPathnameForRouter(Router.pathToRegexp.compile(getMatchedPath(l))(Object.assign({},i,e)),a)}}function createRedirect(e,t){const r=Object.assign({},e.params);return{redirect:{pathname:t,from:e.pathname,params:r}}}function runCallbackIfPossible(e,t,r){if((0,o.isFunction)(e))return e.apply(r,t)}function amend(e,t,r){return n=>n&&(n.cancel||n.redirect)?n:r?runCallbackIfPossible(r[e],t,r):void 0}function removeDomNodes(e){if(e&&e.length){const t=e[0].parentNode;for(let r=0;r<e.length;r++)t.removeChild(e[r])}}function getPathnameForRouter(e,t){const r=t.__effectiveBaseUrl;return r?t.constructor.__createUrl(e.replace(/^\//,""),r).pathname:e}function getMatchedPath(e){return e.map(e=>e.path).reduce((e,t)=>t.length?e.replace(/\/$/,"")+"/"+t.replace(/^\//,""):e,"")}class Router extends t.default{constructor(e,r){const n=document.head.querySelector("base"),i=n&&n.getAttribute("href");super([],Object.assign({baseUrl:i&&t.default.__createUrl(i,document.URL).pathname.replace(/[^\/]*$/,"")},r)),this.resolveRoute=e=>this.__resolveRoute(e);const o=Router.NavigationTrigger;Router.setTriggers.apply(Router,Object.keys(o).map(e=>o[e])),this.baseUrl,this.ready,this.ready=Promise.resolve(e),this.location,this.location=createLocation({resolver:this}),this.__lastStartedRenderId=0,this.__navigationEventHandler=this.__onNavigationEvent.bind(this),this.setOutlet(e),this.subscribe(),this.__createdByRouter=new WeakMap,this.__addedByRouter=new WeakMap}__resolveRoute(e){const t=e.route;let r=Promise.resolve();(0,o.isFunction)(t.children)&&(r=r.then(()=>t.children(function copyContextWithoutNext(e){const t=Object.assign({},e);return delete t.next,t}(e))).then(e=>{isResultNotEmpty(e)||(0,o.isFunction)(t.children)||(e=t.children),function processNewChildren(e,t){if(!Array.isArray(e)&&!(0,o.isObject)(e))throw new Error((0,o.log)(`Incorrect "children" value for the route ${t.path}: expected array or object, but got ${e}`));t.__children=[];const r=(0,o.toArray)(e);for(let n=0;n<r.length;n++)(0,o.ensureRoute)(r[n]),t.__children.push(r[n])}(e,t)}));const n={redirect:t=>createRedirect(e,t),component:e=>{const t=document.createElement(e);return this.__createdByRouter.set(t,!0),t}};return r.then(()=>{if(this.__isLatestRender(e))return runCallbackIfPossible(t.action,[e,n],t)}).then(e=>isResultNotEmpty(e)&&(e instanceof HTMLElement||e.redirect||e===o.notFoundResult)?e:(0,o.isString)(t.redirect)?n.redirect(t.redirect):t.bundle?(0,o.loadBundle)(t.bundle).then(()=>{},()=>{throw new Error((0,o.log)(`Bundle not found: ${t.bundle}. Check if the file name is correct`))}):void 0).then(e=>isResultNotEmpty(e)?e:(0,o.isString)(t.component)?n.component(t.component):void 0)}setOutlet(e){e&&this.__ensureOutlet(e),this.__outlet=e}getOutlet(){return this.__outlet}setRoutes(e,t=!1){return this.__previousContext=void 0,this.__urlForName=void 0,super.setRoutes(e),t||this.__onNavigationEvent(),this.ready}render(e,t){const r=++this.__lastStartedRenderId,n=Object.assign({search:"",hash:""},(0,o.isString)(e)?{pathname:e}:e,{__renderId:r});return this.ready=this.resolve(n).then(e=>this.__fullyResolveChain(e)).then(e=>{if(this.__isLatestRender(e)){const n=this.__previousContext;if(e===n)return this.__updateBrowserHistory(n,!0),this.location;if(this.location=createLocation(e),t&&this.__updateBrowserHistory(e,1===r),(0,o.fireRouterEvent)("location-changed",{router:this,location:this.location}),e.__skipAttach)return this.__copyUnchangedElements(e,n),this.__previousContext=e,this.location;this.__addAppearingContent(e,n);const i=this.__animateIfNeeded(e);return this.__runOnAfterEnterCallbacks(e),this.__runOnAfterLeaveCallbacks(e,n),i.then(()=>{if(this.__isLatestRender(e))return this.__removeDisappearingContent(),this.__previousContext=e,this.location})}}).catch(e=>{if(r===this.__lastStartedRenderId)throw t&&this.__updateBrowserHistory(n),removeDomNodes(this.__outlet&&this.__outlet.children),this.location=createLocation(Object.assign(n,{resolver:this})),(0,o.fireRouterEvent)("error",Object.assign({router:this,error:e},n)),e}),this.ready}__fullyResolveChain(e,t=e){return this.__findComponentContextAfterAllRedirects(t).then(r=>{const n=r!==t?r:e,i=getPathnameForRouter(getMatchedPath(r.chain),r.resolver)===r.pathname,findNextContextIfAny=(e,t)=>{let r=void 0;return void 0===t?t=e.route:r=null,e.next(void 0,t,r).then(t=>null===t||t===o.notFoundResult?i?e:findNextContextIfAny(e,e.route.parent):t)};return findNextContextIfAny(r).then(e=>{if(null===e||e===o.notFoundResult)throw(0,o.getNotFoundError)(n);return e&&e!==o.notFoundResult&&e!==r?this.__fullyResolveChain(n,e):this.__amendWithOnBeforeCallbacks(r)})})}__findComponentContextAfterAllRedirects(e){const t=e.result;return t instanceof HTMLElement?(function renderElement(e,t){t.location=createLocation(e);const r=e.chain.map(e=>e.route).indexOf(e.route);return e.chain[r].element=t,t}(e,t),Promise.resolve(e)):t.redirect?this.__redirect(t.redirect,e.__redirectCount,e.__renderId).then(e=>this.__findComponentContextAfterAllRedirects(e)):t instanceof Error?Promise.reject(t):Promise.reject(new Error((0,o.log)(`Invalid route resolution result for path "${e.pathname}". `+`Expected redirect object or HTML element, but got: "${(0,o.logValue)(t)}". `+"Double check the action return value for the route.")))}__amendWithOnBeforeCallbacks(e){return this.__runOnBeforeCallbacks(e).then(t=>t===this.__previousContext||t===e?t:this.__fullyResolveChain(t))}__runOnBeforeCallbacks(e){const t=this.__previousContext||{},r=t.chain||[],n=e.chain;let i=Promise.resolve();const prevent=()=>({cancel:!0}),redirect=t=>createRedirect(e,t);if(e.__divergedChainIndex=0,e.__skipAttach=!1,r.length){for(let t=0;t<Math.min(r.length,n.length)&&(r[t].route===n[t].route&&(r[t].path===n[t].path||r[t].element===n[t].element)&&this.__isReusableElement(r[t].element,n[t].element));t=++e.__divergedChainIndex);if(e.__skipAttach=n.length===r.length&&e.__divergedChainIndex==n.length&&this.__isReusableElement(e.result,t.result),e.__skipAttach){for(let o=n.length-1;o>=0;o--)r[o].path===n[o].path&&e.search===t.search||(i=this.__runOnBeforeLeaveCallbacks(i,e,{prevent:prevent},r[o]));for(let o=0;o<n.length;o++)r[o].path===n[o].path&&e.search===t.search||(i=this.__runOnBeforeEnterCallbacks(i,e,{prevent:prevent,redirect:redirect},n[o])),r[o].element.location=createLocation(e,r[o].route)}else for(let t=r.length-1;t>=e.__divergedChainIndex;t--)i=this.__runOnBeforeLeaveCallbacks(i,e,{prevent:prevent},r[t])}for(let o=e.__divergedChainIndex;!e.__skipAttach&&o<n.length;o++)i=this.__runOnBeforeEnterCallbacks(i,e,{prevent:prevent,redirect:redirect},n[o]);return i.then(t=>{if(t){if(t.cancel)return this.__previousContext.__renderId=e.__renderId,this.__previousContext;if(t.redirect)return this.__redirect(t.redirect,e.__redirectCount,e.__renderId)}return e})}__runOnBeforeLeaveCallbacks(e,t,r,n){const i=createLocation(t);return e.then(e=>{if(this.__isLatestRender(t)){return amend("onBeforeLeave",[i,r,this],n.element)(e)}}).then(e=>{if(!(e||{}).redirect)return e})}__runOnBeforeEnterCallbacks(e,t,r,n){const i=createLocation(t,n.route);return e.then(e=>{if(this.__isLatestRender(t)){return amend("onBeforeEnter",[i,r,this],n.element)(e)}})}__isReusableElement(e,t){return!(!e||!t)&&(this.__createdByRouter.get(e)&&this.__createdByRouter.get(t)?e.localName===t.localName:e===t)}__isLatestRender(e){return e.__renderId===this.__lastStartedRenderId}__redirect(e,t,r){if(t>256)throw new Error((0,o.log)(`Too many redirects when rendering ${e.from}`));return this.resolve({pathname:this.urlForPath(e.pathname,e.params),redirectFrom:e.from,__redirectCount:(t||0)+1,__renderId:r})}__ensureOutlet(e=this.__outlet){if(!(e instanceof Node))throw new TypeError((0,o.log)(`Expected router outlet to be a valid DOM Node (but got ${e})`))}__updateBrowserHistory({pathname:e,search:t="",hash:r=""},n){if(window.location.pathname!==e||window.location.search!==t||window.location.hash!==r){const i=n?"replaceState":"pushState";window.history[i](null,document.title,e+t+r),window.dispatchEvent(new PopStateEvent("popstate",{state:"vaadin-router-ignore"}))}}__copyUnchangedElements(e,t){let r=this.__outlet;for(let n=0;n<e.__divergedChainIndex;n++){const i=t&&t.chain[n].element;if(i){if(i.parentNode!==r)break;e.chain[n].element=i,r=i}}return r}__addAppearingContent(e,t){this.__ensureOutlet(),this.__removeAppearingContent();const r=this.__copyUnchangedElements(e,t);this.__appearingContent=[],this.__disappearingContent=Array.from(r.children).filter(t=>this.__addedByRouter.get(t)&&t!==e.result);let n=r;for(let i=e.__divergedChainIndex;i<e.chain.length;i++){const t=e.chain[i].element;t&&(n.appendChild(t),this.__addedByRouter.set(t,!0),n===r&&this.__appearingContent.push(t),n=t)}}__removeDisappearingContent(){this.__disappearingContent&&removeDomNodes(this.__disappearingContent),this.__disappearingContent=null,this.__appearingContent=null}__removeAppearingContent(){this.__disappearingContent&&this.__appearingContent&&(removeDomNodes(this.__appearingContent),this.__disappearingContent=null,this.__appearingContent=null)}__runOnAfterLeaveCallbacks(e,t){if(t)for(let r=t.chain.length-1;r>=e.__divergedChainIndex&&this.__isLatestRender(e);r--){const n=t.chain[r].element;if(n)try{const r=createLocation(e);runCallbackIfPossible(n.onAfterLeave,[r,{},t.resolver],n)}finally{this.__disappearingContent.indexOf(n)>-1&&removeDomNodes(n.children)}}}__runOnAfterEnterCallbacks(e){for(let t=e.__divergedChainIndex;t<e.chain.length&&this.__isLatestRender(e);t++){const r=e.chain[t].element||{},n=createLocation(e,e.chain[t].route);runCallbackIfPossible(r.onAfterEnter,[n,{},e.resolver],r)}}__animateIfNeeded(e){const t=(this.__disappearingContent||[])[0],r=(this.__appearingContent||[])[0],n=[],a=e.chain;let s;for(let i=a.length;i>0;i--)if(a[i-1].route.animate){s=a[i-1].route.animate;break}if(t&&r&&s){const e=(0,o.isObject)(s)&&s.leave||"leaving",a=(0,o.isObject)(s)&&s.enter||"entering";n.push((0,i.default)(t,e)),n.push((0,i.default)(r,a))}return Promise.all(n).then(()=>e)}subscribe(){window.addEventListener("vaadin-router-go",this.__navigationEventHandler)}unsubscribe(){window.removeEventListener("vaadin-router-go",this.__navigationEventHandler)}__onNavigationEvent(e){const{pathname:t,search:r,hash:n}=e?e.detail:window.location;(0,o.isString)(this.__normalizePathname(t))&&(e&&e.preventDefault&&e.preventDefault(),this.render({pathname:t,search:r,hash:n},!0))}static setTriggers(...e){(0,n.default)(e)}urlForName(e,t){return this.__urlForName||(this.__urlForName=(0,r.default)(this)),getPathnameForRouter(this.__urlForName(e,t),this)}urlForPath(e,t){return getPathnameForRouter(Router.pathToRegexp.compile(e)(t),this)}static go(e){const{pathname:t,search:r,hash:n}=(0,o.isString)(e)?this.__createUrl(e,"http://a"):e;return(0,o.fireRouterEvent)("go",{pathname:t,search:r,hash:n})}}e.Router=Router}));