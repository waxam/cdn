var H5PUpgrades=H5PUpgrades||{};H5P.ContentUpgradeProcess=function(r){function ContentUpgradeProcess(r,n,e,o,t,a,i){try{if(!((o=JSON.parse(o))instanceof Object))throw!0}catch(s){return i({type:"errorParamsBroken",id:t})}this.loadLibrary=a,this.upgrade(r,n,e,o.params,o.metadata,(function(r,n,e){if(r)return r.id=t,i(r);i(null,JSON.stringify({params:n,metadata:e}))}))}ContentUpgradeProcess.prototype.upgrade=function(r,n,e,o,t,a){var i=this;i.loadLibrary(r,e,(function(r,s){return r?a(r):null===s.semantics?a({type:"libraryMissing",library:s.name+" "+s.version.major+"."+s.version.minor}):void i.processParams(s,n,e,o,t,(function(r,n,e){if(r)return a(r);asyncSerial(s.semantics,(function(r,e,o){i.processField(e,n[e.name],(function(r,t){t&&(n[e.name]=t),o(r)}))}),(function(r){a(r,n,e)}))}))}))},ContentUpgradeProcess.prototype.processParams=function(r,n,e,o,t,a){if(void 0===H5PUpgrades[r.name])return r.upgradesScript?a({type:"scriptMissing",library:r.name+" "+e}):a(null,o);asyncSerial(H5PUpgrades[r.name],(function(r,i,s){r<n.major||r>e.major?s():asyncSerial(i,(function(r,i,s){if((r=+r)<=n.minor||r>e.minor)s();else{var c=void 0!==i.contentUpgrade?i.contentUpgrade:i;try{c(o,(function(r,n,e){o=n,e&&e.metadata&&(t=e.metadata),s(r)}),{metadata:t})}catch(p){console&&console.error&&(console.error("Error",p.stack),console.error("Error",p.name),console.error("Error",p.message)),a(p)}}}),s)}),(function(r){a(r,o,t)}))},ContentUpgradeProcess.prototype.processField=function(n,e,o){var t=this;if(void 0===e)return o();switch(n.type){case"library":if(void 0===e.library||void 0===e.params)return o();for(var a=e.library.split(" ",2),i=0;i<n.options.length;i++){var s="string"==typeof n.options[i]?n.options[i].split(" ",2):n.options[i].name.split(" ",2);if(s[0]===a[0]){if(s[1]===a[1])return o();var c=new r(a[1]),p=new r(s[1]);return c.major>p.major||c.major===p.major&&c.minor>=p.minor?o({type:"errorTooHighVersion",used:a[0]+" "+c,supported:s[0]+" "+p}):t.upgrade(s[0],c,p,e.params,e.metadata,(function(r,n,t){r||(e.library=s[0]+" "+p.major+"."+p.minor,e.params=n,t&&(e.metadata=t)),o(r,e)}))}}o({type:"errorNotSupported",used:a[0]+" "+c});break;case"group":1===n.fields.length&&!0!==n.isSubContent?t.processField(n.fields[0],e,(function(r,n){n&&(e=n),o(r,e)})):asyncSerial(n.fields,(function(r,n,o){var a=e?e[n.name]:null;t.processField(n,a,(function(r,t){t&&(e[n.name]=t),o(r)}))}),(function(r){o(r,e)}));break;case"list":asyncSerial(e,(function(r,o,a){t.processField(n.field,o,(function(n,o){o&&(e[r]=o),a(n)}))}),(function(r){o(r,e)}));break;default:o()}};var asyncSerial=function(r,n,e){var o,t=r instanceof Array;if(!t){var a=[];for(o in r)r.hasOwnProperty(o)&&a.push(o)}var i=-1,check=function(s){setTimeout((function(){++i===(t?r.length:a.length)||null!=s?e(s):(o=t?i:a[i],n(o,r[o],check))}),0)};check()};return ContentUpgradeProcess}(H5P.Version);