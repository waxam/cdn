define(["exports","require","../../../../../lit-element/lit-element.js","../haxcms-site-store.js","../../../../utils/utils.js","../../../../beaker-broker/beaker-broker.js"],(function(e,t,s,i,a,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.HAXCMSBackendBeaker=void 0,t=babelHelpers.interopRequireWildcard(t);
/**
   * Copyright 2018 The Pennsylvania State University
   * @license Apache-2.0, see License.md for full text.
   */
class HAXCMSBackendBeaker extends s.LitElement{static get tag(){return"haxcms-backend-beaker"}render(){return s.html`
      <beaker-broker id="beaker"></beaker-broker>
    `}static get properties(){return{jwt:{type:String},manifest:{type:Object},activeItem:{type:Object}}}constructor(){super(),document.body.addEventListener("jwt-token",this._jwtTokenFired.bind(this)),document.body.addEventListener("haxcms-save-site-data",this.saveManifest.bind(this)),document.body.addEventListener("haxcms-save-outline",this.saveOutline.bind(this)),document.body.addEventListener("haxcms-save-node",this.saveNode.bind(this)),document.body.addEventListener("haxcms-delete-node",this.deleteNode.bind(this)),document.body.addEventListener("haxcms-create-node",this.createNode.bind(this)),document.body.addEventListener("hax-app-picker-selection",this._appPicked.bind(this))}disconnectedCallback(){document.body.removeEventListener("jwt-token",this._jwtTokenFired.bind(this)),document.body.removeEventListener("haxcms-save-site-data",this.saveManifest.bind(this)),document.body.removeEventListener("haxcms-save-outline",this.saveOutline.bind(this)),document.body.removeEventListener("haxcms-save-node",this.saveNode.bind(this)),document.body.removeEventListener("haxcms-delete-node",this.deleteNode.bind(this)),document.body.removeEventListener("haxcms-create-node",this.createNode.bind(this)),document.body.removeEventListener("hax-app-picker-selection",this._appPicked.bind(this)),super.disconnectedCallback()}_appPicked(e){if("dat"===e.detail.connection.protocol){e.preventDefault(),e.stopPropagation();let t=new FileReader;t.onload=e=>{let t="files/"+window.HaxStore.instance.haxTray.shadowRoot.querySelector("#fileupload").files[0].name;this.shadowRoot.querySelector("#beaker").write(t,e.target.result),window.HaxStore.instance.haxTray.shadowRoot.querySelector("#url").value=t,window.HaxStore.instance.haxTray.shadowRoot.querySelector("hax-tray-upload").newAssetConfigure()},t.readAsArrayBuffer(window.HaxStore.instance.haxTray.shadowRoot.querySelector("#fileupload").files[0])}}async saveNode(e){this.activeItem=e.detail,await this.shadowRoot.querySelector("#beaker").write(this.activeItem.location,window.HaxStore.instance.activeHaxBody.haxToContent()),i.store.cmsSiteEditor.instance.shadowRoot.querySelector("#toast").show("Page updated!");const t=new CustomEvent("haxcms-trigger-update-node",{bubbles:!0,composed:!0,cancelable:!1,detail:!0});i.store.cmsSiteEditor.instance.dispatchEvent(t)}async saveOutline(e){this.manifest=i.store.cmsSiteEditor.instance.manifest,this.manifest.items=e.detail,this.manifest.items.forEach((e,t)=>{if(void 0===e.location){let s=(0,a.generateResourceID)("item-");e.id=s,e.location="pages/"+s+"/index.html",e.order=t,e.description="",e.metadata={created:Math.floor(Date.now()/1e3),updated:Math.floor(Date.now()/1e3)},this.shadowRoot.querySelector("#beaker").archive.mkdir("pages/"+s),this.shadowRoot.querySelector("#beaker").write("pages/"+s+"/index.html","<p>Ex uno Plures</p>"),this.manifest.items[t]=e}}),this.shadowRoot.querySelector("#beaker").write("site.json",JSON.stringify(this.manifest,null,2)),i.store.cmsSiteEditor.instance.shadowRoot.querySelector("#toast").show("Outline saved!"),i.store.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),i.store.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}async deleteNode(e){let t=e.detail.item;this.manifest=i.store.cmsSiteEditor.instance.manifest,this.manifest.items=e.detail,this.manifest.items.forEach((e,s)=>{e.id===t.id&&this.splice("manifest.items",s,1)}),this.shadowRoot.querySelector("#beaker").write("site.json",JSON.stringify(this.manifest,null,2)),i.store.cmsSiteEditor.instance.shadowRoot.querySelector("#toast").show(`${t.title} deleted`),i.store.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),i.store.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}async createNode(e){let t=e.detail.values;this.manifest=i.store.cmsSiteEditor.instance.manifest,this.manifest.items=e.detail,this.manifest.items.forEach((e,s)=>{if(void 0===e.location){t.id||(t.id=(0,a.generateResourceID)("item-")),t.location||(t.location="pages/"+t.id+"/index.html");let i=t.location.replace("/index.html","");e.id=t.id,e.location=t.location,e.order=t.order,e.indent=t.indent,e.parent=t.parent,e.description=t.description,e.metadata.created=Math.floor(Date.now()/1e3),e.metadata.updated=Math.floor(Date.now()/1e3),this.shadowRoot.querySelector("#beaker").archive.mkdir(i),this.shadowRoot.querySelector("#beaker").write(t.location,"<p>My great new content!</p>"),this.manifest.items[s]=e}}),this.shadowRoot.querySelector("#beaker").write("site.json",JSON.stringify(this.manifest,null,2)),i.store.cmsSiteEditor.instance.shadowRoot.querySelector("#toast").show(`${t.title} created!`),i.store.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),i.store.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}async saveManifest(e){if(this.manifest=e.detail,"string"==typeof this.manifest.metadata.theme){const e={"haxcms-dev-theme":{element:"haxcms-dev-theme",path:"@lrnwebcomponents/haxcms-elements/lib/haxcms-dev-theme.js",name:"Developer theme"},"outline-player":{element:"outline-player",path:"@lrnwebcomponents/outline-player/outline-player.js",name:"Outline player"},"simple-blog":{element:"simple-blog",path:"@lrnwebcomponents/simple-blog/simple-blog.js",name:"Simple blog"}};e[this.manifest.metadata.theme]&&(this.manifest.metadata.theme=e[this.manifest.metadata.theme])}await this.shadowRoot.querySelector("#beaker").write("site.json",JSON.stringify(this.manifest,null,2)),i.store.cmsSiteEditor.instance.shadowRoot.querySelector("#toast").show("Site details saved!"),i.store.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),i.store.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}_jwtTokenFired(e){this.jwt=e.detail,i.store.jwt=this.jwt,i.store.cmsSiteEditor&&i.store.cmsSiteEditor.instance&&(i.store.cmsSiteEditor.instance.jwt=this.jwt)}async connectedCallback(){super.connectedCallback();let e=this.shadowRoot.querySelector("#beaker");this.jwt=e.archive.url;var s=await e.archive.getInfo();if(null!=this.jwt&&"string"==typeof this.jwt&&s.isOwner){var a=JSON.parse(await e.read("appstore.json"));try{new Promise((e,s)=>t.default(["../haxcms-site-editor.js"],e,s)).then(e=>{i.store.cmsSiteEditorAvailability(),i.store.cmsSiteEditor.instance.jwt=this.jwt,i.store.cmsSiteEditor.instance.appStore=a},e=>{})}catch(o){}}else window.dispatchEvent(new CustomEvent("haxcms-not-logged-in",{bubbles:!0,composed:!0,cancelable:!1,detail:this}))}}e.HAXCMSBackendBeaker=HAXCMSBackendBeaker,window.customElements.define(HAXCMSBackendBeaker.tag,HAXCMSBackendBeaker)}));