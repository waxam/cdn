define(["exports"],function(_exports){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.getRange=function(root){if(root.getSelection){var s=root.getSelection();return s.rangeCount?s.getRangeAt(0):null}var thisFrame=cachedRange.get(root);if(thisFrame){return thisFrame}var initialText=window.getSelection().toString(),result=internalGetShadowSelection(root),rs=result.range&&result.range.toString()||null;if(null!==rs&&rs!==initialText){if(rs.replace(/\s/g,"")!==initialText.replace(/\s/g,"")){console.warn("invalid range, initial text:",initialText);console.warn("vs",rs,result.mode,result.range)}}cachedRange.set(root,result.range);window.setTimeout(function(){cachedRange.delete(root)},0);return result.range};_exports.internalGetShadowSelection=internalGetShadowSelection;var debug=!1,validNodeTypes=[Node.ELEMENT_NODE,Node.TEXT_NODE,Node.DOCUMENT_FRAGMENT_NODE];function isValidNode(node){return validNodeTypes.includes(node.nodeType)}function findNode(s,parentNode,isLeft){var nodes=parentNode.childNodes||parentNode.children;if(!nodes){return parentNode}for(var i=0;i<nodes.length;++i){var j=isLeft?i:nodes.length-1-i,childNode=nodes[j];if(!isValidNode(childNode)){continue}if(s.containsNode(childNode,!0)){if(s.containsNode(childNode,!1)){return childNode}return findNode(s,childNode,isLeft)}}return parentNode}var addInternalListener=function(){var testNode=document.createElement("div"),testRoot=testNode.attachShadow({mode:"open"});if(testRoot.getSelection){document.addEventListener("selectionchange",function(){document.dispatchEvent(new CustomEvent("-shadow-selectionchange"))});return function(){}}var withinInternals=!1,handlers=[];document.addEventListener("selectionchange",function(ev){if(withinInternals){return}document.dispatchEvent(new CustomEvent("-shadow-selectionchange"));withinInternals=!0;window.setTimeout(function(){withinInternals=!1},0);handlers.forEach(function(fn){return fn(ev)})});return function(fn){return handlers.push(fn)}}(),wasCaret=!1,resolveTask=null;addInternalListener(function(){var s=window.getSelection();if("Caret"===s.type){wasCaret=!0}else if(wasCaret&&!resolveTask){resolveTask=Promise.resolve(!0).then(function(){wasCaret=!1;resolveTask=null})}});function containsNextElement(s,node,walkForward){var start=node;while(node=walkFromNode(node,walkForward)){if(!node.contains(start)){break}}if(!node){return!1}return babelHelpers.instanceof(node,Element)&&s.containsNode(node,!0)}function getSelectionDirection(s,leftNode,rightNode){if("Range"!==s.type){return}var measure=function(){return s.toString().length},initialSize=measure();if(1===initialSize&&wasCaret&&leftNode===rightNode){s.extend(leftNode,0);s.collapseToEnd();return}var updatedSize;s.modify("extend","forward","character");updatedSize=measure();if(updatedSize>initialSize||containsNextElement(s,rightNode,!0)){s.modify("extend","backward","character");return!0}else if(updatedSize<initialSize||!s.containsNode(leftNode)){s.modify("extend","backward","character");return!1}s.modify("extend","backward","character");updatedSize=measure();if(updatedSize>initialSize||containsNextElement(s,leftNode,!1)){s.modify("extend","forward","character");return!1}else if(updatedSize<initialSize||!s.containsNode(rightNode)){s.modify("extend","forward","character");return!0}}function walkFromNode(node,walkForward){if(!walkForward){return node.previousSibling||node.parentNode||null}while(node){if(node.nextSibling){return node.nextSibling}node=node.parentNode}return null}function initialSpace(node){if(node.nodeType!==Node.TEXT_NODE){return 0}return /^\s*/.exec(node.textContent)[0].length}function ignoredTrailingSpace(node){if(node.nodeType!==Node.TEXT_NODE){return 0}var trailingSpaceCount=/\s*$/.exec(node.textContent)[0].length;if(!trailingSpaceCount){return 0}return trailingSpaceCount-1}var cachedRange=new Map;var fakeSelectionNode=document.createTextNode("");function internalGetShadowSelection(root){var range=document.createRange(),s=window.getSelection();if(!s.containsNode(root.host,!0)){return{range:null,mode:"none"}}root.insertBefore(fakeSelectionNode,root.childNodes[0]);var includesBeforeRoot=s.containsNode(fakeSelectionNode);fakeSelectionNode.remove();if(includesBeforeRoot){return{range:null,mode:"outside-before"}}root.appendChild(fakeSelectionNode);var includesAfterRoot=s.containsNode(fakeSelectionNode);fakeSelectionNode.remove();if(includesAfterRoot){return{range:null,mode:"outside-after"}}var measure=function(){return s.toString().length},initialSelectionContent=s.toString();if(!("Caret"===s.type||"Range"===s.type)){throw new TypeError("unexpected type: "+s.type)}var initialCaret="Caret"===s.type,leftNode=findNode(s,root,!0),rightNode,isNaturalDirection=void 0;if("Range"===s.type){rightNode=findNode(s,root,!1);isNaturalDirection=getSelectionDirection(s,leftNode,rightNode)}if("Caret"===s.type){s.extend(leftNode,0);var at=measure();s.collapseToEnd();range.setStart(leftNode,at);range.setEnd(leftNode,at);return{range:range,mode:"caret"}}else if(isNaturalDirection===void 0){if("Range"!==s.type){throw new TypeError("unexpected type: "+s.type)}range.setStart(leftNode,0);range.setEnd(rightNode,rightNode.length);return{range:range,mode:"all"}}var size=measure(),offsetLeft,offsetRight,validRightLength=rightNode.length-ignoredTrailingSpace(rightNode);if(isNaturalDirection){s.extend(leftNode,0);offsetLeft=measure()+initialSpace(leftNode);s.extend(rightNode,validRightLength);offsetRight=validRightLength-(measure()-size);s.extend(rightNode,offsetRight)}else{s.extend(rightNode,validRightLength);offsetRight=validRightLength-measure();s.extend(leftNode,0);offsetLeft=measure()-size+initialSpace(leftNode);s.extend(leftNode,offsetLeft)}range.setStart(leftNode,offsetLeft);range.setEnd(rightNode,offsetRight);return{mode:isNaturalDirection?"right":"left",range:range}}});