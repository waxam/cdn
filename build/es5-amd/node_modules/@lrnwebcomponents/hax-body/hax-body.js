define(["exports","../../@polymer/polymer/polymer-legacy.js","../../@polymer/polymer/lib/legacy/polymer.dom.js","../../@polymer/polymer/lib/utils/flattened-nodes-observer.js","../../@polymer/polymer/lib/utils/flush.js","../../@polymer/polymer/lib/utils/async.js","../../@polymer/paper-item/paper-item.js","../simple-colors/simple-colors.js","../../@polymer/iron-a11y-keys/iron-a11y-keys.js","../grid-plate/grid-plate.js","./lib/hax-text-context.js","./lib/hax-ce-context.js","./lib/hax-plate-context.js","./lib/hax-input-mixer.js","./lib/hax-shared-styles.js"],function(_exports,_polymerLegacy,_polymerDom,_flattenedNodesObserver,_flush,async){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.HaxBody=void 0;async=babelHelpers.interopRequireWildcard(async);function _templateObject_211a2850490411e990ee3fd35bb8725b(){var data=babelHelpers.taggedTemplateLiteral(["\n    <style include=\"simple-colors hax-shared-styles\">\n      @import url(\"https://fonts.googleapis.com/css?family=Noto+Serif\");\n      :host {\n        display: block;\n        min-height: 32px;\n        min-width: 32px;\n        outline: none;\n      }\n      .hax-context-menu {\n        padding: 0;\n        margin-left: -5000px;\n        position: absolute;\n        visibility: hidden;\n        opacity: 0;\n        z-index: 1000;\n        float: left;\n        display: block;\n        pointer-events: none;\n        transition: 0.8s opacity ease-in-out, 0.8s visibility ease-in-out;\n      }\n      #haxinputmixer {\n        z-index: 10000000;\n      }\n      .hax-context-visible.hax-active-hover {\n        visibility: visible;\n        opacity: 1;\n        pointer-events: all;\n        margin-left: unset;\n      }\n      :host #bodycontainer ::slotted(*) {\n        font-family: \"Noto Serif\", serif;\n        color: #444;\n        margin: 2px;\n      }\n      :host #bodycontainer ::slotted(h1) {\n        font-size: 2.5em;\n        line-height: 2.5em;\n      }\n      :host #bodycontainer ::slotted(h2) {\n        font-size: 2em;\n      }\n      :host #bodycontainer ::slotted(h3) {\n        font-size: 1.75em;\n      }\n      :host #bodycontainer ::slotted(h4) {\n        font-size: 1.5em;\n      }\n      :host #bodycontainer ::slotted(h5),\n      :host #bodycontainer ::slotted(h6) {\n        font-size: 1.25em;\n      }\n      :host #bodycontainer ::slotted(p) {\n        line-height: 40px;\n        min-height: 26px;\n        font-size: 24px;\n      }\n      :host #bodycontainer ::slotted(a),\n      :host #bodycontainer ::slotted(a:visited),\n      :host #bodycontainer ::slotted(a:active) {\n        color: #000;\n      }\n      :host #bodycontainer ::slotted(a:hover) {\n        color: #2196f3;\n      }\n      :host #bodycontainer ::slotted(ol),\n      :host #bodycontainer ::slotted(ul),\n      :host #bodycontainer ::slotted(li) {\n        padding-bottom: 1.5em;\n        line-height: 40px;\n        font-size: 24px;\n        max-width: 28em;\n      }\n      :host #bodycontainer ::slotted(ol > li:last-child),\n      :host #bodycontainer ::slotted(ul > li:last-child) {\n        padding-bottom: 1em;\n      }\n      :host #bodycontainer ::slotted(ul),\n      :host #bodycontainer ::slotted(ol) {\n        padding-left: 20px;\n        margin-left: 20px;\n      }\n\n      :host([edit-mode]) #bodycontainer ::slotted(*[data-editable]) {\n        outline: none;\n        outline-offset: 2px;\n        transition: 0.2s width ease-in-out, 0.2s height ease-in-out,\n          0.2s margin ease-in-out;\n        caret-color: var(--hax-color-text);\n      }\n      :host([edit-mode]) #bodycontainer ::slotted(*[data-editable]:hover) {\n        outline: 1px solid rgba(145, 151, 162, 0.25);\n        caret-color: #000000;\n      }\n      :host([edit-mode])\n        #bodycontainer\n        ::slotted(*.hax-active[data-editable]:hover) {\n        cursor: text !important;\n        outline: 1px solid rgba(145, 151, 162, 0.25);\n      }\n      :host([edit-mode])\n        #bodycontainer\n        ::slotted(*[data-editable] .hax-active:hover) {\n        cursor: text !important;\n        outline: 1px solid rgba(145, 151, 162, 0.25);\n      }\n      :host([edit-mode])\n        #bodycontainer\n        ::slotted(code.hax-active[data-editable]) {\n        display: block;\n      }\n      :host([edit-mode]) #bodycontainer ::slotted(hr[data-editable]) {\n        height: 2px;\n        background-color: #eeeeee;\n        padding-top: 4px;\n        padding-bottom: 4px;\n      }\n      /** Fix to support safari as it defaults to none */\n      :host([edit-mode]) #bodycontainer ::slotted(*[data-editable]) {\n        -webkit-user-select: text;\n        cursor: pointer;\n      }\n\n      :host([edit-mode])\n        #bodycontainer\n        ::slotted(*[data-editable]::-moz-selection),\n      :host([edit-mode])\n        #bodycontainer\n        ::slotted(*[data-editable] *::-moz-selection) {\n        background-color: var(--hax-body-highlight, --paper-yellow-300);\n        color: black;\n      }\n      :host([edit-mode]) #bodycontainer ::slotted(*[data-editable]::selection),\n      :host([edit-mode])\n        #bodycontainer\n        ::slotted(*[data-editable] *::selection) {\n        background-color: var(--hax-body-highlight, --paper-yellow-300);\n        color: black;\n      }\n      #bodycontainer {\n        -webkit-user-select: text;\n        user-select: text;\n      }\n      :host([edit-mode][hax-ray-mode])\n        #bodycontainer\n        ::slotted(*[data-editable]):before {\n        content: attr(data-hax-ray) \" \" attr(resource) \" \" attr(typeof) \" \"\n          attr(property) \" \" attr(content);\n        font-size: 10px;\n        font-style: italic;\n        left: unset;\n        right: unset;\n        top: unset;\n        background-color: #d3d3d3;\n        color: #000000;\n        bottom: unset;\n        width: auto;\n        padding: 8px;\n        margin: 0;\n        z-index: 1;\n        margin: -16px 0 0 0;\n        float: right;\n        line-height: 2;\n      }\n    </style>\n    <div id=\"bodycontainer\" class=\"ignore-activation\">\n      <slot id=\"body\"></slot>\n    </div>\n    <hax-text-context\n      id=\"textcontextmenu\"\n      class=\"hax-context-menu ignore-activation\"\n    ></hax-text-context>\n    <hax-ce-context\n      id=\"cecontextmenu\"\n      class=\"hax-context-menu ignore-activation\"\n    ></hax-ce-context>\n    <hax-plate-context\n      id=\"platecontextmenu\"\n      class=\"hax-context-menu ignore-activation\"\n    ></hax-plate-context>\n    <hax-input-mixer\n      id=\"haxinputmixer\"\n      class=\"hax-context-menu ignore-activation\"\n    ></hax-input-mixer>\n  "]);_templateObject_211a2850490411e990ee3fd35bb8725b=function(){return data};return data}var HaxBody=(0,_polymerLegacy.Polymer)({is:"hax-body",_template:(0,_polymerLegacy.html)(_templateObject_211a2850490411e990ee3fd35bb8725b()),listeners:{focusin:"_focusIn",mousedown:"_focusIn","hax-context-item-selected":"_haxContextOperation","hax-input-mixer-update":"_haxInputMixerOperation","place-holder-replace":"replacePlaceholder"},properties:{__self:{type:Object,value:void 0},editMode:{type:Boolean,value:!1,reflectToAttribute:!0,observer:"_editModeChanged"},globalPreferences:{type:Object,value:{},observer:"_globalPreferencesUpdated"},haxRayMode:{type:Boolean,value:!1,reflectToAttribute:!0},activeNode:{type:Object,value:null,notify:!0,observer:"_activeNodeChanged"},activeContainerNode:{type:Object,value:null,notify:!0,observer:"_activeContainerNodeChanged"}},ready:function ready(){var _this=this;this.polyfillSafe=window.HaxStore.instance.computePolyfillSafe();this._observer=new _flattenedNodesObserver.FlattenedNodesObserver(this,function(info){(0,_flush.flush)();if(0<info.addedNodes.length){info.addedNodes.map(function(node){if(_this._haxElementTest(node)){if(_this._HTMLPrimativeTest(node)){node.contentEditable=_this.editMode}node.setAttribute("data-editable",_this.editMode);var haxRay=node.tagName.replace("-"," ").toLowerCase(),i=window.HaxStore.instance.gizmoList.findIndex(function(j){return j.tag===node.tagName.toLowerCase()});if(-1!==i){haxRay=window.HaxStore.instance.gizmoList[i].title}node.setAttribute("data-hax-ray",haxRay);_this.fire("hax-body-tag-added",{node:node})}})}if(0<info.removedNodes.length){info.removedNodes.map(function(node){if(_this._haxElementTest(node)&&!node.classList.contains("hax-active")){_this.fire("hax-body-tag-removed",{node:node})}})}})},attached:function attached(){try{document.execCommand("enableObjectResizing",!1,!1);document.execCommand("defaultParagraphSeparator",!1,"p")}catch(e){console.log(e)}window.addEventListener("keydown",this._onKeyDown.bind(this));window.addEventListener("keypress",this._onKeyPress.bind(this));this.shadowRoot.querySelector("slot").addEventListener("mousemove",this.hoverEvent.bind(this));this.shadowRoot.querySelector("slot").addEventListener("mouseup",function(){var tmp=window.HaxStore.getSelection();window.HaxStore._tmpSelection=tmp;try{var range=window.HaxStore.getRange();if(range.cloneRange){window.HaxStore._tmpRange=range.cloneRange()}}catch(e){console.log(e)}});this.shadowRoot.querySelector("slot").addEventListener("paste",function(e){if(window.HaxStore.instance.isTextElement(window.HaxStore.instance.activeNode)&&!window.HaxStore.instance.haxManager.opened){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();var text="";if(e.clipboardData||e.originalEvent.clipboardData){text=(e.originalEvent||e).clipboardData.getData("text/plain")}else if(window.clipboardData){text=window.clipboardData.getData("Text")}try{var range=window.HaxStore.getRange(),sel=window.HaxStore.getSelection(),newNode=document.createTextNode(text),newRange=document.createRange();if(range&&sel){range.deleteContents();range.insertNode(newNode);newRange.setStart(newNode,text.length);newRange.collapse(!0);sel.removeAllRanges();sel.addRange(newRange)}}catch(e){console.log(e)}}});this.__tabTrap=!1;this.fire("hax-register-body",this);document.body.addEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this));window.addEventListener("scroll",this._keepContextVisible.bind(this))},detached:function detached(){window.removeEventListener("keydown",this._onKeyDown.bind(this));window.removeEventListener("keypress",this._onKeyPress.bind(this));this.shadowRoot.querySelector("slot").removeEventListener("mousemove",this.hoverEvent.bind(this));this.shadowRoot.querySelector("slot").removeEventListener("mouseup",function(){var tmp=window.HaxStore.getSelection();window.HaxStore._tmpSelection=tmp;try{var range=window.HaxStore.getRange();if(range.cloneRange){window.HaxStore._tmpRange=range.cloneRange()}}catch(e){console.log(e)}});this.shadowRoot.querySelector("slot").removeEventListener("paste",function(e){if(window.HaxStore.instance.isTextElement(window.HaxStore.instance.activeNode)&&!window.HaxStore.instance.haxManager.opened){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();var text="";if(e.clipboardData||e.originalEvent.clipboardData){text=(e.originalEvent||e).clipboardData.getData("text/plain")}else if(window.clipboardData){text=window.clipboardData.getData("Text")}try{var range=window.HaxStore.getRange(),sel=window.HaxStore.getSelection(),newNode=document.createTextNode(text),newRange=document.createRange();if(range&&sel){range.deleteContents();range.insertNode(newNode);newRange.setStart(newNode,text.length);newRange.collapse(!0);sel.removeAllRanges();sel.addRange(newRange)}}catch(e){console.log(e)}}});document.body.removeEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this));window.removeEventListener("scroll",this._keepContextVisible.bind(this))},_keepContextVisible:function _keepContextVisible(){var el=!1;if(this.$.textcontextmenu.classList.contains("hax-context-visible")){el=this.$.textcontextmenu}else if(this.$.cecontextmenu.classList.contains("hax-context-visible")){el=this.$.cecontextmenu}if(el){if(this.elementInViewport(el)){el.classList.remove("hax-context-pin-bottom","hax-context-pin-top")}else{if(this.__OffBottom){el.classList.add("hax-context-pin-top")}else{el.classList.add("hax-context-pin-bottom")}}}},_onKeyDown:function _onKeyDown(e){var _this2=this;if(this.editMode&&this.getAttribute("contenteditable")){setTimeout(function(){var rng=window.HaxStore.getRange();switch(e.key){case"Tab":if(window.HaxStore.instance.isTextElement(_this2.activeContainerNode)){if(e.detail.keyboardEvent){e.detail.keyboardEvent.preventDefault();e.detail.keyboardEvent.stopPropagation();e.detail.keyboardEvent.stopImmediatePropagation()}e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();if(e.shiftKey){_this2._tabBackKeyPressed()}else{_this2._tabKeyPressed()}}break;case"Enter":_this2.setAttribute("contenteditable",!0);setTimeout(function(){if(rng.commonAncestorContainer&&"function"===typeof rng.commonAncestorContainer.focus){rng.commonAncestorContainer.focus();_this2.__focusLogic(rng.commonAncestorContainer)}},900);break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":if(rng.commonAncestorContainer&&_this2.activeNode!==rng.commonAncestorContainer&&"function"===typeof rng.commonAncestorContainer.focus){if("HAX-BODY"!==rng.commonAncestorContainer.tagName){if(window.HaxStore.instance.isTextElement(rng.commonAncestorContainer)){_this2.setAttribute("contenteditable",!0)}else{_this2.removeAttribute("contenteditable")}setTimeout(function(){rng.commonAncestorContainer.focus();_this2.__focusLogic(rng.commonAncestorContainer)},900)}}else if(rng.commonAncestorContainer&&rng.commonAncestorContainer.parentNode&&_this2.activeNode!==rng.commonAncestorContainer.parentNode&&"function"===typeof rng.commonAncestorContainer.parentNode.focus){if("HAX-BODY"!==rng.commonAncestorContainer.parentNode.tagName){if(window.HaxStore.instance.isTextElement(rng.commonAncestorContainer.parentNode)){_this2.setAttribute("contenteditable",!0)}else{_this2.removeAttribute("contenteditable")}setTimeout(function(){rng.commonAncestorContainer.parentNode.focus();_this2.__focusLogic(rng.commonAncestorContainer.parentNode)},900)}}break;}},100);if(this.$.platecontextmenu.classList.contains("hax-active-hover")){this.__dropActiveHover()}}},_onKeyPress:function _onKeyPress(){if(this.editMode&&this.$.platecontextmenu.classList.contains("hax-active-hover")){this.__dropActiveHover()}},hoverEvent:function hoverEvent(e){if(this.editMode){if(e.target&&null!=e.target.getAttribute("data-hax-ray")){this.__activeHover=e.target;this.fire("hax-active-hover-name",e.target.getAttribute("data-hax-ray"))}else if(e.target&&e.target.parentNode&&null!=e.target.parentNode.getAttribute("data-hax-ray")){this.__activeHover=e.target.parentNode;this.fire("hax-active-hover-name",e.target.parentNode.getAttribute("data-hax-ray"))}if(!this.$.platecontextmenu.classList.contains("hax-active-hover")){var normalizedEvent=(0,_polymerDom.dom)(e),local=normalizedEvent.localTarget;if(e.target===this.$.cecontextmenu||e.target===this.$.textcontextmenu||e.target===this.$.platecontextmenu||local===this.activeNode||local===this.activeContainerNode||e.target===this.activeNode||e.target===this.activeContainerNode||local.parentNode===this.activeContainerNode||local.parentNode.parentNode===this.activeContainerNode||local.parentNode.parentNode.parentNode===this.activeContainerNode){this.__addActiveHover();this.__typeLock=!1}else{this.__dropActiveHover()}}}},__addActiveHover:function __addActiveHover(){this.$.cecontextmenu.classList.add("hax-active-hover");this.$.textcontextmenu.classList.add("hax-active-hover");this.$.platecontextmenu.classList.add("hax-active-hover")},__dropActiveHover:function __dropActiveHover(){this.$.cecontextmenu.classList.remove("hax-active-hover");this.$.textcontextmenu.classList.remove("hax-active-hover");this.$.platecontextmenu.classList.remove("hax-active-hover")},elementInViewport:function elementInViewport(el){var top=el.offsetTop-32-window.HaxStore.instance.haxPanel.$.drawer.offsetHeight,left=el.offsetLeft,width=el.offsetWidth,height=el.offsetHeight;while(el.offsetParent){el=el.offsetParent;top+=el.offsetTop;left+=el.offsetLeft}this.__OffBottom=top<window.pageYOffset+window.innerHeight;return top<window.pageYOffset+window.innerHeight&&left<window.pageXOffset+window.innerWidth&&top+height>window.pageYOffset&&left+width>window.pageXOffset},replacePlaceholder:function replacePlaceholder(e){var _this3=this;if("text"===e.detail){var p=document.createElement("p");p.innerHTML="<br/>";this.haxReplaceNode(this.activeNode,p,(0,_polymerDom.dom)(this.activeNode).parentNode);setTimeout(function(){_this3.activeNode=p;window.HaxStore.write("activeNode",p,_this3);_this3.activeContainerNode.setAttribute("contenteditable",!0);p.focus();_this3.__focusLogic(p)},210)}else{this.replaceElementWorkflow()}},replaceElementWorkflow:function replaceElementWorkflow(){var element=window.HaxStore.nodeToHaxElement(this.activeNode,null),type="*",skipPropMatch=!1;if("place-holder"===element.tag&&babelHelpers.typeof(element.properties.type)!=="undefined"){type=element.properties.type;skipPropMatch=!0}var props={};if(babelHelpers.typeof(window.HaxStore.instance.elementList[element.tag])!=="undefined"&&!1!==window.HaxStore.instance.elementList[element.tag].gizmo&&babelHelpers.typeof(window.HaxStore.instance.elementList[element.tag].gizmo.handles)!=="undefined"&&0<window.HaxStore.instance.elementList[element.tag].gizmo.handles.length){for(var gizmo=window.HaxStore.instance.elementList[element.tag].gizmo,i=0;i<gizmo.handles.length;i++){for(var prop in gizmo.handles[i]){if("type"!==prop&&babelHelpers.typeof(element.properties[gizmo.handles[i][prop]])!=="undefined"){props[prop]=element.properties[gizmo.handles[i][prop]]}}}}var haxElements=window.HaxStore.guessGizmo(type,props,skipPropMatch);if(0<haxElements.length){var tag=this.activeNode.tagName.toLowerCase(),humanName=tag.replace("-"," ");if(babelHelpers.typeof(window.HaxStore.instance.elementList[tag])!=="undefined"&&!1!==window.HaxStore.instance.elementList[tag].gizmo){humanName=window.HaxStore.instance.elementList[tag].gizmo.title}window.HaxStore.instance.haxAppPicker.presentOptions(haxElements,"__convert","Transform ".concat(humanName," to.."),"gizmo")}else{window.HaxStore.toast("Sorry, this can not be transformed!",5e3)}},_globalPreferencesUpdated:function _globalPreferencesUpdated(newValue){if(babelHelpers.typeof(newValue)!=="undefined"&&null!=newValue){this.haxRayMode=newValue.haxRayMode}},_haxStorePropertyUpdated:function _haxStorePropertyUpdated(e){if(e.detail&&babelHelpers.typeof(e.detail.value)!=="undefined"&&e.detail.property){if("object"===babelHelpers.typeof(e.detail.value)){this.set(e.detail.property,null)}this.set(e.detail.property,e.detail.value)}},haxClearBody:function haxClearBody(){var confirm=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!0,status=!0;if(confirm){status=prompt("Are you sure you want to delete all content?")}if(status){window.HaxStore.wipeSlot(this)}},haxInsert:function haxInsert(tag,content){var _this4=this,properties=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{},waitForLock=3<arguments.length&&arguments[3]!==void 0?arguments[3]:!0,tags=window.HaxStore.instance.validTagList;this.__activeHover=null;if(tags.includes(tag)){var frag=document.createElement(tag);frag.innerHTML=content;var newNode=frag.cloneNode(!0);for(var property in properties){var attributeName=window.HaxStore.camelToDash(property);if(properties.hasOwnProperty(property)){if(!0===properties[property]){newNode.setAttribute(attributeName,properties[property])}else if(!1===properties[property]){newNode.removeAttribute(attributeName)}else if(null!=properties[property]&&properties[property].constructor===Array){if(!(newNode.properties&&newNode.properties[property].readOnly)){newNode.set(attributeName,properties[property])}}else if(null!=properties[property]&&properties[property].constructor===Object){if(!(newNode.properties&&newNode.properties[property].readOnly)){newNode.set(attributeName,properties[property])}}else{newNode.setAttribute(attributeName,properties[property])}}}if(null!==window.HaxStore.instance.activePlaceHolder&&babelHelpers.typeof(window.HaxStore.instance.activePlaceHolder.style)!=="undefined"){newNode.style.width=window.HaxStore.instance.activePlaceHolder.style.width;newNode.style.float=window.HaxStore.instance.activePlaceHolder.style.float;newNode.style.margin=window.HaxStore.instance.activePlaceHolder.style.margin;newNode.style.display=window.HaxStore.instance.activePlaceHolder.style.display;this.haxReplaceNode(window.HaxStore.instance.activePlaceHolder,newNode,(0,_polymerDom.dom)(window.HaxStore.instance.activePlaceHolder).parentNode);window.HaxStore.instance.activePlaceHolder=null}else if(null!==this.activeContainerNode){if("GRID-PLATE"!==newNode.tagName&&"GRID-PLATE"===this.activeContainerNode.tagName&&this.activeContainerNode!==this.activeNode){newNode.setAttribute("slot",this.activeNode.getAttribute("slot"));(0,_polymerDom.dom)(this.activeContainerNode).insertBefore(newNode,this.activeNode)}else{(0,_polymerDom.dom)(this).insertBefore(newNode,this.activeContainerNode.nextElementSibling)}}else{(0,_polymerDom.dom)(this).appendChild(newNode)}this.$.textcontextmenu.highlightOps=!1;this.__updateLockFocus=newNode;if(waitForLock){setTimeout(function(){_this4.breakUpdateLock()},150)}return!0}return!1},breakUpdateLock:function breakUpdateLock(){window.HaxStore.write("activeContainerNode",this.__updateLockFocus,this);window.HaxStore.write("activeNode",this.__updateLockFocus,this);this.__updateLockFocus.focus();if("function"===typeof this.__updateLockFocus.scrollIntoViewIfNeeded){this.__updateLockFocus.scrollIntoViewIfNeeded(!0)}else{this.__updateLockFocus.scrollIntoView({behavior:"smooth",inline:"center"})}},haxToContent:function haxToContent(){this.hideContextMenus();var __active=this.activeNode;this.set("activeNode",null);this.set("activeContainerNode",null);window.HaxStore.write("activeNode",null,this);window.HaxStore.write("activeContainerNode",null,this);var children=(0,_polymerDom.dom)(this.$.body).getDistributedNodes();if(this.globalPreferences.haxDeveloperMode){console.log(children)}for(var content="",i=0,len=children.length;i<len;i++){if(this._haxElementTest(children[i])){children[i].removeAttribute("data-editable");children[i].removeAttribute("data-hax-ray");children[i].contentEditable=!1;content+=window.HaxStore.haxNodeToContent(children[i]);if("grid-plate"===children[i].tagName.toLowerCase()){this._applyContentEditable(this.editMode,children[i])}}else if(8===children[i].nodeType){content+="<!-- "+children[i].textContent+" -->"}else if(1!==children[i].nodeType&&babelHelpers.typeof(children[i].textContent)!=="undefined"&&"undefined"!==children[i].textContent){content+=children[i].textContent}}content=content.replace(/\scontenteditable=\"false\"/g,"");content=content.replace(/\sdata-editable=\"true\"/g,"");content=content.replace(/\sdata-editable=\"false\"/g,"");content=content.replace(/\sdata-editable=\""/g,"");content=content.replace(/\sdata-editable/g,"");content=content.replace(/\scontenteditable/g,"");content=content.replace(/\sdraggable/g,"");content=content.replace(/\sdata-draggable/g,"");content=content.replace(/\sdata-hax-ray=\".*?\"/g,"");if(this.parentNode.tagName){var parentTag=this.parentNode.tagName.toLowerCase(),string="style-scope "+parentTag+" x-scope",re=new RegExp(string,"g");content=content.replace(re,"");string="style-scope "+parentTag;re=new RegExp(string,"g");content=content.replace(re,"");string="x-scope "+parentTag+"-0";re=new RegExp(string,"g");content=content.replace(re,"");var tags=window.HaxStore.instance.validTagList;tags.push("hax-preview");for(var i in tags){string="style-scope "+tags[i];re=new RegExp(string,"g");content=content.replace(re,"");string="x-scope "+tags[i]+"-0 ";re=new RegExp(string,"g");content=content.replace(re,"");string="x-scope "+tags[i]+"-0";re=new RegExp(string,"g");content=content.replace(re,"")}}content=content.replace(/\sclass=\"\"/g,"");content=content.replace(/\sclass=\"\s\"/g,"");this._applyContentEditable(this.editMode);window.HaxStore.write("activeNode",__active,this);window.HaxStore.write("activeContainerNode",__active,this);content=window.HaxStore.encapScript(content);if(this.globalPreferences.haxDeveloperMode){console.log(content)}return content},haxDuplicateNode:function haxDuplicateNode(node){var _this5=this,parent=1<arguments.length&&arguments[1]!==void 0?arguments[1]:this;this.hideContextMenus();var nodeClone=(0,_polymerDom.dom)(node).cloneNode(!0);if("webview"===nodeClone.tagName.toLowerCase()&&window.HaxStore.instance._isSandboxed&&babelHelpers.typeof(nodeClone.guestinstance)!=="undefined"){delete nodeClone.guestinstance}if(null!==node){(0,_polymerDom.dom)(parent).insertBefore(nodeClone,(0,_polymerDom.dom)(node).nextSibling)}else{(0,_polymerDom.dom)(parent).appendChild(nodeClone)}setTimeout(function(){if(parent===_this5){window.HaxStore.write("activeContainerNode",nodeClone,_this5)}window.HaxStore.write("activeNode",nodeClone,_this5)},50);return!0},hideContextMenus:function hideContextMenus(){this._hideContextMenu(this.$.textcontextmenu);this._hideContextMenu(this.$.cecontextmenu);this._hideContextMenu(this.$.platecontextmenu);this._hideContextMenu(this.$.haxinputmixer);this.$.textcontextmenu.highlightOps=!1},positionContextMenus:function positionContextMenus(node,container){var tag=node.tagName.toLowerCase();if(window.HaxStore.instance._isSandboxed&&"webview"===tag){tag="iframe"}var props=window.HaxStore.instance.elementList[tag];if(babelHelpers.typeof(props)!=="undefined"&&!window.HaxStore.instance.isTextElement(node)){this.__activeContextType=this.$.cecontextmenu;props.element=node;this.__activeContextType.setHaxProperties(props)}else{this.__activeContextType=this.$.textcontextmenu}this._positionContextMenu(this.__activeContextType,container,-39,-39);this._positionContextMenu(this.$.platecontextmenu,container,-31,0);if(!this._HTMLPrimativeTest(node)&&node!==container){container.contentEditable=!1}else if(this._HTMLPrimativeTest(container)){container.contentEditable=!0}},haxMoveGridPlate:function haxMoveGridPlate(direction,node,container){var _this6=this;switch(direction){case"first":if(null!==container.previousElementSibling){(0,_polymerDom.dom)(this).insertBefore(container,(0,_polymerDom.dom)(this).firstChild)}break;case"up":if(null!==container.previousElementSibling){(0,_polymerDom.dom)(this).insertBefore(container,container.previousElementSibling)}break;case"down":if(null!==container.nextElementSibling){(0,_polymerDom.dom)(this).insertBefore(container.nextElementSibling,container)}break;case"last":if(null!==container.nextElementSibling){(0,_polymerDom.dom)(this).appendChild(container)}break;}setTimeout(function(){_this6.positionContextMenus(node,container);if("function"===typeof container.scrollIntoViewIfNeeded){container.scrollIntoViewIfNeeded(!0)}else{container.scrollIntoView({behavior:"smooth",inline:"center"})}},50);return!0},haxReplaceNode:function haxReplaceNode(node,replacement){var parent=2<arguments.length&&arguments[2]!==void 0?arguments[2]:this;this.hideContextMenus();try{if(null!=node.getAttribute("slot")){replacement.setAttribute("slot",node.getAttribute("slot"))}(0,_polymerDom.dom)(parent).replaceChild(replacement,node)}catch(e){console.log(e)}return replacement},haxChangeTagName:function haxChangeTagName(node,tagName){this.hideContextMenus();for(var replacement=document.createElement(tagName),i=0,l=node.attributes.length;i<l;++i){var nodeName=node.attributes.item(i).nodeName,value=node.attributes.item(i).value;replacement.setAttribute(nodeName,value)}replacement.innerHTML=node.innerHTML.trim();if("ul"==tagName||"ol"==tagName){if(""==replacement.innerHTML){replacement.innerHTML="<li></li>"}else if(!("ul"==node.tagName.toLowerCase()||"ol"==node.tagName.toLowerCase())){replacement.innerHTML="<li>"+node.innerHTML.trim().replace(/<br\/>/g,"</li>\n<li>").replace(/<br>/g,"</li>\n<li>")+"</li>"}}else if("ul"==node.tagName.toLowerCase()||"ol"==node.tagName.toLowerCase()){replacement.innerHTML=replacement.innerHTML.replace(/<ul>/g,"").replace(/<\/ul>/g,"").replace(/<li><\/li>/g,"").replace(/<li>/g,"").replace(/<\/li>/g,"<br/>")}(0,_polymerDom.dom)(this).replaceChild(replacement,node);setTimeout(function(){var children=(0,_polymerDom.dom)(replacement).getEffectiveChildNodes();if(children[0]&&children.tagName){children[0].focus()}else{replacement.focus()}},50);return replacement},haxDeleteNode:function haxDeleteNode(node){var parent=1<arguments.length&&arguments[1]!==void 0?arguments[1]:this;this.hideContextMenus();if(null!=this.activeContainerNode&&null!==this.activeContainerNode.previousElementSibling){this.activeContainerNode.previousElementSibling.focus();if(null!=this.activeContainerNode&&window.HaxStore.instance.isTextElement(this.activeContainerNode)&&""!==(0,_polymerDom.dom)(this.activeContainerNode).textContent){try{var range=document.createRange(),sel=window.HaxStore.getSelection();range.setStart(this.activeContainerNode,1);range.collapse(!0);sel.removeAllRanges();sel.addRange(range);this.activeContainerNode.focus()}catch(e){console.log(e)}}}else if(null!=this.activeContainerNode&&null!==this.activeContainerNode.nextElementSibling){this.activeContainerNode.nextElementSibling.focus()}else{this.set("activeNode",null);this.set("activeContainerNode",null);window.HaxStore.write("activeNode",null,this);window.HaxStore.write("activeContainerNode",null,this)}try{return(0,_polymerDom.dom)(parent).removeChild(node)}catch(e){console.log(e)}},importContent:function importContent(html){var _this7=this,clear=1<arguments.length&&arguments[1]!==void 0?arguments[1]:!0;if(clear){window.HaxStore.wipeSlot(this,"*")}setTimeout(function(){html=window.HaxStore.encapScript(html);var validTags=window.HaxStore.instance.validTagList,fragment=document.createElement("div");fragment.insertAdjacentHTML("beforeend",html);while(null!==fragment.firstChild){if(babelHelpers.typeof(fragment.firstChild.tagName)!=="undefined"&&validTags.includes(fragment.firstChild.tagName.toLowerCase())){if(window.HaxStore.instance._isSandboxed&&"iframe"===fragment.firstChild.tagName.toLowerCase()){for(var replacement=document.createElement("webview"),j=0,l=fragment.firstChild.attributes.length;j<l;++j){var nodeName=fragment.firstChild.attributes.item(j).nodeName,value=fragment.firstChild.attributes.item(j).value;if("height"===nodeName||"width"===nodeName){replacement.style[nodeName]==value}replacement.setAttribute(nodeName,value)}(0,_polymerDom.dom)(_this7).appendChild(replacement)}else{(0,_polymerDom.dom)(_this7).appendChild(fragment.firstChild)}}else{fragment.removeChild(fragment.firstChild)}}},50)},_haxContextOperation:function _haxContextOperation(e){var _this8=this,detail=e.detail,haxElement;switch(detail.eventName){case"p":case"ol":case"ul":case"h2":case"h3":case"h4":case"h5":case"h6":case"blockquote":case"code":this.$.textcontextmenu.selectedValue=detail.eventName;window.HaxStore.write("activeContainerNode",this.haxChangeTagName(this.activeContainerNode,detail.eventName),this);this.positionContextMenus(this.activeNode,this.activeContainerNode);break;case"text-align-left":this.activeNode.style.textAlign=null;this.positionContextMenus(this.activeNode,this.activeContainerNode);break;case"grid-plate-convert":this.replaceElementWorkflow();break;case"grid-plate-duplicate":if(this.activeNode===this.activeContainerNode){this.haxDuplicateNode(this.activeNode)}else{this.haxDuplicateNode(this.activeNode,this.activeContainerNode)}break;case"grid-plate-delete":if(null!=this.activeNode){var tag=this.activeNode.tagName.toLowerCase(),humanName=tag.replace("-"," ");if(babelHelpers.typeof(window.HaxStore.instance.elementList[tag])!=="undefined"&&!1!==window.HaxStore.instance.elementList[tag].gizmo){humanName=window.HaxStore.instance.elementList[tag].gizmo.title}window.HaxStore.instance.haxAppPicker.presentOptions([{icon:"thumb-up",color:"green",title:"Yes"},{icon:"thumb-down",color:"red",title:"No"}],"","Remove this `".concat(humanName,"`?"),"delete")}break;case"grid-plate-first":this.haxMoveGridPlate("first",this.activeNode,this.activeContainerNode);break;case"grid-plate-up":this.haxMoveGridPlate("up",this.activeNode,this.activeContainerNode);break;case"hax-manager-open":window.HaxStore.write("activeHaxElement",{},this);window.HaxStore.instance.haxManager.resetManager(parseInt(detail.value));window.HaxStore.instance.haxManager.toggleDialog();break;case"grid-plate-down":this.haxMoveGridPlate("down",this.activeNode,this.activeContainerNode);break;case"grid-plate-last":this.haxMoveGridPlate("last",this.activeNode,this.activeContainerNode);break;case"close-menu":this.set("activeNode",null);this.set("activeContainerNode",null);window.HaxStore.write("activeNode",null,this);window.HaxStore.write("activeContainerNode",null,this);break;case"hax-edit-property":var haxInputMixer=this.$.haxinputmixer;haxInputMixer.label=detail.target.label;haxInputMixer.options=detail.target.options;haxInputMixer.icon=detail.target.icon;haxInputMixer.description=detail.target.description;haxInputMixer.required=detail.target.required;haxInputMixer.validation=detail.target.validation;haxInputMixer.validationType=detail.target.validationType;haxInputMixer.inputMethod=detail.target.inputMethod;haxInputMixer.value="";if(babelHelpers.typeof(detail.target.propertyToBind)!=="undefined"&&null!=detail.target.propertyToBind&&!1!=detail.target.propertyToBind){haxInputMixer.propertyToBind=detail.target.propertyToBind;if(babelHelpers.typeof(this.activeNode[detail.target.propertyToBind])!=="undefined"){haxInputMixer.value=this.activeNode[detail.target.propertyToBind]}else{haxInputMixer.value=this.activeNode.getAttribute(detail.target.propertyToBind)}}this._positionContextMenu(haxInputMixer,this.activeContainerNode,-1,-38);var style=this.$.cecontextmenu.currentStyle||window.getComputedStyle(this.$.cecontextmenu);haxInputMixer.style.width=style.width.replace("px","")-40+"px";break;case"hax-align-left":this.activeNode.style.float=null;this.activeNode.style.margin=null;this.activeNode.style.display=null;setTimeout(function(){_this8.positionContextMenus(_this8.activeNode,_this8.activeContainerNode)},200);break;case"hax-align-center":this.activeNode.style.float=null;this.activeNode.style.margin="0 auto";this.activeNode.style.display="block";setTimeout(function(){_this8.positionContextMenus(_this8.activeNode,_this8.activeContainerNode)},200);break;case"hax-size-change":if(this.activeNode){this.activeNode.style.width=detail.value+"%";setTimeout(function(){_this8.positionContextMenus(_this8.activeNode,_this8.activeContainerNode)},200)}break;case"hax-manager-configure":this._hideContextMenu(this.$.haxinputmixer);window.HaxStore.instance.haxManager.resetManager();haxElement=window.HaxStore.nodeToHaxElement(window.HaxStore.instance.activeNode);window.HaxStore.write("activeHaxElement",haxElement,this);window.HaxStore.instance.haxManager.editExistingNode=!0;window.HaxStore.instance.haxManager.selectStep("configure");window.HaxStore.instance.haxManager.toggleDialog();setTimeout(function(){window.HaxStore.instance.haxManager.$.preview.$.configurebutton.focus()},100);break;case"hax-manager-configure-container":window.HaxStore.write("activeNode",window.HaxStore.instance.activeContainerNode,this);this._hideContextMenu(this.$.haxinputmixer);window.HaxStore.instance.haxManager.resetManager();haxElement=window.HaxStore.nodeToHaxElement(window.HaxStore.instance.activeNode);window.HaxStore.write("activeHaxElement",haxElement,this);window.HaxStore.instance.haxManager.editExistingNode=!0;window.HaxStore.instance.haxManager.selectStep("configure");window.HaxStore.instance.haxManager.toggleDialog();setTimeout(function(){window.HaxStore.instance.haxManager.$.preview.$.configurebutton.focus()},100);break;}},_haxInputMixerOperation:function _haxInputMixerOperation(e){var mixer=e.detail.inputMixer;if(null!=mixer.propertyToBind){this.activeNode[mixer.propertyToBind]=mixer.value}else if(null!=mixer.slotToBind){item=document.createElement("span");item.style.height="inherit";item.innerHTML=mixer.value;item.slot=mixer.slotToBind;this.activeNode.appendChild(item)}this._hideContextMenu(this.$.haxinputmixer)},_focusIn:function _focusIn(e){var normalizedEvent=(0,_polymerDom.dom)(e);if(this.__focusLogic(normalizedEvent.localTarget)){e.stopPropagation()}},__focusLogic:function __focusLogic(target){var stopProp=!1;if(this.editMode&&!this.__tabTrap){var tags=window.HaxStore.instance.validTagList,containerNode=target,activeNode=null;if(this._haxElementTest(containerNode)&&null!=containerNode.parentNode){while("HAX-BODY"!=containerNode.parentNode.tagName){if(null===activeNode&&tags.includes(containerNode.tagName.toLowerCase())&&"LI"!==containerNode.tagName&&"B"!==containerNode.tagName&&"I"!==containerNode.tagName&&"STRONG"!==containerNode.tagName&&"EM"!==containerNode.tagName){activeNode=containerNode}containerNode=containerNode.parentNode}if(null===activeNode){activeNode=containerNode}else if(!window.HaxStore.instance.isGridPlateElement(containerNode)){activeNode=containerNode}else if(["UL","OL","LI","P","GRID-PLATE"].includes(containerNode.tagName)&&["UL","OL","LI"].includes(activeNode.tagName)){activeNode=containerNode}if(this.activeContainerNode!==containerNode&&tags.includes(containerNode.tagName.toLowerCase())&&!containerNode.classList.contains("ignore-activation")){this.hideContextMenus();this.activeContainerNode=containerNode;window.HaxStore.write("activeContainerNode",containerNode,this);stopProp=!0}else if(containerNode.classList.contains("ignore-activation")){stopProp=!0}if(this.activeNode!==activeNode&&tags.includes(containerNode.tagName.toLowerCase())&&!activeNode.classList.contains("ignore-activation")){this.activeNode=activeNode;window.HaxStore.write("activeNode",activeNode,this);this.positionContextMenus(activeNode,containerNode);stopProp=!0}}}else{this.__tabTrap=!1}return stopProp},_editModeChanged:function _editModeChanged(newValue,oldValue){if(babelHelpers.typeof(oldValue)!=="undefined"){this._applyContentEditable(newValue);this.setAttribute("tabindex","-1");if(!1!==newValue&&babelHelpers.typeof(this.activeNode)!=="undefined"&&null!==this.activeNode){this.positionContextMenus(this.activeNode,this.activeContainerNode)}}if(!1===newValue){this.removeAttribute("contenteditable");this.hideContextMenus()}},_haxResolvePreviousElement:function _haxResolvePreviousElement(node){node=(0,_polymerDom.dom)(node).previousElementSibling;while(null!=node&&babelHelpers.typeof(node.tagName)!=="undefined"&&"HAX-"===node.tagName.substring(0,4)){node=(0,_polymerDom.dom)(node).previousElementSibling}return node},_haxElementTest:function _haxElementTest(node){if(babelHelpers.typeof(node.tagName)!=="undefined"&&"HAX-"!==node.tagName.substring(0,4)){return!0}return!1},_HTMLPrimativeTest:function _HTMLPrimativeTest(node){if(null!=node&&babelHelpers.typeof(node.tagName)!=="undefined"&&-1==node.tagName.indexOf("-")){return!0}return!1},_applyContentEditable:function _applyContentEditable(status){var target=1<arguments.length&&arguments[1]!==void 0?arguments[1]:this.$.body,children=(0,_polymerDom.dom)(target).getDistributedNodes();if(0===children.length){children=(0,_polymerDom.dom)(target).getEffectiveChildNodes()}for(var i=0,len=children.length;i<len;i++){if(this._HTMLPrimativeTest(children[i])){children[i].contentEditable=status}if(this._haxElementTest(children[i])){if(status){children[i].setAttribute("data-editable",status);var haxRay=children[i].tagName.replace("-"," ").toLowerCase(),l=window.HaxStore.instance.gizmoList.findIndex(function(j){return j.tag===children[i].tagName.toLowerCase()});if(-1!==l){haxRay=window.HaxStore.instance.gizmoList[l].title}children[i].setAttribute("data-hax-ray",haxRay)}else{children[i].removeAttribute("data-editable");children[i].removeAttribute("data-hax-ray")}}}},_activeContainerNodeChanged:function _activeContainerNodeChanged(newValue){if(this.editMode&&babelHelpers.typeof(newValue)!=="undefined"&&null!=newValue&&null!=newValue.tagName){if(window.HaxStore.instance.isTextElement(newValue)||window.HaxStore.instance.isGridPlateElement(newValue)){this.setAttribute("contenteditable",!0)}else{this.removeAttribute("contenteditable")}var tag=newValue.tagName.toLowerCase();if("grid-plate"===tag){newValue.editMode=this.editMode;this._applyContentEditable(this.editMode,newValue)}}},_activeNodeChanged:function _activeNodeChanged(newValue,oldValue){var _this9=this;if(babelHelpers.typeof(oldValue)!=="undefined"&&null!=oldValue){oldValue.classList.remove("hax-active")}if(this.editMode&&babelHelpers.typeof(newValue)!=="undefined"&&null!==newValue){var tag=newValue.tagName.toLowerCase();newValue.classList.add("hax-active");if(window.HaxStore.instance.isTextElement(newValue)||window.HaxStore.instance.isGridPlateElement(newValue)){this.setAttribute("contenteditable",!0)}else{this.removeAttribute("contenteditable")}this.$.textcontextmenu.selectedValue=tag;setTimeout(function(){_this9.positionContextMenus(newValue,window.HaxStore.instance.activeContainerNode)},100);if("left"==newValue.style.textAlign){this.$.textcontextmenu.justifyIcon="editor:format-align-left";this.$.textcontextmenu.justifyValue="text-align-left"}else if("left"==newValue.style.float){this.$.cecontextmenu.justifyIcon="editor:format-align-left";this.$.cecontextmenu.justifyValue="hax-align-left"}else if("0 auto"==newValue.style.margin){this.$.cecontextmenu.justifyIcon="editor:format-align-center";this.$.cecontextmenu.justifyValue="hax-align-center"}}else if(null===newValue){this.hideContextMenus();this.$.textcontextmenu.justifyIcon="editor:format-align-left";this.$.textcontextmenu.justifyValue="text-align-left"}},_getPosition:function _getPosition(element){var xPosition=element.offsetLeft-element.scrollLeft+element.clientLeft,yPosition=element.offsetTop-element.scrollTop+element.clientTop;return{x:xPosition,y:yPosition}},_positionContextMenu:function _positionContextMenu(menu,target,xoffset,yoffset){var _this10=this;if(null!=target){var pos=this._getPosition(target);if(null!=xoffset){menu.style.left=pos.x+xoffset+"px"}else{menu.style.left=pos.x+"px"}if(null!=yoffset){menu.style.top=pos.y+yoffset+"px"}else{menu.style.top=pos.y+"px"}}menu.classList.add("hax-context-visible");if(this.__activeHover){menu.classList.add("hax-active-hover");menu.style.marginLeft="";this.__typeLock=!1}setTimeout(function(){async.microTask.run(_this10._keepContextVisible())},100)},_hideContextMenu:function _hideContextMenu(menu){menu.classList.remove("hax-context-visible","hax-context-pin-top","hax-context-pin-bottom");menu.style.left="-100px"},_tabKeyPressed:function _tabKeyPressed(){var focus=!1,node=this.activeContainerNode,activeNodeTagName=this.activeContainerNode.tagName;try{var range=window.HaxStore.getRange().cloneRange(),tagTest=range.commonAncestorContainer.tagName;if(babelHelpers.typeof(tagTest)==="undefined"){tagTest=range.commonAncestorContainer.parentNode.tagName}if(["UL","OL","LI"].includes(activeNodeTagName)||["UL","OL","LI"].includes(tagTest)){if(this.polyfillSafe){document.execCommand("indent");this.__tabTrap=!0}}else{while(!focus){if(null==(0,_polymerDom.dom)(node).nextSibling){focus=!0}else if("function"===(0,_polymerDom.dom)(node).nextSibling.focus){(0,_polymerDom.dom)(node).nextSibling.focus();focus=!0}else{node=(0,_polymerDom.dom)(node).nextSibling}}}}catch(e){console.log(e)}},_tabBackKeyPressed:function _tabBackKeyPressed(){var node=this.activeContainerNode,activeNodeTagName=this.activeContainerNode.tagName;try{var range=window.HaxStore.getRange().cloneRange(),tagTest=range.commonAncestorContainer.tagName;if(babelHelpers.typeof(tagTest)==="undefined"){tagTest=range.commonAncestorContainer.parentNode.tagName}if(["UL","OL","LI"].includes(activeNodeTagName)||["UL","OL","LI"].includes(tagTest)){if(this.polyfillSafe){document.execCommand("outdent");this.__tabTrap=!0}}else{if(null!=node){while(null!=node&&!this._haxElementTest(node)){node=(0,_polymerDom.dom)(node).previousSibling}}if(null!=node){setTimeout(function(){node.focus()},50)}}}catch(e){console.log(e)}}});_exports.HaxBody=HaxBody});