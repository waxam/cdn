define(["meta","require","../../../@polymer/polymer/polymer-legacy.js","../../../@polymer/polymer/lib/legacy/polymer.dom.js","../../../@polymer/polymer/lib/utils/resolve-url.js","../../../@polymer/polymer/lib/utils/async.js","../../../@polymer/iron-ajax/iron-ajax.js"],function(meta,_require,_polymerLegacy,_polymerDom,_resolveUrl,async){"use strict";meta=babelHelpers.interopRequireWildcard(meta);_require=babelHelpers.interopRequireWildcard(_require);async=babelHelpers.interopRequireWildcard(async);var _Mathfloor=Math.floor;function _templateObject_e71f6ea0f80211e8896a0fdd3e86f213(){var data=babelHelpers.taggedTemplateLiteral(["\n    <style>\n      :host {\n        display: block;\n      }\n      :host #slot {\n        background-color: white;\n        opacity: 0.2;\n        transition: all 1s linear;\n        visibility: hidden;\n      }\n      :host([loading]) #slot {\n        opacity: 0.8;\n      }\n      :host([theme-loaded]) #slot {\n        opacity: 1;\n        visibility: visible;\n      }\n      paper-progress {\n        display: block;\n        width: 100%;\n        --paper-progress-active-color: rgba(255, 255, 255, 0.5);\n        --paper-progress-container-color: transparent;\n      }\n    </style>\n    <haxcms-editor-builder></haxcms-editor-builder>\n    <paper-progress\n      hidden$=\"[[!loading]]\"\n      value=\"100\"\n      indeterminate=\"\"\n      bottom-item=\"\"\n    ></paper-progress>\n    <app-location\n      route=\"{{route}}\"\n      query-params=\"{{queryParams}}\"\n    ></app-location>\n    <app-route\n      route=\"{{route}}\"\n      pattern=\":page\"\n      data=\"{{data}}\"\n      tail=\"{{tail}}\"\n      query-params=\"{{queryParams}}\"\n    >\n    </app-route>\n    <iron-ajax\n      id=\"manifest\"\n      url=\"[[outlineLocation]][[file]][[__timeStamp]]\"\n      handle-as=\"json\"\n      debounce-duration=\"250\"\n      last-response=\"{{manifest}}\"\n    ></iron-ajax>\n    <iron-ajax\n      id=\"activecontent\"\n      url=\"[[outlineLocation]][[activeItem.location]][[__timeStamp]]\"\n      handle-as=\"text\"\n      loading=\"{{loading}}\"\n      debounce-duration=\"250\"\n      last-response=\"{{_activeItemContent}}\"\n    ></iron-ajax>\n    <div id=\"slot\"><slot></slot></div>\n  "],["\n    <style>\n      :host {\n        display: block;\n      }\n      :host #slot {\n        background-color: white;\n        opacity: 0.2;\n        transition: all 1s linear;\n        visibility: hidden;\n      }\n      :host([loading]) #slot {\n        opacity: 0.8;\n      }\n      :host([theme-loaded]) #slot {\n        opacity: 1;\n        visibility: visible;\n      }\n      paper-progress {\n        display: block;\n        width: 100%;\n        --paper-progress-active-color: rgba(255, 255, 255, 0.5);\n        --paper-progress-container-color: transparent;\n      }\n    </style>\n    <haxcms-editor-builder></haxcms-editor-builder>\n    <paper-progress\n      hidden\\$=\"[[!loading]]\"\n      value=\"100\"\n      indeterminate=\"\"\n      bottom-item=\"\"\n    ></paper-progress>\n    <app-location\n      route=\"{{route}}\"\n      query-params=\"{{queryParams}}\"\n    ></app-location>\n    <app-route\n      route=\"{{route}}\"\n      pattern=\":page\"\n      data=\"{{data}}\"\n      tail=\"{{tail}}\"\n      query-params=\"{{queryParams}}\"\n    >\n    </app-route>\n    <iron-ajax\n      id=\"manifest\"\n      url=\"[[outlineLocation]][[file]][[__timeStamp]]\"\n      handle-as=\"json\"\n      debounce-duration=\"250\"\n      last-response=\"{{manifest}}\"\n    ></iron-ajax>\n    <iron-ajax\n      id=\"activecontent\"\n      url=\"[[outlineLocation]][[activeItem.location]][[__timeStamp]]\"\n      handle-as=\"text\"\n      loading=\"{{loading}}\"\n      debounce-duration=\"250\"\n      last-response=\"{{_activeItemContent}}\"\n    ></iron-ajax>\n    <div id=\"slot\"><slot></slot></div>\n  "]);_templateObject_e71f6ea0f80211e8896a0fdd3e86f213=function(){return data};return data}(0,_polymerLegacy.Polymer)({_template:(0,_polymerLegacy.html)(_templateObject_e71f6ea0f80211e8896a0fdd3e86f213()),is:"haxcms-site-builder",properties:{queryParams:{type:Object},loading:{type:Boolean,value:!1,reflectToAttribute:!0},outlineLocation:{type:String},manifest:{type:Object,notify:!0,observer:"_manifestChanged"},themeElementName:{type:String,reflectToAttribute:!0,observer:"_themeNameChanged"},themeElement:{type:Object},themeData:{type:Object,value:{"outline-player":"../../../@lrnwebcomponents/outline-player/outline-player.js","simple-blog":"../../../@lrnwebcomponents/simple-blog/simple-blog.js","haxcms-dev-theme":"haxcms-dev-theme.js"}},__imported:{type:Object,value:{}},themeLoaded:{type:Boolean,reflectToAttribute:!0,value:!1},activeItem:{type:Object,notify:!0,observer:"_activeItemChanged"},_activeItemContent:{type:String,observer:"_activeItemContentChanged"},file:{type:String,observer:"_fileChanged"}},created:function created(){document.body.addEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));document.body.addEventListener("haxcms-trigger-update-page",this._triggerUpdatedPage.bind(this));document.body.addEventListener("json-outline-schema-active-item-changed",this._setActiveItem.bind(this))},detached:function detached(){document.body.removeEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));document.body.removeEventListener("haxcms-trigger-update-page",this._triggerUpdatedPage.bind(this));document.body.removeEventListener("json-outline-schema-active-item-changed",this._setActiveItem.bind(this))},_setupActiveFromQuery:function _setupActiveFromQuery(){var _this=this;if(babelHelpers.typeof(this.queryParams.page)!=="undefined"&&babelHelpers.typeof(this.manifest.items)!=="undefined"){var find=this.manifest.items.filter(function(item){if(item.id!==_this.queryParams.page){return!1}return!0});if(0<find.length){var found=find.pop();if(babelHelpers.typeof(window.cmsSiteEditor)!=="undefined"){window.cmsSiteEditor.initialActiveItem=found}setTimeout(function(){_this.fire("haxcms-active-item-changed",found)},250)}}},_setActiveItem:function _setActiveItem(e){this.set("activeItem",e.detail);this.notifyPath("activeItem.*");this.set("queryParams.page",e.detail.id);this.notifyPath("queryParams.page")},_activeItemContentChanged:function _activeItemContentChanged(newValue){var _this2=this;if(newValue){if(null!==newValue){this.wipeSlot(this.themeElement,"*");newValue=this.encapScript(newValue);async.microTask.run(function(){var frag=document.createRange().createContextualFragment(newValue);(0,_polymerDom.dom)(_this2.themeElement).appendChild(frag)})}this.fire("json-outline-schema-active-body-changed",newValue)}},encapScript:function encapScript(html){html=html.replace(/<script[\s\S]*?>/gi,"&lt;script&gt;");html=html.replace(/<\/script>/gi,"&lt;/script&gt;");html=html.replace(/<style[\s\S]*?>/gi,"&lt;style&gt;");html=html.replace(/<\/style>/gi,"&lt;/style&gt;");html=html.replace(/<template[\s\S]*?>[\s\S]*?&lt;script[\s\S]*?&gt;[\s\S]*?&lt;\/script&gt;/gi,function(match){match=match.replace("&lt;script&gt;","<script>");match=match.replace("&lt;/script&gt;","</script>");match=match.replace("&lt;style&gt;","<style>");match=match.replace("&lt;/style&gt;","</style>");return match});return html},_activeItemChanged:function _activeItemChanged(newValue,oldValue){var _this3=this;if(babelHelpers.typeof(newValue.id)!=="undefined"){this.__timeStamp="?"+_Mathfloor(Date.now()/1e3);this.$.activecontent.generateRequest()}else if(babelHelpers.typeof(newValue.id)==="undefined"&&babelHelpers.typeof(oldValue.id)!=="undefined"){async.microTask.run(function(){_this3.wipeSlot(_this3.themeElement,"*")});this.fire("json-outline-schema-active-body-changed",null)}},_triggerUpdatedData:function _triggerUpdatedData(){this.__timeStamp="?"+_Mathfloor(Date.now()/1e3);this.$.manifest.generateRequest()},_triggerUpdatedPage:function _triggerUpdatedPage(){this.__timeStamp="?"+_Mathfloor(Date.now()/1e3);this.$.activecontent.generateRequest()},_fileChanged:function _fileChanged(newValue){if(babelHelpers.typeof(newValue)!=="undefined"){this.$.manifest.generateRequest()}},_manifestChanged:function _manifestChanged(newValue){if(babelHelpers.typeof(newValue)!=="undefined"&&null!=newValue&&babelHelpers.typeof(newValue.id)!=="undefined"){this.themeElementName=newValue.metadata.theme;if(babelHelpers.typeof(window.cmsSiteEditor)!=="undefined"){window.cmsSiteEditor.jsonOutlineSchema=newValue}this.fire("json-outline-schema-changed",newValue)}},_themeNameChanged:function _themeNameChanged(newValue,oldValue){var _this4=this;if(newValue&&oldValue){if(babelHelpers.typeof(window.cmsSiteEditor.instance.haxCmsSiteEditorElement)!=="undefined"){window.cmsSiteEditor.instance.appendChild(window.cmsSiteEditor.instance.haxCmsSiteEditorElement)}}if(newValue){this.themeLoaded=!1;var themeName=newValue;if(babelHelpers.typeof(this.themeData[themeName])==="undefined"){console.log("HAXCMS developer: "+themeName+" is not a valid theme name");this.themeElementName="simple-blog";return!1}this.wipeSlot(this,"*");this.themeElement=document.createElement(themeName);this.themeElement.manifest=this.manifest;if(babelHelpers.typeof(this.__imported[themeName])!=="undefined"){(0,_polymerDom.dom)(this).appendChild(this.themeElement);this.themeLoaded=!0}else{try{new Promise(function(res,rej){return _require.default([(0,_resolveUrl.pathFromUrl)(meta.url)+_this4.themeData[themeName]],res,rej)}).then(function(){(0,_polymerDom.dom)(_this4).appendChild(_this4.themeElement);_this4.__imported[themeName]=themeName;_this4.themeLoaded=!0})}catch(err){(0,_polymerDom.dom)(this).appendChild(this.themeElement);this.themeLoaded=!0}}this._setupActiveFromQuery()}},wipeSlot:function wipeSlot(element){var slot=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"*";if("*"===slot){while(null!==(0,_polymerDom.dom)(element).firstChild){(0,_polymerDom.dom)(element).removeChild((0,_polymerDom.dom)(element).firstChild)}}else{for(var i in(0,_polymerDom.dom)(element).childNodes){if(babelHelpers.typeof((0,_polymerDom.dom)(element).childNodes[i])!=="undefined"&&(0,_polymerDom.dom)(element).childNodes[i].slot===slot){(0,_polymerDom.dom)(element).removeChild((0,_polymerDom.dom)(element).childNodes[i])}}}}})});