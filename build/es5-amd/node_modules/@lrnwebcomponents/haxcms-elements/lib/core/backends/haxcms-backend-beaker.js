define(["exports","meta","require","../../../../../@polymer/polymer/polymer-element.js","../../../../beaker-broker/beaker-broker.js","../../../../../@polymer/polymer/lib/utils/resolve-url.js"],function(_exports,meta,_require,_polymerElement,_beakerBroker,_resolveUrl){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.HAXCMSBackendBeaker=void 0;meta=babelHelpers.interopRequireWildcard(meta);_require=babelHelpers.interopRequireWildcard(_require);function _templateObject_f2a2e0a054c211e99540492d34b1bf39(){var data=babelHelpers.taggedTemplateLiteral(["\n      <beaker-broker id=\"beaker\"></beaker-broker>\n    "]);_templateObject_f2a2e0a054c211e99540492d34b1bf39=function(){return data};return data}var HAXCMSBackendBeaker=function(_PolymerElement){var _Mathfloor=Math.floor;babelHelpers.inherits(HAXCMSBackendBeaker,_PolymerElement);babelHelpers.createClass(HAXCMSBackendBeaker,null,[{key:"tag",get:function get(){return"haxcms-backend-beaker"}},{key:"template",get:function get(){return(0,_polymerElement.html)(_templateObject_f2a2e0a054c211e99540492d34b1bf39())}},{key:"properties",get:function get(){return{jwt:{type:String},manifest:{type:Object},activeItem:{type:Object}}}}]);function HAXCMSBackendBeaker(){var _this;babelHelpers.classCallCheck(this,HAXCMSBackendBeaker);_this=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(HAXCMSBackendBeaker).call(this));afterNextRender(babelHelpers.assertThisInitialized(babelHelpers.assertThisInitialized(_this)),function(){document.body.addEventListener("jwt-token",this._jwtTokenFired.bind(this));document.body.addEventListener("haxcms-save-site-data",this.saveManifest.bind(this));document.body.addEventListener("haxcms-save-outline",this.saveOutline.bind(this));document.body.addEventListener("haxcms-save-node",this.saveNode.bind(this));document.body.addEventListener("haxcms-delete-node",this.deleteNode.bind(this));document.body.addEventListener("haxcms-create-node",this.createNode.bind(this));document.body.addEventListener("hax-app-picker-selection",this._appPicked.bind(this))});return _this}babelHelpers.createClass(HAXCMSBackendBeaker,[{key:"disconnectedCallback",value:function disconnectedCallback(){document.body.removeEventListener("jwt-token",this._jwtTokenFired.bind(this));document.body.removeEventListener("haxcms-save-site-data",this.saveManifest.bind(this));document.body.removeEventListener("haxcms-save-outline",this.saveOutline.bind(this));document.body.removeEventListener("haxcms-save-node",this.saveNode.bind(this));document.body.removeEventListener("haxcms-delete-node",this.deleteNode.bind(this));document.body.removeEventListener("haxcms-create-node",this.createNode.bind(this));document.body.removeEventListener("hax-app-picker-selection",this._appPicked.bind(this));babelHelpers.get(babelHelpers.getPrototypeOf(HAXCMSBackendBeaker.prototype),"disconnectedCallback",this).call(this)}},{key:"_appPicked",value:function _appPicked(e){var _this2=this;if("dat"===e.detail.connection.protocol){e.preventDefault();e.stopPropagation();var reader=new FileReader;reader.onload=function(event){var fileLocation="files/"+window.HaxStore.instance.haxManager.$.fileupload.files[0].name;_this2.$.beaker.write(fileLocation,event.target.result);window.HaxStore.instance.haxManager.$.url.value=fileLocation;window.HaxStore.instance.haxManager.newAssetConfigure()};reader.readAsArrayBuffer(window.HaxStore.instance.haxManager.$.fileupload.files[0])}}},{key:"saveNode",value:function(){var _saveNode=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee(e){var evt;return regeneratorRuntime.wrap(function(_context){while(1){switch(_context.prev=_context.next){case 0:this.activeItem=e.detail;_context.next=3;return this.$.beaker.write(this.activeItem.location,window.HaxStore.instance.activeHaxBody.haxToContent());case 3:window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("Page updated!");evt=new CustomEvent("haxcms-trigger-update-node",{bubbles:!0,composed:!0,cancelable:!1,detail:!0});window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(evt);case 6:case"end":return _context.stop();}}},_callee,this)}));return function saveNode(){return _saveNode.apply(this,arguments)}}()},{key:"saveOutline",value:function(){var _saveOutline=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee2(e){var _this3=this;return regeneratorRuntime.wrap(function(_context2){while(1){switch(_context2.prev=_context2.next){case 0:this.manifest=window.cmsSiteEditor.instance.haxCmsSiteEditorElement.manifest;this.manifest.items=e.detail;this.manifest.items.forEach(function(element,index){if(babelHelpers.typeof(element.location)==="undefined"){var id=_this3.generateResourceID("item-");element.id=id;element.location="pages/"+id+"/index.html";element.order=index;element.description="";element.metadata={created:_Mathfloor(Date.now()/1e3),updated:_Mathfloor(Date.now()/1e3)};_this3.$.beaker.archive.mkdir("pages/"+id);_this3.$.beaker.write("pages/"+id+"/index.html","<p>Ex uno Plures</p>");_this3.manifest.items[index]=element}});this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("Outline saved!");window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}));case 7:case"end":return _context2.stop();}}},_callee2,this)}));return function saveOutline(){return _saveOutline.apply(this,arguments)}}()},{key:"deleteNode",value:function(){var _deleteNode=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee3(e){var _this4=this,page;return regeneratorRuntime.wrap(function(_context3){while(1){switch(_context3.prev=_context3.next){case 0:page=e.detail.item;this.manifest=window.cmsSiteEditor.instance.haxCmsSiteEditorElement.manifest;this.manifest.items=e.detail;this.manifest.items.forEach(function(element,index){if(element.id===page.id){_this4.splice("manifest.items",index,1)}});this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("".concat(page.title," deleted"));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}));case 8:case"end":return _context3.stop();}}},_callee3,this)}));return function deleteNode(){return _deleteNode.apply(this,arguments)}}()},{key:"createNode",value:function(){var _createNode=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee4(e){var _this5=this,page;return regeneratorRuntime.wrap(function(_context4){while(1){switch(_context4.prev=_context4.next){case 0:page=e.detail.values;this.manifest=window.cmsSiteEditor.instance.haxCmsSiteEditorElement.manifest;this.manifest.items=e.detail;this.manifest.items.forEach(function(element,index){if(babelHelpers.typeof(element.location)==="undefined"){if(!page.id){page.id=_this5.generateResourceID("item-")}if(!page.location){page.location="pages/"+page.id+"/index.html"}var directory=page.location.replace("/index.html","");element.id=page.id;element.location=page.location;element.order=page.order;element.indent=page.indent;element.parent=page.parent;element.description=page.description;element.metadata.created=_Mathfloor(Date.now()/1e3);element.metadata.updated=_Mathfloor(Date.now()/1e3);_this5.$.beaker.archive.mkdir(directory);_this5.$.beaker.write(page.location,"<p>My great new content!</p>");_this5.set("manifest.items.".concat(index),element)}});this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("".concat(page.title," created!"));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}));case 8:case"end":return _context4.stop();}}},_callee4,this)}));return function createNode(){return _createNode.apply(this,arguments)}}()},{key:"saveManifest",value:function(){var _saveManifest=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee5(e){var themeData;return regeneratorRuntime.wrap(function(_context5){while(1){switch(_context5.prev=_context5.next){case 0:this.manifest=e.detail;if("string"===typeof this.manifest.metadata.theme){themeData={"haxcms-dev-theme":{element:"haxcms-dev-theme",path:"@lrnwebcomponents/haxcms-elements/lib/haxcms-dev-theme.js",name:"Developer theme"},"outline-player":{element:"outline-player",path:"@lrnwebcomponents/outline-player/outline-player.js",name:"Outline player"},"simple-blog":{element:"simple-blog",path:"@lrnwebcomponents/simple-blog/simple-blog.js",name:"Simple blog"}};if(themeData[this.manifest.metadata.theme]){this.manifest.metadata.theme=themeData[this.manifest.metadata.theme]}}_context5.next=4;return this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));case 4:window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("Site details saved!");window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}));case 7:case"end":return _context5.stop();}}},_callee5,this)}));return function saveManifest(){return _saveManifest.apply(this,arguments)}}()},{key:"_jwtTokenFired",value:function _jwtTokenFired(e){this.jwt=e.detail}},{key:"generateResourceID",value:function generateResourceID(){var base=0<arguments.length&&arguments[0]!==void 0?arguments[0]:"";function idPart(){return _Mathfloor(65536*(1+Math.random())).toString(16).substring(1)}return base+idPart()+idPart()+"-"+idPart()+"-"+idPart()+"-"+idPart()+"-"+idPart()+idPart()+idPart()}},{key:"connectedCallback",value:function(){var _connectedCallback=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function _callee6(){var _this6=this,beaker,info,appstore;return regeneratorRuntime.wrap(function(_context6){while(1){switch(_context6.prev=_context6.next){case 0:babelHelpers.get(babelHelpers.getPrototypeOf(HAXCMSBackendBeaker.prototype),"connectedCallback",this).call(this);beaker=this.$.beaker;this.jwt=beaker.archive.url;_context6.next=5;return beaker.archive.getInfo();case 5:info=_context6.sent;if(!(null!=this.jwt&&"string"==typeof this.jwt&&info.isOwner)){_context6.next=13;break}_context6.t0=JSON;_context6.next=10;return beaker.read("appstore.json");case 10:_context6.t1=_context6.sent;appstore=_context6.t0.parse.call(_context6.t0,_context6.t1);try{new Promise(function(res,rej){return _require.default([(0,_resolveUrl.pathFromUrl)(decodeURIComponent(meta.url))+"../haxcms-site-editor.js"],res,rej)}).then(function(){var haxCmsSiteEditorElement=document.createElement("haxcms-site-editor");haxCmsSiteEditorElement.jwt=_this6.jwt;haxCmsSiteEditorElement.appStore=appstore;window.cmsSiteEditor.instance.haxCmsSiteEditorElement=haxCmsSiteEditorElement;window.cmsSiteEditor.instance.appendTarget.appendChild(haxCmsSiteEditorElement)},function(){})}catch(err){}case 13:case"end":return _context6.stop();}}},_callee6,this)}));return function connectedCallback(){return _connectedCallback.apply(this,arguments)}}()}]);return HAXCMSBackendBeaker}(_polymerElement.PolymerElement);_exports.HAXCMSBackendBeaker=HAXCMSBackendBeaker;window.customElements.define(HAXCMSBackendBeaker.tag,HAXCMSBackendBeaker)});