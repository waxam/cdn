define(["exports","../../../../@polymer/polymer/polymer-element.js","../../../../@polymer/polymer/lib/utils/async.js","./haxcms-site-store.js","../../../../mobx/lib/mobx.module.js","../../../../@polymer/polymer/lib/utils/render-status.js","../../../hax-body-behaviors/lib/HAXWiring.js","../../../../@polymer/paper-fab/paper-fab.js","../../../../@polymer/paper-tooltip/paper-tooltip.js","../../../../@polymer/paper-button/paper-button.js","../../../../@polymer/iron-ajax/iron-ajax.js","../../../../@polymer/iron-icons/editor-icons.js","../../../jwt-login/jwt-login.js","../../../h-a-x/h-a-x.js","../../../simple-toast/simple-toast.js","../../../simple-modal/simple-modal.js","../../../hax-body/lib/hax-schema-form.js"],function(_exports,_polymerElement,_async,_haxcmsSiteStore,_mobxModule,_renderStatus,_HAXWiring){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.HAXCMSSiteEditor=void 0;function _templateObject_33cf248054c311e99540492d34b1bf39(){var data=babelHelpers.taggedTemplateLiteral(["\n      <style>\n        :host {\n          display: block;\n        }\n        #editbutton {\n          position: fixed;\n          bottom: 0;\n          right: 0;\n          margin: 16px;\n          padding: 2px;\n          width: 40px;\n          height: 40px;\n          visibility: visible;\n          opacity: 1;\n          transition: all 0.4s ease;\n          z-index: 1000;\n        }\n        #outlinebutton {\n          position: fixed;\n          bottom: 0;\n          right: 46px;\n          margin: 16px;\n          padding: 2px;\n          width: 40px;\n          height: 40px;\n          visibility: visible;\n          opacity: 1;\n          transition: all 0.4s ease;\n          z-index: 1000;\n        }\n        :host([edit-mode]) #editbutton {\n          width: 100%;\n          z-index: 100;\n          right: 0;\n          bottom: 0;\n          border-radius: 0;\n          height: 80px;\n          margin: 0;\n          padding: 8px;\n          background-color: var(--paper-blue-500) !important;\n        }\n        h-a-x {\n          padding: 80px 40px;\n          margin: auto;\n          display: none;\n        }\n        :host([edit-mode]) h-a-x {\n          display: block;\n        }\n      </style>\n      <iron-ajax\n        headers='{\"Authorization\": \"Bearer [[jwt]]\"}'\n        id=\"nodeupdateajax\"\n        url=\"[[saveNodePath]]\"\n        method=\"[[method]]\"\n        body=\"[[updateNodeData]]\"\n        content-type=\"application/json\"\n        handle-as=\"json\"\n        on-response=\"_handleNodeResponse\"\n      ></iron-ajax>\n      <iron-ajax\n        headers='{\"Authorization\": \"Bearer [[jwt]]\"}'\n        id=\"outlineupdateajax\"\n        url=\"[[saveOutlinePath]]\"\n        method=\"[[method]]\"\n        body=\"[[updateOutlineData]]\"\n        content-type=\"application/json\"\n        handle-as=\"json\"\n        on-response=\"_handleOutlineResponse\"\n      ></iron-ajax>\n      <iron-ajax\n        headers='{\"Authorization\": \"Bearer [[jwt]]\"}'\n        id=\"getfieldsajax\"\n        url=\"[[getNodeFieldsPath]]\"\n        method=\"[[method]]\"\n        body=\"[[getFieldsData]]\"\n        content-type=\"application/json\"\n        handle-as=\"json\"\n        on-response=\"_handleGetFieldsResponse\"\n      ></iron-ajax>\n      <iron-ajax\n        headers='{\"Authorization\": \"Bearer [[jwt]]\"}'\n        id=\"manifestupdateajax\"\n        url=\"[[saveManifestPath]]\"\n        method=\"[[method]]\"\n        body=\"[[updateManifestData]]\"\n        content-type=\"application/json\"\n        handle-as=\"json\"\n        on-response=\"_handleManifestResponse\"\n      ></iron-ajax>\n      <iron-ajax\n        headers='{\"Authorization\": \"Bearer [[jwt]]\"}'\n        id=\"publishajax\"\n        loading=\"{{publishing}}\"\n        url=\"[[publishSitePath]]\"\n        method=\"[[method]]\"\n        body=\"[[publishSiteData]]\"\n        content-type=\"application/json\"\n        handle-as=\"json\"\n        on-response=\"_handlePublishResponse\"\n      ></iron-ajax>\n      <iron-ajax\n        headers='{\"Authorization\": \"Bearer [[jwt]]\"}'\n        id=\"createajax\"\n        url=\"[[createNodePath]]\"\n        method=\"[[method]]\"\n        body=\"[[createData]]\"\n        content-type=\"application/json\"\n        handle-as=\"json\"\n        on-response=\"_handleCreateResponse\"\n        last-response=\"{{__createNodeResponse}}\"\n      ></iron-ajax>\n      <iron-ajax\n        headers='{\"Authorization\": \"Bearer [[jwt]]\"}'\n        id=\"deleteajax\"\n        url=\"[[deleteNodePath]]\"\n        method=\"[[method]]\"\n        body=\"[[deleteData]]\"\n        content-type=\"application/json\"\n        handle-as=\"json\"\n        on-response=\"_handleDeleteResponse\"\n        last-response=\"{{__deleteNodeResponse}}\"\n      ></iron-ajax>\n      <h-a-x app-store$=\"[[appStore]]\"></h-a-x>\n    "]);_templateObject_33cf248054c311e99540492d34b1bf39=function(){return data};return data}var HAXCMSSiteEditor=function(_PolymerElement){babelHelpers.inherits(HAXCMSSiteEditor,_PolymerElement);function HAXCMSSiteEditor(){babelHelpers.classCallCheck(this,HAXCMSSiteEditor);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(HAXCMSSiteEditor).apply(this,arguments))}babelHelpers.createClass(HAXCMSSiteEditor,[{key:"_attachDom",value:function _attachDom(dom){this.appendChild(dom)}},{key:"ready",value:function ready(){babelHelpers.get(babelHelpers.getPrototypeOf(HAXCMSSiteEditor.prototype),"ready",this).call(this);this.__disposer=[];(0,_renderStatus.afterNextRender)(this,function(){var _this=this;(0,_mobxModule.autorun)(function(reaction){_this.manifest=(0,_mobxModule.toJS)(_haxcmsSiteStore.store.manifest);_this.__disposer.push(reaction)});(0,_mobxModule.autorun)(function(reaction){_this.activeItem=(0,_mobxModule.toJS)(_haxcmsSiteStore.store.activeItem);_this.__disposer.push(reaction)});window.SimpleToast.requestAvailability();window.SimpleModal.requestAvailability();window.addEventListener("hax-store-ready",this._storeReadyToGo.bind(this));window.addEventListener("json-outline-schema-active-item-changed",this._newActiveItem.bind(this));window.addEventListener("json-outline-schema-active-body-changed",this._bodyChanged.bind(this));window.addEventListener("haxcms-save-outline",this.saveOutline.bind(this));window.addEventListener("haxcms-save-node",this.saveNode.bind(this));window.addEventListener("haxcms-save-node-details",this.saveNodeDetails.bind(this));window.addEventListener("haxcms-save-site-data",this.saveManifest.bind(this));window.addEventListener("haxcms-load-node-fields",this.loadNodeFields.bind(this));window.addEventListener("haxcms-create-node",this.createNode.bind(this));window.addEventListener("haxcms-delete-node",this.deleteNode.bind(this));window.addEventListener("haxcms-publish-site",this.publishSite.bind(this));_async.microTask.run(function(){_this.updateStyles();if(window.HaxStore.ready){_this._storeReadyToGo({detail:!0})}});var evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"You are logged in, edit tools shown."}});window.dispatchEvent(evt)})}},{key:"disconnectedCallback",value:function disconnectedCallback(){for(var i in this.__disposer){this.__disposer[i].dispose()}window.removeEventListener("hax-store-ready",this._storeReadyToGo.bind(this));window.removeEventListener("haxcms-save-outline",this.saveOutline.bind(this));window.removeEventListener("haxcms-save-node",this.saveNode.bind(this));window.removeEventListener("haxcms-save-node-details",this.saveNodeDetails.bind(this));window.removeEventListener("haxcms-save-site-data",this.saveManifest.bind(this));window.removeEventListener("haxcms-publish-site",this.publishSite.bind(this));window.removeEventListener("json-outline-schema-active-item-changed",this._newActiveItem.bind(this));window.removeEventListener("json-outline-schema-active-body-changed",this._bodyChanged.bind(this));window.removeEventListener("haxcms-load-node-fields",this.loadNodeFields.bind(this));window.removeEventListener("haxcms-create-node",this.createNode.bind(this));window.removeEventListener("haxcms-delete-node",this.deleteNode.bind(this));babelHelpers.get(babelHelpers.getPrototypeOf(HAXCMSSiteEditor.prototype),"disconnectedCallback",this).call(this)}},{key:"loadNodeFields",value:function loadNodeFields(e){this.__nodeFieldsInvoked=e.detail;this.set("getFieldsData.jwt",this.jwt);this.notifyPath("getFieldsData.jwt");this.set("getFieldsData.token",this.getFieldsToken);this.notifyPath("getFieldsData.token");this.set("getFieldsData.siteName",this.manifest.metadata.siteName);this.notifyPath("getFieldsData.siteName");this.set("getFieldsData.nodeId",this.activeItem.id);this.notifyPath("getFieldsData.nodeId");this.$.getfieldsajax.generateRequest()}},{key:"_handleGetFieldsResponse",value:function _handleGetFieldsResponse(e){var wiring=new _HAXWiring.HAXWiring;this._haxSchema=wiring.prototypeHaxProperties();this._haxSchema.settings=e.detail.response.haxSchema;var values=e.detail.response.values,c=document.createElement("hax-schema-form");c.style.minWidth="50vw";for(var key in this._haxSchema.settings){var schema=wiring.getHaxJSONSchema(key,this._haxSchema);for(var i in schema.properties){if(values[i]){schema.properties[i].value=values[i]}}c.set(key+"Schema",schema)}this.__fieldsForm=c;var b1=document.createElement("paper-button");b1.raised=!0;var icon=document.createElement("iron-icon");icon.icon="icons:save";b1.appendChild(icon);b1.appendChild(document.createTextNode("Save fields"));b1.setAttribute("dialog-confirm","dialog-confirm");b1.addEventListener("click",this._saveFieldsTap.bind(this));var b2=document.createElement("paper-button");b2.appendChild(document.createTextNode("cancel"));b2.setAttribute("dialog-dismiss","dialog-dismiss");var b=document.createElement("div");b.style.position="absolute";b.style.bottom=0;b.style.left=0;b.style.right=0;b.style.zIndex=1e6;b.style.backgroundColor="#ddd";b.appendChild(b1);b.appendChild(b2);var evt=new CustomEvent("simple-modal-show",{bubbles:!0,composed:!0,cancelable:!1,detail:{title:"Edit "+_haxcmsSiteStore.store.activeTitle+" fields",elements:{content:c,buttons:b},invokedBy:this.__nodeFieldsInvoked,clone:!1}});window.dispatchEvent(evt)}},{key:"_saveFieldsTap",value:function _saveFieldsTap(){var values=this.__fieldsForm.value;values.id=this.activeItem.id;window.dispatchEvent(new CustomEvent("haxcms-save-node-details",{bubbles:!0,composed:!0,cancelable:!0,detail:values}));window.dispatchEvent(new CustomEvent("simple-modal-hide",{bubbles:!0,composed:!0,cancelable:!0,detail:{}}))}},{key:"createNode",value:function createNode(e){if(e.detail.values){this.set("createData",{});this.set("createData",e.detail.values);this.notifyPath("createData.*");this.set("createData.siteName",this.manifest.metadata.siteName);this.notifyPath("createData.siteName");this.set("createData.jwt",this.jwt);this.notifyPath("createData.jwt");this.$.createajax.generateRequest();var evt=new CustomEvent("simple-modal-hide",{bubbles:!0,composed:!0,cancelable:!0,detail:{}});window.dispatchEvent(evt)}}},{key:"_handleCreateResponse",value:function _handleCreateResponse(){var evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Created ".concat(this.__createNodeResponse.title,"!"),duration:3e3}});window.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}},{key:"deleteNode",value:function deleteNode(e){this.set("deleteData",{});this.set("deleteData.nodeId",e.detail.item.id);this.notifyPath("deleteData.nodeId");this.set("deleteData.siteName",this.manifest.metadata.siteName);this.notifyPath("deleteData.siteName");this.set("deleteData.jwt",this.jwt);this.notifyPath("deleteData.jwt");this.$.deleteajax.generateRequest();var evt=new CustomEvent("simple-modal-hide",{bubbles:!0,composed:!0,cancelable:!0,detail:{}});window.dispatchEvent(evt)}},{key:"_handleDeleteResponse",value:function _handleDeleteResponse(){var evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Deleted ".concat(this.__deleteNodeResponse.title),duration:3e3}});this.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}},{key:"_storeReadyToGo",value:function _storeReadyToGo(event){if(event.detail){window.HaxStore.instance.connectionRewrites.appendJwt="jwt";window.HaxStore.instance.haxPanel.align="left";window.HaxStore.instance.haxPanel.hidePanelOps=!0}}},{key:"_publishingChanged",value:function _publishingChanged(newValue,oldValue){if(newValue){var evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Publishing...",duration:0}});window.dispatchEvent(evt)}else if(!newValue&&oldValue){var _evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Publishing...",duration:3e3}});window.dispatchEvent(_evt)}}},{key:"_manifestChanged",value:function _manifestChanged(newValue){if(this.activeItem&&newValue.metadata){window.HaxStore.instance.connectionRewrites.appendUploadEndPoint="siteName="+newValue.metadata.siteName+"&nodeId="+this.activeItem.id}}},{key:"_newActiveItem",value:function _newActiveItem(e){this.set("activeItem",e.detail);this.notifyPath("activeItem.*")}},{key:"_activeItemChanged",value:function _activeItemChanged(newValue){if(newValue&&this.manifest){window.HaxStore.instance.connectionRewrites.appendUploadEndPoint="siteName="+this.manifest.metadata.siteName+"&nodeId="+newValue.id}}},{key:"_handleNodeResponse",value:function _handleNodeResponse(e){if("undefined"!==typeof e.detail.location&&this.activeItem.location!==e.detail.location){window.location(e.detail.location);window.history.pushState({},null,e.detail.location);window.dispatchEvent(new PopStateEvent("popstate"));var active=this.manifest.items.find(function(i){return i.id===e.detail.id});this.activeItem=active;this.dispatchEvent(new CustomEvent("json-outline-schema-active-item-changed",{bubbles:!0,composed:!0,cancelable:!0,detail:active}))}var evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Page saved!",duration:4e3}});window.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));this.dispatchEvent(new CustomEvent("haxcms-trigger-update-node",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}},{key:"_handleOutlineResponse",value:function _handleOutlineResponse(){var evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Outline saved!",duration:3e3}});window.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}},{key:"_handleManifestResponse",value:function _handleManifestResponse(){var evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Site details saved!",duration:3e3}});this.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}},{key:"_handlePublishResponse",value:function _handlePublishResponse(e){var data=e.detail.response,content=document.createElement("span");content.innerHTML="\n    <a href=\"".concat(data.url,"\" target=\"_blank\">\n      <paper-button raised style=\"color:yellow;text-transform: none;font-weight: bold;\">\n      ").concat(data.label,"\n      </paper-button>\n    </a>");var evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:data.response,duration:1e4,slot:content.cloneNode(!0)}});window.dispatchEvent(evt)}},{key:"saveNode",value:function saveNode(){this.set("updateNodeData",{});this.set("updateNodeData.siteName",this.manifest.metadata.siteName);this.notifyPath("updateNodeData.siteName");this.set("updateNodeData.body",window.HaxStore.instance.activeHaxBody.haxToContent());this.notifyPath("updateNodeData.body");this.set("updateNodeData.nodeId",this.activeItem.id);this.notifyPath("updateNodeData.nodeId");this.set("updateNodeData.jwt",this.jwt);this.notifyPath("updateNodeData.jwt");if(this.saveNodePath){this.$.nodeupdateajax.generateRequest()}}},{key:"saveNodeDetails",value:function saveNodeDetails(e){this.set("updateNodeData",{});this.set("updateNodeData.siteName",this.manifest.metadata.siteName);this.notifyPath("updateNodeData.siteName");this.set("updateNodeData.nodeId",e.detail.id);this.notifyPath("updateNodeData.nodeId");this.set("updateNodeData.details",e.detail);this.notifyPath("updateNodeData.details");this.set("updateNodeData.jwt",this.jwt);this.notifyPath("updateNodeData.jwt");if(this.saveNodePath){this.$.nodeupdateajax.generateRequest()}}},{key:"saveOutline",value:function saveOutline(e){this.set("updateOutlineData.siteName",this.manifest.metadata.siteName);this.notifyPath("updateOutlineData.siteName");this.set("updateOutlineData.items",e.detail);this.notifyPath("updateOutlineData.items");this.set("updateOutlineData.jwt",this.jwt);this.notifyPath("updateOutlineData.jwt");if(this.saveOutlinePath){this.$.outlineupdateajax.generateRequest()}}},{key:"saveManifest",value:function saveManifest(e){this.set("updateManifestData.siteName",this.manifest.metadata.siteName);this.notifyPath("updateManifestData.siteName");this.set("updateManifestData.manifest",e.detail);this.notifyPath("updateManifestData.manifest");this.set("updateManifestData.jwt",this.jwt);this.notifyPath("updateManifestData.jwt");if(this.saveManifestPath){this.$.manifestupdateajax.generateRequest()}}},{key:"publishSite",value:function publishSite(){this.set("publishSiteData.siteName",this.manifest.metadata.siteName);this.notifyPath("publishSiteData.siteName");this.set("publishSiteData.jwt",this.jwt);this.notifyPath("publishSiteData.jwt");if(this.publishSitePath){this.$.publishajax.generateRequest()}}},{key:"_bodyChanged",value:function _bodyChanged(e){window.HaxStore.instance.activeHaxBody.importContent(e.detail)}}],[{key:"tag",get:function get(){return"haxcms-site-editor"}},{key:"template",get:function get(){return(0,_polymerElement.html)(_templateObject_33cf248054c311e99540492d34b1bf39())}},{key:"properties",get:function get(){var _ref;return _ref={method:{type:String,value:"POST"},jwt:{type:String},saveNodePath:{type:String},createNodePath:{type:String},deleteNodePath:{type:String},saveManifestPath:{type:String},publishSitePath:{type:String},publishing:{type:Boolean,observer:"_publishingChanged"},saveOutlinePath:{type:String},appStore:{type:Object},editMode:{type:Boolean,reflectToAttribute:!0,value:!1},updateNodeData:{type:Object,value:{}},deleteData:{type:Object,value:{}},createData:{type:Object,value:{}},publishSiteData:{type:Object,value:{}},updateManifestData:{type:Object,value:{}},updateOutlineData:{type:Object,value:{}}},babelHelpers.defineProperty(_ref,"updateManifestData",{type:Object,value:{}}),babelHelpers.defineProperty(_ref,"getFieldsData",{type:Object,value:{}}),babelHelpers.defineProperty(_ref,"activeItem",{type:Object,notify:!0,observer:"_activeItemChanged"}),babelHelpers.defineProperty(_ref,"manifest",{type:Object,notify:!0,observer:"_manifestChanged"}),babelHelpers.defineProperty(_ref,"getNodeFieldsPath",{type:String}),babelHelpers.defineProperty(_ref,"getFieldsToken",{type:String}),_ref}}]);return HAXCMSSiteEditor}(_polymerElement.PolymerElement);_exports.HAXCMSSiteEditor=HAXCMSSiteEditor;window.customElements.define(HAXCMSSiteEditor.tag,HAXCMSSiteEditor)});