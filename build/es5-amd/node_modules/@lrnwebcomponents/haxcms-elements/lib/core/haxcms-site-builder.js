define(["exports","meta","require","../../../../@polymer/polymer/polymer-legacy.js","../../../../@polymer/polymer/lib/utils/settings.js","../../../../@polymer/polymer/lib/mixins/element-mixin.js","../../../../@polymer/polymer/lib/legacy/polymer.dom.js","../../../../@polymer/polymer/lib/utils/resolve-url.js","../../../../@polymer/polymer/lib/utils/async.js","../../../json-outline-schema/json-outline-schema.js","../../../simple-toast/simple-toast.js","../../../simple-modal/simple-modal.js","../../../../@polymer/iron-ajax/iron-ajax.js","../../../../@polymer/paper-progress/paper-progress.js","../../../../mobx/lib/mobx.module.js","./haxcms-site-store.js","./haxcms-site-router.js","./haxcms-editor-builder.js"],function(_exports,meta,_require,_polymerLegacy,_settings,_elementMixin,_polymerDom,_resolveUrl,async,_jsonOutlineSchema,_simpleToast,_simpleModal,_ironAjax,_paperProgress,_mobxModule,_haxcmsSiteStore){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.HAXCMSSiteBuilder=void 0;meta=babelHelpers.interopRequireWildcard(meta);_require=babelHelpers.interopRequireWildcard(_require);async=babelHelpers.interopRequireWildcard(async);var _Mathfloor=Math.floor;function _templateObject_3dd58110490411e990ee3fd35bb8725b(){var data=babelHelpers.taggedTemplateLiteral(["\n    <style>\n      :host {\n        display: block;\n      }\n      :host #slot {\n        transition: all 0.2s ease-in-out;\n        background-color: var(--haxcms-color, white);\n        opacity: 0.2;\n        visibility: hidden;\n      }\n      :host([theme-loaded]) #slot {\n        opacity: 1;\n        visibility: visible;\n      }\n      paper-progress {\n        display: block;\n        width: 100%;\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        background-color: transparent;\n        z-index: 1000;\n        --paper-progress-active-color: var(\n          --haxcms-color,\n          rgba(255, 255, 255, 0.5)\n        );\n        --paper-progress-container-color: transparent;\n      }\n    </style>\n    <haxcms-site-router base-uri=\"[[baseURI]]\"></haxcms-site-router>\n    <paper-progress hidden$=\"[[!loading]]\" indeterminate></paper-progress>\n    <iron-ajax\n      id=\"manifest\"\n      url=\"[[outlineLocation]][[file]][[__timeStamp]]\"\n      handle-as=\"json\"\n      debounce-duration=\"250\"\n      last-response=\"{{manifest}}\"\n    ></iron-ajax>\n    <iron-ajax\n      id=\"activecontent\"\n      url=\"[[outlineLocation]][[activeItem.location]][[__timeStamp]]\"\n      handle-as=\"text\"\n      loading=\"{{loading}}\"\n      debounce-duration=\"250\"\n      last-response=\"{{activeItemContent}}\"\n    ></iron-ajax>\n    <div id=\"slot\"><slot></slot></div>\n  "],["\n    <style>\n      :host {\n        display: block;\n      }\n      :host #slot {\n        transition: all 0.2s ease-in-out;\n        background-color: var(--haxcms-color, white);\n        opacity: 0.2;\n        visibility: hidden;\n      }\n      :host([theme-loaded]) #slot {\n        opacity: 1;\n        visibility: visible;\n      }\n      paper-progress {\n        display: block;\n        width: 100%;\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        background-color: transparent;\n        z-index: 1000;\n        --paper-progress-active-color: var(\n          --haxcms-color,\n          rgba(255, 255, 255, 0.5)\n        );\n        --paper-progress-container-color: transparent;\n      }\n    </style>\n    <haxcms-site-router base-uri=\"[[baseURI]]\"></haxcms-site-router>\n    <paper-progress hidden\\$=\"[[!loading]]\" indeterminate></paper-progress>\n    <iron-ajax\n      id=\"manifest\"\n      url=\"[[outlineLocation]][[file]][[__timeStamp]]\"\n      handle-as=\"json\"\n      debounce-duration=\"250\"\n      last-response=\"{{manifest}}\"\n    ></iron-ajax>\n    <iron-ajax\n      id=\"activecontent\"\n      url=\"[[outlineLocation]][[activeItem.location]][[__timeStamp]]\"\n      handle-as=\"text\"\n      loading=\"{{loading}}\"\n      debounce-duration=\"250\"\n      last-response=\"{{activeItemContent}}\"\n    ></iron-ajax>\n    <div id=\"slot\"><slot></slot></div>\n  "]);_templateObject_3dd58110490411e990ee3fd35bb8725b=function(){return data};return data}var HAXCMSSiteBuilder=(0,_polymerLegacy.Polymer)({_template:(0,_polymerLegacy.html)(_templateObject_3dd58110490411e990ee3fd35bb8725b()),is:"haxcms-site-builder",properties:{queryParams:{type:Object},loading:{type:Boolean,value:!1,reflectToAttribute:!0},outlineLocation:{type:String,notify:!0,reflectToAttribute:!0},manifest:{type:Object,notify:!0,observer:"_manifestChanged"},themeData:{type:Object,observer:"_themeChanged"},themeElement:{type:Object},__imported:{type:Object,value:{}},themeLoaded:{type:Boolean,reflectToAttribute:!0,value:!1},activeItem:{type:Object,notify:!0,observer:"_activeItemChanged"},activeItemContent:{type:String,notify:!0,observer:"_activeItemContentChanged"},file:{type:String,observer:"_fileChanged"},baseURI:{type:String}},created:function created(){this.__timeStamp="";(0,_settings.setPassiveTouchGestures)(!0);window.JSONOutlineSchema.requestAvailability();window.addEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));window.addEventListener("haxcms-trigger-update-page",this._triggerUpdatedPage.bind(this));window.addEventListener("json-outline-schema-active-item-changed",this._setActiveItem.bind(this));window.SimpleToast.requestAvailability()},attached:function attached(){var _this=this;window.SimpleModal.requestAvailability();this.__disposer=(0,_mobxModule.autorun)(function(){_this.themeData=(0,_mobxModule.toJS)(_haxcmsSiteStore.store.themeData)});this.editorBuilder=document.createElement("haxcms-editor-builder");document.body.appendChild(this.editorBuilder);async.microTask.run(function(){if(window.cmsSiteEditor&&_this.manifest){window.cmsSiteEditor.jsonOutlineSchema=_this.manifest}if("published"!==_this.editorBuilder.getContext()){_this.__timeStamp="?"+_Mathfloor(Date.now()/1e3)}})},detached:function detached(){window.removeEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));window.removeEventListener("haxcms-trigger-update-page",this._triggerUpdatedPage.bind(this));window.removeEventListener("json-outline-schema-active-item-changed",this._setActiveItem.bind(this));this.__disposer()},_setActiveItem:function _setActiveItem(e){var _this2=this;this.set("activeItem",e.detail);this.notifyPath("activeItem.*");this.set("queryParams.page",e.detail.id);this.notifyPath("queryParams.page");var time=2e3;if(window.HaxStore&&window.HaxStore.ready){time=10}setTimeout(function(){if(window.cmsSiteEditor.instance&&window.cmsSiteEditor.haxCmsSiteEditorUIElement){window.cmsSiteEditor.haxCmsSiteEditorUIElement.set("activeItem",_this2.activeItem)}},time)},_activeItemContentChanged:function _activeItemContentChanged(newValue){var _this3=this;if(newValue){var html=newValue;if(null!==html){this.wipeSlot(this.themeElement,"*");html=this.encapScript(newValue);async.microTask.run(function(){setTimeout(function(){var frag=document.createRange().createContextualFragment(html);(0,_polymerDom.dom)(_this3.themeElement).appendChild(frag);_this3.fire("json-outline-schema-active-body-changed",html);if(!window.HaxStore||!window.HaxStore.ready){setTimeout(function(){if(window.cmsSiteEditor.instance&&window.cmsSiteEditor.haxCmsSiteEditorUIElement){window.HaxStore.instance.activeHaxBody.importContent(html)}},2e3)}},50)});if(this.manifest.metadata.dynamicElementLoader){var i;(function(){var tagsFound=_this3.findTagsInHTML(html),basePath=(0,_resolveUrl.pathFromUrl)(decodeURIComponent(meta.url)),_loop=function(){var tagName=tagsFound[i];if(_this3.manifest.metadata.dynamicElementLoader[tagName]&&!window.customElements.get(tagName)){new Promise(function(res,rej){return _require.default(["".concat(basePath,"../../../../").concat(_this3.manifest.metadata.dynamicElementLoader[tagName])],res,rej)}).then(function(){}).catch(function(error){console.log(error)})}};for(i in tagsFound){_loop()}})()}}}},findTagsInHTML:function findTagsInHTML(html){var tags={},tag="",matches=html.match(/<\/(\S*?)-(\S*?)>/g);for(var i in matches){tag=matches[i].replace("</","").replace(">","");tags[tag]=tag}return tags},encapScript:function encapScript(html){html=html.replace(/<script[\s\S]*?>/gi,"&lt;script&gt;");html=html.replace(/<\/script>/gi,"&lt;/script&gt;");html=html.replace(/<style[\s\S]*?>/gi,"&lt;style&gt;");html=html.replace(/<\/style>/gi,"&lt;/style&gt;");html=html.replace(/<template[\s\S]*?>[\s\S]*?&lt;script[\s\S]*?&gt;[\s\S]*?&lt;\/script&gt;/gi,function(match){match=match.replace("&lt;script&gt;","<script>");match=match.replace("&lt;/script&gt;","</script>");match=match.replace("&lt;style&gt;","<style>");match=match.replace("&lt;/style&gt;","</style>");return match});return html},_activeItemChanged:function _activeItemChanged(newValue){if(babelHelpers.typeof(newValue.id)!=="undefined"){if("published"!==this.editorBuilder.getContext()){this.__timeStamp="?"+_Mathfloor(Date.now()/1e3)}this.$.activecontent.generateRequest()}else if(babelHelpers.typeof(newValue.id)==="undefined"){this.fire("json-outline-schema-active-body-changed",null)}},_triggerUpdatedData:function _triggerUpdatedData(){if("published"!==this.editorBuilder.getContext()){this.__timeStamp="?"+_Mathfloor(Date.now()/1e3)}this.$.manifest.generateRequest()},_triggerUpdatedPage:function _triggerUpdatedPage(){if("published"!==this.editorBuilder.getContext()){this.__timeStamp="?"+_Mathfloor(Date.now()/1e3)}if(this.activeItem.location){this.$.activecontent.generateRequest()}},_fileChanged:function _fileChanged(newValue){if(babelHelpers.typeof(newValue)!=="undefined"){this.$.manifest.generateRequest()}},_manifestChanged:function _manifestChanged(newValue){if(newValue){if(!newValue.metadata.dynamicElementLoader){newValue.metadata.dynamicElementLoader={"a11y-gif-player":"@lrnwebcomponents/a11y-gif-player/a11y-gif-player.js","citation-element":"@lrnwebcomponents/citation-element/citation-element.js","hero-banner":"@lrnwebcomponents/hero-banner/hero-banner.js","image-compare-slider":"@lrnwebcomponents/image-compare-slider/image-compare-slider.js","license-element":"@lrnwebcomponents/license-element/license-element.js","lrn-aside":"@lrnwebcomponents/lrn-aside/lrn-aside.js","lrn-calendar":"@lrnwebcomponents/lrn-calendar/lrn-calendar.js","lrn-math":"@lrnwebcomponents/lrn-math/lrn-math.js","lrn-table":"@lrnwebcomponents/lrn-table/lrn-table.js","lrn-vocab":"@lrnwebcomponents/lrn-vocab/lrn-vocab.js","lrndesign-blockquote":"@lrnwebcomponents/lrndesign-blockquote/lrndesign-blockquote.js","magazine-cover":"@lrnwebcomponents/magazine-cover/magazine-cover.js","media-behaviors":"@lrnwebcomponents/media-behaviors/media-behaviors.js","media-image":"@lrnwebcomponents/media-image/media-image.js","meme-maker":"@lrnwebcomponents/meme-maker/meme-maker.js","multiple-choice":"@lrnwebcomponents/multiple-choice/multiple-choice.js","paper-audio-player":"@lrnwebcomponents/paper-audio-player/paper-audio-player.js","person-testimonial":"@lrnwebcomponents/person-testimonial/person-testimonial.js","place-holder":"@lrnwebcomponents/place-holder/place-holder.js","q-r":"@lrnwebcomponents/q-r/q-r.js","full-width-image":"@lrnwebcomponents/full-width-image/full-width-image.js","self-check":"@lrnwebcomponents/self-check/self-check.js","simple-concept-network":"@lrnwebcomponents/simple-concept-network/simple-concept-network.js","stop-note":"@lrnwebcomponents/stop-note/stop-note.js","tab-list":"@lrnwebcomponents/tab-list/tab-list.js","task-list":"@lrnwebcomponents/task-list/task-list.js","video-player":"@lrnwebcomponents/video-player/video-player.js","wave-player":"@lrnwebcomponents/wave-player/wave-player.js","wikipedia-query":"@lrnwebcomponents/wikipedia-query/wikipedia-query.js"}}_haxcmsSiteStore.store.manifest=newValue;window.cmsSiteEditor.jsonOutlineSchema=newValue;this.fire("json-outline-schema-changed",newValue)}},_themeChanged:function _themeChanged(newValue,oldValue){var _this4=this;if(newValue&&oldValue){if(window.cmsSiteEditor&&window.cmsSiteEditor.instance&&babelHelpers.typeof(window.cmsSiteEditor.instance.haxCmsSiteEditorElement)!=="undefined"){window.cmsSiteEditor.instance.appendChild(window.cmsSiteEditor.instance.haxCmsSiteEditorElement)}}if(newValue){this.themeLoaded=!1;var theme=newValue;this.wipeSlot(this,"*");this.themeElement=document.createElement(theme.element);if(babelHelpers.typeof(this.__imported[theme.element])!=="undefined"){(0,_polymerDom.dom)(this).appendChild(this.themeElement);this.themeLoaded=!0}else{try{new Promise(function(res,rej){return _require.default([(0,_resolveUrl.pathFromUrl)(decodeURIComponent(meta.url))+"../../../../"+newValue.path],res,rej)}).then(function(){(0,_polymerDom.dom)(_this4).appendChild(_this4.themeElement);_this4.__imported[theme.element]=theme.element;_this4.themeLoaded=!0;(0,_elementMixin.updateStyles)()})}catch(err){(0,_polymerDom.dom)(this).appendChild(this.themeElement);this.themeLoaded=!0}}}},wipeSlot:function wipeSlot(element){var slot=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"*";if("*"===slot){while(null!==(0,_polymerDom.dom)(element).firstChild){(0,_polymerDom.dom)(element).removeChild((0,_polymerDom.dom)(element).firstChild)}}else{for(var i in(0,_polymerDom.dom)(element).childNodes){if(babelHelpers.typeof((0,_polymerDom.dom)(element).childNodes[i])!=="undefined"&&(0,_polymerDom.dom)(element).childNodes[i].slot===slot){(0,_polymerDom.dom)(element).removeChild((0,_polymerDom.dom)(element).childNodes[i])}}}}});_exports.HAXCMSSiteBuilder=HAXCMSSiteBuilder});