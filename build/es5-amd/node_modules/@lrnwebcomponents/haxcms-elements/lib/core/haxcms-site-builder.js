define(["exports","meta","require","../../../../@polymer/polymer/polymer-element.js","../../../../@polymer/polymer/lib/utils/settings.js","../../../../@polymer/polymer/lib/mixins/element-mixin.js","../../../../@polymer/polymer/lib/utils/render-status.js","../../../../@polymer/polymer/lib/legacy/polymer.dom.js","../../../../@polymer/polymer/lib/utils/resolve-url.js","../../../hax-body/lib/haxutils.js","../../../../mobx/lib/mobx.module.js","./haxcms-site-store.js","../../../../@polymer/iron-ajax/iron-ajax.js","./haxcms-site-router.js"],function(_exports,meta,_require,_polymerElement,_settings,_elementMixin,_renderStatus,_polymerDom,_resolveUrl,_haxutils,_mobxModule,_haxcmsSiteStore,_ironAjax,_haxcmsSiteRouter){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.HAXCMSSiteBuilder=void 0;meta=babelHelpers.interopRequireWildcard(meta);_require=babelHelpers.interopRequireWildcard(_require);function _templateObject_37a9b290984e11e98da46dc60ea6a0fa(){var data=babelHelpers.taggedTemplateLiteral(["\n      <style>\n        :host {\n          display: block;\n        }\n        :host #slot {\n          transition: all 0.2s ease-in-out;\n          background-color: var(--haxcms-color, white);\n          opacity: 0.2;\n          visibility: hidden;\n        }\n        :host([theme-loaded]) #slot {\n          opacity: 1;\n          visibility: visible;\n        }\n        paper-progress {\n          display: block;\n          width: 100%;\n          position: fixed;\n          top: 0;\n          left: 0;\n          right: 0;\n          background-color: transparent;\n          z-index: 1000;\n          --paper-progress-active-color: var(\n            --haxcms-color,\n            rgba(255, 255, 255, 0.5)\n          );\n          --paper-progress-container-color: transparent;\n        }\n      </style>\n      <haxcms-site-router base-uri=\"[[baseURI]]\"></haxcms-site-router>\n      <paper-progress hidden$=\"[[!loading]]\" indeterminate></paper-progress>\n      <iron-ajax\n        id=\"manifest\"\n        url=\"[[outlineLocation]][[file]][[__timeStamp]]\"\n        handle-as=\"json\"\n        last-response=\"{{manifest}}\"\n        last-error=\"{{lastError}}\"\n      ></iron-ajax>\n      <iron-ajax\n        id=\"activecontent\"\n        url=\"[[outlineLocation]][[activeItem.location]][[__timeStamp]]\"\n        handle-as=\"text\"\n        loading=\"{{loading}}\"\n        last-response=\"{{activeItemContent}}\"\n        last-error=\"{{lastError}}\"\n      ></iron-ajax>\n      <div id=\"slot\"><slot></slot></div>\n    "],["\n      <style>\n        :host {\n          display: block;\n        }\n        :host #slot {\n          transition: all 0.2s ease-in-out;\n          background-color: var(--haxcms-color, white);\n          opacity: 0.2;\n          visibility: hidden;\n        }\n        :host([theme-loaded]) #slot {\n          opacity: 1;\n          visibility: visible;\n        }\n        paper-progress {\n          display: block;\n          width: 100%;\n          position: fixed;\n          top: 0;\n          left: 0;\n          right: 0;\n          background-color: transparent;\n          z-index: 1000;\n          --paper-progress-active-color: var(\n            --haxcms-color,\n            rgba(255, 255, 255, 0.5)\n          );\n          --paper-progress-container-color: transparent;\n        }\n      </style>\n      <haxcms-site-router base-uri=\"[[baseURI]]\"></haxcms-site-router>\n      <paper-progress hidden\\$=\"[[!loading]]\" indeterminate></paper-progress>\n      <iron-ajax\n        id=\"manifest\"\n        url=\"[[outlineLocation]][[file]][[__timeStamp]]\"\n        handle-as=\"json\"\n        last-response=\"{{manifest}}\"\n        last-error=\"{{lastError}}\"\n      ></iron-ajax>\n      <iron-ajax\n        id=\"activecontent\"\n        url=\"[[outlineLocation]][[activeItem.location]][[__timeStamp]]\"\n        handle-as=\"text\"\n        loading=\"{{loading}}\"\n        last-response=\"{{activeItemContent}}\"\n        last-error=\"{{lastError}}\"\n      ></iron-ajax>\n      <div id=\"slot\"><slot></slot></div>\n    "]);_templateObject_37a9b290984e11e98da46dc60ea6a0fa=function _templateObject_37a9b290984e11e98da46dc60ea6a0fa(){return data};return data}/**
 * `haxcms-site-builder`
 * `build the site and everything off of this`
 * @microcopy - the mental model for this element
 * - This is a factory element, it doesn't do much on its own visually
 * - it loads a site.json file and then utilizes this data in order to construct
 *   what theme it should load (element) in order to get everything off and running
 */var HAXCMSSiteBuilder=/*#__PURE__*/function(_PolymerElement){babelHelpers.inherits(HAXCMSSiteBuilder,_PolymerElement);babelHelpers.createClass(HAXCMSSiteBuilder,[{key:"_lastErrorChanged",value:function _lastErrorChanged(newValue){if(newValue){console.error(newValue);var evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:newValue.statusText}});window.dispatchEvent(evt)}}/**
   * ready life cycle
   */}],[{key:"tag",/**
   * Store the tag name to make it easier to obtain directly.
   * @notice function name must be here for tooling to operate correctly
   */get:function get(){return"haxcms-site-builder"}// render function
},{key:"template",get:function get(){return(0,_polymerElement.html)(_templateObject_37a9b290984e11e98da46dc60ea6a0fa())}},{key:"properties",get:function get(){return{/**
       * Singular error reporter / visual based on requests erroring
       */lastError:{type:Object,observer:"_lastErrorChanged"},/**
       * queryParams
       */queryParams:{type:Object},/**
       * Loading status of the page to render.
       */loading:{type:Boolean,value:!1,reflectToAttribute:!0},/**
       * support for alternate locations.
       */outlineLocation:{type:String,notify:!0,reflectToAttribute:!0},/**
       * Manifest from file
       */manifest:{type:Object,notify:!0,observer:"_manifestChanged"},/**
       * Theme, used to boot a design element
       */themeData:{type:Object,observer:"_themeChanged"},/**
       * Theme, used to boot a design element
       */themeElement:{type:Object},/**
       * Imported items so we can allow theme flipping dynamically
       */__imported:{type:Object,value:{}},/**
       * theme loaded to indicate to the theme we have a theme ready to go
       */themeLoaded:{type:Boolean,reflectToAttribute:!0,value:!1},/**
       * Active item which is in JSON Outline Schema
       */activeItem:{type:Object,notify:!0,observer:"_activeItemChanged"},/**
       * Active item content
       */activeItemContent:{type:String,notify:!0,observer:"_activeItemContentChanged"},/**
       * Location of the site.json file
       */file:{type:String,observer:"_fileChanged"},/**
       * Injected by HAXcms
       */baseURI:{type:String}}}}]);function HAXCMSSiteBuilder(){var _this;babelHelpers.classCallCheck(this,HAXCMSSiteBuilder);_this=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(HAXCMSSiteBuilder).call(this));window.addEventListener("hax-store-ready",_this.storeReady.bind(babelHelpers.assertThisInitialized(_this)));new Promise(function(res,rej){return _require.default(["../../../../@polymer/paper-progress/paper-progress.js"],res,rej)});// attempt to set polymer passive gestures globally
// this decreases logging and improves performance on scrolling
(0,_settings.setPassiveTouchGestures)(!0);// hide the outdated fallback
if(document.getElementById("haxcmsoutdatedfallback")){document.getElementById("haxcmsoutdatedfallback").style.display="none"}_this.__disposer=[];(0,_mobxModule.autorun)(function(reaction){_this.themeData=(0,_mobxModule.toJS)(_haxcmsSiteStore.store.themeData);_this.__disposer.push(reaction)});(0,_mobxModule.autorun)(function(reaction){_this.activeItem=(0,_mobxModule.toJS)(_haxcmsSiteStore.store.activeItem);_this.__disposer.push(reaction)});_this.__timeStamp="";return _this}babelHelpers.createClass(HAXCMSSiteBuilder,[{key:"connectedCallback",value:function connectedCallback(){babelHelpers.get(babelHelpers.getPrototypeOf(HAXCMSSiteBuilder.prototype),"connectedCallback",this).call(this);(0,_renderStatus.afterNextRender)(this,function(){var _this2=this;this.dispatchEvent(new CustomEvent("haxcms-ready",{bubbles:!0,composed:!0,cancelable:!1,detail:this}));if(document.getElementById("haxcmsoutdatedfallback")){document.body.removeChild(document.getElementById("haxcmsoutdatedfallback"))}window.addEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));window.addEventListener("haxcms-trigger-update-node",this._triggerUpdatedNode.bind(this));// dyanmcially import the editor builder which figures out if we should have one
new Promise(function(res,rej){return _require.default(["./haxcms-editor-builder.js"],res,rej)}).then(function(response){_this2.editorBuilder=document.createElement("haxcms-editor-builder");// attach editor builder after we've appended to the screen
document.body.appendChild(_this2.editorBuilder);// get fresh data if not published
if("published"!==_this2.editorBuilder.getContext()&&"demo"!==_this2.editorBuilder.getContext()){_this2.__timeStamp="?"+Math.floor(Date.now()/1e3)}}).catch(function(error){/* Error handling */console.log(error)});var evt=document.createEvent("UIEvents");evt.initUIEvent("resize",!0,!1,window,0);window.dispatchEvent(evt)})}/**
   * Detached life cycle
   */},{key:"disconnectedCallback",value:function disconnectedCallback(){window.removeEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));window.removeEventListener("haxcms-trigger-update-node",this._triggerUpdatedNode.bind(this));for(var i in this.__disposer){this.__disposer[i].dispose()}window.removeEventListener("hax-store-ready",this.storeReady.bind(this));babelHelpers.get(babelHelpers.getPrototypeOf(HAXCMSSiteBuilder.prototype),"disconnectedCallback",this).call(this)}},{key:"storeReady",value:function storeReady(e){// append UI element to body to avoid stack order issues
if(_haxcmsSiteStore.store.cmsSiteEditor&&_haxcmsSiteStore.store.cmsSiteEditor.instance&&window.HaxStore.instance.activeHaxBody&&_haxcmsSiteStore.store.activeItemContent){window.HaxStore.instance.activeHaxBody.importContent(_haxcmsSiteStore.store.activeItemContent)}}/**
   * React to content being loaded from a page.
   */},{key:"_activeItemContentChanged",value:function _activeItemContentChanged(newValue,oldValue){var _this3=this;if(newValue){var html=newValue;// only append if not empty
if(null!==html){(0,_haxutils.wipeSlot)(this.themeElement,"*");html=(0,_haxutils.encapScript)(newValue);// set in the store
_haxcmsSiteStore.store.activeItemContent=html;// insert the content as quickly as possible, then work on the dynamic imports
// @todo this might be why we get a double render some times
setTimeout(function(){if(0===(0,_polymerDom.dom)(_this3.themeElement).getEffectiveChildNodes().length){var frag=document.createRange().createContextualFragment(html);(0,_polymerDom.dom)(_this3.themeElement).appendChild(frag);_this3.dispatchEvent(new CustomEvent("json-outline-schema-active-body-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:html}))}},5);// if there are, dynamically import them
if(this.manifest.metadata.dynamicElementLoader){var i;(function(){var tagsFound=(0,_haxutils.findTagsInHTML)(html),basePath=(0,_resolveUrl.pathFromUrl)(decodeURIComponent(meta.url)),_loop=function _loop(){var tagName=tagsFound[i];if(_this3.manifest.metadata.dynamicElementLoader[tagName]&&!window.customElements.get(tagName)){new Promise(function(res,rej){return _require.default(["".concat(basePath,"../../../../").concat(_this3.manifest.metadata.dynamicElementLoader[tagName])],res,rej)}).then(function(response){// useful to debug if dynamic references are coming in
//console.log(tagName + ' dynamic import');
}).catch(function(error){/* Error handling */console.log(error);console.log(tagName)})}};for(i in tagsFound){_loop()}})()}}}}/**
   * Active item updated, let's request the content from it
   */},{key:"_activeItemChanged",value:function _activeItemChanged(newValue,oldValue){if(newValue&&babelHelpers.typeof(newValue.id)!==("undefined"===typeof void 0?"undefined":babelHelpers.typeof(void 0))){this.set("queryParams.nodeId",newValue.id);this.notifyPath("queryParams.nodeId");// get fresh data if not published
if(this.editorBuilder&&"published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()){this.__timeStamp="?"+Math.floor(Date.now()/1e3)}this.$.activecontent.generateRequest()}// we had something, now we don't. wipe out the content area of the theme
else if(oldValue&&!newValue){// fire event w/ nothing, this is because there is no content
this.dispatchEvent(new CustomEvent("json-outline-schema-active-body-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:null}))}}/**
   * got a message that we need to update our json manifest data
   */},{key:"_triggerUpdatedData",value:function _triggerUpdatedData(e){// get fresh data if not published
if(this.editorBuilder&&"published"!==this.editorBuilder.getContext()){this.__timeStamp="?"+Math.floor(Date.now()/1e3)}this.$.manifest.generateRequest()}/**
   * got a message that we need to update our page content
   */},{key:"_triggerUpdatedNode",value:function _triggerUpdatedNode(e){// get fresh data if not published
if(this.editorBuilder&&"published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()){this.__timeStamp="?"+Math.floor(Date.now()/1e3)}// ensure we don't get a miss on initial load
if(this.activeItem.location){this.$.activecontent.generateRequest()}}/**
   * File changed so let's pull from the location
   */},{key:"_fileChanged",value:function _fileChanged(newValue,oldValue){if(babelHelpers.typeof(newValue)!==("undefined"===typeof void 0?"undefined":babelHelpers.typeof(void 0))){this.$.manifest.generateRequest()}}/**
   * notice manifest changes and ensure slot is rebuilt.
   */},{key:"_manifestChanged",value:function _manifestChanged(newValue,oldValue){if(newValue&&newValue.metadata&&newValue.items){// ensure there's a dynamicELementLoader defined
// @todo this could also be a place to mix in criticals
// that are system required yet we lazy load like grid-plate
if(!newValue.metadata.dynamicElementLoader){newValue.metadata.dynamicElementLoader={"a11y-gif-player":"@lrnwebcomponents/a11y-gif-player/a11y-gif-player.js","citation-element":"@lrnwebcomponents/citation-element/citation-element.js","hero-banner":"@lrnwebcomponents/hero-banner/hero-banner.js","image-compare-slider":"@lrnwebcomponents/image-compare-slider/image-compare-slider.js","license-element":"@lrnwebcomponents/license-element/license-element.js","lrn-aside":"@lrnwebcomponents/lrn-aside/lrn-aside.js","lrn-calendar":"@lrnwebcomponents/lrn-calendar/lrn-calendar.js","lrn-math":"@lrnwebcomponents/lrn-math/lrn-math.js","lrn-table":"@lrnwebcomponents/lrn-table/lrn-table.js","lrn-vocab":"@lrnwebcomponents/lrn-vocab/lrn-vocab.js","lrndesign-blockquote":"@lrnwebcomponents/lrndesign-blockquote/lrndesign-blockquote.js","magazine-cover":"@lrnwebcomponents/magazine-cover/magazine-cover.js","media-behaviors":"@lrnwebcomponents/media-behaviors/media-behaviors.js","media-image":"@lrnwebcomponents/media-image/media-image.js","meme-maker":"@lrnwebcomponents/meme-maker/meme-maker.js","multiple-choice":"@lrnwebcomponents/multiple-choice/multiple-choice.js","paper-audio-player":"@lrnwebcomponents/paper-audio-player/paper-audio-player.js","person-testimonial":"@lrnwebcomponents/person-testimonial/person-testimonial.js","place-holder":"@lrnwebcomponents/place-holder/place-holder.js","q-r":"@lrnwebcomponents/q-r/q-r.js","full-width-image":"@lrnwebcomponents/full-width-image/full-width-image.js","self-check":"@lrnwebcomponents/self-check/self-check.js","simple-concept-network":"@lrnwebcomponents/simple-concept-network/simple-concept-network.js","stop-note":"@lrnwebcomponents/stop-note/stop-note.js","tab-list":"@lrnwebcomponents/tab-list/tab-list.js","task-list":"@lrnwebcomponents/task-list/task-list.js","video-player":"@lrnwebcomponents/video-player/video-player.js","wave-player":"@lrnwebcomponents/wave-player/wave-player.js","wikipedia-query":"@lrnwebcomponents/wikipedia-query/wikipedia-query.js"}}_haxcmsSiteStore.store.manifest=newValue;this.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:newValue}))}}/**
   * notice theme changes and ensure slot is rebuilt.
   */},{key:"_themeChanged",value:function _themeChanged(newValue,oldValue){var _this4=this;if(newValue&&oldValue){if(_haxcmsSiteStore.store.cmsSiteEditor&&_haxcmsSiteStore.store.cmsSiteEditor.instance&&babelHelpers.typeof(_haxcmsSiteStore.store.cmsSiteEditor.instance.haxCmsSiteEditorElement)!==("undefined"===typeof void 0?"undefined":babelHelpers.typeof(void 0))){_haxcmsSiteStore.store.cmsSiteEditor.instance.appendChild(_haxcmsSiteStore.store.cmsSiteEditor.instance.haxCmsSiteEditorElement)}}if(newValue){this.themeLoaded=!1;var theme=newValue;// wipe out what we got
(0,_haxutils.wipeSlot)(this,"*");// create the 'theme' as a new element
this.themeElement=document.createElement(theme.element);// weird but definition already here so we should be able
// to just use this without an import, it's possible..
if(babelHelpers.typeof(this.__imported[theme.element])!==("undefined"===typeof void 0?"undefined":babelHelpers.typeof(void 0))){(0,_polymerDom.dom)(this).appendChild(this.themeElement);this.themeLoaded=!0}else{// import the reference to the item dynamically, if we can
try{new Promise(function(res,rej){return _require.default([(0,_resolveUrl.pathFromUrl)(decodeURIComponent(meta.url))+"../../../../"+newValue.path],res,rej)}).then(function(e){// add it into ourselves so it unpacks and we kick this off!
(0,_polymerDom.dom)(_this4).appendChild(_this4.themeElement);_this4.__imported[theme.element]=theme.element;_this4.themeLoaded=!0})}catch(err){// error in the event this is a double registration
// also strange to be able to reach this but technically possible
(0,_polymerDom.dom)(this).appendChild(this.themeElement);this.themeLoaded=!0}}// delay for theme switching to reapply the css variable associations
setTimeout(function(){(0,_elementMixin.updateStyles)()},500)}}}]);return HAXCMSSiteBuilder}(_polymerElement.PolymerElement);_exports.HAXCMSSiteBuilder=HAXCMSSiteBuilder;window.customElements.define(HAXCMSSiteBuilder.tag,HAXCMSSiteBuilder)});