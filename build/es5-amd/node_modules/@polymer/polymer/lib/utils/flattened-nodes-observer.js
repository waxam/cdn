define(["exports","./boot.js","./array-splice.js","./async.js"],function(_exports,_boot,_arraySplice,_async){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.FlattenedNodesObserver=void 0;function isSlot(node){return"slot"===node.localName}var FlattenedNodesObserver=function(){babelHelpers.createClass(FlattenedNodesObserver,null,[{key:"getFlattenedNodes",value:function getFlattenedNodes(node){if(isSlot(node)){node=node;return node.assignedNodes({flatten:!0})}else{return Array.from(node.childNodes).map(function(node){if(isSlot(node)){node=node;return node.assignedNodes({flatten:!0})}else{return[node]}}).reduce(function(a,b){return a.concat(b)},[])}}}]);function FlattenedNodesObserver(target,callback){var _this=this;babelHelpers.classCallCheck(this,FlattenedNodesObserver);this._shadyChildrenObserver=null;this._nativeChildrenObserver=null;this._connected=!1;this._target=target;this.callback=callback;this._effectiveNodes=[];this._observer=null;this._scheduled=!1;this._boundSchedule=function(){_this._schedule()};this.connect();this._schedule()}babelHelpers.createClass(FlattenedNodesObserver,[{key:"connect",value:function connect(){var _this2=this;if(isSlot(this._target)){this._listenSlots([this._target])}else if(this._target.children){this._listenSlots(this._target.children);if(window.ShadyDOM){this._shadyChildrenObserver=ShadyDOM.observeChildren(this._target,function(mutations){_this2._processMutations(mutations)})}else{this._nativeChildrenObserver=new MutationObserver(function(mutations){_this2._processMutations(mutations)});this._nativeChildrenObserver.observe(this._target,{childList:!0})}}this._connected=!0}},{key:"disconnect",value:function disconnect(){if(isSlot(this._target)){this._unlistenSlots([this._target])}else if(this._target.children){this._unlistenSlots(this._target.children);if(window.ShadyDOM&&this._shadyChildrenObserver){ShadyDOM.unobserveChildren(this._shadyChildrenObserver);this._shadyChildrenObserver=null}else if(this._nativeChildrenObserver){this._nativeChildrenObserver.disconnect();this._nativeChildrenObserver=null}}this._connected=!1}},{key:"_schedule",value:function _schedule(){var _this3=this;if(!this._scheduled){this._scheduled=!0;_async.microTask.run(function(){return _this3.flush()})}}},{key:"_processMutations",value:function _processMutations(mutations){this._processSlotMutations(mutations);this.flush()}},{key:"_processSlotMutations",value:function _processSlotMutations(mutations){if(mutations){for(var i=0,mutation;i<mutations.length;i++){mutation=mutations[i];if(mutation.addedNodes){this._listenSlots(mutation.addedNodes)}if(mutation.removedNodes){this._unlistenSlots(mutation.removedNodes)}}}}},{key:"flush",value:function flush(){if(!this._connected){return!1}if(window.ShadyDOM){ShadyDOM.flush()}if(this._nativeChildrenObserver){this._processSlotMutations(this._nativeChildrenObserver.takeRecords())}else if(this._shadyChildrenObserver){this._processSlotMutations(this._shadyChildrenObserver.takeRecords())}this._scheduled=!1;for(var info={target:this._target,addedNodes:[],removedNodes:[]},newNodes=this.constructor.getFlattenedNodes(this._target),splices=(0,_arraySplice.calculateSplices)(newNodes,this._effectiveNodes),i=0,s;i<splices.length&&(s=splices[i]);i++){for(var j=0,n;j<s.removed.length&&(n=s.removed[j]);j++){info.removedNodes.push(n)}}for(var _i=0,_s;_i<splices.length&&(_s=splices[_i]);_i++){for(var _j=_s.index;_j<_s.index+_s.addedCount;_j++){info.addedNodes.push(newNodes[_j])}}this._effectiveNodes=newNodes;var didFlush=!1;if(info.addedNodes.length||info.removedNodes.length){didFlush=!0;this.callback.call(this._target,info)}return didFlush}},{key:"_listenSlots",value:function _listenSlots(nodeList){for(var i=0,n;i<nodeList.length;i++){n=nodeList[i];if(isSlot(n)){n.addEventListener("slotchange",this._boundSchedule)}}}},{key:"_unlistenSlots",value:function _unlistenSlots(nodeList){for(var i=0,n;i<nodeList.length;i++){n=nodeList[i];if(isSlot(n)){n.removeEventListener("slotchange",this._boundSchedule)}}}}]);return FlattenedNodesObserver}();_exports.FlattenedNodesObserver=FlattenedNodesObserver});