define(["exports","../../../@polymer/polymer/lib/utils/debounce.js","../../../@polymer/polymer/lib/utils/async.js"],function(_exports,_debounce,_async){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.DataProviderMixin=_exports.ItemCache=void 0;var ItemCache=function(){function ItemCache(grid,parentCache,parentItem){babelHelpers.classCallCheck(this,ItemCache);this.grid=grid;this.parentCache=parentCache;this.parentItem=parentItem;this.itemCaches={};this.items={};this.effectiveSize=0;this.size=0;this.pendingRequests={}}babelHelpers.createClass(ItemCache,[{key:"isLoading",value:function isLoading(){var _this=this;return Object.keys(this.pendingRequests).length||Object.keys(this.itemCaches).filter(function(index){return _this.itemCaches[index].isLoading()})[0]}},{key:"getItemForIndex",value:function getItemForIndex(index){var _this$getCacheAndInde=this.getCacheAndIndex(index),cache=_this$getCacheAndInde.cache,scaledIndex=_this$getCacheAndInde.scaledIndex;return cache.items[scaledIndex]}},{key:"updateSize",value:function updateSize(){var _this2=this;this.effectiveSize=!this.parentItem||this.grid._isExpanded(this.parentItem)?this.size+Object.keys(this.itemCaches).reduce(function(prev,curr){var subCache=_this2.itemCaches[curr];subCache.updateSize();return prev+subCache.effectiveSize},0):0}},{key:"ensureSubCacheForScaledIndex",value:function ensureSubCacheForScaledIndex(scaledIndex){if(!this.itemCaches[scaledIndex]){var subCache=new ItemCache(this.grid,this,this.items[scaledIndex]);this.itemCaches[scaledIndex]=subCache;this.grid._loadPage(0,subCache)}}},{key:"getCacheAndIndex",value:function getCacheAndIndex(index){for(var thisLevelIndex=index,keys=Object.keys(this.itemCaches),i=0;i<keys.length;i++){var expandedIndex=+keys[i],subCache=this.itemCaches[expandedIndex];if(thisLevelIndex<=expandedIndex){return{cache:this,scaledIndex:thisLevelIndex}}else if(thisLevelIndex<=expandedIndex+subCache.effectiveSize){return subCache.getCacheAndIndex(thisLevelIndex-expandedIndex-1)}thisLevelIndex-=subCache.effectiveSize}return{cache:this,scaledIndex:thisLevelIndex}}}]);return ItemCache}();_exports.ItemCache=ItemCache;_exports.DataProviderMixin=function DataProviderMixin(superClass){return function(_superClass){babelHelpers.inherits(DataProviderMixin,_superClass);function DataProviderMixin(){babelHelpers.classCallCheck(this,DataProviderMixin);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(DataProviderMixin).apply(this,arguments))}babelHelpers.createClass(DataProviderMixin,[{key:"_sizeChanged",value:function _sizeChanged(size){var delta=size-this._cache.size;this._cache.size+=delta;this._cache.effectiveSize+=delta;this._effectiveSize=this._cache.effectiveSize}},{key:"_updateRowItem",value:function _updateRowItem(item,el){el.children.forEach(function(cell){cell._instance&&(cell._instance.item=item)})}},{key:"_getItem",value:function _getItem(index,el){if(index>=this._effectiveSize){return}el.index=index;var _this$_cache$getCache=this._cache.getCacheAndIndex(index),cache=_this$_cache$getCache.cache,scaledIndex=_this$_cache$getCache.scaledIndex,item=cache.items[scaledIndex];if(item){this._toggleAttribute("loading",!1,el);this._updateItem(el,item);if(this._isExpanded(item)){cache.ensureSubCacheForScaledIndex(scaledIndex)}}else{this._toggleAttribute("loading",!0,el);this._loadPage(this._getPageForIndex(scaledIndex),cache)}}},{key:"_pagesForPhysicalItems",value:function _pagesForPhysicalItems(){var _this3=this,firstVisiblePage=this._getPageForIndex(this._firstVisibleIndex+this._vidxOffset);return[firstVisiblePage].concat(this._physicalItems.filter(function(row){return row.index}).items(function(row){return _this3._getPageForIndex(row.index)})).reduce(function(prev,curr){if(-1===prev.indexOf(curr)){prev.push(curr)}return prev},[])}},{key:"_expandedInstanceChangedCallback",value:function _expandedInstanceChangedCallback(inst,value){if(inst.item===void 0){return}if(value){this.expandItem(inst.item)}else{this.collapseItem(inst.item)}}},{key:"getItemId",value:function getItemId(item){return this.itemIdPath?this.get(this.itemIdPath,item):item}},{key:"_isExpanded",value:function _isExpanded(item){return this.expandedItems&&-1<this._getItemIndexInArray(item,this.expandedItems)}},{key:"_expandedItemsChanged",value:function _expandedItemsChanged(){this._cache.updateSize();this._effectiveSize=this._cache.effectiveSize;this._assignModels()}},{key:"expandItem",value:function expandItem(item){if(!this._isExpanded(item)){this.push("expandedItems",item)}}},{key:"collapseItem",value:function collapseItem(item){if(this._isExpanded(item)){this.splice("expandedItems",this._getItemIndexInArray(item,this.expandedItems),1)}}},{key:"_getIndexLevel",value:function _getIndexLevel(index){var _this$_cache$getCache2=this._cache.getCacheAndIndex(index),cache=_this$_cache$getCache2.cache,level=0;while(cache.parentCache){cache=cache.parentCache;level++}return level}},{key:"_canPopulate",value:function _canPopulate(){return this._hasData&&this._columnTree}},{key:"_loadPage",value:function _loadPage(page,cache){var _this4=this;if(!cache.pendingRequests[page]&&this.dataProvider){this._setLoading(!0);cache.pendingRequests[page]=!0;var params={page:page,pageSize:this.pageSize,sortOrders:this._mapSorters(),filters:this._mapFilters(),parentItem:cache.parentItem};this.dataProvider(params,function(items,size){if(size!==void 0){cache.size=size}else{if(params.parentItem){cache.size=items.length}}items.forEach(function(item,itemsIndex){cache.items[page*_this4.pageSize+itemsIndex]=item});_this4._cache.updateSize();_this4._effectiveSize=_this4._cache.effectiveSize;Array.from(_this4.$.items.children).forEach(function(row){var cachedItem=_this4._cache.getItemForIndex(row.index);if(-1<items.indexOf(cachedItem)){_this4._toggleAttribute("loading",!1,row);_this4._updateItem(row,cachedItem)}});_this4._hasData=!0;_this4._increasePoolIfNeeded(0);delete cache.pendingRequests[page];_this4._setLoading(_this4._cache.isLoading())})}}},{key:"_getPageForIndex",value:function _getPageForIndex(index){return Math.floor(index/this.pageSize)}},{key:"clearCache",value:function clearCache(){this._cache=new ItemCache(this);Array.from(this.$.items.children).forEach(function(row){Array.from(row.children).forEach(function(cell){cell._instance&&cell._instance._setPendingProperty("item",{},!1)})});this._cache.size=this.size||0;this._cache.updateSize();this._hasData=!1;this._assignModels();if(!this._effectiveSize){this._loadPage(0,this._cache)}}},{key:"_flushItemsDebouncer",value:function _flushItemsDebouncer(){if(this._debouncerLoad){this._debouncerLoad.flush()}}},{key:"_pageSizeChanged",value:function _pageSizeChanged(pageSize,oldPageSize){if(oldPageSize!==void 0&&pageSize!==oldPageSize){this.clearCache()}}},{key:"_checkSize",value:function _checkSize(){if(this.size===void 0&&0===this._effectiveSize){console.warn("The <vaadin-grid> needs the total number of items"+" in order to display rows. Set the total number of items"+" to the `size` property, or provide the total number of items"+" in the second argument of the `dataProvider`\u2019s `callback` call.")}}},{key:"_dataProviderChanged",value:function _dataProviderChanged(dataProvider,oldDataProvider){if(oldDataProvider!==void 0){this.clearCache()}if(dataProvider&&this.items&&this.items.length){this._scrollToIndex(this._firstVisibleIndex)}this._ensureFirstPageLoaded();this._debouncerCheckSize=_debounce.Debouncer.debounce(this._debouncerCheckSize,_async.timeOut.after(2e3),this._checkSize.bind(this));this._scrollHandler()}},{key:"_ensureFirstPageLoaded",value:function _ensureFirstPageLoaded(){var _this5=this;if(!this._hasData){this._loadPage(0,this._cache,function(){var hadData=_this5._hasData;_this5._hasData=!0;if(!hadData){_this5.notifyResize()}})}}},{key:"_itemsEqual",value:function _itemsEqual(item1,item2){return this.getItemId(item1)===this.getItemId(item2)}},{key:"_getItemIndexInArray",value:function _getItemIndexInArray(item,array){var _this6=this,result=-1;array.forEach(function(i,idx){if(_this6._itemsEqual(i,item)){result=idx}});return result}}],[{key:"properties",get:function get(){return{pageSize:{type:Number,value:50,observer:"_pageSizeChanged"},dataProvider:{type:Object,notify:!0,observer:"_dataProviderChanged"},loading:{type:Boolean,notify:!0,readOnly:!0,reflectToAttribute:!0},_cache:{type:Object,value:function value(){var cache=new ItemCache(this);return cache}},itemIdPath:{type:String,value:null},expandedItems:{type:Object,notify:!0,value:function value(){return[]}}}}},{key:"observers",get:function get(){return["_sizeChanged(size)","_expandedItemsChanged(expandedItems.*)"]}}]);return DataProviderMixin}(superClass)}});