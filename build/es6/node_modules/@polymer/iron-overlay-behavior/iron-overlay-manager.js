import"../polymer/polymer-legacy.js";import"./iron-overlay-backdrop.js";import{IronA11yKeysBehavior}from"../iron-a11y-keys-behavior/iron-a11y-keys-behavior.js";import{dom}from"../polymer/lib/legacy/polymer.dom.js";import*as gestures from"../polymer/lib/utils/gestures.js";export const IronOverlayManagerClass=function(){this._overlays=[],this._minimumZ=101,this._backdropElement=null,gestures.add(document.documentElement,"tap",function(){}),document.addEventListener("tap",this._onCaptureClick.bind(this),!0),document.addEventListener("focus",this._onCaptureFocus.bind(this),!0),document.addEventListener("keydown",this._onCaptureKeyDown.bind(this),!0)};IronOverlayManagerClass.prototype={constructor:IronOverlayManagerClass,get backdropElement(){return this._backdropElement||(this._backdropElement=document.createElement("iron-overlay-backdrop")),this._backdropElement},get deepActiveElement(){var active=document.activeElement;for(active&&active instanceof Element!=!1||(active=document.body);active.root&&dom(active.root).activeElement;)active=dom(active.root).activeElement;return active},_bringOverlayAtIndexToFront:function(i){var overlay=this._overlays[i];if(overlay){var lastI=this._overlays.length-1,currentOverlay=this._overlays[lastI];if(currentOverlay&&this._shouldBeBehindOverlay(overlay,currentOverlay)&&lastI--,!(i>=lastI)){var minimumZ=Math.max(this.currentOverlayZ(),this._minimumZ);for(this._getZ(overlay)<=minimumZ&&this._applyOverlayZ(overlay,minimumZ);i<lastI;)this._overlays[i]=this._overlays[i+1],i++;this._overlays[lastI]=overlay}}},addOrRemoveOverlay:function(overlay){overlay.opened?this.addOverlay(overlay):this.removeOverlay(overlay)},addOverlay:function(overlay){var i=this._overlays.indexOf(overlay);if(i>=0)return this._bringOverlayAtIndexToFront(i),void this.trackBackdrop();var insertionIndex=this._overlays.length,currentOverlay=this._overlays[insertionIndex-1],minimumZ=Math.max(this._getZ(currentOverlay),this._minimumZ),newZ=this._getZ(overlay);if(currentOverlay&&this._shouldBeBehindOverlay(overlay,currentOverlay)){this._applyOverlayZ(currentOverlay,minimumZ),insertionIndex--;var previousOverlay=this._overlays[insertionIndex-1];minimumZ=Math.max(this._getZ(previousOverlay),this._minimumZ)}newZ<=minimumZ&&this._applyOverlayZ(overlay,minimumZ),this._overlays.splice(insertionIndex,0,overlay),this.trackBackdrop()},removeOverlay:function(overlay){var i=this._overlays.indexOf(overlay);-1!==i&&(this._overlays.splice(i,1),this.trackBackdrop())},currentOverlay:function(){var i=this._overlays.length-1;return this._overlays[i]},currentOverlayZ:function(){return this._getZ(this.currentOverlay())},ensureMinimumZ:function(minimumZ){this._minimumZ=Math.max(this._minimumZ,minimumZ)},focusOverlay:function(){var current=this.currentOverlay();current&&current._applyFocus()},trackBackdrop:function(){var overlay=this._overlayWithBackdrop();(overlay||this._backdropElement)&&(this.backdropElement.style.zIndex=this._getZ(overlay)-1,this.backdropElement.opened=!!overlay,this.backdropElement.prepare())},getBackdrops:function(){for(var backdrops=[],i=0;i<this._overlays.length;i++)this._overlays[i].withBackdrop&&backdrops.push(this._overlays[i]);return backdrops},backdropZ:function(){return this._getZ(this._overlayWithBackdrop())-1},_overlayWithBackdrop:function(){for(var i=this._overlays.length-1;i>=0;i--)if(this._overlays[i].withBackdrop)return this._overlays[i]},_getZ:function(overlay){var z=this._minimumZ;if(overlay){var z1=Number(overlay.style.zIndex||window.getComputedStyle(overlay).zIndex);z1==z1&&(z=z1)}return z},_setZ:function(element,z){element.style.zIndex=z},_applyOverlayZ:function(overlay,aboveZ){this._setZ(overlay,aboveZ+2)},_overlayInPath:function(path){path=path||[];for(var i=0;i<path.length;i++)if(path[i]._manager===this)return path[i]},_onCaptureClick:function(event){var i=this._overlays.length-1;if(-1!==i)for(var overlay,path=dom(event).path;(overlay=this._overlays[i])&&this._overlayInPath(path)!==overlay&&(overlay._onCaptureClick(event),overlay.allowClickThrough);)i--},_onCaptureFocus:function(event){var overlay=this.currentOverlay();overlay&&overlay._onCaptureFocus(event)},_onCaptureKeyDown:function(event){var overlay=this.currentOverlay();overlay&&(IronA11yKeysBehavior.keyboardEventMatchesKeys(event,"esc")?overlay._onCaptureEsc(event):IronA11yKeysBehavior.keyboardEventMatchesKeys(event,"tab")&&overlay._onCaptureTab(event))},_shouldBeBehindOverlay:function(overlay1,overlay2){return!overlay1.alwaysOnTop&&overlay2.alwaysOnTop}};export const IronOverlayManager=new IronOverlayManagerClass;