/**
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at
http://polymer.github.io/LICENSE.txt The complete set of authors may be found at
http://polymer.github.io/AUTHORS.txt The complete set of contributors may be
found at http://polymer.github.io/CONTRIBUTORS.txt Code distributed by Google as
part of the polymer project is also subject to an additional IP rights grant
found at http://polymer.github.io/PATENTS.txt
*/
import"../polymer/polymer-legacy.js";import"../iron-a11y-keys-behavior/iron-a11y-keys-behavior.js";import{IronResizableBehavior}from"../iron-resizable-behavior/iron-resizable-behavior.js";import{IronScrollTargetBehavior}from"../iron-scroll-target-behavior/iron-scroll-target-behavior.js";import{OptionalMutableDataBehavior}from"../polymer/lib/legacy/mutable-data-behavior.js";import{Polymer}from"../polymer/lib/legacy/polymer-fn.js";import{dom}from"../polymer/lib/legacy/polymer.dom.js";import{Templatizer}from"../polymer/lib/legacy/templatizer-behavior.js";import{animationFrame,idlePeriod,microTask}from"../polymer/lib/utils/async.js";import{Debouncer}from"../polymer/lib/utils/debounce.js";import{enqueueDebouncer,flush}from"../polymer/lib/utils/flush.js";import{html}from"../polymer/lib/utils/html-tag.js";import{matches,translate}from"../polymer/lib/utils/path.js";import{TemplateInstanceBase}from"../polymer/lib/utils/templatize.js";var IOS=navigator.userAgent.match(/iP(?:hone|ad;(?: U;)? CPU) OS (\d+)/),IOS_TOUCH_SCROLLING=IOS&&IOS[1]>=8;Polymer({_template:html`
    <style>
      :host {
        display: block;
      }

      @media only screen and (-webkit-max-device-pixel-ratio: 1) {
        :host {
          will-change: transform;
        }
      }

      #items {
        @apply --iron-list-items-container;
        position: relative;
      }

      :host(:not([grid])) #items > ::slotted(*) {
        width: 100%;
      }

      #items > ::slotted(*) {
        box-sizing: border-box;
        margin: 0;
        position: absolute;
        top: 0;
        will-change: transform;
      }
    </style>

    <array-selector id="selector" items="{{items}}" selected="{{selectedItems}}" selected-item="{{selectedItem}}"></array-selector>

    <div id="items">
      <slot></slot>
    </div>
`,is:"iron-list",properties:{items:{type:Array},as:{type:String,value:"item"},indexAs:{type:String,value:"index"},selectedAs:{type:String,value:"selected"},grid:{type:Boolean,value:!1,reflectToAttribute:!0,observer:"_gridChanged"},selectionEnabled:{type:Boolean,value:!1},selectedItem:{type:Object,notify:!0},selectedItems:{type:Object,notify:!0},multiSelection:{type:Boolean,value:!1},scrollOffset:{type:Number,value:0}},observers:["_itemsChanged(items.*)","_selectionEnabledChanged(selectionEnabled)","_multiSelectionChanged(multiSelection)","_setOverflow(scrollTarget, scrollOffset)"],behaviors:[Templatizer,IronResizableBehavior,IronScrollTargetBehavior,OptionalMutableDataBehavior],_ratio:.5,_scrollerPaddingTop:0,_scrollPosition:0,_physicalSize:0,_physicalAverage:0,_physicalAverageCount:0,_physicalTop:0,_virtualCount:0,_estScrollHeight:0,_scrollHeight:0,_viewportHeight:0,_viewportWidth:0,_physicalItems:null,_physicalSizes:null,_firstVisibleIndexVal:null,_lastVisibleIndexVal:null,_maxPages:2,_focusedItem:null,_focusedVirtualIndex:-1,_focusedPhysicalIndex:-1,_offscreenFocusedItem:null,_focusBackfillItem:null,_itemsPerRow:1,_itemWidth:0,_rowHeight:0,_templateCost:0,_parentModel:!0,get _physicalBottom(){return this._physicalTop+this._physicalSize},get _scrollBottom(){return this._scrollPosition+this._viewportHeight},get _virtualEnd(){return this._virtualStart+this._physicalCount-1},get _hiddenContentSize(){return(this.grid?this._physicalRows*this._rowHeight:this._physicalSize)-this._viewportHeight},get _itemsParent(){return dom(dom(this._userTemplate).parentNode)},get _maxScrollTop(){return this._estScrollHeight-this._viewportHeight+this._scrollOffset},get _maxVirtualStart(){var virtualCount=this._convertIndexToCompleteRow(this._virtualCount);return Math.max(0,virtualCount-this._physicalCount)},set _virtualStart(val){val=this._clamp(val,0,this._maxVirtualStart),this.grid&&(val-=val%this._itemsPerRow),this._virtualStartVal=val},get _virtualStart(){return this._virtualStartVal||0},set _physicalStart(val){(val%=this._physicalCount)<0&&(val=this._physicalCount+val),this.grid&&(val-=val%this._itemsPerRow),this._physicalStartVal=val},get _physicalStart(){return this._physicalStartVal||0},get _physicalEnd(){return(this._physicalStart+this._physicalCount-1)%this._physicalCount},set _physicalCount(val){this._physicalCountVal=val},get _physicalCount(){return this._physicalCountVal||0},get _optPhysicalSize(){return 0===this._viewportHeight?1/0:this._viewportHeight*this._maxPages},get _isVisible(){return Boolean(this.offsetWidth||this.offsetHeight)},get firstVisibleIndex(){var idx=this._firstVisibleIndexVal;if(null==idx){var physicalOffset=this._physicalTop+this._scrollOffset;idx=this._iterateItems((function(pidx,vidx){return(physicalOffset+=this._getPhysicalSizeIncrement(pidx))>this._scrollPosition?this.grid?vidx-vidx%this._itemsPerRow:vidx:this.grid&&this._virtualCount-1===vidx?vidx-vidx%this._itemsPerRow:void 0}))||0,this._firstVisibleIndexVal=idx}return idx},get lastVisibleIndex(){var idx=this._lastVisibleIndexVal;if(null==idx){if(this.grid)idx=Math.min(this._virtualCount,this.firstVisibleIndex+this._estRowsInView*this._itemsPerRow-1);else{var physicalOffset=this._physicalTop+this._scrollOffset;this._iterateItems((function(pidx,vidx){physicalOffset<this._scrollBottom&&(idx=vidx),physicalOffset+=this._getPhysicalSizeIncrement(pidx)}))}this._lastVisibleIndexVal=idx}return idx},get _defaultScrollTarget(){return this},get _virtualRowCount(){return Math.ceil(this._virtualCount/this._itemsPerRow)},get _estRowsInView(){return Math.ceil(this._viewportHeight/this._rowHeight)},get _physicalRows(){return Math.ceil(this._physicalCount/this._itemsPerRow)},get _scrollOffset(){return this._scrollerPaddingTop+this.scrollOffset},ready:function(){this.addEventListener("focus",this._didFocus.bind(this),!0)},attached:function(){this._debounce("_render",this._render,animationFrame),this.listen(this,"iron-resize","_resizeHandler"),this.listen(this,"keydown","_keydownHandler")},detached:function(){this.unlisten(this,"iron-resize","_resizeHandler"),this.unlisten(this,"keydown","_keydownHandler")},_setOverflow:function(scrollTarget){this.style.webkitOverflowScrolling=scrollTarget===this?"touch":"",this.style.overflowY=scrollTarget===this?"auto":"",this._lastVisibleIndexVal=null,this._firstVisibleIndexVal=null,this._debounce("_render",this._render,animationFrame)},updateViewportBoundaries:function(){var styles=window.getComputedStyle(this);this._scrollerPaddingTop=this.scrollTarget===this?0:parseInt(styles["padding-top"],10),this._isRTL=Boolean("rtl"===styles.direction),this._viewportWidth=this.$.items.offsetWidth,this._viewportHeight=this._scrollTargetHeight,this.grid&&this._updateGridMetrics()},_scrollHandler:function(){var scrollTop=Math.max(0,Math.min(this._maxScrollTop,this._scrollTop)),delta=scrollTop-this._scrollPosition,isScrollingDown=delta>=0;if(this._scrollPosition=scrollTop,this._firstVisibleIndexVal=null,this._lastVisibleIndexVal=null,Math.abs(delta)>this._physicalSize&&this._physicalSize>0){delta-=this._scrollOffset;var idxAdjustment=Math.round(delta/this._physicalAverage)*this._itemsPerRow;this._virtualStart=this._virtualStart+idxAdjustment,this._physicalStart=this._physicalStart+idxAdjustment,this._physicalTop=Math.floor(this._virtualStart/this._itemsPerRow)*this._physicalAverage,this._update()}else if(this._physicalCount>0){var reusables=this._getReusables(isScrollingDown);isScrollingDown?(this._physicalTop=reusables.physicalTop,this._virtualStart=this._virtualStart+reusables.indexes.length,this._physicalStart=this._physicalStart+reusables.indexes.length):(this._virtualStart=this._virtualStart-reusables.indexes.length,this._physicalStart=this._physicalStart-reusables.indexes.length),this._update(reusables.indexes,isScrollingDown?null:reusables.indexes),this._debounce("_increasePoolIfNeeded",this._increasePoolIfNeeded.bind(this,0),microTask)}},_getReusables:function(fromTop){var ith,offsetContent,physicalItemHeight,idxs=[],protectedOffsetContent=this._hiddenContentSize*this._ratio,virtualStart=this._virtualStart,virtualEnd=this._virtualEnd,physicalCount=this._physicalCount,top=this._physicalTop+this._scrollOffset,bottom=this._physicalBottom+this._scrollOffset,scrollTop=this._scrollTop,scrollBottom=this._scrollBottom;for(fromTop?(ith=this._physicalStart,this._physicalEnd,offsetContent=scrollTop-top):(ith=this._physicalEnd,this._physicalStart,offsetContent=bottom-scrollBottom);offsetContent-=physicalItemHeight=this._getPhysicalSizeIncrement(ith),!(idxs.length>=physicalCount||offsetContent<=protectedOffsetContent);)if(fromTop){if(virtualEnd+idxs.length+1>=this._virtualCount)break;if(top+physicalItemHeight>=scrollTop-this._scrollOffset)break;idxs.push(ith),top+=physicalItemHeight,ith=(ith+1)%physicalCount}else{if(virtualStart-idxs.length<=0)break;if(top+this._physicalSize-physicalItemHeight<=scrollBottom)break;idxs.push(ith),top-=physicalItemHeight,ith=0===ith?physicalCount-1:ith-1}return{indexes:idxs,physicalTop:top-this._scrollOffset}},_update:function(itemSet,movingUp){if(!(itemSet&&0===itemSet.length||0===this._physicalCount)){if(this._manageFocus(),this._assignModels(itemSet),this._updateMetrics(itemSet),movingUp)for(;movingUp.length;){var idx=movingUp.pop();this._physicalTop-=this._getPhysicalSizeIncrement(idx)}this._positionItems(),this._updateScrollerSize()}},_createPool:function(size){var i,inst;this._ensureTemplatized();var physicalItems=new Array(size);for(i=0;i<size;i++)inst=this.stamp(null),physicalItems[i]=inst.root.querySelector("*"),this._itemsParent.appendChild(inst.root);return physicalItems},_isClientFull:function(){return 0!=this._scrollBottom&&this._physicalBottom-1>=this._scrollBottom&&this._physicalTop<=this._scrollPosition},_increasePoolIfNeeded:function(count){var nextPhysicalCount=this._clamp(this._physicalCount+count,3,this._virtualCount-this._virtualStart);if(nextPhysicalCount=this._convertIndexToCompleteRow(nextPhysicalCount),this.grid){var correction=nextPhysicalCount%this._itemsPerRow;correction&&nextPhysicalCount-correction<=this._physicalCount&&(nextPhysicalCount+=this._itemsPerRow),nextPhysicalCount-=correction}var delta=nextPhysicalCount-this._physicalCount,nextIncrease=Math.round(.5*this._physicalCount);if(!(delta<0)){if(delta>0){var ts=window.performance.now();[].push.apply(this._physicalItems,this._createPool(delta));for(var i=0;i<delta;i++)this._physicalSizes.push(0);this._physicalCount=this._physicalCount+delta,this._physicalStart>this._physicalEnd&&this._isIndexRendered(this._focusedVirtualIndex)&&this._getPhysicalIndex(this._focusedVirtualIndex)<this._physicalEnd&&(this._physicalStart=this._physicalStart+delta),this._update(),this._templateCost=(window.performance.now()-ts)/delta,nextIncrease=Math.round(.5*this._physicalCount)}this._virtualEnd>=this._virtualCount-1||0===nextIncrease||(this._isClientFull()?this._physicalSize<this._optPhysicalSize&&this._debounce("_increasePoolIfNeeded",this._increasePoolIfNeeded.bind(this,this._clamp(Math.round(50/this._templateCost),1,nextIncrease)),idlePeriod):this._debounce("_increasePoolIfNeeded",this._increasePoolIfNeeded.bind(this,nextIncrease),microTask))}},_render:function(){if(this.isAttached&&this._isVisible)if(0!==this._physicalCount){var reusables=this._getReusables(!0);this._physicalTop=reusables.physicalTop,this._virtualStart=this._virtualStart+reusables.indexes.length,this._physicalStart=this._physicalStart+reusables.indexes.length,this._update(reusables.indexes),this._update(),this._increasePoolIfNeeded(0)}else this._virtualCount>0&&(this.updateViewportBoundaries(),this._increasePoolIfNeeded(3))},_ensureTemplatized:function(){if(!this.ctor){this._userTemplate=this.queryEffectiveChildren("template"),this._userTemplate||console.warn("iron-list requires a template to be provided in light-dom");var instanceProps={__key__:!0};instanceProps[this.as]=!0,instanceProps[this.indexAs]=!0,instanceProps[this.selectedAs]=!0,instanceProps.tabIndex=!0,this._instanceProps=instanceProps,this.templatize(this._userTemplate,this.mutableData)}},_gridChanged:function(newGrid,oldGrid){void 0!==oldGrid&&(this.notifyResize(),flush(),newGrid&&this._updateGridMetrics())},_itemsChanged:function(change){if("items"===change.path)this._virtualStart=0,this._physicalTop=0,this._virtualCount=this.items?this.items.length:0,this._physicalIndexForKey={},this._firstVisibleIndexVal=null,this._lastVisibleIndexVal=null,this._physicalCount=this._physicalCount||0,this._physicalItems=this._physicalItems||[],this._physicalSizes=this._physicalSizes||[],this._physicalStart=0,this._scrollTop>this._scrollOffset&&this._resetScrollPosition(0),this._removeFocusedItem(),this._debounce("_render",this._render,animationFrame);else if("items.splices"===change.path){if(this._adjustVirtualIndex(change.value.indexSplices),this._virtualCount=this.items?this.items.length:0,change.value.indexSplices.some((function(splice){return splice.addedCount>0||splice.removed.length>0}))){var activeElement=this._getActiveElement();this.contains(activeElement)&&activeElement.blur()}var affectedIndexRendered=change.value.indexSplices.some((function(splice){return splice.index+splice.addedCount>=this._virtualStart&&splice.index<=this._virtualEnd}),this);this._isClientFull()&&!affectedIndexRendered||this._debounce("_render",this._render,animationFrame)}else"items.length"!==change.path&&this._forwardItemPath(change.path,change.value)},_forwardItemPath:function(path,value){var isIndexRendered,pidx,inst,dot=(path=path.slice(6)).indexOf(".");-1===dot&&(dot=path.length);var offscreenInstance=this.modelForElement(this._offscreenFocusedItem),vidx=parseInt(path.substring(0,dot),10);(isIndexRendered=this._isIndexRendered(vidx))?(pidx=this._getPhysicalIndex(vidx),inst=this.modelForElement(this._physicalItems[pidx])):offscreenInstance&&(inst=offscreenInstance),inst&&inst[this.indexAs]===vidx&&(path=path.substring(dot+1),path=this.as+(path?"."+path:""),inst._setPendingPropertyOrPath(path,value,!1,!0),inst._flushProperties&&inst._flushProperties(!0),isIndexRendered&&(this._updateMetrics([pidx]),this._positionItems(),this._updateScrollerSize()))},_adjustVirtualIndex:function(splices){splices.forEach((function(splice){if(splice.removed.forEach(this._removeItem,this),splice.index<this._virtualStart){var delta=Math.max(splice.addedCount-splice.removed.length,splice.index-this._virtualStart);this._virtualStart=this._virtualStart+delta,this._focusedVirtualIndex>=0&&(this._focusedVirtualIndex=this._focusedVirtualIndex+delta)}}),this)},_removeItem:function(item){this.$.selector.deselect(item),this._focusedItem&&this.modelForElement(this._focusedItem)[this.as]===item&&this._removeFocusedItem()},_iterateItems:function(fn,itemSet){var pidx,vidx,rtn,i;if(2===arguments.length&&itemSet){for(i=0;i<itemSet.length;i++)if(pidx=itemSet[i],vidx=this._computeVidx(pidx),null!=(rtn=fn.call(this,pidx,vidx)))return rtn}else{for(pidx=this._physicalStart,vidx=this._virtualStart;pidx<this._physicalCount;pidx++,vidx++)if(null!=(rtn=fn.call(this,pidx,vidx)))return rtn;for(pidx=0;pidx<this._physicalStart;pidx++,vidx++)if(null!=(rtn=fn.call(this,pidx,vidx)))return rtn}},_computeVidx:function(pidx){return pidx>=this._physicalStart?this._virtualStart+(pidx-this._physicalStart):this._virtualStart+(this._physicalCount-this._physicalStart)+pidx},_assignModels:function(itemSet){this._iterateItems((function(pidx,vidx){var el=this._physicalItems[pidx],item=this.items&&this.items[vidx];if(null!=item){var inst=this.modelForElement(el);inst.__key__=null,this._forwardProperty(inst,this.as,item),this._forwardProperty(inst,this.selectedAs,this.$.selector.isSelected(item)),this._forwardProperty(inst,this.indexAs,vidx),this._forwardProperty(inst,"tabIndex",this._focusedVirtualIndex===vidx?0:-1),this._physicalIndexForKey[inst.__key__]=pidx,inst._flushProperties&&inst._flushProperties(!0),el.removeAttribute("hidden")}else el.setAttribute("hidden","")}),itemSet)},_updateMetrics:function(itemSet){flush();var newPhysicalSize=0,oldPhysicalSize=0,prevAvgCount=this._physicalAverageCount,prevPhysicalAvg=this._physicalAverage;this._iterateItems((function(pidx,vidx){oldPhysicalSize+=this._physicalSizes[pidx],this._physicalSizes[pidx]=this._physicalItems[pidx].offsetHeight,newPhysicalSize+=this._physicalSizes[pidx],this._physicalAverageCount+=this._physicalSizes[pidx]?1:0}),itemSet),this.grid?(this._updateGridMetrics(),this._physicalSize=Math.ceil(this._physicalCount/this._itemsPerRow)*this._rowHeight):(oldPhysicalSize=1===this._itemsPerRow?oldPhysicalSize:Math.ceil(this._physicalCount/this._itemsPerRow)*this._rowHeight,this._physicalSize=this._physicalSize+newPhysicalSize-oldPhysicalSize,this._itemsPerRow=1),this._physicalAverageCount!==prevAvgCount&&(this._physicalAverage=Math.round((prevPhysicalAvg*prevAvgCount+newPhysicalSize)/this._physicalAverageCount))},_updateGridMetrics:function(){this._itemWidth=this._physicalCount>0?this._physicalItems[0].getBoundingClientRect().width:200,this._rowHeight=this._physicalCount>0?this._physicalItems[0].offsetHeight:200,this._itemsPerRow=this._itemWidth?Math.floor(this._viewportWidth/this._itemWidth):this._itemsPerRow},_positionItems:function(){this._adjustScrollPosition();var y=this._physicalTop;if(this.grid){var totalItemWidth=this._itemsPerRow*this._itemWidth,rowOffset=(this._viewportWidth-totalItemWidth)/2;this._iterateItems((function(pidx,vidx){var modulus=vidx%this._itemsPerRow,x=Math.floor(modulus*this._itemWidth+rowOffset);this._isRTL&&(x*=-1),this.translate3d(x+"px",y+"px",0,this._physicalItems[pidx]),this._shouldRenderNextRow(vidx)&&(y+=this._rowHeight)}))}else this._iterateItems((function(pidx,vidx){this.translate3d(0,y+"px",0,this._physicalItems[pidx]),y+=this._physicalSizes[pidx]}))},_getPhysicalSizeIncrement:function(pidx){return this.grid?this._computeVidx(pidx)%this._itemsPerRow!=this._itemsPerRow-1?0:this._rowHeight:this._physicalSizes[pidx]},_shouldRenderNextRow:function(vidx){return vidx%this._itemsPerRow==this._itemsPerRow-1},_adjustScrollPosition:function(){var deltaHeight=0===this._virtualStart?this._physicalTop:Math.min(this._scrollPosition+this._physicalTop,0);if(0!==deltaHeight){this._physicalTop=this._physicalTop-deltaHeight;var scrollTop=this._scrollTop;!IOS_TOUCH_SCROLLING&&scrollTop>0&&this._resetScrollPosition(scrollTop-deltaHeight)}},_resetScrollPosition:function(pos){this.scrollTarget&&pos>=0&&(this._scrollTop=pos,this._scrollPosition=this._scrollTop)},_updateScrollerSize:function(forceUpdate){this.grid?this._estScrollHeight=this._virtualRowCount*this._rowHeight:this._estScrollHeight=this._physicalBottom+Math.max(this._virtualCount-this._physicalCount-this._virtualStart,0)*this._physicalAverage,((forceUpdate=(forceUpdate=(forceUpdate=forceUpdate||0===this._scrollHeight)||this._scrollPosition>=this._estScrollHeight-this._physicalSize)||this.grid&&this.$.items.style.height<this._estScrollHeight)||Math.abs(this._estScrollHeight-this._scrollHeight)>=this._viewportHeight)&&(this.$.items.style.height=this._estScrollHeight+"px",this._scrollHeight=this._estScrollHeight)},scrollToItem:function(item){return this.scrollToIndex(this.items.indexOf(item))},scrollToIndex:function(idx){if(!("number"!=typeof idx||idx<0||idx>this.items.length-1)&&(flush(),0!==this._physicalCount)){idx=this._clamp(idx,0,this._virtualCount-1),(!this._isIndexRendered(idx)||idx>=this._maxVirtualStart)&&(this._virtualStart=this.grid?idx-2*this._itemsPerRow:idx-1),this._manageFocus(),this._assignModels(),this._updateMetrics(),this._physicalTop=Math.floor(this._virtualStart/this._itemsPerRow)*this._physicalAverage;for(var currentTopItem=this._physicalStart,currentVirtualItem=this._virtualStart,targetOffsetTop=0,hiddenContentSize=this._hiddenContentSize;currentVirtualItem<idx&&targetOffsetTop<=hiddenContentSize;)targetOffsetTop+=this._getPhysicalSizeIncrement(currentTopItem),currentTopItem=(currentTopItem+1)%this._physicalCount,currentVirtualItem++;this._updateScrollerSize(!0),this._positionItems(),this._resetScrollPosition(this._physicalTop+this._scrollOffset+targetOffsetTop),this._increasePoolIfNeeded(0),this._firstVisibleIndexVal=null,this._lastVisibleIndexVal=null}},_resetAverage:function(){this._physicalAverage=0,this._physicalAverageCount=0},_resizeHandler:function(){this._debounce("_render",(function(){this._firstVisibleIndexVal=null,this._lastVisibleIndexVal=null,this._isVisible?(this.updateViewportBoundaries(),this.toggleScrollListener(!0),this._resetAverage(),this._render()):this.toggleScrollListener(!1)}),animationFrame)},selectItem:function(item){return this.selectIndex(this.items.indexOf(item))},selectIndex:function(index){if(!(index<0||index>=this._virtualCount)){if(!this.multiSelection&&this.selectedItem&&this.clearSelection(),this._isIndexRendered(index)){var model=this.modelForElement(this._physicalItems[this._getPhysicalIndex(index)]);model&&(model[this.selectedAs]=!0),this.updateSizeForIndex(index)}this.$.selector.selectIndex(index)}},deselectItem:function(item){return this.deselectIndex(this.items.indexOf(item))},deselectIndex:function(index){if(!(index<0||index>=this._virtualCount)){if(this._isIndexRendered(index))this.modelForElement(this._physicalItems[this._getPhysicalIndex(index)])[this.selectedAs]=!1,this.updateSizeForIndex(index);this.$.selector.deselectIndex(index)}},toggleSelectionForItem:function(item){return this.toggleSelectionForIndex(this.items.indexOf(item))},toggleSelectionForIndex:function(index){(this.$.selector.isIndexSelected?this.$.selector.isIndexSelected(index):this.$.selector.isSelected(this.items[index]))?this.deselectIndex(index):this.selectIndex(index)},clearSelection:function(){this._iterateItems((function(pidx,vidx){this.modelForElement(this._physicalItems[pidx])[this.selectedAs]=!1})),this.$.selector.clearSelection()},_selectionEnabledChanged:function(selectionEnabled){(selectionEnabled?this.listen:this.unlisten).call(this,this,"tap","_selectionHandler")},_selectionHandler:function(e){var model=this.modelForElement(e.target);if(model){var modelTabIndex,activeElTabIndex,target=dom(e).path[0],activeEl=this._getActiveElement(),physicalItem=this._physicalItems[this._getPhysicalIndex(model[this.indexAs])];"input"!==target.localName&&"button"!==target.localName&&"select"!==target.localName&&(modelTabIndex=model.tabIndex,model.tabIndex=-100,activeElTabIndex=activeEl?activeEl.tabIndex:-1,model.tabIndex=modelTabIndex,activeEl&&physicalItem!==activeEl&&physicalItem.contains(activeEl)&&-100!==activeElTabIndex||this.toggleSelectionForItem(model[this.as]))}},_multiSelectionChanged:function(multiSelection){this.clearSelection(),this.$.selector.multi=multiSelection},updateSizeForItem:function(item){return this.updateSizeForIndex(this.items.indexOf(item))},updateSizeForIndex:function(index){return this._isIndexRendered(index)?(this._updateMetrics([this._getPhysicalIndex(index)]),this._positionItems(),null):null},_manageFocus:function(){var fidx=this._focusedVirtualIndex;fidx>=0&&fidx<this._virtualCount?this._isIndexRendered(fidx)?this._restoreFocusedItem():this._createFocusBackfillItem():this._virtualCount>0&&this._physicalCount>0&&(this._focusedPhysicalIndex=this._physicalStart,this._focusedVirtualIndex=this._virtualStart,this._focusedItem=this._physicalItems[this._physicalStart])},_convertIndexToCompleteRow:function(idx){return this._itemsPerRow=this._itemsPerRow||1,this.grid?Math.ceil(idx/this._itemsPerRow)*this._itemsPerRow:idx},_isIndexRendered:function(idx){return idx>=this._virtualStart&&idx<=this._virtualEnd},_isIndexVisible:function(idx){return idx>=this.firstVisibleIndex&&idx<=this.lastVisibleIndex},_getPhysicalIndex:function(vidx){return(this._physicalStart+(vidx-this._virtualStart))%this._physicalCount},focusItem:function(idx){this._focusPhysicalItem(idx)},_focusPhysicalItem:function(idx){if(!(idx<0||idx>=this._virtualCount)){this._restoreFocusedItem(),this._isIndexRendered(idx)||this.scrollToIndex(idx);var focusable,physicalItem=this._physicalItems[this._getPhysicalIndex(idx)],model=this.modelForElement(physicalItem);model.tabIndex=-100,-100===physicalItem.tabIndex&&(focusable=physicalItem),focusable||(focusable=dom(physicalItem).querySelector('[tabindex="-100"]')),model.tabIndex=0,this._focusedVirtualIndex=idx,focusable&&focusable.focus()}},_removeFocusedItem:function(){this._offscreenFocusedItem&&this._itemsParent.removeChild(this._offscreenFocusedItem),this._offscreenFocusedItem=null,this._focusBackfillItem=null,this._focusedItem=null,this._focusedVirtualIndex=-1,this._focusedPhysicalIndex=-1},_createFocusBackfillItem:function(){var fpidx=this._focusedPhysicalIndex;if(!(this._offscreenFocusedItem||this._focusedVirtualIndex<0)){if(!this._focusBackfillItem){var inst=this.stamp(null);this._focusBackfillItem=inst.root.querySelector("*"),this._itemsParent.appendChild(inst.root)}this._offscreenFocusedItem=this._physicalItems[fpidx],this.modelForElement(this._offscreenFocusedItem).tabIndex=0,this._physicalItems[fpidx]=this._focusBackfillItem,this._focusedPhysicalIndex=fpidx,this.translate3d(0,"-10000px",0,this._offscreenFocusedItem)}},_restoreFocusedItem:function(){if(this._offscreenFocusedItem&&!(this._focusedVirtualIndex<0)){this._assignModels();var fpidx=this._focusedPhysicalIndex=this._getPhysicalIndex(this._focusedVirtualIndex),onScreenItem=this._physicalItems[fpidx];if(onScreenItem){var onScreenInstance=this.modelForElement(onScreenItem),offScreenInstance=this.modelForElement(this._offscreenFocusedItem);onScreenInstance[this.as]===offScreenInstance[this.as]?(this._focusBackfillItem=onScreenItem,onScreenInstance.tabIndex=-1,this._physicalItems[fpidx]=this._offscreenFocusedItem,this.translate3d(0,"-10000px",0,this._focusBackfillItem)):(this._removeFocusedItem(),this._focusBackfillItem=null),this._offscreenFocusedItem=null}}},_didFocus:function(e){var targetModel=this.modelForElement(e.target),focusedModel=this.modelForElement(this._focusedItem),hasOffscreenFocusedItem=null!==this._offscreenFocusedItem,fidx=this._focusedVirtualIndex;targetModel&&(focusedModel===targetModel?this._isIndexVisible(fidx)||this.scrollToIndex(fidx):(this._restoreFocusedItem(),focusedModel&&(focusedModel.tabIndex=-1),targetModel.tabIndex=0,fidx=targetModel[this.indexAs],this._focusedVirtualIndex=fidx,this._focusedPhysicalIndex=this._getPhysicalIndex(fidx),this._focusedItem=this._physicalItems[this._focusedPhysicalIndex],hasOffscreenFocusedItem&&!this._offscreenFocusedItem&&this._update()))},_keydownHandler:function(e){switch(e.keyCode){case 40:this._focusedVirtualIndex<this._virtualCount-1&&e.preventDefault(),this._focusPhysicalItem(this._focusedVirtualIndex+(this.grid?this._itemsPerRow:1));break;case 39:this.grid&&this._focusPhysicalItem(this._focusedVirtualIndex+(this._isRTL?-1:1));break;case 38:this._focusedVirtualIndex>0&&e.preventDefault(),this._focusPhysicalItem(this._focusedVirtualIndex-(this.grid?this._itemsPerRow:1));break;case 37:this.grid&&this._focusPhysicalItem(this._focusedVirtualIndex+(this._isRTL?1:-1));break;case 13:this._focusPhysicalItem(this._focusedVirtualIndex),this.selectionEnabled&&this._selectionHandler(e)}},_clamp:function(v,min,max){return Math.min(max,Math.max(min,v))},_debounce:function(name,cb,asyncModule){this._debouncers=this._debouncers||{},this._debouncers[name]=Debouncer.debounce(this._debouncers[name],asyncModule,cb.bind(this)),enqueueDebouncer(this._debouncers[name])},_forwardProperty:function(inst,name,value){inst._setPendingProperty(name,value)},_forwardHostPropV2:function(prop,value){(this._physicalItems||[]).concat([this._offscreenFocusedItem,this._focusBackfillItem]).forEach((function(item){item&&this.modelForElement(item).forwardHostProp(prop,value)}),this)},_notifyInstancePropV2:function(inst,prop,value){if(matches(this.as,prop)){var idx=inst[this.indexAs];prop==this.as&&(this.items[idx]=value),this.notifyPath(translate(this.as,"items."+idx,prop),value)}},_getStampedChildren:function(){return this._physicalItems},_forwardInstancePath:function(inst,path,value){0===path.indexOf(this.as+".")&&this.notifyPath("items."+inst.__key__+"."+path.slice(this.as.length+1),value)},_forwardParentPath:function(path,value){(this._physicalItems||[]).concat([this._offscreenFocusedItem,this._focusBackfillItem]).forEach((function(item){item&&this.modelForElement(item).notifyPath(path,value,!0)}),this)},_forwardParentProp:function(prop,value){(this._physicalItems||[]).concat([this._offscreenFocusedItem,this._focusBackfillItem]).forEach((function(item){item&&(this.modelForElement(item)[prop]=value)}),this)},_getActiveElement:function(){var itemsHost=this._itemsParent.node.domHost;return dom(itemsHost?itemsHost.root:document).activeElement}});