/**
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at
http://polymer.github.io/LICENSE.txt The complete set of authors may be found at
http://polymer.github.io/AUTHORS.txt The complete set of contributors may be
found at http://polymer.github.io/CONTRIBUTORS.txt Code distributed by Google as
part of the polymer project is also subject to an additional IP rights grant
found at http://polymer.github.io/PATENTS.txt
*/
import{Polymer}from"../polymer/lib/legacy/polymer-fn.js";import{Base}from"../polymer/polymer-legacy.js";Polymer({is:"iron-request",hostAttributes:{hidden:!0},properties:{xhr:{type:Object,notify:!0,readOnly:!0,value:function(){return new XMLHttpRequest}},response:{type:Object,notify:!0,readOnly:!0,value:function(){return null}},status:{type:Number,notify:!0,readOnly:!0,value:0},statusText:{type:String,notify:!0,readOnly:!0,value:""},completes:{type:Object,readOnly:!0,notify:!0,value:function(){return new Promise(function(resolve,reject){this.resolveCompletes=resolve,this.rejectCompletes=reject}.bind(this))}},progress:{type:Object,notify:!0,readOnly:!0,value:function(){return{}}},aborted:{type:Boolean,notify:!0,readOnly:!0,value:!1},errored:{type:Boolean,notify:!0,readOnly:!0,value:!1},timedOut:{type:Boolean,notify:!0,readOnly:!0,value:!1}},get succeeded(){if(this.errored||this.aborted||this.timedOut)return!1;var status=this.xhr.status||0;return 0===status||status>=200&&status<300},send:function(options){var xhr=this.xhr;if(xhr.readyState>0)return null;xhr.addEventListener("progress",function(progress){this._setProgress({lengthComputable:progress.lengthComputable,loaded:progress.loaded,total:progress.total}),this.fire("iron-request-progress-changed",{value:this.progress})}.bind(this)),xhr.addEventListener("error",function(error){this._setErrored(!0),this._updateStatus();var response=options.rejectWithRequest?{error,request:this}:error;this.rejectCompletes(response)}.bind(this)),xhr.addEventListener("timeout",function(error){this._setTimedOut(!0),this._updateStatus();var response=options.rejectWithRequest?{error,request:this}:error;this.rejectCompletes(response)}.bind(this)),xhr.addEventListener("abort",function(){this._setAborted(!0),this._updateStatus();var error=new Error("Request aborted."),response=options.rejectWithRequest?{error,request:this}:error;this.rejectCompletes(response)}.bind(this)),xhr.addEventListener("loadend",function(){if(this._updateStatus(),this._setResponse(this.parseResponse()),this.succeeded)this.resolveCompletes(this);else{var error=new Error("The request failed with status code: "+this.xhr.status),response=options.rejectWithRequest?{error,request:this}:error;this.rejectCompletes(response)}}.bind(this)),this.url=options.url;var isXHRAsync=!1!==options.async;xhr.open(options.method||"GET",options.url,isXHRAsync);var acceptType={json:"application/json",text:"text/plain",html:"text/html",xml:"application/xml",arraybuffer:"application/octet-stream"}[options.handleAs],headers=options.headers||Object.create(null),newHeaders=Object.create(null);for(var key in headers)newHeaders[key.toLowerCase()]=headers[key];if(headers=newHeaders,acceptType&&!headers.accept&&(headers.accept=acceptType),Object.keys(headers).forEach((function(requestHeader){/[A-Z]/.test(requestHeader)&&Base._error("Headers must be lower case, got",requestHeader),xhr.setRequestHeader(requestHeader,headers[requestHeader])}),this),isXHRAsync){xhr.timeout=options.timeout;var handleAs=options.handleAs;!options.jsonPrefix&&handleAs||(handleAs="text"),xhr.responseType=xhr._responseType=handleAs,options.jsonPrefix&&(xhr._jsonPrefix=options.jsonPrefix)}xhr.withCredentials=!!options.withCredentials;var body=this._encodeBodyObject(options.body,headers["content-type"]);return xhr.send(body),this.completes},parseResponse:function(){var xhr=this.xhr,responseType=xhr.responseType||xhr._responseType,preferResponseText=!this.xhr.responseType,prefixLen=xhr._jsonPrefix&&xhr._jsonPrefix.length||0;try{switch(responseType){case"json":if(preferResponseText||void 0===xhr.response)try{return JSON.parse(xhr.responseText)}catch(_){return console.warn("Failed to parse JSON sent from "+xhr.responseURL),null}return xhr.response;case"xml":return xhr.responseXML;case"blob":case"document":case"arraybuffer":return xhr.response;case"text":default:if(prefixLen)try{return JSON.parse(xhr.responseText.substring(prefixLen))}catch(_){return console.warn("Failed to parse JSON sent from "+xhr.responseURL),null}return xhr.responseText}}catch(e){this.rejectCompletes(new Error("Could not parse response. "+e.message))}},abort:function(){this._setAborted(!0),this.xhr.abort()},_encodeBodyObject:function(body,contentType){if("string"==typeof body)return body;var bodyObj=body;switch(contentType){case"application/json":return JSON.stringify(bodyObj);case"application/x-www-form-urlencoded":return this._wwwFormUrlEncode(bodyObj)}return body},_wwwFormUrlEncode:function(object){if(!object)return"";var pieces=[];return Object.keys(object).forEach((function(key){pieces.push(this._wwwFormUrlEncodePiece(key)+"="+this._wwwFormUrlEncodePiece(object[key]))}),this),pieces.join("&")},_wwwFormUrlEncodePiece:function(str){return null!=str&&str.toString?encodeURIComponent(str.toString().replace(/\r?\n/g,"\r\n")).replace(/%20/g,"+"):""},_updateStatus:function(){this._setStatus(this.xhr.status),this._setStatusText(void 0===this.xhr.statusText?"":this.xhr.statusText)}});