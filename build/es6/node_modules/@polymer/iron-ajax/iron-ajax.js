/**
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at
http://polymer.github.io/LICENSE.txt The complete set of authors may be found at
http://polymer.github.io/AUTHORS.txt The complete set of contributors may be
found at http://polymer.github.io/CONTRIBUTORS.txt Code distributed by Google as
part of the polymer project is also subject to an additional IP rights grant
found at http://polymer.github.io/PATENTS.txt
*/
import"./iron-request.js";import{Polymer}from"../polymer/lib/legacy/polymer-fn.js";import{Base}from"../polymer/polymer-legacy.js";Polymer({is:"iron-ajax",hostAttributes:{hidden:!0},properties:{url:{type:String},params:{type:Object,value:function(){return{}}},method:{type:String,value:"GET"},headers:{type:Object,value:function(){return{}}},contentType:{type:String,value:null},body:{type:Object,value:null},sync:{type:Boolean,value:!1},handleAs:{type:String,value:"json"},withCredentials:{type:Boolean,value:!1},timeout:{type:Number,value:0},auto:{type:Boolean,value:!1},verbose:{type:Boolean,value:!1},lastRequest:{type:Object,notify:!0,readOnly:!0},lastProgress:{type:Object,notify:!0,readOnly:!0},loading:{type:Boolean,notify:!0,readOnly:!0},lastResponse:{type:Object,notify:!0,readOnly:!0},lastError:{type:Object,notify:!0,readOnly:!0},activeRequests:{type:Array,notify:!0,readOnly:!0,value:function(){return[]}},debounceDuration:{type:Number,value:0,notify:!0},jsonPrefix:{type:String,value:""},bubbles:{type:Boolean,value:!1},rejectWithRequest:{type:Boolean,value:!1},_boundHandleResponse:{type:Function,value:function(){return this._handleResponse.bind(this)}}},observers:["_requestOptionsChanged(url, method, params.*, headers, contentType, body, sync, handleAs, jsonPrefix, withCredentials, timeout, auto)"],created:function(){this._boundOnProgressChanged=this._onProgressChanged.bind(this)},get queryString(){var param,value,queryParts=[];for(param in this.params)if(value=this.params[param],param=window.encodeURIComponent(param),Array.isArray(value))for(var i=0;i<value.length;i++)queryParts.push(param+"="+window.encodeURIComponent(value[i]));else null!==value?queryParts.push(param+"="+window.encodeURIComponent(value)):queryParts.push(param);return queryParts.join("&")},get requestUrl(){var queryString=this.queryString,url=this.url||"";if(queryString){var bindingChar=url.indexOf("?")>=0?"&":"?";return url+bindingChar+queryString}return url},get requestHeaders(){var header,headers={},contentType=this.contentType;if(null==contentType&&"string"==typeof this.body&&(contentType="application/x-www-form-urlencoded"),contentType&&(headers["content-type"]=contentType),"object"==typeof this.headers)for(header in this.headers)headers[header]=this.headers[header].toString();return headers},_onProgressChanged:function(event){this._setLastProgress(event.detail.value)},toRequestOptions:function(){return{url:this.requestUrl||"",method:this.method,headers:this.requestHeaders,body:this.body,async:!this.sync,handleAs:this.handleAs,jsonPrefix:this.jsonPrefix,withCredentials:this.withCredentials,timeout:this.timeout,rejectWithRequest:this.rejectWithRequest}},generateRequest:function(){var request=document.createElement("iron-request"),requestOptions=this.toRequestOptions();return this.push("activeRequests",request),request.completes.then(this._boundHandleResponse).catch(this._handleError.bind(this,request)).then(this._discardRequest.bind(this,request)),this.fire("iron-ajax-presend",{request,options:requestOptions},{bubbles:this.bubbles,cancelable:!0}).defaultPrevented?(request.abort(),request.rejectCompletes(request),request):(this.lastRequest&&this.lastRequest.removeEventListener("iron-request-progress-changed",this._boundOnProgressChanged),request.addEventListener("iron-request-progress-changed",this._boundOnProgressChanged),request.send(requestOptions),this._setLastProgress(null),this._setLastRequest(request),this._setLoading(!0),this.fire("request",{request,options:requestOptions},{bubbles:this.bubbles,composed:!0}),this.fire("iron-ajax-request",{request,options:requestOptions},{bubbles:this.bubbles,composed:!0}),request)},_handleResponse:function(request){request===this.lastRequest&&(this._setLastResponse(request.response),this._setLastError(null),this._setLoading(!1)),this.fire("response",request,{bubbles:this.bubbles,composed:!0}),this.fire("iron-ajax-response",request,{bubbles:this.bubbles,composed:!0})},_handleError:function(request,error){this.verbose&&Base._error(error),request===this.lastRequest&&(this._setLastError({request,error,status:request.xhr.status,statusText:request.xhr.statusText,response:request.xhr.response}),this._setLastResponse(null),this._setLoading(!1)),this.fire("iron-ajax-error",{request,error},{bubbles:this.bubbles,composed:!0}),this.fire("error",{request,error},{bubbles:this.bubbles,composed:!0})},_discardRequest:function(request){var requestIndex=this.activeRequests.indexOf(request);requestIndex>-1&&this.splice("activeRequests",requestIndex,1)},_requestOptionsChanged:function(){this.debounce("generate-request",(function(){null!=this.url&&this.auto&&this.generateRequest()}),this.debounceDuration)}});