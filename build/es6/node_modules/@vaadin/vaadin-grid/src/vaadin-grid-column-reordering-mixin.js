import{GestureEventListeners}from"../../../@polymer/polymer/lib/mixins/gesture-event-listeners.js";import{addListener}from"../../../@polymer/polymer/lib/utils/gestures.js";import{dom}from"../../../@polymer/polymer/lib/legacy/polymer.dom.js";import{useShadow}from"../../../@polymer/polymer/lib/utils/settings.js";export const ColumnReorderingMixin=superClass=>(class ColumnReorderingMixin extends(GestureEventListeners(superClass)){static get properties(){return{columnReorderingAllowed:{type:Boolean,value:!1},_orderBaseScope:{type:Number,value:1e7}}}static get observers(){return["_updateOrders(_columnTree, _columnTree.*)"]}ready(){super.ready(),addListener(this,"track",this._onTrackEvent),this._reorderGhost=this.shadowRoot.querySelector('[part="reorder-ghost"]'),this.addEventListener("touchstart",this._onTouchStart.bind(this)),this.addEventListener("touchmove",this._onTouchMove.bind(this)),this.addEventListener("touchend",this._onTouchEnd.bind(this)),this.addEventListener("contextmenu",this._onContextMenu.bind(this))}_onContextMenu(e){this.hasAttribute("reordering")&&e.preventDefault()}_onTouchStart(e){this._startTouchReorderTimeout=setTimeout(()=>{this._onTrackStart({detail:{x:e.touches[0].clientX,y:e.touches[0].clientY}})},100)}_onTouchMove(e){this._draggedColumn&&e.preventDefault(),clearTimeout(this._startTouchReorderTimeout)}_onTouchEnd(){clearTimeout(this._startTouchReorderTimeout),this._onTrackEnd()}_onTrackEvent(e){if("start"===e.detail.state){const path=e.composedPath(),headerCell=path[path.indexOf(this.$.header)-2];if(!headerCell||!headerCell._content)return;const activeElement=this.getRootNode().activeElement;if(headerCell._content.contains(this.getRootNode().activeElement)&&(!this._ie||!this._isFocusable(activeElement)))return;if(this.$.scroller.hasAttribute("column-resizing"))return;this._touchDevice||this._onTrackStart(e)}else"track"===e.detail.state?this._onTrack(e):"end"===e.detail.state&&this._onTrackEnd(e)}_onTrackStart(e){if(!this.columnReorderingAllowed)return;const path=e.path||dom(e).path;if(path&&path.filter(node=>node.hasAttribute&&node.hasAttribute("draggable"))[0])return;const headerCell=this._cellFromPoint(e.detail.x,e.detail.y);if(headerCell&&-1!==headerCell.getAttribute("part").indexOf("header-cell")){for(this._toggleAttribute("reordering",!0,this),this._draggedColumn=headerCell._column;1===this._draggedColumn.parentElement.childElementCount;)this._draggedColumn=this._draggedColumn.parentElement;this._setSiblingsReorderStatus(this._draggedColumn,"allowed"),this._draggedColumn._reorderStatus="dragging",this._updateGhost(headerCell),this._reorderGhost.style.visibility="visible",this._updateGhostPosition(e.detail.x,this._touchDevice?e.detail.y-50:e.detail.y),this._autoScroller()}}_onTrack(e){if(!this._draggedColumn)return;const targetCell=this._cellFromPoint(e.detail.x,e.detail.y);if(!targetCell)return;const targetColumn=this._getTargetColumn(targetCell,this._draggedColumn);this._isSwapAllowed(this._draggedColumn,targetColumn)&&this._isSwappableByPosition(targetColumn,e.detail.x)&&this._swapColumnOrders(this._draggedColumn,targetColumn),this._updateGhostPosition(e.detail.x,this._touchDevice?e.detail.y-50:e.detail.y),this._lastDragClientX=e.detail.x}_onTrackEnd(){this._draggedColumn&&(this._toggleAttribute("reordering",!1,this),this._draggedColumn._reorderStatus="",this._setSiblingsReorderStatus(this._draggedColumn,""),this._draggedColumn=null,this._lastDragClientX=null,this._reorderGhost.style.visibility="hidden")}_cellFromPoint(x,y){let cell;if(x=x||0,y=y||0,this._draggedColumn||this._toggleAttribute("no-content-pointer-events",!0,this.$.scroller),useShadow?cell=this.shadowRoot.elementFromPoint(x,y):"vaadin-grid-cell-content"===(cell=document.elementFromPoint(x,y)).localName&&(cell=cell.assignedSlot.parentNode),this._toggleAttribute("no-content-pointer-events",!1,this.$.scroller),cell&&cell._column)return cell}_updateGhostPosition(eventClientX,eventClientY){const ghostRect=this._reorderGhost.getBoundingClientRect(),targetLeft=eventClientX-ghostRect.width/2,targetTop=eventClientY-ghostRect.height/2,_left=parseInt(this._reorderGhost._left||0),_top=parseInt(this._reorderGhost._top||0);this._reorderGhost._left=_left-(ghostRect.left-targetLeft),this._reorderGhost._top=_top-(ghostRect.top-targetTop),this._reorderGhost.style.transform=`translate(${this._reorderGhost._left}px, ${this._reorderGhost._top}px)`}_getInnerText(e){return e.localName?"none"===getComputedStyle(e).display?"":Array.from(e.childNodes).map(n=>this._getInnerText(n)).join(""):e.textContent}_updateGhost(cell){const ghost=this._reorderGhost;ghost.textContent=this._getInnerText(cell._content);const style=window.getComputedStyle(cell);return["boxSizing","display","width","height","background","alignItems","padding","border","flex-direction","overflow"].forEach(propertyName=>ghost.style[propertyName]=style[propertyName]),ghost}_updateOrders(columnTree,splices){void 0!==columnTree&&void 0!==splices&&columnTree[0].forEach((column,index)=>column._order=(index+1)*this._orderBaseScope)}_setSiblingsReorderStatus(column,status){Array.from(column.parentNode.children).filter(child=>/column/.test(child.localName)&&this._isSwapAllowed(child,column)).forEach(sibling=>sibling._reorderStatus=status)}_autoScroller(){if(this._lastDragClientX){const rightDiff=this._lastDragClientX-this.getBoundingClientRect().right+50,leftDiff=this.getBoundingClientRect().left-this._lastDragClientX+50;rightDiff>0?this.$.table.scrollLeft+=rightDiff/10:leftDiff>0&&(this.$.table.scrollLeft-=leftDiff/10),this._scrollHandler()}this._draggedColumn&&this.async(this._autoScroller,10)}_isSwapAllowed(column1,column2){if(column1&&column2){const differentColumns=column1!==column2,sameParent=column1.parentElement===column2.parentElement,sameFrozen=column1.frozen===column2.frozen;return differentColumns&&sameParent&&sameFrozen}}_isSwappableByPosition(targetColumn,clientX){const targetCell=Array.from(this.$.header.querySelectorAll('tr:not([hidden]) [part~="cell"]')).filter(cell=>targetColumn.contains(cell._column))[0],sourceCellRect=this.$.header.querySelector("tr:not([hidden]) [reorder-status=dragging]").getBoundingClientRect(),targetRect=targetCell.getBoundingClientRect();return targetRect.left>sourceCellRect.left?clientX>targetRect.right-sourceCellRect.width:clientX<targetRect.left+sourceCellRect.width}_swapColumnOrders(column1,column2){const _order=column1._order;column1._order=column2._order,column2._order=_order,this._updateLastFrozen(),this._updateFirstAndLastColumn()}_getTargetColumn(targetCell,draggedColumn){if(targetCell&&draggedColumn){let candidate=targetCell._column;for(;candidate.parentElement!==draggedColumn.parentElement&&candidate!==this;)candidate=candidate.parentElement;return candidate.parentElement===draggedColumn.parentElement?candidate:targetCell._column}}});