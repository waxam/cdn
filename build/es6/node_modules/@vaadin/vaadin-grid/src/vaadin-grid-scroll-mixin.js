import{Debouncer}from"../../../@polymer/polymer/lib/utils/debounce.js";import{timeOut,animationFrame,microTask}from"../../../@polymer/polymer/lib/utils/async.js";export const ScrollMixin=superClass=>(class ScrollMixin extends superClass{get _timeouts(){return{SCROLL_PERIOD:1e3,WHEEL_SCROLLING:200,SCROLLING:100,IGNORE_WHEEL:500}}static get properties(){return{_frozenCells:{type:Array,value:function(){return[]}},_scrollbarWidth:{type:Number,value:function(){var scrollDiv=document.createElement("div");scrollDiv.style.width="100px",scrollDiv.style.height="100px",scrollDiv.style.overflow="scroll",scrollDiv.style.position="absolute",scrollDiv.style.top="-9999px",document.body.appendChild(scrollDiv);var scrollbarWidth=scrollDiv.offsetWidth-scrollDiv.clientWidth;return document.body.removeChild(scrollDiv),scrollbarWidth}},_rowWithFocusedElement:Element,_deltaYAcc:{type:Number,value:0}}}static get observers(){return["_scrollHeightUpdated(_estScrollHeight)"]}ready(){super.ready(),this.scrollTarget=this.$.table,this.addEventListener("wheel",e=>{this._wheelScrolling=!0,this._debouncerWheelScrolling=Debouncer.debounce(this._debouncerWheelScrolling,timeOut.after(this._timeouts.WHEEL_SCROLLING),()=>this._wheelScrolling=!1),this._onWheel(e)}),this.$.table.addEventListener("scroll",e=>{this.$.outerscroller.outerScrolling&&e.stopImmediatePropagation()},!0),this.$.items.addEventListener("focusin",e=>{const itemsIndex=e.composedPath().indexOf(this.$.items);this._rowWithFocusedElement=e.composedPath()[itemsIndex-1]}),this.$.items.addEventListener("focusout",()=>this._rowWithFocusedElement=void 0)}_onWheel(e){if(!e.ctrlKey&&!this._hasScrolledAncestor(e.target,e.deltaX,e.deltaY)){var table=this.$.table,deltaY=e.deltaY;if(1===e.deltaMode&&(deltaY*=this._physicalAverage),this._wheelAnimationFrame)return this._deltaYAcc+=deltaY,void e.preventDefault();deltaY+=this._deltaYAcc,this._deltaYAcc=0,this._wheelAnimationFrame=!0,this._debouncerWheelAnimationFrame=Debouncer.debounce(this._debouncerWheelAnimationFrame,animationFrame,()=>this._wheelAnimationFrame=!1);var momentum=Math.abs(e.deltaX)+Math.abs(deltaY);this._canScroll(table,e.deltaX,deltaY)?(e.preventDefault(),table.scrollTop+=deltaY,table.scrollLeft+=e.deltaX,this._scrollHandler(),this._hasResidualMomentum=!0,this._ignoreNewWheel=!0,this._debouncerIgnoreNewWheel=Debouncer.debounce(this._debouncerIgnoreNewWheel,timeOut.after(this._timeouts.IGNORE_WHEEL),()=>this._ignoreNewWheel=!1)):this._hasResidualMomentum&&momentum<=this._previousMomentum||this._ignoreNewWheel?e.preventDefault():momentum>this._previousMomentum&&(this._hasResidualMomentum=!1),this._previousMomentum=momentum}}_hasScrolledAncestor(el,deltaX,deltaY){return"vaadin-grid-cell-content"!==el.localName&&(!(!this._canScroll(el,deltaX,deltaY)||-1===["auto","scroll"].indexOf(getComputedStyle(el).overflow))||(el!==this&&el.parentElement?this._hasScrolledAncestor(el.parentElement,deltaX,deltaY):void 0))}_canScroll(el,deltaX,deltaY){return deltaY>0&&el.scrollTop<el.scrollHeight-el.offsetHeight||deltaY<0&&el.scrollTop>0||deltaX>0&&el.scrollLeft<el.scrollWidth-el.offsetWidth||deltaX<0&&el.scrollLeft>0}_scheduleScrolling(){this._scrollingFrame||(this._scrollingFrame=requestAnimationFrame(()=>this._toggleAttribute("scrolling",!0,this.$.scroller))),this._debounceScrolling=Debouncer.debounce(this._debounceScrolling,timeOut.after(this._timeouts.SCROLLING),()=>{cancelAnimationFrame(this._scrollingFrame),delete this._scrollingFrame,this._toggleAttribute("scrolling",!1,this.$.scroller),this.$.outerscroller.outerScrolling||this._reorderRows()}),this._scrollPeriodFrame||(this._scrollPeriodFrame=requestAnimationFrame(()=>this._toggleAttribute("scroll-period",!0,this.$.scroller))),this._debounceScrollPeriod=Debouncer.debounce(this._debounceScrollPeriod,timeOut.after(this._timeouts.SCROLL_PERIOD),()=>{cancelAnimationFrame(this._scrollPeriodFrame),delete this._scrollPeriodFrame,this._toggleAttribute("scroll-period",!1,this.$.scroller)})}_afterScroll(){this._translateStationaryElements(),this.hasAttribute("reordering")||this._scheduleScrolling();const os=this.$.outerscroller;if(this._ios||!this._wheelScrolling&&!os.passthrough||os.syncOuterScroller(),this._ios){const overScroll=Math.max(-os.scrollTop,0)||Math.min(0,os.scrollHeight-os.scrollTop-os.offsetHeight);this.$.items.style.transform=`translateY(${overScroll}px)`}this._updateOverflow()}_updateOverflow(){let overflow="";const table=this.$.table;table.scrollTop<table.scrollHeight-table.clientHeight&&(overflow+=" bottom"),table.scrollTop>0&&(overflow+=" top"),table.scrollLeft<table.scrollWidth-table.clientWidth&&(overflow+=" right"),table.scrollLeft>0&&(overflow+=" left"),this._debounceOverflow=Debouncer.debounce(this._debounceOverflow,animationFrame,()=>{const value=overflow.trim();value.length>0&&this.getAttribute("overflow")!==value?this.setAttribute("overflow",value):0==value.length&&this.hasAttribute("overflow")&&this.removeAttribute("overflow")})}_reorderRows(){const body=this.$.items,items=body.querySelectorAll("tr");if(!items.length)return;const adjustedVirtualStart=this._virtualStart+this._vidxOffset,targetRow=this._rowWithFocusedElement||Array.from(items).filter(row=>!row.hidden)[0];if(!targetRow)return;const targetPhysicalIndex=targetRow.index-adjustedVirtualStart,delta=Array.from(items).indexOf(targetRow)-targetPhysicalIndex;if(delta>0)for(let i=0;i<delta;i++)body.appendChild(items[i]);else if(delta<0)for(let i=items.length+delta;i<items.length;i++)body.insertBefore(items[i],items[0])}_frozenCellsChanged(){this._debouncerCacheElements=Debouncer.debounce(this._debouncerCacheElements,microTask,()=>{Array.from(this.root.querySelectorAll('[part~="cell"]')).forEach(function(cell){cell.style.transform=""}),this._frozenCells=Array.prototype.slice.call(this.$.table.querySelectorAll("[frozen]")),this._translateStationaryElements()}),this._updateLastFrozen()}_updateLastFrozen(){if(!this._columnTree)return;const columnsRow=this._columnTree[this._columnTree.length-1].slice(0);columnsRow.sort((a,b)=>a._order-b._order);const lastFrozen=columnsRow.reduce((prev,col,index)=>(col._lastFrozen=!1,col.frozen&&!col.hidden?index:prev),void 0);void 0!==lastFrozen&&(columnsRow[lastFrozen]._lastFrozen=!0)}_translateStationaryElements(){this._edge&&!this._scrollbarWidth?(this.$.items.style.transform=this._getTranslate(-this._scrollLeft||0,-this._scrollTop||0),this.$.footer.style.transform=this.$.header.style.transform=this._getTranslate(-this._scrollLeft||0,0)):this.$.footer.style.transform=this.$.header.style.transform=this._getTranslate(0,this._scrollTop);for(var frozenCellTransform=this._getTranslate(this._scrollLeft,0),i=0;i<this._frozenCells.length;i++)this._frozenCells[i].style.transform=frozenCellTransform}_getTranslate(x,y){return"translate("+x+"px,"+y+"px)"}_scrollHeightUpdated(_estScrollHeight){this.$.outersizer.style.top=this.$.fixedsizer.style.top=_estScrollHeight+"px"}});