import{afterNextRender}from"../../../@polymer/polymer/lib/utils/render-status.js";import{idlePeriod,animationFrame}from"../../../@polymer/polymer/lib/utils/async.js";import{flush}from"../../../@polymer/polymer/lib/utils/flush.js";import{PolymerIronList}from"./iron-list.js";import{Debouncer}from"../../../@polymer/polymer/lib/utils/debounce.js";class GridScrollerElement extends PolymerIronList{static get is(){return"vaadin-grid-scroller"}static get properties(){return{size:{type:Number,notify:!0},_vidxOffset:{value:0}}}static get observers(){return["_effectiveSizeChanged(_effectiveSize)"]}connectedCallback(){super.connectedCallback(),this._scrollHandler()}_updateScrollerItem(item,index){}_afterScroll(){}_getRowTarget(){}_createScrollerRows(){}_canPopulate(){}scrollToIndex(index){this._warnPrivateAPIAccess("scrollToIndex"),index>0&&(this._pendingScrollToIndex=null),!parseInt(this.$.items.style.borderTopWidth)&&index>0&&(this._pendingScrollToIndex=index),this._scrollingToIndex=!0,index=Math.min(Math.max(index,0),this._effectiveSize-1),this.$.table.scrollTop=index/this._effectiveSize*(this.$.table.scrollHeight-this.$.table.offsetHeight),this._scrollHandler(),this._accessIronListAPI(()=>this._maxScrollTop)&&this._virtualCount<this._effectiveSize&&this._adjustVirtualIndexOffset(1e6),this._accessIronListAPI(()=>super.scrollToIndex(index-this._vidxOffset)),this._scrollHandler();const row=Array.from(this.$.items.children).filter(child=>child.index===index)[0];if(row){const headerOffset=row.getBoundingClientRect().top-this.$.header.getBoundingClientRect().bottom;Math.abs(headerOffset)>1&&(this.$.table.scrollTop+=headerOffset,this._scrollHandler())}this._scrollingToIndex=!1}_effectiveSizeChanged(size){let fvi,fviOffset=0;if(this._iterateItems((pidx,vidx)=>{if(vidx===this._firstVisibleIndex){const row=this._physicalItems[pidx];fvi=row.index,fviOffset=row.getBoundingClientRect().top}}),this.items&&size<this.items.length&&(this._scrollTop=0),!Array.isArray(this.items)){const maxVirtualItems=this._edge||this._ie?3e4:1e5;this.items={length:Math.min(size,maxVirtualItems)}}this._accessIronListAPI(()=>super._itemsChanged({path:"items"})),this._virtualCount=Math.min(this.items.length,size)||0,0===this._scrollTop&&(this._accessIronListAPI(()=>this._scrollToIndex(Math.min(size-1,fvi))),this._iterateItems((pidx,vidx)=>{const row=this._physicalItems[pidx];if(row.index===fvi&&(this.$.table.scrollTop+=Math.round(row.getBoundingClientRect().top-fviOffset)),row.index===this._focusedItemIndex&&this._itemsFocusable&&this.$.items.contains(this.shadowRoot.activeElement)){const cellIndex=Array.from(this._itemsFocusable.parentElement.children).indexOf(this._itemsFocusable);row.children[cellIndex].focus()}})),this._assignModels(),requestAnimationFrame(()=>this._update())}_positionItems(){let rePosition;this._adjustScrollPosition(),isNaN(this._physicalTop)&&(rePosition=!0,this._physicalTop=0);let y=this._physicalTop;this._iterateItems((pidx,vidx)=>{this._physicalItems[pidx].style.transform=`translateY(${y}px)`,y+=this._physicalSizes[pidx]}),rePosition&&this._scrollToIndex(0)}_increasePoolIfNeeded(count){0===count&&this._scrollingToIndex||!this._canPopulate()||!this._effectiveSize||(this._initialPoolCreated?this._optPhysicalSize!==1/0&&(this._debounceIncreasePool=Debouncer.debounce(this._debounceIncreasePool,idlePeriod,()=>{this._updateMetrics();const remainingPhysicalSize=this._optPhysicalSize-this._physicalSize;let estimatedMissingRowCount=Math.ceil(remainingPhysicalSize/this._physicalAverage);this._physicalCount+estimatedMissingRowCount>this._effectiveSize&&(estimatedMissingRowCount=Math.max(0,this._effectiveSize-this._physicalCount)),this._physicalSize&&estimatedMissingRowCount>0&&(super._increasePoolIfNeeded(estimatedMissingRowCount),this.__reorderChildNodes())})):(this._initialPoolCreated=!0,super._increasePoolIfNeeded(25)))}__reorderChildNodes(){const childNodes=Array.from(this.$.items.childNodes);!!childNodes.reduce((inOrder,current,currentIndex,array)=>{if(0===currentIndex||array[currentIndex-1].index===current.index-1)return inOrder},!0)||childNodes.sort((row1,row2)=>row1.index-row2.index).forEach(row=>this.$.items.appendChild(row))}_createPool(size){const fragment=document.createDocumentFragment(),physicalItems=this._createScrollerRows(size);physicalItems.forEach(inst=>fragment.appendChild(inst)),this._getRowTarget().appendChild(fragment);const content=this.querySelector("[slot]");if(content){const slot=content.getAttribute("slot");content.setAttribute("slot","foo-bar"),content.setAttribute("slot",slot)}return this._updateHeaderFooterMetrics(),afterNextRender(this,()=>this.notifyResize()),physicalItems}_assignModels(itemSet){this._iterateItems((pidx,vidx)=>{const el=this._physicalItems[pidx];this._toggleAttribute("hidden",vidx>=this._effectiveSize,el),this._updateScrollerItem(el,vidx+(this._vidxOffset||0))},itemSet)}_scrollHandler(){const delta=this.$.table.scrollTop-this._scrollPosition;this._accessIronListAPI(super._scrollHandler);const oldOffset=this._vidxOffset;this._accessIronListAPI(()=>this._maxScrollTop)&&this._virtualCount<this._effectiveSize&&this._adjustVirtualIndexOffset(delta),this._vidxOffset!==oldOffset&&this._update(),this._afterScroll()}_adjustVirtualIndexOffset(delta){if(Math.abs(delta)>1e4){if(this._noScale)return void(this._noScale=!1);const scale=this.$.table.scrollTop/(this.$.table.scrollHeight-this.$.table.offsetHeight),offset=scale*this._effectiveSize;this._vidxOffset=Math.round(offset-scale*this._virtualCount)}else{const oldOffset=this._vidxOffset||0,threshold=1e3,maxShift=100;0===this._scrollTop?(this._vidxOffset=0,oldOffset!==this._vidxOffset&&super.scrollToIndex(0)):this.firstVisibleIndex<threshold&&this._vidxOffset>0&&(this._vidxOffset-=Math.min(this._vidxOffset,maxShift),oldOffset!==this._vidxOffset&&super.scrollToIndex(this.firstVisibleIndex+(oldOffset-this._vidxOffset)),this._noScale=!0);const maxOffset=this._effectiveSize-this._virtualCount;this._scrollTop>=this._maxScrollTop&&this._maxScrollTop>0?(this._vidxOffset=maxOffset,oldOffset!==this._vidxOffset&&super.scrollToIndex(this._virtualCount)):this.firstVisibleIndex>this._virtualCount-threshold&&this._vidxOffset<maxOffset&&(this._vidxOffset+=Math.min(maxOffset-this._vidxOffset,maxShift),oldOffset!==this._vidxOffset&&super.scrollToIndex(this.firstVisibleIndex-(this._vidxOffset-oldOffset)),this._noScale=!0)}}_accessIronListAPI(cb){this._warnPrivateAPIAccessAsyncEnabled=!1;const returnValue=cb.apply(this);return this._debouncerWarnPrivateAPIAccess=Debouncer.debounce(this._debouncerWarnPrivateAPIAccess,animationFrame,()=>this._warnPrivateAPIAccessAsyncEnabled=!0),returnValue}_debounceRender(cb,asyncModule){super._debounceRender(()=>this._accessIronListAPI(cb),asyncModule)}_warnPrivateAPIAccess(apiName){this._warnPrivateAPIAccessAsyncEnabled&&console.warn(`Accessing private API (${apiName})!`)}_render(){this._accessIronListAPI(super._render)}_createFocusBackfillItem(){}_multiSelectionChanged(){}clearSelection(){}_itemsChanged(){}_manageFocus(){}_removeFocusedItem(){}get _firstVisibleIndex(){return this._accessIronListAPI(()=>super.firstVisibleIndex)}get _lastVisibleIndex(){return this._accessIronListAPI(()=>super.lastVisibleIndex)}_scrollToIndex(index){this._accessIronListAPI(()=>this.scrollToIndex(index))}get firstVisibleIndex(){return this._warnPrivateAPIAccess("firstVisibleIndex"),super.firstVisibleIndex}set firstVisibleIndex(value){this._warnPrivateAPIAccess("firstVisibleIndex"),super.firstVisibleIndex=value}get lastVisibleIndex(){return this._warnPrivateAPIAccess("lastVisibleIndex"),super.lastVisibleIndex}set lastVisibleIndex(value){this._warnPrivateAPIAccess("lastVisibleIndex"),super.lastVisibleIndex=value}updateViewportBoundaries(){this._warnPrivateAPIAccess("updateViewportBoundaries"),super.updateViewportBoundaries.apply(this,arguments)}_resizeHandler(){super._resizeHandler(),flush()}}customElements.define(GridScrollerElement.is,GridScrollerElement);export{GridScrollerElement as ScrollerElement};