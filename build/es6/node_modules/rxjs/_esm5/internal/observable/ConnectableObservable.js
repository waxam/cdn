import*as tslib_1 from"../../../../tslib/tslib.es6.js";import{SubjectSubscriber}from"../Subject.js";import{Observable}from"../Observable.js";import{Subscriber}from"../Subscriber.js";import{Subscription}from"../Subscription.js";import{refCount as higherOrderRefCount}from"../operators/refCount.js";var ConnectableObservable=function(_super){tslib_1.__extends(ConnectableObservable,_super);function ConnectableObservable(source,subjectFactory){var _this=_super.call(this)||this;_this.source=source;_this.subjectFactory=subjectFactory;_this._refCount=0;_this._isComplete=!1;return _this}ConnectableObservable.prototype._subscribe=function(subscriber){return this.getSubject().subscribe(subscriber)};ConnectableObservable.prototype.getSubject=function(){var subject=this._subject;if(!subject||subject.isStopped){this._subject=this.subjectFactory()}return this._subject};ConnectableObservable.prototype.connect=function(){var connection=this._connection;if(!connection){this._isComplete=!1;connection=this._connection=new Subscription;connection.add(this.source.subscribe(new ConnectableSubscriber(this.getSubject(),this)));if(connection.closed){this._connection=null;connection=Subscription.EMPTY}else{this._connection=connection}}return connection};ConnectableObservable.prototype.refCount=function(){return higherOrderRefCount()(this)};return ConnectableObservable}(Observable);export{ConnectableObservable};var connectableProto=ConnectableObservable.prototype;export var connectableObservableDescriptor={operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:connectableProto._subscribe},_isComplete:{value:connectableProto._isComplete,writable:!0},getSubject:{value:connectableProto.getSubject},connect:{value:connectableProto.connect},refCount:{value:connectableProto.refCount}};var ConnectableSubscriber=function(_super){tslib_1.__extends(ConnectableSubscriber,_super);function ConnectableSubscriber(destination,connectable){var _this=_super.call(this,destination)||this;_this.connectable=connectable;return _this}ConnectableSubscriber.prototype._error=function(err){this._unsubscribe();_super.prototype._error.call(this,err)};ConnectableSubscriber.prototype._complete=function(){this.connectable._isComplete=!0;this._unsubscribe();_super.prototype._complete.call(this)};ConnectableSubscriber.prototype._unsubscribe=function(){var connectable=this.connectable;if(connectable){this.connectable=null;var connection=connectable._connection;connectable._refCount=0;connectable._subject=null;connectable._connection=null;if(connection){connection.unsubscribe()}}};return ConnectableSubscriber}(SubjectSubscriber),RefCountOperator=function(){function RefCountOperator(connectable){this.connectable=connectable}RefCountOperator.prototype.call=function(subscriber,source){var connectable=this.connectable;connectable._refCount++;var refCounter=new RefCountSubscriber(subscriber,connectable),subscription=source.subscribe(refCounter);if(!refCounter.closed){refCounter.connection=connectable.connect()}return subscription};return RefCountOperator}(),RefCountSubscriber=function(_super){tslib_1.__extends(RefCountSubscriber,_super);function RefCountSubscriber(destination,connectable){var _this=_super.call(this,destination)||this;_this.connectable=connectable;return _this}RefCountSubscriber.prototype._unsubscribe=function(){var connectable=this.connectable;if(!connectable){this.connection=null;return}this.connectable=null;var refCount=connectable._refCount;if(0>=refCount){this.connection=null;return}connectable._refCount=refCount-1;if(1<refCount){this.connection=null;return}var connection=this.connection,sharedConnection=connectable._connection;this.connection=null;if(sharedConnection&&(!connection||sharedConnection===connection)){sharedConnection.unsubscribe()}};return RefCountSubscriber}(Subscriber);