import{isArray}from"./util/isArray.js";import{isObject}from"./util/isObject.js";import{isFunction}from"./util/isFunction.js";import{tryCatch}from"./util/tryCatch.js";import{errorObject}from"./util/errorObject.js";import{UnsubscriptionError}from"./util/UnsubscriptionError.js";var Subscription=function(){function Subscription(unsubscribe){this.closed=!1;this._parent=null;this._parents=null;this._subscriptions=null;if(unsubscribe){this._unsubscribe=unsubscribe}}Subscription.prototype.unsubscribe=function(){var hasErrors=!1,errors;if(this.closed){return}var _a=this,_parent=_a._parent,_parents=_a._parents,_unsubscribe=_a._unsubscribe,_subscriptions=_a._subscriptions;this.closed=!0;this._parent=null;this._parents=null;this._subscriptions=null;var index=-1,len=_parents?_parents.length:0;while(_parent){_parent.remove(this);_parent=++index<len&&_parents[index]||null}if(isFunction(_unsubscribe)){var trial=tryCatch(_unsubscribe).call(this);if(trial===errorObject){hasErrors=!0;errors=errors||(errorObject.e instanceof UnsubscriptionError?flattenUnsubscriptionErrors(errorObject.e.errors):[errorObject.e])}}if(isArray(_subscriptions)){index=-1;len=_subscriptions.length;while(++index<len){var sub=_subscriptions[index];if(isObject(sub)){var trial=tryCatch(sub.unsubscribe).call(sub);if(trial===errorObject){hasErrors=!0;errors=errors||[];var err=errorObject.e;if(err instanceof UnsubscriptionError){errors=errors.concat(flattenUnsubscriptionErrors(err.errors))}else{errors.push(err)}}}}}if(hasErrors){throw new UnsubscriptionError(errors)}};Subscription.prototype.add=function(teardown){if(!teardown||teardown===Subscription.EMPTY){return Subscription.EMPTY}if(teardown===this){return this}var subscription=teardown;switch(typeof teardown){case"function":subscription=new Subscription(teardown);case"object":if(subscription.closed||"function"!==typeof subscription.unsubscribe){return subscription}else if(this.closed){subscription.unsubscribe();return subscription}else if("function"!==typeof subscription._addParent){var tmp=subscription;subscription=new Subscription;subscription._subscriptions=[tmp]}break;default:throw new Error("unrecognized teardown "+teardown+" added to Subscription.");}var subscriptions=this._subscriptions||(this._subscriptions=[]);subscriptions.push(subscription);subscription._addParent(this);return subscription};Subscription.prototype.remove=function(subscription){var subscriptions=this._subscriptions;if(subscriptions){var subscriptionIndex=subscriptions.indexOf(subscription);if(-1!==subscriptionIndex){subscriptions.splice(subscriptionIndex,1)}}};Subscription.prototype._addParent=function(parent){var _a=this,_parent=_a._parent,_parents=_a._parents;if(!_parent||_parent===parent){this._parent=parent}else if(!_parents){this._parents=[parent]}else if(-1===_parents.indexOf(parent)){_parents.push(parent)}};Subscription.EMPTY=function(empty){empty.closed=!0;return empty}(new Subscription);return Subscription}();export{Subscription};function flattenUnsubscriptionErrors(errors){return errors.reduce(function(errs,err){return errs.concat(err instanceof UnsubscriptionError?err.errors:err)},[])}