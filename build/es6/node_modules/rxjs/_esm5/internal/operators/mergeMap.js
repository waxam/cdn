import*as tslib_1 from"../../../../tslib/tslib.es6.js";import{subscribeToResult}from"../util/subscribeToResult.js";import{OuterSubscriber}from"../OuterSubscriber.js";import{InnerSubscriber}from"../InnerSubscriber.js";import{map}from"./map.js";import{from}from"../observable/from.js";export function mergeMap(project,resultSelector,concurrent){if(void 0===concurrent){concurrent=Number.POSITIVE_INFINITY}if("function"===typeof resultSelector){return function(source){return source.pipe(mergeMap(function(a,i){return from(project(a,i)).pipe(map(function(b,ii){return resultSelector(a,b,i,ii)}))},concurrent))}}else if("number"===typeof resultSelector){concurrent=resultSelector}return function(source){return source.lift(new MergeMapOperator(project,concurrent))}}var MergeMapOperator=function(){function MergeMapOperator(project,concurrent){if(void 0===concurrent){concurrent=Number.POSITIVE_INFINITY}this.project=project;this.concurrent=concurrent}MergeMapOperator.prototype.call=function(observer,source){return source.subscribe(new MergeMapSubscriber(observer,this.project,this.concurrent))};return MergeMapOperator}();export{MergeMapOperator};var MergeMapSubscriber=function(_super){tslib_1.__extends(MergeMapSubscriber,_super);function MergeMapSubscriber(destination,project,concurrent){if(void 0===concurrent){concurrent=Number.POSITIVE_INFINITY}var _this=_super.call(this,destination)||this;_this.project=project;_this.concurrent=concurrent;_this.hasCompleted=!1;_this.buffer=[];_this.active=0;_this.index=0;return _this}MergeMapSubscriber.prototype._next=function(value){if(this.active<this.concurrent){this._tryNext(value)}else{this.buffer.push(value)}};MergeMapSubscriber.prototype._tryNext=function(value){var result,index=this.index++;try{result=this.project(value,index)}catch(err){this.destination.error(err);return}this.active++;this._innerSub(result,value,index)};MergeMapSubscriber.prototype._innerSub=function(ish,value,index){var innerSubscriber=new InnerSubscriber(this,void 0,void 0),destination=this.destination;destination.add(innerSubscriber);subscribeToResult(this,ish,value,index,innerSubscriber)};MergeMapSubscriber.prototype._complete=function(){this.hasCompleted=!0;if(0===this.active&&0===this.buffer.length){this.destination.complete()}this.unsubscribe()};MergeMapSubscriber.prototype.notifyNext=function(outerValue,innerValue){this.destination.next(innerValue)};MergeMapSubscriber.prototype.notifyComplete=function(innerSub){var buffer=this.buffer;this.remove(innerSub);this.active--;if(0<buffer.length){this._next(buffer.shift())}else if(0===this.active&&this.hasCompleted){this.destination.complete()}};return MergeMapSubscriber}(OuterSubscriber);export{MergeMapSubscriber};