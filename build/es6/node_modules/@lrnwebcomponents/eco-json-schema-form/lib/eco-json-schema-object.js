import{html,Polymer}from"../../../@polymer/polymer/polymer-legacy.js";import{dom}from"../../../@polymer/polymer/lib/legacy/polymer.dom.js";import{FlattenedNodesObserver}from"../../../@polymer/polymer/lib/utils/flattened-nodes-observer.js";import{AppLocalizeBehavior}from"../../../@polymer/app-localize-behavior/app-localize-behavior.js";import"../../../@polymer/iron-flex-layout/iron-flex-layout-classes.js";import"./eco-json-schema-array.js";import"./eco-json-schema-boolean.js";import"./eco-json-schema-enum.js";import"./eco-json-schema-file.js";import"./eco-json-schema-input.js";Polymer({is:"eco-json-schema-object",_template:html`
    <custom-style>
      <style is="custom-style" include="iron-flex iron-flex-alignment">
        div.layout {
          height: auto;
        }
        #form {
          display: block;
          @apply --eco-json-schema-object-form;
          @apply --layout-vertical;
          @apply --layout-wrap;
        }
        #form ::slotted(paper-input) {
          --paper-input-container-shared-input-style: {
            border: none !important;
            width: 100% !important;
            background-color: transparent !important;
          }
        }
      </style>
    </custom-style>

    <template is="dom-if" if="{{!wizard}}">
      <div class="header" hidden\$="[[!label]]">[[label]]</div>
    </template>
    <div class="layout vertical flex start-justified">
      <div id="form" class="layout horizontal flex start-justified">
        <slot></slot>
      </div>
    </div>
  `,behaviors:[AppLocalizeBehavior],properties:{language:{value:"en"},resources:{value:function(){return{}}},schema:{type:Object,notify:!0,observer:"_schemaChanged"},label:{type:String},value:{type:Object,notify:!0,value:function(){return{}}},error:{type:Object,observer:"_errorChanged"},wizard:{type:Boolean,notify:!0}},detached:function(){this._clearForm()},_buildSchemaProperties:function(){var ctx=this;this._schemaProperties=Object.keys(this.schema.properties||[]).map(key=>{var schema=ctx.schema.properties[key],property={property:key,label:schema.title||key,schema:schema,component:schema.component||{}};if(!property.component.valueProperty){property.component.valueProperty="value"}if(!property.component.slot){property.component.slot=""}if(ctx._isSchemaEnum(schema)){property.component.name=property.component.name||"eco-json-schema-enum";if(typeof schema.value===typeof void 0){schema.value=""}property.value=schema.value}else if(ctx._isSchemaBoolean(schema.type)){property.component.name=property.component.name||"eco-json-schema-boolean";if(typeof schema.value===typeof void 0){schema.value=!1}property.value=schema.value}else if(ctx._isSchemaFile(schema.type)){property.component.name=property.component.name||"eco-json-schema-file";if(typeof schema.value===typeof void 0){schema.value={}}property.value=schema.value}else if(ctx._isSchemaValue(schema.type)){property.component.name=property.component.name||"eco-json-schema-input";if(typeof schema.value===typeof void 0){schema.value=""}property.value=schema.value}else if(ctx._isSchemaObject(schema.type)){property.component.name=property.component.name||"eco-json-schema-object";if(typeof schema.value===typeof void 0){schema.value={}}property.value=schema.value}else if(ctx._isSchemaArray(schema.type)){property.component.name=property.component.name||"eco-json-schema-array";if(typeof schema.value===typeof void 0){schema.value=[]}property.value=schema.value}else{return console.error("Unknown property type %s",schema.type)}return property})},_schemaPropertyChanged:function(event,detail){if(detail.path&&/\.length$/.test(detail.path)){return}var ctx=this,property=event.target.schemaProperty,path=["value",property.property];if(detail.path&&/\.splices$/.test(detail.path)){var parts=detail.path.split(".").slice(1,-1);while(parts.length){path.push(parts.shift());if(property.keyMap&&property.keyMap[path.join(".")]){path=property.keyMap[path.join(".")].split(".")}}if(detail.value.keySplices){if(property.keyMap){detail.value.keySplices.forEach(splice=>{splice.removed.forEach(k=>{delete property.keyMap[path.concat([k]).join(".")]})})}}if(detail.value){detail.value.indexSplices.forEach(splice=>{var args=[path.join("."),splice.index,splice.removed.length];if(splice.addedCount){for(var i=0,ii=splice.addedCount;i<ii;i++){if(splice.addedKeys&&splice.addedKeys[i]){property.keyMap=property.keyMap||{};property.keyMap[path.concat([splice.addedKeys[i]]).join(".")]=path.concat([i+splice.index]).join(".")}args.push(ctx._deepClone(splice.object[i+splice.index]))}}ctx.splice.apply(ctx,args)})}}else if(detail.path){var parts=detail.path.split(".").slice(1),v=this.value;if(!v.hasOwnProperty(property.property)){this.set("value."+property.property,{});this.notifyPath("value."+property.property)}while(parts.length){var k=parts.shift();path.push(k);if(property.keyMap&&property.keyMap[path.join(".")]){path=property.keyMap[path.join(".")].split(".")}}this.set(path.join("."),this._deepClone(detail.value));this.notifyPath(path.join("."))}else{property.value=detail.value;this.set(path,this._deepClone(detail.value));this.notifyPath(path)}},_setValue:function(){var value={};this._schemaProperties.forEach(property=>{if(typeof property.value!==typeof void 0){value[property.property]=this._deepClone(property.value)}});this.set("value",value);this.notifyPath("value.*")},_buildForm:function(){this._schemaProperties.forEach(property=>{var el=this.create(property.component.name,{label:property.label,schema:property.schema,schemaProperty:property,language:this.language,resources:this.resources});if("paper-input"===property.component.name){el.style["background-color"]="transparent";el.style.width="100%"}el.setAttribute("name",property.property);el.className="flex start-justified";el[property.component.valueProperty]=property.value;for(var attr in property.component.attributes){el.setAttribute(attr,property.component.attributes[attr])}for(var prop in property.component.properties){el[prop]=property.component.properties[prop]}this.listen(el,property.component.valueProperty.replace(/([A-Z])/g,"-$1").toLowerCase()+"-changed","_schemaPropertyChanged");if(typeof this.$!==typeof void 0){dom(this).appendChild(el)}if(""!=property.component.slot){let temp=document.createElement("div");temp.innerHTML=property.component.slot;let cloneDiv=temp.cloneNode(!0);while(null!==dom(cloneDiv).firstChild){dom(el).appendChild(dom(cloneDiv).firstChild)}}})},_removePropertyEl:function(el){if(typeof el.schemaProperty!==typeof void 0){this.unlisten(el,el.schemaProperty.component.valueProperty.replace(/([A-Z])/g,"-$1").toLowerCase()+"-changed","_schemaPropertyChanged")}el.schemaProperty=null;dom(this).removeChild(el)},_clearForm:function(){if(typeof this.$!==typeof void 0){var formEl=dom(this);while(formEl.firstChild){this._removePropertyEl(formEl.firstChild)}}},_schemaChanged:function(newValue){if(newValue){this._clearForm();this._buildSchemaProperties();this._buildForm();this._setValue()}},_errorChanged:function(){dom(this).childNodes.forEach(el=>{var name=el.getAttribute("name");if(this.error&&this.error[name]){el.error=this.error[name]}else{el.error=null}})},_deepClone:function(o){return JSON.parse(JSON.stringify(o))},_isSchemaValue:function(type){return this._isSchemaBoolean(type)||this._isSchemaNumber(type)||this._isSchemaString(type)||this._isSchemaFile(type)},_isSchemaFile:function(type){if(Array.isArray(type)){return-1!==type.indexOf("file")}else{return"file"===type}},_isSchemaBoolean:function(type){if(Array.isArray(type)){return-1!==type.indexOf("boolean")}else{return"boolean"===type}},_isSchemaEnum:function(schema){return!!schema.enum},_isSchemaNumber:function(type){if(Array.isArray(type)){return-1!==type.indexOf("number")||-1!==type.indexOf("integer")}else{return"number"===type||"integer"===type}},_isSchemaString:function(type){if(Array.isArray(type)){return-1!==type.indexOf("string")}else{return"string"===type}},_isSchemaObject:function(type){return"object"===type},_isSchemaArray:function(type){return"array"===type}});