import{html,Polymer}from"@polymer/polymer/polymer-legacy.js";import{dom}from"@polymer/polymer/lib/legacy/polymer.dom.js";import"@polymer/iron-flex-layout/iron-flex-layout-classes.js";import{AppLocalizeBehavior}from"@polymer/app-localize-behavior/app-localize-behavior.js";import"./eco-json-schema-array.js";import"./eco-json-schema-boolean.js";import"./eco-json-schema-enum.js";import"./eco-json-schema-file.js";import"./eco-json-schema-input.js";Polymer({is:"eco-json-schema-object",_template:html`
    <custom-style>
      <style is="custom-style" include="iron-flex iron-flex-alignment">
        div.layout {
          height: auto;
        }
        #form {
          display: block;
          @apply --eco-json-schema-object-form;
          @apply --layout-vertical;
          @apply --layout-wrap;
        }
        #form ::slotted(paper-input) {
          --paper-input-container-shared-input-style: {
            border: none !important;
            width: 100% !important;
            background-color: transparent !important;
          }
        }
      </style>
    </custom-style>

    <template is="dom-if" if="{{!wizard}}">
      <div class="header" hidden\$="[[!label]]">[[label]]</div>
    </template>
    <div class="layout vertical flex start-justified">
      <div id="form" class="layout horizontal flex start-justified">
        <slot></slot>
      </div>
    </div>
  `,behaviors:[AppLocalizeBehavior],properties:{language:{value:"en"},resources:{value:function(){return{}}},schema:{type:Object,observer:"_schemaChanged"},label:{type:String},value:{type:Object,notify:!0,value:function(){return{}}},error:{type:Object,observer:"_errorChanged"},wizard:{type:Boolean,notify:!0}},detached:function(){this._clearForm()},_buildSchemaProperties:function(){var a=this;this._schemaProperties=Object.keys(this.schema.properties||[]).map(function(b){var c=a.schema.properties[b],d={property:b,label:c.title||b,schema:c,component:c.component||{}};if(d.component.valueProperty||(d.component.valueProperty="value"),d.component.slot||(d.component.slot=""),a._isSchemaEnum(c))d.component.name=d.component.name||"eco-json-schema-enum","undefined"===typeof c.value&&(c.value=""),d.value=c.value;else if(a._isSchemaBoolean(c.type))d.component.name=d.component.name||"eco-json-schema-boolean","undefined"===typeof c.value&&(c.value=!1),d.value=c.value;else if(a._isSchemaFile(c.type))d.component.name=d.component.name||"eco-json-schema-file","undefined"===typeof c.value&&(c.value={}),d.value=c.value;else if(a._isSchemaValue(c.type))d.component.name=d.component.name||"eco-json-schema-input","undefined"===typeof c.value&&(c.value=""),d.value=c.value;else if(a._isSchemaObject(c.type))d.component.name=d.component.name||"eco-json-schema-object","undefined"===typeof c.value&&(c.value={}),d.value=c.value;else if(a._isSchemaArray(c.type))d.component.name=d.component.name||"eco-json-schema-array","undefined"===typeof c.value&&(c.value=[]),d.value=c.value;else return console.error("Unknown property type %s",c.type);return d})},_schemaPropertyChanged:function(a,b){if(!(b.path&&/\.length$/.test(b.path))){var c=this,d=a.target.schemaProperty,e=["value",d.property];if(b.path&&/\.splices$/.test(b.path)){for(var f=b.path.split(".").slice(1,-1);f.length;)e.push(f.shift()),d.keyMap&&d.keyMap[e.join(".")]&&(e=d.keyMap[e.join(".")].split("."));b.value.keySplices&&d.keyMap&&b.value.keySplices.forEach(function(j){j.removed.forEach(function(l){delete d.keyMap[e.concat([l]).join(".")]})}),b.value&&b.value.indexSplices.forEach(function(j){var l=[e.join("."),j.index,j.removed.length];if(j.addedCount)for(var m=0,n=j.addedCount;m<n;m++)j.addedKeys&&j.addedKeys[m]&&(d.keyMap=d.keyMap||{},d.keyMap[e.concat([j.addedKeys[m]]).join(".")]=e.concat([m+j.index]).join(".")),l.push(c._deepClone(j.object[m+j.index]));c.splice.apply(c,l)})}else if(b.path){var f=b.path.split(".").slice(1),g=this.value;for(g.hasOwnProperty(d.property)||(this.set("value."+d.property,{}),this.notifyPath("value."+d.property));f.length;){var h=f.shift();e.push(h),d.keyMap&&d.keyMap[e.join(".")]&&(e=d.keyMap[e.join(".")].split("."))}this.set(e.join("."),this._deepClone(b.value)),this.notifyPath(e.join("."))}else d.value=b.value,this.set(e,this._deepClone(b.value)),this.notifyPath(e)}},_setValue:function(){var a=this,b={};this._schemaProperties.forEach(function(c){typeof c.value!==typeof void 0&&(b[c.property]=a._deepClone(c.value))}),this.value=b},_buildForm:function(){var a=this;this._schemaProperties.forEach(b=>{var c=a.create(b.component.name,{label:b.label,schema:b.schema,schemaProperty:b,language:this.language,resources:this.resources});for(var d in"paper-input"===b.component.name&&(c.style["background-color"]="transparent",c.style.width="100%"),c.setAttribute("name",b.property),c.className="flex start-justified",c[b.component.valueProperty]=b.value,b.component.attributes)c.setAttribute(d,b.component.attributes[d]);for(var e in b.component.properties)c[e]=b.component.properties[e];if(a.listen(c,b.component.valueProperty.replace(/([A-Z])/g,"-$1").toLowerCase()+"-changed","_schemaPropertyChanged"),typeof a.$!=="undefined"&&dom(this).appendChild(c),""!=b.component.slot){var f=document.createElement("template");f.innerHTML=b.component.slot,dom(c).appendChild(f)}})},_removePropertyEl:function(a){typeof a.schemaProperty!==typeof void 0&&this.unlisten(a,a.schemaProperty.component.valueProperty.replace(/([A-Z])/g,"-$1").toLowerCase()+"-changed","_schemaPropertyChanged"),a.schemaProperty=null,dom(this).removeChild(a)},_clearForm:function(){if(typeof this.$!==typeof void 0)for(var a=dom(this);a.firstChild;)this._removePropertyEl(a.firstChild)},_schemaChanged:function(a,b){a&&typeof b!==typeof void 0&&(this._clearForm(),this._buildSchemaProperties(),this._buildForm(),this._setValue())},_errorChanged:function(){var a=this;dom(this).childNodes.forEach(function(b){var c=b.getAttribute("name");b.error=a.error&&a.error[c]?a.error[c]:null})},_deepClone:function(a){return JSON.parse(JSON.stringify(a))},_isSchemaValue:function(a){return this._isSchemaBoolean(a)||this._isSchemaNumber(a)||this._isSchemaString(a)||this._isSchemaFile(a)},_isSchemaFile:function(a){return Array.isArray(a)?-1!==a.indexOf("file"):"file"===a},_isSchemaBoolean:function(a){return Array.isArray(a)?-1!==a.indexOf("boolean"):"boolean"===a},_isSchemaEnum:function(a){return!!a.enum},_isSchemaNumber:function(a){return Array.isArray(a)?-1!==a.indexOf("number")||-1!==a.indexOf("integer"):"number"===a||"integer"===a},_isSchemaString:function(a){return Array.isArray(a)?-1!==a.indexOf("string"):"string"===a},_isSchemaObject:function(a){return"object"===a},_isSchemaArray:function(a){return"array"===a}});