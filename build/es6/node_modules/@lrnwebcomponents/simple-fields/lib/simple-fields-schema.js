import{LitElement as e,html as t,css as s}from"../../../lit-element/lit-element.js";import"./simple-fields-array.js";class SimpleFieldsSchema extends e{static get styles(){return[s``]}render(){return t`
      <div id="schema-fields" aria-live="polite">
        <slot></slot>
      </div>
    `}constructor(){super(),this.autofocus=!1,this.codeTheme="vs-light-2",this.dataTypes={array:{element:"simple-fields-array",defaultValue:[],isArray:!0,previewSlot:"preview",sortSlot:"sort"},boolean:{element:"simple-fields-boolean",defaultValue:!1},fieldset:{element:"simple-fields-fieldset",defaultValue:{},isFieldset:!0},file:{element:"simple-fields-file",defaultValue:{}},integer:{element:"paper-input",defaultValue:"",type:"number",step:1},markup:{element:"simple-fields-markup",defaultValue:""},number:{element:"paper-input",type:"number",defaultValue:""},object:{element:"simple-fields-fieldset",defaultValue:{},isFieldset:!0},string:{element:"paper-input"},tabs:{element:"a11y-tabs",defaultValue:{},isFieldset:!0}},this.language="en",this.resources={},this.value={},setTimeout(()=>{import("./simple-fields-fieldset.js"),import("../../../@polymer/iron-icons/iron-icons.js"),import("../../../@polymer/iron-icons/editor-icons.js"),import("../../../@polymer/paper-input/paper-input.js"),import("../../../@polymer/paper-icon-button/paper-icon-button.js"),import("../../simple-tooltip/simple-tooltip.js")},0)}static get tag(){return"simple-fields-schema"}static get properties(){return{...super.properties,autofocus:{type:Boolean},codeTheme:{type:String},dataTypes:{type:Object},error:{type:Object},label:{type:String},language:{type:String,attribute:"lang",reflect:!0},resources:{type:Object},schema:{type:Object},value:{type:Object},wizard:{type:Boolean}}}_buildFormElement(e,t=this,s=-1,i){let r=document.createElement(e.component.type.element),l=s>-1?e.name.replace("..",`.${s}.`):e.name,o=this._getValue(l),p=e.schema.properties?Object.keys(e.schema.properties):[];r.label=e.label||e.title,r.schema=e.schema,r.resources=this.resources,r.setAttribute("language",this.language),r.setAttribute("name",l),Object.keys(e.component.type).forEach(t=>{r.setAttribute(t,e.component.type[t])}),e.schema.hidden&&r.setAttribute("hidden",!0),i&&(r.slot=i),t.append(r),e.component.type.isArray&&s<0?(r.addEventListener("add",e=>this._setValue(`${l}.${o.length}`,{})),r.addEventListener("remove",e=>{let t=this._deepClone(o);t.splice(parseInt(e.detail.id.replace(/item-/,"")),1),console.log(t,parseInt(e.detail.id.replace(/item-/,""))),this._setValue(`${l}`,t)}),e.sortBy&&(o=o.sort((t,s)=>{let i=0,r=0,l=0;for(;i<e.sortBy.length&&r===l;)r=t[e.sortBy[i]],l=s[e.sortBy[i]],i++;return r===l?0:r<l?-1:1})),o&&o.forEach((t,s)=>{let i=`item-${s}`,o=r.buildItem(i),a=e.component.type.sortSlot,n=e.component.type.previewSlot,m=p.filter(t=>!0===e.schema.properties[t].previewField);m.length<1&&m.push(p[0]),p.forEach(t=>{let i=e.schema.properties[t].name.replace(`${l}..`,"");this._buildFormElement(e.schema.properties[t],o,s,a&&e.sortBy[0]===i?a:m.includes(t)?n:void 0)})})):e.schema&&e.schema.properties?Object.keys(e.schema.properties).forEach(t=>this._buildFormElement(e.schema.properties[t],r)):(r[e.component.valueProperty]=o,r.onchange=t=>this._setValue(l,r[e.component.valueProperty]))}_getProperties(e=this.schema,t){let s=this;return Object.keys(e.properties||[]).map(i=>{let r=e.properties[i],l={name:t?`${t}.${i}`:i,schema:r,component:r.component||{},description:r.description,label:r.title||i,previewField:r.previewField,sortBy:r.sortBy};return l.component.valueProperty=l.component.valueProperty||"value",l.component.slot=l.component.slot||"",Object.keys(s.dataTypes).forEach(e=>{(Array.isArray(r.type)&&-1!==r.type.indexOf(e)||r.type===e)&&(l.component.type=this._deepClone(s.dataTypes[e]),l.component.type.element=l.component.name||l.component.type.element,l.component.type.type=r.format,(l.component.type.isFieldset||l.component.type.isArray)&&(r.items&&r.items.properties||(r.items={properties:r.properties?this._deepClone(r.properties):{}}),r.items&&r.items.properties&&(l.schema.properties=this._getProperties(r.items,l.component.type.isArray?`${l.name}.`:l.name))))}),l.component.type&&l.component.type.element||console.error("Unknown property type %s",r.type),l})}_setValue(e,t){let s=this._deepClone(this.value),i=this.value,r=e.split("."),l=r.length;for(var o=0;o<l-1;o++){let e=r[o];i[e]||(i[e]={}),i=i[e]}i[r[l-1]]=t,this._valueChanged(this.value,s)}_getValue(e){let t=e.split("."),s=this.value;return t.forEach(e=>{s=s&&s[e]?s[e]:void 0}),s}updated(e){e.forEach((e,t)=>{"schema"===t&&this._schemaChanged(this.schema,e),"value"===t&&this._valueChanged(this.value,e)})}_clearForm(){this.querySelectorAll("*").forEach(e=>e.remove())}_deepClone(e){return JSON.parse(JSON.stringify(e))}_rebuildForm(){if(this._clearForm(),this.schema){this._getProperties(this.schema).forEach(e=>this._buildFormElement(e))}}_valueChanged(e,t){console.log("this._valueChanged",this.value,t),e&&e!==t&&(this._rebuildForm(),this.dispatchEvent(new CustomEvent("value-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this})))}_schemaChanged(e,t){e&&e!==t&&(this._rebuildForm(),this.dispatchEvent(new CustomEvent("schema-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this})))}disconnectedCallback(){this._clearForm(),super.disconnectedCallback()}}window.customElements.define(SimpleFieldsSchema.tag,SimpleFieldsSchema);export{SimpleFieldsSchema};