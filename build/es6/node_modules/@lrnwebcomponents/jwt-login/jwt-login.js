import{LitElement as e,html as t}from"../../lit-element/lit-element.js";import"../../@polymer/iron-ajax/iron-ajax.js";class JwtLogin extends e{constructor(){super(),this.auto=!1,this.method="GET",this.body={},this.key="jwt",this.jwt=null}lastErrorChanged(e){e.detail.value&&(console.error(e),this.dispatchEvent(new CustomEvent("jwt-login-refresh-error",{composed:!0,bubbles:!0,cancelable:!1,detail:{value:e.detail.value}})))}render(){return t`
      <iron-ajax
        reject-with-request
        ?auto="${this.auto}"
        id="request"
        method="${this.method}"
        url="${this.url}"
        handle-as="json"
        content-type="application/json"
        @response="${this.loginResponse}"
        @last-error-changed="${this.lastErrorChanged}"
      >
      </iron-ajax>
    `}static get tag(){return"jwt-login"}static get properties(){return{auto:{type:Boolean},refreshUrl:{type:String,attribute:"refresh-url"},redirectUrl:{type:String,attribute:"redirect-url"},logoutUrl:{type:String,attribute:"logout-url"},url:{type:String},method:{type:String},body:{type:Object},key:{type:String},jwt:{type:String}}}updated(e){e.forEach((e,t)=>{"jwt"==t&&(this._jwtChanged(this[t],e),this.dispatchEvent(new CustomEvent("jwt-changed",{detail:{value:this[t]}})))})}_jwtChanged(e,t){null!=e&&""!=e&&"null"!=e||void 0===t?e&&(localStorage.setItem(this.key,e),this.dispatchEvent(new CustomEvent("jwt-token",{bubbles:!0,cancelable:!0,composed:!0,detail:e})),this.dispatchEvent(new CustomEvent("jwt-logged-in",{bubbles:!0,cancelable:!0,composed:!0,detail:!0}))):(localStorage.removeItem(this.key),this.dispatchEvent(new CustomEvent("jwt-logged-in",{bubbles:!0,cancelable:!0,composed:!0,detail:!1})))}connectedCallback(){super.connectedCallback(),window.addEventListener("jwt-login-refresh-token",this.requestRefreshToken.bind(this)),window.addEventListener("jwt-login-toggle",this.toggleLogin.bind(this)),window.addEventListener("jwt-login-login",this.loginRequest.bind(this)),window.addEventListener("jwt-login-logout",this.logoutRequest.bind(this))}disconnectedCallback(){window.removeEventListener("jwt-login-refresh-token",this.requestRefreshToken.bind(this)),window.removeEventListener("jwt-login-login",this.loginRequest.bind(this)),window.removeEventListener("jwt-login-toggle",this.toggleLogin.bind(this)),window.removeEventListener("jwt-login-logout",this.logoutRequest.bind(this)),super.disconnectedCallback()}firstUpdated(e){this.jwt=localStorage.getItem(this.key)}requestRefreshToken(e){this.__context="refresh",e.detail.element&&(this.__element=e.detail.element),this.shadowRoot.querySelector("#request").url=this.refreshUrl,this.shadowRoot.querySelector("#request").body={},this.shadowRoot.querySelector("#request").generateRequest()}toggleLogin(e){null==this.jwt?this.loginRequest(e):this.logoutRequest(e)}loginRequest(e){this.__context="login",this.body=e.detail,this.shadowRoot.querySelector("#request").url=this.url,this.shadowRoot.querySelector("#request").body={...this.body},this.shadowRoot.querySelector("#request").generateRequest()}logoutRequest(e){this.__context="logout",this.__redirect=e.detail.redirect,this.body={},this.jwt=null,this.shadowRoot.querySelector("#request").url=this.logoutUrl,this.shadowRoot.querySelector("#request").body={},this.shadowRoot.querySelector("#request").generateRequest()}loginResponse(e){if(200==e.detail.status&&"Access denied"!=e.detail.response)switch(this.__context){case"login":this.jwt=e.detail.response;break;case"refresh":this.jwt=e.detail.response,this.__element&&(this.__element.obj[this.__element.callback](this.jwt,...this.__element.params),this.__element=!1);break;case"logout":this.__redirect&&this.redirectUrl&&setTimeout(()=>{window.location.href=this.redirectUrl},100)}else this.lastErrorChanged(e)}}window.customElements.define(JwtLogin.tag,JwtLogin);export{JwtLogin};