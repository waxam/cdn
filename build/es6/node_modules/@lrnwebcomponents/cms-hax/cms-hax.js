import{LitElement,html,css}from"../../lit-element/lit-element.js";import"../../@polymer/iron-ajax/iron-ajax.js";import"../h-a-x/h-a-x.js";class CmsHax extends LitElement{static get styles(){return[css`
        :host {
          display: block;
          font-size: 16px;
          box-sizing: content-box;
        }
      `]}render(){return html`
      <iron-ajax
        id="pageupdateajax"
        url="${this.endPoint}"
        method="${this.method}"
        content-type="application/json"
        handle-as="json"
        @response="${this._handleUpdateResponse}"
      ></iron-ajax>
      <h-a-x app-store="${this.__appStore}"></h-a-x>
    `}static get tag(){return"cms-hax"}decodeHTMLEntities(text){for(var entities=[["amp","&"],["apos","'"],["#x27","'"],["#x2F","/"],["#39","'"],["#47","/"],["lt","<"],["gt",">"],["nbsp"," "],["quot",'"']],i=0,max=entities.length;i<max;++i)text=text.replace(new RegExp("&"+entities[i][0]+";","g"),entities[i][1]);return text}static get properties(){return{__ready:{type:Boolean},openDefault:{type:Boolean,reflect:!0,attribute:"open-default"},hideExportButton:{type:Boolean,attribute:"hide-export-button"},hidePanelOps:{type:Boolean,attribute:"hide-panel-ops"},hidePreferencesButton:{type:Boolean,attribute:"hide-preferences-button"},align:{type:String},allowedTags:{type:Array},endPoint:{type:String,attribute:"end-point"},method:{type:String},appStoreConnection:{type:String,attribute:"app-store-connection"},__appStore:{type:String},editMode:{type:Boolean,reflect:!0,attribute:"edit-mode"},syncBody:{type:Boolean,attribute:"sync-body"},bodyValue:{type:String,attribute:"body-value"},hideMessage:{type:Boolean,attribute:"hide-message"},redirectLocation:{type:String,attribute:"redirect-location"},redirectOnSave:{type:Boolean,attribute:"redirect-on-save"},activeHaxBody:{type:Object},__imported:{type:Boolean}}}_activeHaxBodyUpdated(bodyElement,ready){if(null!=bodyElement&&ready&&!this.__imported){this.__imported=!0;let children=this.querySelector("template");null!=children&&bodyElement.importContent(children.innerHTML)}}_computeRedirectOnSave(redirectLocation){return void 0!==redirectLocation}_noticeTagChanges(openDefault,allowedTags,hideExportButton,hidePanelOps,hidePreferencesButton,align){window.HaxStore.ready&&(allowedTags&&(window.HaxStore.instance.validTagList=allowedTags),window.HaxStore.instance.haxPanel.hideExportButton=hideExportButton,window.HaxStore.instance.haxPanel.hidePanelOps=hidePanelOps,window.HaxStore.instance.haxPanel.hidePreferencesButton=hidePreferencesButton,window.HaxStore.instance.haxPanel.align=align,openDefault&&window.HaxStore.write("editMode",openDefault,this))}firstUpdated(){this.__applyMO(),this.__ready=!0}_storeReady(e){setTimeout(()=>{this._noticeTagChanges(this.openDefault,this.allowedTags,this.hideExportButton,this.hidePanelOps,this.hidePreferencesButton,this.align),this.__applyMO()},0)}constructor(){super(),window.addEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.addEventListener("hax-store-ready",this._storeReady.bind(this)),window.addEventListener("hax-save",this._saveFired.bind(this)),this.__lock=!1,this.openDefault=!1,this.hideExportButton=!0,this.hidePanelOps=!1,this.hidePreferencesButton=!1,this.align="right",this.method="PUT",this.syncBody=!1,this.bodyValue="",this.hideMessage=!1,this.__imported=!1,window.SimpleToast.requestAvailability(),import("./lib/cms-token.js"),import("./lib/cms-block.js"),import("./lib/cms-views.js"),import("./lib/cms-entity.js"),import("../simple-toast/simple-toast.js")}_makeAppStore(val){this.__appStore=this.decodeHTMLEntities(val)}updated(changedProperties){changedProperties.forEach((oldValue,propName)=>{"redirectLocation"==propName&&(this.redirectOnSave=this._computeRedirectOnSave(this[propName])),"activeHaxBody"!=propName&&"__ready"!=propName||this._activeHaxBodyUpdated(this.activeHaxBody,this.__ready),"appStoreConnection"==propName&&this._makeAppStore(this[propName]),["openDefault","allowedTags","hideExportButton","hidePanelOps","hidePreferencesButton","align"].includes(propName)&&this._noticeTagChanges(this.openDefault,this.allowedTags,this.hideExportButton,this.hidePanelOps,this.hidePreferencesButton,this.align)})}disconnectedCallback(){this._observer&&(this._observer.disconnect(),this._observer=null),super.disconnectedCallback()}connectedCallback(){super.connectedCallback(),this.__applyMO()}__applyMO(){!this._observer&&this.syncBody&&window.HaxStore&&window.HaxStore.instance&&window.HaxStore.instance.activeHaxBody&&(this._observer=new MutationObserver(mutations=>{this.__lock||(this.__lock=!0,this.dispatchEvent(new CustomEvent("hax-body-content-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:window.HaxStore.instance.activeHaxBody.haxToContent()})),setTimeout(()=>{this.__lock=!1},100))}),this._observer.observe(window.HaxStore.instance.activeHaxBody,{childList:!0,subtree:!0}))}_haxStorePropertyUpdated(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&("object"==typeof e.detail.value&&(this[e.detail.property]={}),this[e.detail.property]=e.detail.value)}_saveFired(e){this.shadowRoot.querySelector("#pageupdateajax").body=window.HaxStore.instance.activeHaxBody.haxToContent(),this.shadowRoot.querySelector("#pageupdateajax").generateRequest()}_handleUpdateResponse(e){if(!this.hideMessage){const evt=new CustomEvent("simple-toast-show",{bubbles:!0,cancelable:!0,composed:!0,detail:{text:"Saved!",duration:3e3}});this.dispatchEvent(evt),this.redirectOnSave&&setTimeout(()=>{window.location=this.redirectLocation},500)}}}window.customElements.define(CmsHax.tag,CmsHax);export{CmsHax};