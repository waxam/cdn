import{html as e,css as t}from"../../lit-element/lit-element.js";import{SimpleColors as i}from"../simple-colors/simple-colors.js";import{UndoManagerBehaviors as o}from"../undo-manager/undo-manager.js";import{HAXStore as a}from"./lib/hax-store.js";import{autorun as n,toJS as s}from"../../mobx/dist/mobx.esm.js";import{encapScript as l,wipeSlot as r,generateResourceID as d,nodeToHaxElement as c,haxElementToNode as h,camelToDash as u,wrap as m,unwrap as p,ReplaceWithPolyfill as g,normalizeEventPath as v}from"../utils/utils.js";Element.prototype.replaceWith||(Element.prototype.replaceWith=g),CharacterData.prototype.replaceWith||(CharacterData.prototype.replaceWith=g),DocumentType.prototype.replaceWith||(DocumentType.prototype.replaceWith=g),String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){return this.split(e).join(t)});var b=null;class HaxBody extends(o(i)){static get tag(){return"hax-body"}static get styles(){return[...super.styles,t`
        :host([edit-mode]),
        :host([edit-mode]) * ::slotted(*) {
          line-height: 1.8;
        }
        :host([edit-mode]) ul,
        :host([edit-mode]) ol {
          padding-left: 20px;
          margin-left: 20px;
        }
        :host([edit-mode]) ul {
          list-style-type: disc;
        }
        :host([edit-mode]) li {
          margin-bottom: 6px;
        }
        :host {
          display: block;
          position: relative;
          min-height: 32px;
          min-width: 32px;
          outline: none;
          --hax-contextual-action-text-color: var(
            --simple-colors-default-theme-grey-1,
            #fff
          );
          --hax-contextual-action-hover-color: var(
            --simple-colors-default-theme-grey-8,
            #009dc7
          );
          --hax-contextual-action-color: var(
            --simple-colors-default-theme-grey-12,
            #007999
          );
          --hax-body-editable-outline: 0px solid
            var(--simple-colors-default-theme-grey-4, #eeeeee);
          --hax-body-active-outline-hover: 1px solid
            var(--simple-colors-default-theme-grey-8, #eeeeee);
          --hax-body-active-outline: 0px solid
            var(
              --hax-contextual-action-hover-color,
              var(--simple-colors-default-theme-cyan-7, #009dc7)
            );
          --hax-body-active-drag-outline: 1px solid
            var(
              --hax-contextual-action-hover-color,
              var(--simple-colors-default-theme-cyan-7, #009dc7)
            );
          --hax-body-target-background-color: var(
            --simple-colors-default-theme-grey-11,
            #009dc7
          );
          --hax-body-possible-target-background-color: inherit;
        }
        #addincontext {
          opacity: 0.5;
          transition: 0.2s opacity ease-in-out;
        }
        #addincontext:hover,
        #addincontext:active,
        #addincontext:focus {
          opacity: 1;
          cursor: pointer;
        }
        .hax-context-menu {
          padding: 0;
          margin-left: -5000px;
          position: fixed;
          visibility: hidden;
          opacity: 0;
          z-index: 1000;
          float: left;
          display: block;
          pointer-events: none;
          transition: 0.2s top ease-in-out, 0.2s left ease-in-out;
        }
        #textcontextmenu.hax-context-menu {
          z-index: 1000;
        }
        .hax-context-visible {
          position: absolute;
          visibility: visible;
          pointer-events: all;
          opacity: 1;
        }
        .hax-context-menu-active {
          margin-left: unset;
        }
        :host([edit-mode]) #bodycontainer ::slotted([contenteditable]) {
          -webkit-appearance: textfield;
          cursor: text;
          -moz-user-select: text;
          -khtml-user-select: text;
          -webkit-user-select: text;
          -o-user-select: text;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:empty):before {
          content: attr(data-hax-ray);
          opacity: 0.2;
          transition: 0.2s all ease-in-out;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:hover:empty):before {
          opacity: 0.4;
          cursor: text;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:empty:focus):before {
          content: "";
        }
        :host([edit-mode]) #bodycontainer ::slotted(p) {
          min-height: var(--hax-base-styles-p-min-height, 1rem);
          font-size: var(--hax-base-styles-p-font-size);
          line-height: var(--hax-base-styles-p-line-height);
          letter-spacing: var(--hax-base-styles-p-letter-spacing);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a) {
          color: var(--hax-base-styles-a-color);
          font-size: var(
            --hax-base-styles-a-font-size,
            var(--hax-base-styles-p-font-size)
          );
          font-weight: var(--hax-base-styles-a-font-weight);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:visited) {
          color: var(--hax-base-styles-a-color-visited);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:active),
        :host([edit-mode]) #bodycontainer ::slotted(a:focus),
        :host([edit-mode]) #bodycontainer ::slotted(a:hover) {
          color: var(--hax-base-styles-a-color-active);
          font-weight: var(--hax-base-styles-a-font-weight-active);
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol),
        :host([edit-mode]) #bodycontainer ::slotted(ul),
        :host([edit-mode]) #bodycontainer ::slotted(li) {
          padding-bottom: var(--hax-base-styles-list-padding-bottom);
          line-height: var(
            --hax-base-styles-list-line-height,
            var(--hax-base-styles-p-line-height)
          );
          font-size: var(
            --hax-base-styles-list-font-size,
            var(--hax-base-styles-p-font-size)
          );
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol > li:last-child),
        :host([edit-mode]) #bodycontainer ::slotted(ul > li:last-child) {
          padding-bottom: var(--hax-base-styles-list-last-child-padding-bottom);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img[contenteditable]) {
          max-width: 100%;
        }
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          outline: none;
          caret-color: auto;
        }
        :host([edit-mode]) #bodycontainer ::slotted(*.blinkfocus) {
          outline: 4px solid var(--hax-contextual-action-hover-color);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not(grid-plate)[contenteditable]:hover) {
          outline: var(--hax-body-active-outline-hover);
          caret-color: auto;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]:hover) {
          cursor: text !important;
          caret-color: auto;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not(grid-plate)[contenteditable] .hax-active:hover) {
          cursor: text !important;
          caret-color: auto;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(code.hax-active[contenteditable]) {
          display: block;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]) {
          outline: var(--hax-body-active-outline) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(hr[contenteditable]) {
          height: 2px;
          background-color: #eeeeee;
          padding-top: 4px;
          padding-bottom: 4px;
        }
        /** Fix to support safari as it defaults to none */
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          -webkit-user-select: text;
          cursor: pointer;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::-moz-selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::-moz-selection) {
          background-color: var(
            --hax-body-highlight,
            var(--simple-colors-default-theme-yellow-2, yellow)
          );
          color: black;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::selection) {
          background-color: var(
            --hax-body-highlight,
            var(--simple-colors-default-theme-yellow-2, yellow)
          );
          color: black;
        }
        #bodycontainer {
          -webkit-user-select: text;
          user-select: text;
        }
        .hax-context-menu:not(:defined) {
          display: none;
        }
        /* drag and drop */
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*):before {
          background-color: var(--hax-body-possible-target-background-color);
          content: " ";
          width: 100%;
          display: block;
          position: relative;
          margin: -12px 0 0 0;
          z-index: 2;
          height: 12px;
          transition: 0.2s all ease-in-out;
        }
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(img) {
          outline: var(--hax-body-editable-outline);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered),
        :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered):before {
          background-color: var(--hax-body-target-background-color) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered) {
          border-top: 8px
            var(
              --hax-contextual-action-hover-color,
              var(--simple-colors-default-theme-cyan-7, #009dc7)
            );
          margin-top: -8px;
        }

        @media screen and (min-color-index: 0) and(-webkit-min-device-pixel-ratio:0) {
          /*
            Define here the CSS styles applied only to Safari browsers
            (any version and any device) via https://solvit.io/bcf61b6
          */
          :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*) {
            outline: var(--hax-body-editable-outline);
            background-color: var(--hax-body-possible-target-background-color);
          }
          :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered) {
            background-color: var(
              --hax-body-target-background-color
            ) !important;
            outline: var(--hax-body-active-outline);
          }
        }
      `]}constructor(){super(),this.__ignoreActive=!1,this.__dragMoving=!1,this.___moveLock=!1,this.editMode=!1,this.haxMover=!1,this.activeNode=null,setTimeout(()=>{import("./lib/hax-text-context.js"),import("./lib/hax-ce-context.js"),import("./lib/hax-plate-context.js"),import("../grid-plate/grid-plate.js"),this.polyfillSafe=a.computePolyfillSafe(),this.addEventListener("place-holder-replace",this.replacePlaceholder.bind(this)),this.addEventListener("focusin",this._focusIn.bind(this)),this.addEventListener("mousemove",this._mouseMove.bind(this)),this.addEventListener("mouseleave",this._mouseLeave.bind(this)),this.addEventListener("touchstart",this._mouseMove.bind(this),{passive:!0}),this.addEventListener("mousedown",this._mouseDown.bind(this)),this.addEventListener("mouseup",this._mouseUp.bind(this)),this.addEventListener("dragenter",this.dragEnterBody.bind(this)),this.addEventListener("dragend",this.dragEndBody.bind(this)),this.addEventListener("drop",this.dropEvent.bind(this))},0),n(()=>{this.editMode=s(a.editMode)}),n(()=>{this.activeNode=s(a.activeNode)}),n(()=>{s(a.activeEditingElement)})}dragEndBody(e){this.__manageFakeEndCap(!1),a._lockContextPosition=!1,this.querySelectorAll(".hax-hovered").forEach(e=>{e.classList.remove("hax-hovered")})}_mouseLeave(e){this.editMode&&a.ready&&(clearTimeout(this.__mouseQuickTimer),clearTimeout(this.__mouseTimer),this.__activeHover=null,this._hideContextMenu(this.contextMenus.add))}_mouseMove(e){if(this.editMode&&a.ready){var t=v(e);clearTimeout(this.__mouseQuickTimer),this.__mouseQuickTimer=setTimeout(()=>{if(this.__activeHover&&this.__activeHover!=t[0].closest("[data-hax-ray]:not(li)")&&!t[0].closest("#addincontext")){let i;for(var e=0;e<t.length;e++)t[e].getAttribute&&"addincontext"==t[e].getAttribute("id")&&(i=!0);i||(this.__activeHover=null,this._hideContextMenu(this.contextMenus.add))}},300),clearTimeout(this.__mouseTimer),this.__mouseTimer=setTimeout(()=>{this.__addActiveVisible();let i=t[0].closest("[data-hax-ray]:not(li)");if(i){this.__activeHover=i;let t=this.__activeHover.getBoundingClientRect(),o=this.contextMenus.add.getBoundingClientRect(),a=(e.pageY-(t.top+window.scrollY))/t.height,n=-o.height-1;a>.3?(n=t.height+1,this.__addAbove=!1):this.__addAbove=!0,this._positionContextMenu(this.contextMenus.add,this.__activeHover,t.width/2-o.width/2,n)}else if(t[0].closest(".column")&&t[3]&&t[3].closest("grid-plate")){let i,o,a=this.contextMenus.add.getBoundingClientRect(),n=-a.height-1;if(t[0].closest(".column:not(.has-nodes")){if(this.__addAbove=!1,this.__slot=t[0].closest(".column").getAttribute("id").replace("col","col-"),0==t[0].closest(".column").parentNode.parentNode.host.children.length){let e=document.createElement("p");t[0].closest(".column").parentNode.parentNode.host.appendChild(e)}this.__activeHover=t[0].closest(".column").parentNode.parentNode.host.children[0],i=t[0].closest(".column").getBoundingClientRect(),n=i.height/2-a.height/2,o=t[0].closest(".column")}else{this.__activeHover=t[0].closest(".column").parentNode.parentNode.host,o=this.__activeHover,i=this.__activeHover.getBoundingClientRect(),(e.pageY-(i.top+window.scrollY))/i.height>.3?(n=i.height+1,this.__addAbove=!1):this.__addAbove=!0}this._positionContextMenu(this.contextMenus.add,o,i.width/2-a.width/2,n)}else t[0].closest("#bodycontainer")&&(this.__activeHover=null,this._hideContextMenu(this.contextMenus.add))},400)}}_mouseDown(e){if(this.editMode){this.__mouseDown=!0;let t=e.target;t.closest("[draggable]")?t=t.closest("[draggable]"):t.closest("[slot]")?t=t.closest("[slot]"):t.closest("[data-hax-ray]")?t=t.closest("[data-hax-ray]"):t.closest("[contenteditable]")?t=t.closest("[contenteditable]"):a.validTagList.includes(t.tagName.toLowerCase())||"HAX-BODY"!==t.tagName&&console.warn(t),!t.haxUIElement&&this.__focusLogic(t)&&(e.stopPropagation(),e.stopImmediatePropagation())}}_mouseUp(e){setTimeout(()=>{this.__mouseDown=!1},0),clearTimeout(b),this.__manageFakeEndCap(!1)}clickEvent(e){clearTimeout(b)}blurEvent(e){this.editMode&&a.activeEditingElement}__manageFakeEndCap(e=!0){if(e&&!this.__fakeEndCap){let e=document.createElement("fake-hax-body-end");e.style.width="100%",e.style.height="20px",e.style.zIndex="2",e.style.display="block",this.__fakeEndCap=e,this.haxMover=!0,this.appendChild(this.__fakeEndCap),this.__applyNodeEditableState(this.__fakeEndCap,!0)}else!e&&this.__fakeEndCap&&(this.__fakeEndCap.remove(),this.haxMover=!1,this.__fakeEndCap=null)}dragEnterBody(e){this.__manageFakeEndCap(!0)}render(){return e`
      <div id="bodycontainer" class="ignore-activation">
        <slot id="body"></slot>
      </div>
      <hax-text-context
        id="textcontextmenu"
        class="hax-context-menu ignore-activation"
      ></hax-text-context>
      <hax-ce-context
        id="cecontextmenu"
        class="hax-context-menu ignore-activation"
      ></hax-ce-context>
      <hax-plate-context
        id="platecontextmenu"
        class="hax-context-menu ignore-activation"
      ></hax-plate-context>
      <hax-context-item
        id="addincontext"
        class="hax-context-menu ignore-activation"
        icon="icons:add-circle"
        label="Add here"
        mini
        circle
      >
      </hax-context-item>
    `}static get properties(){return{...super.properties,haxMover:{type:Boolean,attribute:"hax-mover",reflect:!0},editMode:{type:Boolean,reflect:!0,attribute:"edit-mode"},activeNode:{type:Object}}}firstUpdated(e){this.dispatchEvent(new CustomEvent("hax-register-body",{bubbles:!0,cancelable:!0,composed:!0,detail:this}));try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("defaultParagraphSeparator",!1,"p")}catch(e){console.warn(e)}this.contextMenus={text:this.shadowRoot.querySelector("#textcontextmenu"),plate:this.shadowRoot.querySelector("#platecontextmenu"),ce:this.shadowRoot.querySelector("#cecontextmenu"),add:this.shadowRoot.querySelector("#addincontext")},this.contextMenus.add.addEventListener("click",this._addInContextClick.bind(this)),this.shadowRoot.querySelector("slot").addEventListener("mouseup",e=>{this.editMode&&setTimeout(()=>{const e=a.getSelection();a._tmpSelection=e,a.haxSelectedText=e.toString();try{const e=a.getRange();e.cloneRange&&(a._tmpRange=e.cloneRange())}catch(e){console.warn(e)}},10)}),this.editMode=a.editMode,this.__tabTrap=!1,this.ready=!0,super.firstUpdated&&super.firstUpdated(e)}_addInContextClick(e){this.__mouseDown=!1;["ul","ol"].includes(this.__activeHover.parentNode.tagName.toLowerCase())&&(this.__activeHover=this.__activeHover.parentNode),this.haxInsert("p","",{},this.__activeHover),this.__activeHover=null,this._hideContextMenu(this.contextMenus.add)}updated(e){e.forEach((e,t)=>{"editMode"==t&&void 0!==e&&setTimeout(()=>{this._editModeChanged(this[t],e),this[t]?(this._activeNodeChanged(this.activeNode,null),this.activeNode.focus()):this._activeNodeChanged(null,this.activeNode)},0),"activeNode"==t&&this.ready&&this._activeNodeChanged(this[t],e)}),super.updated&&super.updated(e)}connectedCallback(){super.connectedCallback(),this._observer=new MutationObserver(e=>{var t=!1;this.__ignoreActive||this.__dragMoving||this.undoStackIgnore||this.__fakeEndCap?this.undoStackIgnore?e.forEach(e=>{e.addedNodes.length>0&&e.addedNodes.forEach(e=>{this._validElementTest(e)&&setTimeout(()=>{this.__applyNodeEditableState(e,this.editMode)},0)})}):this.__ignoreActive&&(this.__ignoreActive=!1):e.forEach(e=>{if(e.addedNodes.length>0){for(var i of e.addedNodes)if(this._validElementTest(i)){if(!this.__delHit&&"BR"===i.tagName&&i.parentElement&&a.__validGridTags().includes(i.parentElement.tagName.toLowerCase())&&i===i.parentElement.childNodes[i.parentElement.childNodes.length-1]){let e=i.parentElement;if(i.remove(),e.childNodes.length>0){let t=e.childNodes[e.childNodes.length-1];t.textContent+="​",a._positionCursorInNode(t,t.length)}continue}if(this.__delHit=!1,"P"===i.tagName&&i.children.length>0&&"P"===i.children[0].tagName){p(i);continue}if("P"===i.tagName&&i.parentElement&&"P"===i.parentElement.tagName){p(i.parentElement);continue}if(null!=i.getAttribute("slot")&&i.parentElement===this){i.removeAttribute("slot");continue}if("LI"===i.tagName&&i.children.length>0&&"SPAN"===i.children[0].tagName){this.activeNode!==i.children[0]&&this.activeNode!==i||(this.activeNode=i),p(i.children[0]);continue}if("LI"===i.tagName&&i.parentElement&&!["UL","OL"].includes(i.parentElement.tagName)){p(i);continue}if("P"===i.tagName&&i.children.length>0&&["P","LI"].includes(i.children[0].tagName)){p(i.children[0]);continue}if(this.__slot&&(i.setAttribute("slot",this.__slot),this.__slot=null),this.__indentTrap)if("SPAN"===i.tagName)i.parentNode===this?this.haxChangeTagName(i,"p",!0):"LI"===i.parentNode.tagName&&(i.parentNode.innerHTML=i.textContent);else if("BR"===i.tagName){i.remove();continue}if(!this.editMode||"true"!=i.getAttribute("contenteditable")&&!0!==i.getAttribute("contenteditable")&&"contenteditable"!=i.getAttribute("contenteditable")||this.__applyNodeEditableState(i,!this.editMode),this.__applyNodeEditableState(i,this.editMode),a.isGridPlateElement(i)){let e=i.querySelectorAll("*");for(var o=0;o<e.length;o++)this._validElementTest(e[o])&&this.__applyNodeEditableState(e[o],this.editMode)}if(["H1","H2","H3","H4","H5","H6"].includes(i.tagName)&&null==i.getAttribute("id")&&i.setAttribute("id",d("header-")),this.___moveLock||t)this.___moveLock=!1;else if(t=!0,a.activeNode=i,"BR"===i.tagName){const e=a.getSelection();a._tmpSelection=e,a.haxSelectedText=e.toString();const t=a.getRange();t.collapsed&&"BR"===this.activeNode.tagName&&this.activeNode.parentNode===t.commonAncestorContainer&&""===this.activeNode.innerText&&(a.activeNode=this.activeNode.parentNode)}}this.__indentTrap&&setTimeout(()=>{this.__indentTrap=!1},0)}})}),this._observer.observe(this,{childList:!0,subtree:!0}),window.addEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),window.addEventListener("click",this.clickEvent.bind(this)),window.addEventListener("blur",this.blurEvent.bind(this)),window.addEventListener("keydown",this._onKeyDown.bind(this)),window.addEventListener("keypress",this._onKeyPress.bind(this)),document.body.addEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.addEventListener("scroll",this._keepContextVisible.bind(this),{passive:!0}),window.addEventListener("resize",this._keepContextVisible.bind(this),{passive:!0})}disconnectedCallback(){window.removeEventListener("click",this.clickEvent.bind(this)),window.removeEventListener("blur",this.blurEvent.bind(this)),window.removeEventListener("keydown",this._onKeyDown.bind(this)),window.removeEventListener("keypress",this._onKeyPress.bind(this)),document.body.removeEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.removeEventListener("scroll",this._keepContextVisible.bind(this)),window.removeEventListener("resize",this._keepContextVisible.bind(this)),window.removeEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),this._observer.disconnect(),super.disconnectedCallback()}_keepContextVisible(e=null){this.editMode&&(clearTimeout(this.__contextVisibleLock),this.__contextVisibleLock=setTimeout(()=>{let e=!1;this.contextMenus.text.classList.contains("hax-context-visible")?e=this.contextMenus.text:this.contextMenus.ce.classList.contains("hax-context-visible")&&(e=this.contextMenus.ce),e&&(this.activeNode&&this.elementMidViewport()?(e.classList.add("hax-context-pin-top"),this.contextMenus.plate.classList.add("hax-context-pin-top")):(e.classList.remove("hax-context-pin-top"),this.contextMenus.plate.classList.remove("hax-context-pin-top")),this.positionContextMenus())},100))}_onKeyDown(e){if(this.editMode&&"HAX-TRAY"!==document.activeElement.tagName&&"BODY"!==document.activeElement.tagName&&"SIMPLE-MODAL"!==document.activeElement.tagName&&this.getAttribute("contenteditable")){if(this.__dropActiveVisible(),this.__manageFakeEndCap(!1),null!=a.getSelection().anchorNode)switch(e.key){case"Z":case"z":e.ctrlKey&&(e.shiftKey?this.redo():this.undo(),e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation());break;case"Tab":a.isTextElement(this.activeNode)&&(e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),e.shiftKey?this._tabBackKeyPressed():this._tabKeyPressed());break;case"Enter":if(this.activeNode&&(this.__slot=this.activeNode.getAttribute("slot")),this.activeNode&&"P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const e=this.activeNode.textContent.replaceAll(/ /g," ");this.keyboardShortCutProcess(e)}break;case"Backspace":case"Delete":this.__delHit=!0;break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":setTimeout(()=>{const e=a.getSelection();a._tmpSelection=e,a.haxSelectedText=e.toString();const t=a.getRange();t.commonAncestorContainer&&this.activeNode!==t.commonAncestorContainer&&"function"==typeof t.commonAncestorContainer.focus?"HAX-BODY"!==t.commonAncestorContainer.tagName&&this.__focusLogic(t.commonAncestorContainer,!1):t.commonAncestorContainer&&t.commonAncestorContainer.parentNode&&this.activeNode!==t.commonAncestorContainer.parentNode&&"function"==typeof t.commonAncestorContainer.parentNode.focus&&("HAX-BODY"!==t.commonAncestorContainer.parentNode.tagName?this.__focusLogic(t.commonAncestorContainer.parentNode,!1):this.__focusLogic(t.commonAncestorContainer,!1))},0);break;default:setTimeout(()=>{if(this.activeNode&&"P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const e=this.activeNode.textContent.replaceAll(/ /g," ");" "===e[e.length-1]&&this.keyboardShortCutProcess(e)}},0)}}}keyboardShortCutProcess(e){if(a.keyboardShortcuts[e.replace(" ","")]){let t=h(a.keyboardShortcuts[e.replace(" ","")]);this.haxReplaceNode(this.activeNode,t),this.__focusLogic(t),"HR"===t.tagName&&this.haxInsert("p","",{})}else if("!"===e[0]){let t=e.replace("!","").replaceAll(/ /g,"");if(a.elementList[t]){let e,i=a.haxSchemaFromTag(t);e=i.gizmo.tag&&i.demoSchema&&i.demoSchema[0]?h(i.demoSchema[0]):document.createElement(t),this.haxReplaceNode(this.activeNode,e),this.__focusLogic(e)}else a.toast(t+" is not a valid tag")}}_onKeyPress(e){clearTimeout(this.__keyPress),this.__keyPress=setTimeout(()=>{this.editMode&&this.activeNode&&a.isTextElement(this.activeNode)&&("Enter"===e.key&&(this.activeNode=this.activeNode.nextElementSibling),clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout(()=>{this.__addActiveVisible(),this.positionContextMenus()},2500))},50)}elementMidViewport(){const e=this.activeNode.getBoundingClientRect().y;return e<0&&e>-1*this.activeNode.offsetHeight+140}replacePlaceholder(e){if("text"===e.detail){let e=document.createElement("p");this.haxReplaceNode(this.activeNode,e),this.__focusLogic(e),this.activeNode.parentNode&&this.activeNode.parentNode.setAttribute("contenteditable",!0)}else this.replaceElementWorkflow()}canTansformNode(e=null){return this.replaceElementWorkflow(e,!0).length>0}replaceElementWorkflow(e=null,t=!1){null==e&&(e=this.activeNode);let i=c(e,null),o="*",n=!1;"place-holder"===i.tag&&void 0!==i.properties.type&&(o=i.properties.type,n=!0);var s={};if(void 0!==a.elementList[i.tag]&&!1!==a.elementList[i.tag].gizmo&&void 0!==a.elementList[i.tag].gizmo.handles&&a.elementList[i.tag].gizmo.handles.length>0){let e=a.elementList[i.tag].gizmo;for(var l=0;l<e.handles.length;l++)for(var r in e.handles[l])"type"!==r&&void 0!==i.properties[e.handles[l][r]]&&(s[r]=i.properties[e.handles[l][r]])}let d=a.guessGizmo(o,s,n);if(d.length>0){let i=e.tagName.toLowerCase(),o=i.replace("-"," ");void 0!==a.elementList[i]&&!1!==a.elementList[i].gizmo&&(o=a.elementList[i].gizmo.title),t||(a.activePlaceHolder=this.activeNode,a.haxAppPicker.presentOptions(d,"__convert",`Transform ${o} to..`,"gizmo"))}else t||a.toast("Sorry, this can not be transformed!",5e3);return d}_haxStorePropertyUpdated(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&(this[e.detail.property]=e.detail.value)}haxClearBody(e=!0){let t=!0;e&&(t=prompt("Are you sure you want to delete all content?")),t&&r(this)}haxInsert(e,t,i={},o=this.activeNode){var n=document.createElement(e);n.innerHTML=t;const s=n.cloneNode(!0);for(var l in i){let e=u(l);i.hasOwnProperty(l)&&(!0===i[l]?s.setAttribute(e,e):!1===i[l]?s.removeAttribute(e):null!=i[l]&&i[l].constructor===Array||null!=i[l]&&i[l].constructor===Object?s.properties&&s.properties[l].readOnly||(s.set?s.set(e,i[l]):s[e]=i[l]):s.setAttribute(e,i[l]))}return null!==a.activePlaceHolder&&void 0!==a.activePlaceHolder.style?(s.style.width=a.activePlaceHolder.style.width,s.style.float=a.activePlaceHolder.style.float,s.style.margin=a.activePlaceHolder.style.margin,s.style.display=a.activePlaceHolder.style.display,this.haxReplaceNode(a.activePlaceHolder,s),a.activePlaceHolder=null):o&&o.parentNode?"GRID-PLATE"===o.parentNode.tagName?(null!=o.getAttribute("slot")&&s.setAttribute("slot",o.getAttribute("slot")),this.__addAbove?o.parentNode.insertBefore(s,o):o.parentNode.insertBefore(s,o.nextElementSibling)):o.parentNode&&o.parentNode.nextElementSibling?o.parentNode.nextElementSibling.parentNode.insertBefore(s,o.parentNode.nextElementSibling):o.parentNode&&o.nextElementSibling?this.__addAbove?o.parentNode.insertBefore(s,o):o.parentNode.insertBefore(s,o.nextElementSibling):o.parentNode&&o.parentNode.children[o.parentNode.children.length-1]===o?this.__addAbove?o.parentNode.insertBefore(s,o):o.parentNode.appendChild(s):o.parentNode?o.parentNode.insertBefore(s,o):this.appendChild(s):this.appendChild(s),this.contextMenus.text.hasSelectedText=!1,setTimeout(()=>{this.__focusLogic(s),this.scrollHere(s)},0),s}haxToContent(){this.hideContextMenus();var e=this.activeNode;a.activeNode=null;let t="slot"===this.shadowRoot.querySelector("#body").localName?this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}):[];for(var i="",o=0;o<t.length;o++)if(this._validElementTest(t[o]))t[o].removeAttribute("data-hax-ray"),t[o].classList.remove("hax-hovered"),t[o].contentEditable=!1,i+=a.nodeToContent(t[o]),"grid-plate"===t[o].tagName.toLowerCase()&&this._applyContentEditable(this.editMode,t[o]);else if(8===t[o].nodeType)i+="\x3c!-- "+t[o].textContent+" --\x3e";else if(t[o].haxUIElement&&t[o].children&&t[o].children[0]){let e=a.runHook(t[o],"activeElementChanged",[this.activeNode,!1]);e&&e!==t[o]?i+=a.nodeToContent(e):i+=a.nodeToContent(t[o].children[0])}else 1!==t[o].nodeType&&void 0!==t[o].textContent&&"undefined"!==t[o].textContent&&(i+=t[o].textContent);if(i=(i=(i=(i=i.replace(/\scontenteditable=\"false\"/g,"")).replace(/\scontenteditable/g,"")).replace(/\sdraggable/g,"")).replace(/\sdata-hax-ray=\".*?\"/g,""),this.parentNode.tagName){let e=this.parentNode.tagName.toLowerCase(),t="style-scope "+e+" x-scope",n=new RegExp(t,"g");i=i.replace(n,""),t="style-scope "+e,n=new RegExp(t,"g"),i=i.replace(n,""),t="x-scope "+e+"-0",n=new RegExp(t,"g"),i=i.replace(n,"");let s=a.validTagList;for(var o in s)t="style-scope "+s[o],n=new RegExp(t,"g"),i=i.replace(n,""),t="x-scope "+s[o]+"-0 ",n=new RegExp(t,"g"),i=i.replace(n,""),t="x-scope "+s[o]+"-0",n=new RegExp(t,"g"),i=i.replace(n,"")}return i=(i=i.replace(/\sclass=\"\"/g,"")).replace(/\sclass=\"\s\"/g,""),this._applyContentEditable(this.editMode),a.activeNode=e,i=l(i)}haxDuplicateNode(e){let t=c(e,null);var i=a.elementList[e.tagName.toLowerCase()];if(void 0!==i&&void 0!==i.saveOptions.unsetAttributes)for(var o in i.saveOptions.unsetAttributes)t.properties[i.saveOptions.unsetAttributes[o]]&&delete t.properties[i.saveOptions.unsetAttributes[o]];a.testHook(e,"preProcessInsertContent")&&(t=a.runHook(e,"preProcessInsertContent",[t])),t.content==t.properties.innerHTML&&delete t.properties.innerHTML;var n=h({tag:t.tag,content:t.content,properties:t.properties});return"webview"===n.tagName.toLowerCase()&&a._isSandboxed&&void 0!==n.guestinstance&&delete n.guestinstance,null!==e?e.parentNode.insertBefore(n,e.nextSibling):e.parentNode.appendChild(n),a.activeNode=n,!0}hideContextMenus(e=!0){clearTimeout(b),clearTimeout(this.__keyPress),clearTimeout(this.__contextVisibleLock),clearTimeout(this.__positionContextTimer),this._hideContextMenu(this.contextMenus.text),this._hideContextMenu(this.contextMenus.ce),this._hideContextMenu(this.contextMenus.add),this.__activeHover=null,e&&this._hideContextMenu(this.contextMenus.plate)}positionContextMenus(e=this.activeNode){if(e&&e.tagName&&this.ready){let t=e.tagName.toLowerCase();a.elementList&&a.elementList[t]&&a.elementList[t].contentEditable?e.setAttribute("contenteditable",!0):e.removeAttribute("contenteditable"),clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout(()=>{if(!a._lockContextPosition){let t=140,i=e.tagName.toLowerCase();a._isSandboxed&&"webview"===i&&(i="iframe");let o=a.elementList[i];if(void 0===o||a.isTextElement(e)){this._hideContextMenu(this.contextMenus.ce),this._positionContextMenu(this.contextMenus.text,e,0,-28),t+=this.contextMenus.text.getBoundingClientRect().width}else this._hideContextMenu(this.contextMenus.text),o.element=e,"core"==o.editingElement?this._positionContextMenu(this.contextMenus.ce,e,0,-28):this._hideContextMenu(this.contextMenus.ce),t+=28;if(o&&"core"!=o.editingElement)setTimeout(()=>{if(e&&e.parentNode){let t=e.parentNode.getBoundingClientRect();this._positionContextMenu(this.contextMenus.plate,e.parentNode,t.width-this.contextMenus.plate.getBoundingClientRect().width+1,-26)}},250);else{let i=e.getBoundingClientRect();this.activeNode&&("LI"===this.activeNode.tagName||this._HTMLInlineTextDecorationTest(this.activeNode))?this._hideContextMenu(this.contextMenus.plate):Math.round(t)>=Math.round(i.width)?this._positionContextMenu(this.contextMenus.plate,e,0,-56):this._positionContextMenu(this.contextMenus.plate,e,i.width-this.contextMenus.plate.getBoundingClientRect().width+1,-26)}}},50)}}__addActiveVisible(){for(var e in this.contextMenus)("add"!=e||this.__activeHover)&&this.contextMenus[e].classList.add("hax-context-menu-active")}__dropActiveVisible(){for(var e in this.contextMenus)this.contextMenus[e].classList.remove("hax-context-menu-active");this.__activeHover=null,this._hideContextMenu(this.contextMenus.add)}haxMoveGridPlate(e,t){switch(this.___moveLock=!0,e){case"up":null!==t.previousElementSibling&&t.parentNode.insertBefore(t,t.previousElementSibling);break;case"down":null!==t.nextElementSibling&&t.parentNode.insertBefore(t.nextElementSibling,t)}return this.scrollHere(t),this.positionContextMenus(t),!0}async haxGridPlateOps(e=!0,t="right",i=this.activeNode){let o=!1;if("GRID-PLATE"===i.tagName){if(e)switch(i.layout){case"1":i.layout="1-1",o=!0;break;case"1-1":i.layout="1-1-1",o=!0;break;case"1-1-1":i.layout="1-1-1-1",o=!0;break;case"1-1-1-1":i.layout="1-1-1-1-1",o=!0;break;case"1-1-1-1-1":i.layout="1-1-1-1-1-1",o=!0}else switch(i.layout){case"1-1":let e;await i.childNodes.forEach(t=>{t.tagName&&(e=t.cloneNode(!0),i.getAttribute("slot")?e.setAttribute("slot",i.getAttribute("slot")):e.removeAttribute("slot"),i.parentNode.insertBefore(e,i))}),a.activeNode=e,setTimeout(()=>{i.remove()},0),o=!0;break;case"1-1-1":i.layout="1-1",o=!0;break;case"1-1-1-1":i.layout="1-1-1",o=!0;break;case"1-1-1-1-1":i.layout="1-1-1-1",o=!0;break;case"1-1-1-1-1-1":i.layout="1-1-1-1-1",o=!0}if(o){let e=this.contextMenus.plate.shadowRoot.querySelector("#right"),o=this.contextMenus.plate.shadowRoot.querySelector("#rightremove");e.disabled=!1,o.disabled=!1,"1-1-1-1-1-1"==i.layout&&(e.disabled=!0),"left"==t&&i.childNodes.forEach(e=>{if(e.tagName){let t=parseInt(e.getAttribute("slot").replace("col-",""),10)+1;e.setAttribute("slot","col-"+t)}})}}else{let e=document.createElement("grid-plate");e.layout="1-1",e.disableResponsive=!0,i.getAttribute("slot")&&e.setAttribute("slot",i.getAttribute("slot"));let o="2";"right"==t&&(o="1");let a=i.cloneNode(!0);a.setAttribute("slot","col-"+o),e.appendChild(a),i.parentNode.insertBefore(e,i),setTimeout(()=>{i.remove()},0)}a.refreshActiveNodeForm()}haxReplaceNode(e,t){try{null==e&&(e=this.__oldActiveNode),!e.replaceWith&&a._tmpRange&&(e=a._tmpRange,a._tmpRange=null),e&&e.getAttribute&&null!=e.getAttribute("slot")&&t.setAttribute("slot",e.getAttribute("slot")),e.replaceWith(t)}catch(e){console.warn(e)}return t}haxChangeTagName(e,t,i=!0){for(var o=document.createElement(t),a=0,n=e.attributes.length;a<n;++a){let t=e.attributes.item(a).nodeName,i=e.attributes.item(a).value;try{o.setAttribute(t,i)}catch(t){console.warn(e.attributes),console.warn(t)}}i&&(o.innerHTML=e.innerHTML.trim()),"ul"==t||"ol"==t?"<br />"==o.innerHTML?o.innerHTML="<li><br /></li>":"ul"!=e.tagName.toLowerCase()&&"ol"!=e.tagName.toLowerCase()&&(o.innerHTML="<li>"+e.innerHTML.trim().replace(/<br\/>/g,"</li>\n<li>").replace(/<br>/g,"</li>\n<li>")+"</li>"):"ul"!=e.tagName.toLowerCase()&&"ol"!=e.tagName.toLowerCase()||(o.innerHTML=o.innerHTML.replace(/<ul>/g,"").replace(/<\/ul>/g,"").replace(/<li><\/li>/g,"").replace(/<li>/g,"").replace(/<\/li>/g,"<br/>"));try{e.replaceWith(o),i&&setTimeout(()=>{let e=o.children;e[0]&&e.tagName?e[0].focus():o.focus()},10)}catch(t){console.warn(t),console.warn(o),console.warn(e)}return o}haxDeleteNode(e){if(e.previousElementSibling)a.activeNode=e.previousElementSibling;else if(e.nextElementSibling)a.activeNode=e.nextElementSibling;else{this.haxInsert("p","",{});try{var t=document.createRange(),i=a.getSelection();t.setStart(this.activeNode,0),t.collapse(!0),i.removeAllRanges(),i.addRange(t),this.activeNode.focus()}catch(e){console.warn(e)}}try{return e.remove()}catch(e){console.warn(e)}}importContent(e,t=!0){t&&r(this,"*"),setTimeout(()=>{e=l(e);let t=document.createElement("div");for(t.insertAdjacentHTML("beforeend",e);null!==t.firstChild;)if(void 0!==t.firstChild.tagName)if(a._isSandboxed&&"iframe"===t.firstChild.tagName.toLowerCase()){for(var i=document.createElement("webview"),o=0,n=t.firstChild.attributes.length;o<n;++o){var s=t.firstChild.attributes.item(o).nodeName,r=t.firstChild.attributes.item(o).value;"height"!==s&&"width"!==s||i.style[s],i.setAttribute(s,r)}this.appendChild(i)}else this.appendChild(t.firstChild);else t.removeChild(t.firstChild)},0)}_haxContextOperation(e){let t=e.detail;switch(t.eventName){case"insert-above-active":if(this.activeNode&&this.activeNode.previousElementSibling)this.haxInsert("p","",{},this.activeNode.previousElementSibling);else{let e=document.createElement("p");this.insertBefore(e,this.childNodes[0])}break;case"insert-below-active":this.haxInsert("p","",{});break;case"hax-source-view-toggle":if(this.activeNode.__haxSourceView){this.activeNode.__haxSourceView=!1;let e=a.runHook(a.activeEditingElement,"activeElementChanged",[this.activeNode,!1]),t=a.haxSchemaFromTag(this.activeNode.tagName.toLowerCase());if(this.activeNode&&this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&e.setAttribute("slot",this.activeNode.getAttribute("slot")),t.saveOptions&&t.saveOptions.unsetAttributes&&t.saveOptions.unsetAttributes.length)for(var i in t.saveOptions.unsetAttributes)e.removeAttribute(t.saveOptions.unsetAttributes[i]);this.__applyNodeEditableState(e,this.editMode),p(a.activeEditingElement),a.activeEditingElement=null}else this.activeNode.__haxSourceView=!0,a.activeEditingElement=document.createElement("code-editor"),a.activeEditingElement.language="html",a.activeEditingElement.title="",a.activeEditingElement.theme="vs",a.activeEditingElement.fontSize=12,a.activeEditingElement.wordWrap=!0,import("../code-editor/code-editor.js"),this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&a.activeEditingElement.setAttribute("slot",this.activeNode.getAttribute("slot")),this.__ignoreActive=!0,this.activeNode.removeAttribute("contenteditable"),this.activeNode.removeAttribute("data-hax-ray"),this.activeNode.classList.remove("hax-active"),m(this.activeNode,a.activeEditingElement);break;case"hax-full-text-editor-toggle":if(this.activeNode.__haxSourceView){this.activeNode.__haxSourceView=!1;let e=a.runHook(a.activeEditingElement,"activeElementChanged",[this.activeNode,!1]),t=a.haxSchemaFromTag(this.activeNode.tagName.toLowerCase());if(this.activeNode&&this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&e.setAttribute("slot",this.activeNode.getAttribute("slot")),t.saveOptions&&t.saveOptions.unsetAttributes&&t.saveOptions.unsetAttributes.length)for(var i in t.saveOptions.unsetAttributes)e.removeAttribute(t.saveOptions.unsetAttributes[i]);this.__applyNodeEditableState(e,this.editMode),p(a.activeEditingElement),a.activeEditingElement=null}else this.activeNode.__haxSourceView=!0,import("../rich-text-editor/rich-text-editor.js").then(()=>{a.activeEditingElement=document.createElement("rich-text-editor"),a.activeEditingElement.type="rich-text-editor-toolbar-full",this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&a.activeEditingElement.setAttribute("slot",this.activeNode.getAttribute("slot")),this.__ignoreActive=!0,this.activeNode.removeAttribute("contenteditable"),this.activeNode.removeAttribute("data-hax-ray"),this.activeNode.classList.remove("hax-active"),m(this.activeNode,a.activeEditingElement)});break;case"text-tag":a.activeNode=this.haxChangeTagName(this.activeNode,t.value),this.positionContextMenus();break;case"text-tag-ul":this.contextMenus.text.realSelectedValue="ul",a.activeNode=this.haxChangeTagName(this.activeNode,"ul"),this.positionContextMenus();break;case"text-tag-ol":this.contextMenus.text.realSelectedValue="ol",a.activeNode=this.haxChangeTagName(this.activeNode,"ol"),this.positionContextMenus();break;case"text-align-left":this.activeNode.style.textAlign=null;break;case"hax-transform-node":this.replaceElementWorkflow();break;case"hax-plate-create-right":this.haxGridPlateOps();break;case"hax-plate-remove-right":this.haxGridPlateOps(!1);break;case"hax-plate-duplicate":this.haxDuplicateNode(this.activeNode);break;case"hax-plate-delete":null!=this.activeNode&&this.haxDeleteNode(this.activeNode);break;case"hax-plate-up":this.haxMoveGridPlate("up",this.activeNode);break;case"hax-plate-down":this.haxMoveGridPlate("down",this.activeNode)}}_focusIn(e){this.__mouseDown||this.__focusLogic(e.target)&&(e.stopPropagation(),e.stopImmediatePropagation())}__focusLogic(e,t=!0){let i=!1;if(this.editMode&&!this.__tabTrap){let o=e;"SPAN"===o.tagName&&a.isTextElement(o.parentNode)&&""==o.parentNode.getAttribute("slot")&&(o=e.parentNode);let n=null;if(this._validElementTest(o)&&o.parentNode&&o.parentNode.tagName){if("P"===o.parentNode.tagName&&""==o.parentNode.getAttribute("slot"))n=o,i=!0;else{for(;o.parentNode&&o.parentNode.tagName&&"HAX-BODY"!=o.parentNode.tagName;)null===n&&"B"!==o.tagName&&"I"!==o.tagName&&"STRONG"!==o.tagName&&"EM"!==o.tagName&&(n=o),o=o.parentNode;null===n?n=o:a.isGridPlateElement(o)||(n=o)}(this.activeNode&&this.activeNode.parentNode!==o&&!o.classList.contains("ignore-activation")||o.haxUIElement||o.classList.contains("ignore-activation"))&&(i=!0),n.haxUIElement||n.classList.contains("ignore-activation")||(a.activeNode=n,setTimeout(()=>{if(t&&!this.__mouseDown&&a.isTextElement(n))try{var e=document.createRange(),i=a.getSelection();e.setStart(this.activeNode,0),e.collapse(!0),i.removeAllRanges(),i.addRange(e),this.activeNode.focus()}catch(e){console.warn(e)}this.positionContextMenus(n)},0),i=!0)}}else this.__tabTrap=!1;return i}scrollHere(e){setTimeout(()=>{"function"==typeof e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded(!0):e.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})},0)}undo(){super.undo(),setTimeout(()=>{let e=this.querySelector(".hax-active");e?(this.__focusLogic(e),this.scrollHere(e)):this.hideContextMenus()},0)}redo(){super.redo(),setTimeout(()=>{let e=this.querySelector(".hax-active");e?(this.__focusLogic(e),this.scrollHere(e)):this.hideContextMenus()},0)}_editModeChanged(e,t){if(void 0!==t){if(this._applyContentEditable(e),e)if(this.children&&this.children[0]&&this.children[0].focus)this.__focusLogic(this.children[0]);else{this.haxInsert("p","",{});try{var i=document.createRange(),o=a.getSelection();i.setStart(this.activeNode,0),i.collapse(!0),o.removeAllRanges(),o.addRange(i),this.activeNode.focus()}catch(e){console.warn(e)}}setTimeout(()=>{this.undoStack.undoStackLimit=50,this.undoStack.undoStackPosition=-1,this.undoStack.commands=[],this.undoStack.changed(),this.undoStackInitialValue=this.innerHTML,this.undoStackPrevValue=this.undoStackInitialValue},0)}if(0==e){p(a.activeEditingElement),a.activeEditingElement=null,this.removeAttribute("contenteditable"),this.hideContextMenus();let e=this.querySelectorAll("[contenteditable],.hax-active");for(var n=0;n<e.length;n++){let t=e[n];t.removeAttribute("contenteditable"),t.classList.remove("hax-active")}}let s="slot"===this.shadowRoot.querySelector("#body").localName?this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}):[];0===s.length&&(s=this.shadowRoot.querySelector("#body").children);for(n=0;n<s.length;n++)a.runHook(s[n],"editModeChanged",[e])}_haxResolvePreviousElement(e){for(e=e.previousElementSibling;null!=e&&void 0!==e.tagName&&"HAX-"===e.tagName.substring(0,4);)e=e.previousElementSibling;return e}_validElementTest(e){return!(e.haxUIElement||!e.tagName||["TEMPLATE","HAX-BODY","HAX-APP-SEARCH-RESULT","FAKE-HAX-BODY-END"].includes(e.tagName))&&(!this._HTMLInlineTextDecorationTest(e)||"HAX-BODY"==e.parentNode)}_HTMLInlineTextDecorationTest(e){return["span","b","strong","i","em"].includes(e.tagName.toLowerCase())}_HTMLPrimativeTest(e){return null!=e&&void 0!==e.tagName&&-1==e.tagName.indexOf("-")}_applyContentEditable(e,t=this.shadowRoot.querySelector("#body")){let i="slot"===t.localName?t.assignedNodes({flatten:!0}):[];0===i.length&&(i=t.children);for(var o=0;o<i.length;o++)if(this._validElementTest(i[o])&&(!e||!0!==i[o].getAttribute("contenteditable")&&"true"!=i[o].getAttribute("contenteditable")&&"contenteditable"!=i[o].getAttribute("contenteditable"))&&this.__applyNodeEditableState(i[o],e),a.isGridPlateElement(i[o])){let t=i[o].querySelectorAll("*");for(var n=0;n<t.length;n++)this._validElementTest(t[n])&&this.__applyNodeEditableState(t[n],e)}}__applyNodeEditableState(e,t=!0){let i,o=e.tagName.replace("-"," ").toLowerCase(),n=s(a.gizmoList).findIndex(t=>{if(t)return t.tag===e.tagName.toLowerCase()});if(-1!==n&&(o=s(a.gizmoList)[n].title),"IMG"==e.tagName&&e.setAttribute("draggable",!1),t?(e.setAttribute("data-hax-ray",o),i="addEventListener"):(e.removeAttribute("data-hax-ray"),i="removeEventListener"),e[i]("drop",this.dropEvent.bind(this)),e[i]("dragenter",this.dragEnter.bind(this)),e[i]("dragleave",this.dragLeave.bind(this)),e[i]("dragover",e=>{this.__dragMoving=!0,e.preventDefault()}),this._HTMLPrimativeTest(e)&&(t?e.setAttribute("contenteditable",t):e.removeAttribute("contenteditable"),e.querySelectorAll("a").length>0)){let o=e.querySelectorAll("a");for(var l=0,r=o.length;l<r;l++)t?o[l].setAttribute("contenteditable",t):o[l].removeAttribute("contenteditable"),o[l][i]("click",e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()})}}undoManagerStackLogic(e){this.__dragMoving||(this.querySelectorAll(".hax-hovered").forEach(e=>{e.classList.remove("hax-hovered")}),super.undoManagerStackLogic(e))}dropEvent(e){if(this.editMode){this.__dragMoving=!1,this.undoManagerStackLogic({}),clearTimeout(b),a._lockContextPosition=!1,a.haxTray.activeTab="item-1";var t,i=null,o=v(e);i=e.target.closest("grid-plate")&&e.target.parentNode!=e.target.closest("grid-plate")?e.target.closest("grid-plate"):e.target.closest("[contenteditable],img")?e.target.closest("[contenteditable],img"):e.originalTarget?e.originalTarget:e.target,o[0].classList.contains("column")?this.__slot=o[0].getAttribute("id").replace("col","col-"):i.getAttribute("slot")&&(this.__slot=i.getAttribute("slot")),a.activeNode=i,this.querySelectorAll(".hax-hovered").forEach(e=>{e.classList.remove("hax-hovered")}),this.querySelectorAll(".active").forEach(e=>{e.classList.remove("active")});try{if(e.dataTransfer&&e.dataTransfer.items&&e.dataTransfer.items.length>0&&"file"===e.dataTransfer.items[0].kind){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();let i=document.createElement("p");e.target.closest("grid-plate")&&e.target.parentNode!=e.target.closest("grid-plate")?t=e.target.closest("grid-plate"):e.target.closest("[contenteditable],img")&&(t=e.target.closest("[contenteditable],img")),t&&t.tagName&&!["GRID-PLATE","HAX-BODY"].includes(t.tagName)||"GRID-PLATE"===o[0].tagName?(t.getAttribute("slot")?i.setAttribute("slot",t.getAttribute("slot")):o[0].classList.contains("column")?i.setAttribute("slot",o[0].getAttribute("id").replace("col","col-")):i.removeAttribute("slot"),t.parentNode.insertBefore(i,t)):(o[0].classList.contains("column")?i.setAttribute("slot",o[0].getAttribute("id").replace("col","col-")):t&&"HAX-BODY"===t.tagName&&i.getAttribute("slot")&&i.removeAttribute("slot"),t?t.appendChild(i):this.appendChild(i)),e.placeHolderElement=i,this.dispatchEvent(new CustomEvent("place-holder-file-drop",{bubbles:!0,cancelable:!0,composed:!0,detail:e}))}else{if(i=a.__dragTarget,t=e.target,e.target.closest("grid-plate")&&e.target.parentNode!=e.target.closest("grid-plate")?t=e.target.closest("grid-plate"):e.target.closest("[contenteditable],img")&&(t=e.target.closest("[contenteditable],img")),t&&i&&this._validElementTest(i)&&i!==t){try{["GRID-PLATE","HAX-BODY"].includes(t.tagName)&&"GRID-PLATE"!==o[0].tagName?(o[0].classList.contains("column")?i.setAttribute("slot",o[0].getAttribute("id").replace("col","col-")):"HAX-BODY"===t.tagName&&i.getAttribute("slot")&&i.removeAttribute("slot"),t.appendChild(i)):(t.getAttribute("slot")?i.setAttribute("slot",t.getAttribute("slot")):o[0].classList.contains("column")?i.setAttribute("slot",o[0].getAttribute("id").replace("col","col-")):i.removeAttribute("slot"),t.parentNode.insertBefore(i,t))}catch(e){console.warn(e)}e.preventDefault(),e.stopPropagation()}i&&this._validElementTest(i)&&"function"==typeof i.focus&&(a.activeNode=i,this.dispatchEvent(new CustomEvent("hax-drop-focus-event",{bubbles:!0,cancelable:!0,composed:!0,detail:this.activeNode})),this.scrollHere(this.activeNode),this.positionContextMenus())}}catch(e){console.warn(e)}}a.__dragTarget=null,this.__manageFakeEndCap(!1)}dragEnter(e){this.editMode&&e.target&&(this.__dragMoving=!0,e.preventDefault(),e.target&&e.target.classList&&e.target.classList.add("hax-hovered"),this.handleMousemove(e))}handleMousemove(e){var t=e.clientX,i=e.clientY,o=document.documentElement.clientWidth,a=document.documentElement.clientHeight,n=a-200,s=o-200,l=t<200,r=t>s,d=i<200,c=i>n;if(l||r||d||c){var h=Math.max(document.body.scrollWidth,document.body.offsetWidth,document.body.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth),u=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.body.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight),m=h-o,p=u-a;!function checkForWindowScroll(){clearTimeout(b),function adjustWindowScroll(){var e=window.pageXOffset,o=window.pageYOffset,a=o>0,h=o<p,u=e>0,g=e<m,v=e,b=o;if(l&&u){v-=25*((200-t)/200)}else if(r&&g){v+=25*((t-s)/200)}if(d&&a){b-=25*((200-i)/200)}else if(c&&h){b+=25*((i-n)/200)}return v=Math.max(0,Math.min(m,v)),b=Math.max(0,Math.min(p,b)),(v!==e||b!==o)&&(window.scrollTo(v,b),!0)}()&&(b=setTimeout(checkForWindowScroll,30))}()}else clearTimeout(b)}dragLeave(e){this.editMode&&e.target&&e.target.classList&&(this.__dragMoving=!0,e.target.classList.remove("hax-hovered"))}async _activeNodeChanged(e,t){if(window.SimplePopoverManager.requestAvailability().opened=!1,await this.querySelectorAll(".hax-active").forEach(e=>{e.classList.remove("hax-active")}),this.editMode&&null!=e&&e.parentNode){let t=e.tagName.toLowerCase();e.classList.add("hax-active"),a.isTextElement(e)||"HR"===e.tagName||a.isGridPlateElement(e)?(e.setAttribute("contenteditable",!0),this.setAttribute("contenteditable",!0)):(e.removeAttribute("contenteditable"),this.removeAttribute("contenteditable")),this._keepContextVisible(),this.contextMenus.text.realSelectedValue=t}else null===e&&(this.hideContextMenus(),this.__oldActiveNode=t);if(this.editMode&&a.runHook(t,"activeElementChanged",[t,!1])&&(this.__ignoreActive=!0),this.editMode&&a.runHook(e,"activeElementChanged",[e,!0])&&(this.__ignoreActive=!0),this.editMode&&t){let e=a.haxSchemaFromTag(t.tagName.toLowerCase());if("core"!=e.editingElement||t.parentNode&&t.parentNode.haxUIElement&&t.parentNode===a.activeEditingElement){this.__ignoreActive=!0;let o=a.runHook(a.activeEditingElement,"activeElementChanged",[t,!1]);if(o&&o!==t){if(t&&t.getAttribute&&null!=t.getAttribute("slot")&&o.setAttribute("slot",t.getAttribute("slot")),e.saveOptions&&e.saveOptions.unsetAttributes&&e.saveOptions.unsetAttributes.length)for(var i in e.saveOptions.unsetAttributes)o.removeAttribute(e.saveOptions.unsetAttributes[i]);this.__applyNodeEditableState(o,this.editMode)}p(a.activeEditingElement),a.activeEditingElement=null}}if(this.editMode&&e){let t=a.haxSchemaFromTag(e.tagName);if(t&&t.editingElement&&"core"!=t.editingElement){if(t.editingElement.import){let e=a.pathFromUrl(decodeURIComponent(import.meta.url));await import(`${e}../../${t.editingElement.import}`)}a.activeEditingElement=document.createElement(t.editingElement.tag),e.getAttribute&&null!=e.getAttribute("slot")&&a.activeEditingElement.setAttribute("slot",e.getAttribute("slot")),t.editingElement.callback&&t.editingElement.callback(a.activeEditingElement),this.__ignoreActive=!0,m(e,a.activeEditingElement),a.runHook(a.activeEditingElement,"activeElementChanged",[e,!0])}}}_getPosition(e){return{x:e.offsetLeft-e.scrollLeft+e.clientLeft,y:e.offsetTop-e.scrollTop+e.clientTop}}_positionContextMenu(e,t,i,o){if(null!=t){let a=this._getPosition(t);e.style.left=null!=i?a.x+i+"px":a.x+"px",e.style.top=null!=o?a.y+o+"px":a.y+"px"}e.setAttribute("on-screen","on-screen"),e.classList.add("hax-context-visible","hax-context-menu-active")}_hideContextMenu(e){e.removeAttribute("on-screen"),e.visible=!1,e.classList.remove("hax-context-visible","hax-context-pin-top","hax-context-menu-active")}_tabKeyPressed(){if(this.activeNode&&a.getRange().cloneRange)try{let t=!1,i=this.activeNode.parentNode;const o=this.activeNode.parentNode.tagName;let n=a.getRange().cloneRange();var e=n.commonAncestorContainer.tagName;if(void 0===e&&(e=n.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(o)||["UL","OL","LI"].includes(e))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("indent"));else for(;!t;)null==i.nextSibling?t=!0:"function"===i.nextSibling.focus?(i.nextSibling.focus(),t=!0):i=i.nextSibling}catch(e){console.warn(e)}}_tabBackKeyPressed(){if(this.activeNode&&a.getRange().cloneRange)try{let t=this.activeNode.parentNode;const i=this.activeNode.parentNode.tagName;let o=a.getRange().cloneRange();var e=o.commonAncestorContainer.tagName;if(void 0===e&&(e=o.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(i)||["UL","OL","LI"].includes(e))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("outdent"));else{if(null!=t)for(;null!=t&&!this._validElementTest(t);)t=t.previousSibling;null!=t&&setTimeout(()=>{t.focus()},50)}}catch(e){console.warn(e)}}}window.customElements.define(HaxBody.tag,HaxBody);export{HaxBody};