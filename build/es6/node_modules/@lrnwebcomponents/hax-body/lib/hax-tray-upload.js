import{LitElement as e,html as t,css as o}from"../../../lit-element/lit-element.js";import{winEventsElement as a}from"../../utils/utils.js";class HaxTrayUpload extends(a(e)){static get styles(){return[o`
        *[hidden] {
          display: none;
        }
      `]}static get tag(){return"hax-tray-upload"}constructor(){super(),this.__winEvents={"hax-app-picker-selection":"_haxAppPickerSelection","place-holder-file-drop":"_placeHolderFileDrop"}}render(){return t`
      <input type="text" id="url" hidden />
      <vaadin-upload
        @upload-before="${this._fileAboutToUpload}"
        @upload-response="${this._fileUploadResponse}"
        form-data-name="file-upload"
        id="fileupload"
        hidden
      ></vaadin-upload>
    `}newAssetConfigure(){let e={source:this.shadowRoot.querySelector("#url").value,title:this.shadowRoot.querySelector("#url").value},t=window.HaxStore.guessGizmoType(e),o=window.HaxStore.guessGizmo(t,e,!1,!0);o.length>0?1===o.length?void 0!==o[0].tag&&this.dispatchEvent(new CustomEvent("hax-insert-content",{bubbles:!0,cancelable:!0,composed:!0,detail:o[0]})):window.HaxStore.instance.haxAppPicker.presentOptions(o,t,"Pick how to present the "+t,"gizmo"):window.HaxStore.toast("Sorry, HAX doesn't know how to handle that type of link yet.")}firstUpdated(e){super.firstUpdated&&super.firstUpdated(e),setTimeout(()=>{import("../../../@vaadin/vaadin-upload/vaadin-upload.js")},0)}_placeHolderFileDrop(e){window.HaxStore.instance.activePlaceHolder=e.detail.placeHolderElement,this.shadowRoot.querySelector("#fileupload")._onDrop(e.detail)}_fileUploadResponse(e){this.editExistingNode=!0;let t=JSON.parse(e.detail.xhr.response),o=this.__appUsed.connection.operations.add.resultMap,a={},i={};for(var l in void 0!==this._resolveObjectPath(o.item,t)&&(a=this._resolveObjectPath(o.item,t)),i.type=o.defaultGizmoType,o.gizmo)i[l]=this._resolveObjectPath(o.gizmo[l],a);void 0===i.url&&void 0!==i.source&&(i.url=i.source),void 0!==o.gizmo.type&&(i.type=this._resolveObjectPath(o.gizmo.type,a)),this.shadowRoot.querySelector("#url").value=i.url,this.newAssetConfigure()}_fileAboutToUpload(e){if(this.__allowUpload)this.__allowUpload=!1;else{e.preventDefault(),e.stopPropagation();let o={source:e.detail.file.name,type:e.detail.file.type};var t=window.HaxStore.guessGizmoType(o);let a=window.HaxStore.getHaxAppStoreTargets(t);1===a.length?this._haxAppPickerSelection({detail:a[0]}):0!==a.length?window.HaxStore.instance.haxAppPicker.presentOptions(a,t,"Where would you like to upload this "+t+"?","app"):window.HaxStore.toast("Sorry, you don't have a storage location that can handle "+t+" uploads!",5e3)}}_haxAppPickerSelection(e){let t=e.detail.connection;this.__appUsed=e.detail,this.shadowRoot.querySelector("#fileupload").method=t.operations.add.method;let o=t.protocol+"://"+t.url;"/"!=o.substr(o.length-1)&&(o+="/"),void 0!==t.operations.add.endPoint&&(o+=t.operations.add.endPoint),null!=window.HaxStore.instance.connectionRewrites.appendUploadEndPoint&&(o+="?"+window.HaxStore.instance.connectionRewrites.appendUploadEndPoint),null!=window.HaxStore.instance.connectionRewrites.appendJwt&&(o+="&"+window.HaxStore.instance.connectionRewrites.appendJwt+"="+localStorage.getItem(window.HaxStore.instance.connectionRewrites.appendJwt)),this.shadowRoot.querySelector("#fileupload").headers=t.headers,this.shadowRoot.querySelector("#fileupload").target=o,this.__allowUpload=!0,this.shadowRoot.querySelector("#fileupload").uploadFiles()}_resolveObjectPath(e,t){return e.split(".").reduce((function(e,t){return e?e[t]:null}),t||self)}}window.customElements.define(HaxTrayUpload.tag,HaxTrayUpload);export{HaxTrayUpload};