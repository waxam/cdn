Object.defineProperty(exports,"__esModule",{value:!0}),exports.HaxUploadField=void 0;require("lit");var e=require("@lrnwebcomponents/simple-fields/lib/simple-fields-upload.js"),t=require("@lrnwebcomponents/utils/utils.js"),o=require("./hax-store.js"),n=require("@lrnwebcomponents/i18n-manager/lib/I18NMixin.js");function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(e){return typeof e}:function _typeof(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}var r=function(r){function HaxUploadField(){var e;return function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,HaxUploadField),(e=function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}(this,_getPrototypeOf(HaxUploadField).call(this))).__winEvents={"hax-app-picker-selection":"_haxAppPickerSelection"},e.t={whereUpload:"Where would you like to upload this",cantHandle:"Sorry, you don't have a storage location that can handle",uploads:"uploads"},e.registerLocalization({context:_assertThisInitialized(e),namespace:"hax"}),e}return function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}(HaxUploadField,(0,t.winEventsElement)((0,n.I18NMixin)(e.SimpleFieldsUpload))),function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}(HaxUploadField,[{key:"_canUpload",value:function _canUpload(){return!this.__allowUpload&&o.HAXStore}},{key:"_fileAboutToUpload",value:function _fileAboutToUpload(e){if(this._canUpload()){e.preventDefault(),e.stopPropagation();var t={source:e.detail.file.name,type:e.detail.file.type},n=o.HAXStore.guessGizmoType(t),r=o.HAXStore.getHaxAppStoreTargets(n);1===r.length?this._haxAppPickerSelection({detail:r[0]}):0!==r.length?o.HAXStore.haxAppPicker.presentOptions(r,n,"".concat(this.t.whereUpload," ").concat(n,"?"),"app"):o.HAXStore.toast("".concat(this.t.cantHandle," ").concat(n," ").concat(this.t.uploads,"!"),5e3)}else this.__allowUpload=!1}},{key:"_haxAppPickerSelection",value:function _haxAppPickerSelection(e){var t=e.detail.connection;this.__appUsed=e.detail,this.shadowRoot.querySelector("#fileupload").method=t.operations.add.method;var n=t.protocol+"://"+t.url;"/"!=n.substr(n.length-1)&&(n+="/"),"undefined"!==_typeof(t.operations.add.endPoint)&&(n+=t.operations.add.endPoint),null!=o.HAXStore.connectionRewrites.appendUploadEndPoint&&(n+="?"+o.HAXStore.connectionRewrites.appendUploadEndPoint),null!=o.HAXStore.connectionRewrites.appendJwt&&(n+="&"+o.HAXStore.connectionRewrites.appendJwt+"="+function localStorageGet(e){try{return localStorage.getItem(e)}catch(e){return!1}}(o.HAXStore.connectionRewrites.appendJwt)),this.shadowRoot.querySelector("#fileupload").headers=t.headers,this.shadowRoot.querySelector("#fileupload").target=n,this.__allowUpload=!0,this.shadowRoot.querySelector("#fileupload").uploadFiles()}},{key:"_fileUploadResponse",value:function _fileUploadResponse(e){var t=JSON.parse(e.detail.xhr.response),o=this.__appUsed.connection.operations.add.resultMap,n={},r={};for(var i in"undefined"!==_typeof(this._resolveObjectPath(o.item,t))&&(n=this._resolveObjectPath(o.item,t)),r.type=o.defaultGizmoType,o.gizmo)r[i]=this._resolveObjectPath(o.gizmo[i],n);"undefined"===_typeof(r.url)&&"undefined"!==_typeof(r.source)&&(r.url=r.source),"undefined"!==_typeof(o.gizmo.type)&&(r.type=this._resolveObjectPath(o.gizmo.type,n)),this.shadowRoot.querySelector("#url").value=r.url}}]),HaxUploadField}();exports.HaxUploadField=r,window.customElements.define("hax-upload-field",r);