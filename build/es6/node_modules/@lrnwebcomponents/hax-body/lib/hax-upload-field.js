import{html as e,css as o}from"../../../lit-element/lit-element.js";import{SimpleFieldsUpload as t}from"../../simple-fields/lib/simple-fields-upload.js";import{winEventsElement as i}from"../../utils/utils.js";class HaxUploadField extends(i(t)){constructor(){super(),this.__winEvents={"hax-app-picker-selection":"_haxAppPickerSelection"}}_fileAboutToUpload(e){if(!this.__allowUpload&&window.HaxStore){e.preventDefault(),e.stopPropagation();let t={source:e.detail.file.name,type:e.detail.file.type};var o=window.HaxStore.guessGizmoType(t);let i=window.HaxStore.getHaxAppStoreTargets(o);1===i.length?this._haxAppPickerSelection({detail:i[0]}):0!==i.length?window.HaxStore.instance.haxAppPicker.presentOptions(i,o,"Where would you like to upload this "+o+"?","app"):window.HaxStore.toast("Sorry, you don't have a storage location that can handle "+o+" uploads!",5e3)}else this.__allowUpload=!1}_fileUploadResponse(e){let o=JSON.parse(e.detail.xhr.response),t=this.__appUsed.connection.operations.add.resultMap,i={},a={};for(var l in void 0!==this._resolveObjectPath(t.item,o)&&(i=this._resolveObjectPath(t.item,o)),a.type=t.defaultGizmoType,t.gizmo)a[l]=this._resolveObjectPath(t.gizmo[l],i);void 0===a.url&&void 0!==a.source&&(a.url=a.source),void 0!==t.gizmo.type&&(a.type=this._resolveObjectPath(t.gizmo.type,i)),this.shadowRoot.querySelector("#url").value=a.url}_haxAppPickerSelection(e){let o=e.detail.connection;this.__appUsed=e.detail,this.shadowRoot.querySelector("#fileupload").method=o.operations.add.method;let t=o.protocol+"://"+o.url;"/"!=t.substr(t.length-1)&&(t+="/"),void 0!==o.operations.add.endPoint&&(t+=o.operations.add.endPoint),null!=window.HaxStore.instance.connectionRewrites.appendUploadEndPoint&&(t+="?"+window.HaxStore.instance.connectionRewrites.appendUploadEndPoint),null!=window.HaxStore.instance.connectionRewrites.appendJwt&&(t+="&"+window.HaxStore.instance.connectionRewrites.appendJwt+"="+localStorage.getItem(window.HaxStore.instance.connectionRewrites.appendJwt)),this.shadowRoot.querySelector("#fileupload").headers=o.headers,this.shadowRoot.querySelector("#fileupload").target=t,this.__allowUpload=!0,this.shadowRoot.querySelector("#fileupload").uploadFiles()}}window.customElements.define("hax-upload-field",HaxUploadField);export{HaxUploadField};