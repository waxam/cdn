import{html,Polymer}from"../../../@polymer/polymer/polymer-legacy.js";import{dom}from"../../../@polymer/polymer/lib/legacy/polymer.dom.js";import{pathFromUrl}from"../../../@polymer/polymer/lib/utils/resolve-url.js";import{setPassiveTouchGestures}from"../../../@polymer/polymer/lib/utils/settings.js";import"../../../@polymer/iron-ajax/iron-ajax.js";import"../../simple-toast/simple-toast.js";import"../../media-behaviors/media-behaviors.js";import"../../hax-body-behaviors/hax-body-behaviors.js";import"../../hal-9000/hal-9000.js";import{CodeSample}from"../../code-sample/code-sample.js";import{getRange}from"./shadows-safari.js";import"./hax-app.js";import"./hax-stax.js";import"./hax-stax-browser.js";import"./hax-blox.js";import"./hax-blox-browser.js";window.HaxStore=window.HaxStore||{};window.HaxStore.instance=null;window.HaxStore.requestAvailability=function(){if(!window.HaxStore.instance){window.HaxStore.instance=document.createElement("hax-store");document.body.appendChild(window.HaxStore.instance)}return window.HaxStore.instance};Polymer({_template:html`
    <style>
      :host {
        display: none;
      }
    </style>
    <slot></slot>
    <iron-ajax
      id="appstore"
      url="[[appStore.url]]"
      params="[[appStore.params]]"
      method="GET"
      content-type="application/json"
      handle-as="json"
      last-response="{{__appStoreData}}"
    ></iron-ajax>
    <hal-9000 id="hal" debug="debug" commands="[[voiceCommands]]"></hal-9000>
  `,is:"hax-store",behaviors:[MediaBehaviors.Video,HAXBehaviors.PropertiesBehaviors],observers:["_loadAppStoreData(__ready, __appStoreData, haxAutoloader)"],properties:{skipHAXConfirmation:{type:Boolean,value:!1,reflectToAttribute:!0},storageData:{type:Object,value:{},observer:"_storageDataChanged"},haxAppPicker:{type:Object},haxStaxPicker:{type:Object},haxManager:{type:Object},haxAutoloader:{type:Object},haxBodies:{type:Array,value:[]},activePlaceHolder:{type:Object,value:null},activeHaxBody:{type:Object},appStore:{type:Object,observer:"_appStoreChanged"},haxToast:{type:Object},haxPanel:{type:Object},haxExport:{type:Object},haxPreferences:{type:Object},activeHaxElement:{type:Object},activeNode:{type:Object},activeContainerNode:{type:Object},sessionObject:{type:Object,value:{}},editMode:{type:Boolean,value:!1,observer:"_editModeChanged"},canSupportUploads:{type:Boolean,value:!1},skipExitTrap:{type:Boolean,value:!1},defaults:{type:Object,value:{image:{src:"stock.jpg",alt:"A beachfront deep in the heart of Alaska."},iframe:{src:"https://www.wikipedia.org/"}}},gizmoList:{type:Array,value:[]},elementList:{type:Object,value:{}},appList:{type:Array,value:[]},staxList:{type:Array,value:[]},bloxList:{type:Array,value:[]},globalPreferences:{type:Object,value:{},observer:"_globalPreferencesChanged"},activeApp:{type:Object,value:{}},validTagList:{type:Array,value:["p","div","ol","ul","li","a","strong","kbd","em","i","b","hr","h1","h2","h3","h4","h5","h6","blockquote","code","figure","img","iframe","video","audio","section","grid-plate","template","webview"]},validGizmoTypes:{type:Array,value:["data","video","audio","text","link","file","pdf","image","csv","doc","content","text","inline","*"]},_isSandboxed:{type:Boolean,value:function(){let test=document.createElement("webview");if("function"===typeof test.reload){return!0}return!1}},__appStoreData:{type:Object},__ready:{type:Boolean},voiceCommands:{type:Object}},_storageDataChanged:function(newValue){if(newValue&&window.HaxStore.ready&&this.__storageDataProcessed){if(window.localStorage.getItem("haxConfirm")){window.localStorage.setItem("haxUserData",JSON.stringify(newValue))}else if(window.sessionStorage.getItem("haxConfirm")){window.sessionStorage.setItem("haxUserData",JSON.stringify(newValue))}}},isTextElement:function(node){if(null!=node&&this.validTagList.includes(node.tagName.toLowerCase())){if(["p","ol","ul","li","a","h1","h2","h3","h4","h5","h6","span","i","bold","em","strong","blockquote","code","figure"].includes(node.tagName.toLowerCase())){return!0}}return!1},isGridPlateElement:function(node){let tag=node.tagName.toLowerCase();if(this.validTagList.includes(tag)){if(["p","ol","ul","li","div","h1","h2","h3","h4","h5","h6","blockquote","code","figure","grid-plate"].includes(tag)){return!0}}return!1},_appStoreChanged:function(newValue){if(typeof newValue!==typeof void 0&&null!=newValue){if(typeof newValue.apps===typeof void 0){this.$.appstore.generateRequest()}else{setTimeout(()=>{this.__appStoreData=newValue},500)}}},_loadAppStoreData:function(ready,appDataResponse,haxAutoloader){if(typeof appDataResponse!==typeof void 0&&null!=appDataResponse){if(typeof appDataResponse.autoloader!==typeof void 0){for(var i=0;i<appDataResponse.autoloader.length;i++){this.push("validTagList",appDataResponse.autoloader[i]);let CEname=appDataResponse.autoloader[i];const basePath=pathFromUrl(decodeURIComponent(import.meta.url));import(`${basePath}../../${CEname}/${CEname}.js`).then(()=>{let CEClass=window.customElements.get(CEname);if("function"===typeof CEClass.getHaxProperties){this.setHaxProperties(CEClass.getHaxProperties(),CEname)}else if("function"===typeof CEClass.HAXWiring){this.setHaxProperties(CEClass.HAXWiring.getHaxProperties(),CEname)}else if(CEClass.haxProperties){this.setHaxProperties(CEClass.haxProperties,CEname)}else{dom(haxAutoloader).appendChild(document.createElement(CEname))}}).catch(error=>{console.log(error)})}}if(typeof appDataResponse.apps!==typeof void 0){for(var apps=appDataResponse.apps,i=0;i<apps.length;i++){let app=document.createElement("hax-app");app.data=apps[i];if(apps[i].connection.operations.add){window.HaxStore.write("canSupportUploads",!0,this)}window.HaxStore.instance.appendChild(app)}}if(typeof appDataResponse.stax!==typeof void 0){for(var staxs=appDataResponse.stax,i=0;i<staxs.length;i++){let stax=document.createElement("hax-stax");stax.data=staxs[i];window.HaxStore.instance.appendChild(stax)}}if(typeof appDataResponse.blox!==typeof void 0){for(var bloxs=appDataResponse.blox,i=0;i<bloxs.length;i++){let blox=document.createElement("hax-blox");blox.data=bloxs[i];window.HaxStore.instance.appendChild(blox)}}const evt=new CustomEvent("hax-store-app-store-loaded",{bubbles:!0,cancelable:!0,detail:!0});this.dispatchEvent(evt)}},_editModeChanged:function(newValue){if(newValue&&this.globalPreferences.haxVoiceCommands){this.$.hal.auto=!0}else{this.$.hal.auto=!1}},_globalPreferencesChanged:function(newValue){if(this.__storageDataProcessed&&newValue&&typeof newValue.haxVoiceCommands!==typeof void 0&&window.HaxStore.ready){let storageData=this.storageData;storageData.globalPreferences=newValue;this.set("storageData",{});this.set("storageData",storageData);if(newValue.haxVoiceCommands&&this.editMode){this.$.hal.auto=!0}else{this.$.hal.auto=!1}}},detached:function(){window.removeEventListener("hax-register-properties",this._haxStoreRegisterProperties.bind(this));document.body.removeEventListener("hax-register-app",this._haxStoreRegisterApp.bind(this));document.body.removeEventListener("hax-register-stax",this._haxStoreRegisterStax.bind(this));document.body.removeEventListener("hax-register-blox",this._haxStoreRegisterBlox.bind(this));document.body.removeEventListener("hax-store-write",this._writeHaxStore.bind(this));document.body.removeEventListener("hax-register-manager",this._haxStoreRegisterManager.bind(this));document.body.removeEventListener("hax-register-autoloader",this._haxStoreRegisterAutoloader.bind(this));document.body.removeEventListener("hax-register-body",this._haxStoreRegisterBody.bind(this));document.body.removeEventListener("hax-register-panel",this._haxStoreRegisterPanel.bind(this));document.body.removeEventListener("hax-register-app-picker",this._haxStoreRegisterAppPicker.bind(this));document.body.removeEventListener("hax-register-stax-picker",this._haxStoreRegisterStaxPicker.bind(this));document.body.removeEventListener("hax-register-blox-picker",this._haxStoreRegisterBloxPicker.bind(this));document.body.removeEventListener("hax-register-preferences",this._haxStoreRegisterPreferences.bind(this));document.body.removeEventListener("hax-register-export",this._haxStoreRegisterExport.bind(this));document.body.removeEventListener("hax-insert-content",this._haxStoreInsertContent.bind(this));document.body.removeEventListener("hax-insert-content-array",this._haxStoreInsertMultiple.bind(this));window.removeEventListener("hax-add-voice-command",this._addVoiceCommand.bind(this));window.removeEventListener("onbeforeunload",this._onBeforeUnload.bind(this));window.removeEventListener("hax-consent-tap",this._haxConsentTap.bind(this));window.removeEventListener("paste",this._onPaste.bind(this));this.fire("hax-store-ready",!1);window.HaxStore.ready=!1},_haxConsentTap:function(){window.localStorage.setItem("haxConfirm",!0);window.localStorage.setItem("haxUserData",JSON.stringify(this.storageData))},ready:function(){if(this.skipHAXConfirmation){window.sessionStorage.setItem("haxConfirm",!0);window.localStorage.setItem("haxConfirm",!0)}let haxConfirm=window.sessionStorage.getItem("haxConfirm")||window.localStorage.getItem("haxConfirm");if(!haxConfirm){window.sessionStorage.setItem("haxConfirm",!0);window.HaxStore.toast(`
      The HAX content editor keeps preferences in order to improve your experience.
      This data is stored in your browser and is never sent anywhere.
      Click to accept.
      `,"-1","fit-bottom","I Accept","hax-consent-tap")}else{if(window.sessionStorage.getItem("haxConfirm")&&!window.localStorage.getItem("haxConfirm")){try{let globalData=window.sessionStorage.getItem("haxUserData")?JSON.parse(window.sessionStorage.getItem("haxUserData")):{};this.set("storageData",globalData)}catch(e){}}else{try{let globalData=window.localStorage.getItem("haxUserData")?JSON.parse(window.localStorage.getItem("haxUserData")):{};this.set("storageData",globalData)}catch(e){}}}},attached:function(){this.fire("hax-store-ready",!0);window.HaxStore.ready=!0;this.__ready=!0;this._buildPrimitiveDefinitions();window.addEventListener("hax-consent-tap",this._haxConsentTap.bind(this));window.addEventListener("onbeforeunload",this._onBeforeUnload.bind(this));window.addEventListener("paste",this._onPaste.bind(this));this.voiceCommands=this._initVoiceCommands();setTimeout(()=>{this.__storageDataProcessed=!0;if(this.storageData.globalPreferences){window.HaxStore.write("globalPreferences",this.storageData.globalPreferences,this)}},325)},_initVoiceCommands:function(){var commands={};commands[`${this.$.hal.respondsTo} scroll up`]=()=>{window.scrollBy({top:-(.5*window.innerHeight),left:0,behavior:"smooth"})};commands[`${this.$.hal.respondsTo} scroll (down)`]=()=>{window.scrollBy({top:.5*window.innerHeight,left:0,behavior:"smooth"})};commands[`hey ${this.$.hal.respondsTo}`]=()=>{this.$.hal.speak("Yeah what do you want")};commands[`${this.$.hal.respondsTo} find media`]=()=>{window.HaxStore.write("activeHaxElement",{},window.HaxStore.instance);window.HaxStore.instance.haxManager.resetManager(1);window.HaxStore.instance.haxManager.toggleDialog(!1)};return commands},addVoiceCommand:function(command){this.push("voiceCommands",command);this.notifyPath("voiceCommands.*")},_addVoiceCommand:function(e){this.addVoiceCommand(e.detail)},_onBeforeUnload:function(){if(!window.HaxStore.instance.skipExitTrap&&window.HaxStore.instance.editMode){return"Are you sure you want to leave? Your work will not be saved!"}},_onPaste:function(e){if(window.HaxStore.instance.isTextElement(window.HaxStore.instance.activeNode)&&!window.HaxStore.instance.haxManager.opened){e.preventDefault();let text="";if(e.clipboardData||e.originalEvent.clipboardData){text=(e.originalEvent||e).clipboardData.getData("text/plain")}else if(window.clipboardData){text=window.clipboardData.getData("Text")}window.HaxStore.getSelection();var range;if(range=window.HaxStore.getRange()){range.deleteContents();range.insertNode(document.createTextNode(text))}}},created:function(){setPassiveTouchGestures(!0);if(null==window.HaxStore.instance){window.HaxStore.instance=this}this.haxToast=window.SimpleToast.requestAvailability();window.addEventListener("hax-register-properties",this._haxStoreRegisterProperties.bind(this));document.body.addEventListener("hax-register-app",this._haxStoreRegisterApp.bind(this));document.body.addEventListener("hax-register-stax",this._haxStoreRegisterStax.bind(this));document.body.addEventListener("hax-register-blox",this._haxStoreRegisterBlox.bind(this));document.body.addEventListener("hax-store-write",this._writeHaxStore.bind(this));document.body.addEventListener("hax-register-manager",this._haxStoreRegisterManager.bind(this));document.body.addEventListener("hax-register-autoloader",this._haxStoreRegisterAutoloader.bind(this));document.body.addEventListener("hax-register-body",this._haxStoreRegisterBody.bind(this));document.body.addEventListener("hax-register-panel",this._haxStoreRegisterPanel.bind(this));document.body.addEventListener("hax-register-app-picker",this._haxStoreRegisterAppPicker.bind(this));document.body.addEventListener("hax-register-stax-picker",this._haxStoreRegisterStaxPicker.bind(this));document.body.addEventListener("hax-register-blox-picker",this._haxStoreRegisterBloxPicker.bind(this));document.body.addEventListener("hax-register-preferences",this._haxStoreRegisterPreferences.bind(this));document.body.addEventListener("hax-register-export",this._haxStoreRegisterExport.bind(this));document.body.addEventListener("hax-insert-content",this._haxStoreInsertContent.bind(this));document.body.addEventListener("hax-insert-content-array",this._haxStoreInsertMultiple.bind(this));window.addEventListener("hax-add-voice-command",this._addVoiceCommand.bind(this));document.body.style.setProperty("--hax-ui-headings","#d4ff77")},_buildPrimitiveDefinitions:function(){if(window.HaxStore.instance._isSandboxed){this.setHaxProperties({canScale:!0,canPosition:!0,canEditSource:!1,settings:{quick:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],advanced:[]}},"webview")}this.setHaxProperties({canScale:!0,canPosition:!0,canEditSource:!0,gizmo:{title:"Basic iframe",description:"A basic iframe",icon:"icons:fullscreen",color:"grey",groups:["Content"],handles:[{type:"link",source:"src",height:"height",width:"width"}],meta:{author:"W3C"}},settings:{quick:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],advanced:[]}},"iframe");this.setHaxProperties({canScale:!0,canPosition:!0,canEditSource:!1,gizmo:{title:"Image",description:"A basic img tag",icon:"image:image",color:"grey",groups:["Image","Media"],handles:[{type:"link",source:"src"},{type:"image",source:"src",height:"height",width:"width"}],meta:{author:"W3C"}},settings:{quick:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"},{attribute:"alt",title:"Alt text",description:"Useful for screen readers and improved SEO.",inputMethod:"alt",icon:"accessibility"},{attribute:"height",title:"Height",description:"height in pixels of the item",inputMethod:"textfield",icon:"icons:swap-vert"},{attribute:"width",title:"Width",description:"width in pixels of the item",inputMethod:"textfield",icon:"icons:swap-horiz"}],configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"},{attribute:"alt",title:"Alt text",description:"Useful for screen readers and improved SEO.",inputMethod:"alt",icon:"accessibility"},{attribute:"height",title:"Height",description:"height in pixels of the item",inputMethod:"textfield",icon:"icons:swap-vert"},{attribute:"width",title:"Width",description:"width in pixels of the item",inputMethod:"textfield",icon:"icons:swap-horiz"}],advanced:[]}},"img");this.setHaxProperties({canScale:!1,canPosition:!1,canEditSource:!0,gizmo:{title:"Basic link",description:"A basic a tag",icon:"icons:link",color:"grey",groups:["Link"],handles:[{type:"link",source:"href",title:"innerText",alt:"title"}],meta:{author:"W3C"}},settings:{quick:[{attribute:"href",title:"Link",description:"The URL for this video.",inputMethod:"textfield",icon:"icons:link",required:!0,validationType:"url"},{attribute:"title",title:"Title text",description:"Useful for screen readers and improved SEO.",inputMethod:"textfield",icon:"icons:accessibility"}],configure:[{attribute:"innerText",title:"Text",description:"Text of the link",inputMethod:"textfield",required:!0},{attribute:"href",title:"Link",description:"The URL for this video.",inputMethod:"textfield",icon:"icons:link",required:!0,validationType:"url"},{attribute:"title",title:"Title text",description:"Useful for screen readers and improved SEO.",inputMethod:"textfield",icon:"icons:accessibility"},{attribute:"target",title:"Target",description:"Where to place the link.",inputMethod:"select",icon:"icons:launch",options:{"":"Same window",_blank:"New window",_top:"Top window",_parent:"Parent window"}}],advanced:[]}},"a");this.setHaxProperties({canScale:!1,canPosition:!1,canEditSource:!0,settings:{quick:[],configure:[],advanced:[]}},"p");this.setHaxProperties({canScale:!0,canPosition:!0,canEditSource:!1,settings:{quick:[],configure:[],advanced:[]}},"hr");this.setHaxProperties(CodeSample.haxProperties,CodeSample.tag)},_haxStoreRegisterManager:function(e){if(e.detail&&typeof this.haxManager===typeof void 0){this.haxManager=e.detail}},_haxStoreRegisterAutoloader:function(e){if(e.detail&&typeof this.haxAutoloader===typeof void 0){this.haxAutoloader=e.detail}},_haxStoreRegisterAppPicker:function(e){if(e.detail&&typeof this.haxAppPicker===typeof void 0){this.haxAppPicker=e.detail}},_haxStoreRegisterStaxPicker:function(e){if(e.detail&&typeof this.haxStaxPicker===typeof void 0){this.haxStaxPicker=e.detail}},_haxStoreRegisterBloxPicker:function(e){if(e.detail&&typeof this.haxBloxPicker===typeof void 0){this.haxBloxPicker=e.detail}},closeAllDrawers:function(active=!1){let drawers=["haxManager","haxBloxPicker","haxStaxPicker","haxPreferences","haxExport"];for(var i in drawers){if(active===this[drawers[i]]){active.open();if("haxManager"===drawers[i]){setTimeout(()=>{if(null!=active.querySelector("#activepage .iron-selected paper-input")){active.querySelector("#activepage .iron-selected paper-input").focus()}},325)}else{setTimeout(()=>{if(null!=active.querySelector("paper-checkbox,paper-input,textarea,paper-button")){active.querySelector("paper-checkbox,paper-input,textarea,paper-button").focus()}},325)}}else{this[drawers[i]].close()}}},_haxStoreInsertContent:function(e){if(e.detail){var properties={};if(typeof e.detail.properties!==typeof void 0){properties=e.detail.properties}this.activeHaxBody.__activeHover=null;if(e.detail.replace&&e.detail.replacement){let node=window.HaxStore.haxElementToNode(e.detail.tag,e.detail.content,properties);if(this.activeNode!==this.activeContainerNode){this.activeHaxBody.haxReplaceNode(this.activeNode,node,this.activeContainerNode)}else{this.activeHaxBody.haxReplaceNode(this.activeNode,node)}}else if(typeof e.detail.__type!==typeof void 0&&"inline"===e.detail.__type){let node=window.HaxStore.haxElementToNode(e.detail.tag,e.detail.content,properties);if(null!==this.activePlaceHolder){this.activePlaceHolder.deleteContents();this.activePlaceHolder.insertNode(node)}this.activePlaceHolder=null}else{this.activeHaxBody.haxInsert(e.detail.tag,e.detail.content,properties)}}},_haxStoreInsertMultiple:function(e){if(e.detail){var properties;for(var i in e.detail){properties={};if(typeof e.detail[i].properties!==typeof void 0){properties=e.detail[i].properties}this.activeHaxBody.haxInsert(e.detail[i].tag,e.detail[i].content,properties,!1)}setTimeout(()=>{this.activeHaxBody.breakUpdateLock()},300)}},_haxStoreRegisterBody:function(e){if(e.detail){this.haxBodies.push(e.detail);this.activeHaxBody=e.detail;window.HaxStore.write("activeHaxBody",this.activeHaxBody,this);window.HaxStore.write("editMode",this.editMode,this)}},_haxStoreRegisterPanel:function(e){if(e.detail&&typeof this.haxPanel===typeof void 0){this.haxPanel=e.detail}},_haxStoreRegisterExport:function(e){if(e.detail&&typeof this.haxExport===typeof void 0){this.haxExport=e.detail}},_haxStoreRegisterPreferences:function(e){if(e.detail&&typeof this.haxPreferences===typeof void 0){this.haxPreferences=e.detail}},computePolyfillSafe:function(){if(document.head.createShadowRoot||document.head.attachShadow){return!0}else{console.log("Shadow DOM missing, certain operations hidden");return!1}},_writeHaxStore:function(e){if(e.detail&&typeof e.detail.value!==typeof void 0&&e.detail.property&&e.detail.owner){if("object"===typeof e.detail.value){this.set(e.detail.property,{})}this.set(e.detail.property,e.detail.value);this.fire("hax-store-property-updated",{property:e.detail.property,value:e.detail.value,owner:e.detail.owner})}},_haxStoreRegisterApp:function(e){if(e.detail){e.detail.index=this.appList.length;this.push("appList",e.detail);window.HaxStore.write("appList",this.appList,this);if(typeof e.target.parentElement!==typeof void 0&&"HAX-STORE"===e.target.parentElement.tagName){dom(e.target.parentElement).removeChild(e.target)}}},_haxStoreRegisterStax:function(e){if(e.detail){e.detail.index=this.staxList.length;this.push("staxList",e.detail);window.HaxStore.write("staxList",this.staxList,this);if(typeof e.target.parentElement!==typeof void 0&&"HAX-STORE"===e.target.parentElement.tagName){dom(e.target.parentElement).removeChild(e.target)}}},_haxStoreRegisterBlox:function(e){if(e.detail){e.detail.index=this.bloxList.length;this.push("bloxList",e.detail);window.HaxStore.write("bloxList",this.bloxList,this);if(typeof e.target.parentElement!==typeof void 0&&"HAX-STORE"===e.target.parentElement.tagName){dom(e.target.parentElement).removeChild(e.target)}}},_haxStoreRegisterProperties:function(e){if(e.detail&&e.detail.properties&&e.detail.tag){if(typeof this.elementList[e.detail.tag]===typeof void 0){let gizmo=e.detail.properties.gizmo;if(gizmo){gizmo.tag=e.detail.tag;let gizmos=this.gizmoList;gizmos.push(gizmo);window.HaxStore.write("gizmoList",gizmos,this)}this.set("elementList."+e.detail.tag,e.detail.properties);if(!this.validTagList.find(element=>{return element===e.detail.tag})){this.push("validTagList",e.detail.tag)}}if(typeof e.target.parentElement!==typeof void 0&&"HAX-AUTOLOADER"===e.target.parentElement.tagName){dom(this.haxAutoloader).removeChild(e.target)}}}});window.HaxStore.toArray=obj=>{return Object.keys(obj).map(function(key){return obj[key]})};window.HaxStore.camelToDash=str=>{return str.replace(/\W+/g,"-").replace(/([a-z\d])([A-Z])/g,"$1-$2").toLowerCase()};window.HaxStore.dashToCamel=str=>{return str.replace(/-([a-z])/g,function(g){return g[1].toUpperCase()})};window.HaxStore.htmlToHaxElements=html=>{let elements=[];const validTags=window.HaxStore.instance.validTagList;let fragment=document.createElement("div");fragment.innerHTML=html;const children=fragment.childNodes;for(var i=0;i<children.length;i++){if(typeof children[i].tagName!==typeof void 0&&validTags.includes(children[i].tagName.toLowerCase())){elements.push(window.HaxStore.nodeToHaxElement(children[i],null))}}return elements};window.HaxStore.nodeToHaxElement=(node,eventName="insert-element")=>{var props={};if(typeof node.style!==typeof void 0){props.style=node.getAttribute("style")}if(null===props.style||"null"===props.style){delete props.style}if(typeof node.attributes.class!==typeof void 0){props.class=node.attributes.class.nodeValue.replace("hax-active","")}if(typeof node.attributes.id!==typeof void 0){props.id=node.getAttribute("id")}let tmpProps=node.properties;if(typeof tmpProps===typeof void 0){tmpProps=node.__data}if(typeof tmpProps!==typeof void 0){for(var property in tmpProps){if("class"!=property&&"style"!=property&&tmpProps.hasOwnProperty(property)&&typeof node[property]!==void 0&&null!=node[property]&&""!=node[property]){props[property]=node[property]}else if(!1===node[property]){props[property]=node[property]}}for(var attribute in node.attributes){if(typeof node.attributes[attribute].name!==typeof void 0&&"class"!=node.attributes[attribute].name&&"style"!=node.attributes[attribute].name&&"id"!=node.attributes[attribute].name&&node.attributes.hasOwnProperty(attribute)&&typeof node.attributes[attribute].value!==void 0&&null!=node.attributes[attribute].value&&""!=node.attributes[attribute].value&&!tmpProps.hasOwnProperty(window.HaxStore.dashToCamel(node.attributes[attribute].name))){props[window.HaxStore.dashToCamel(node.attributes[attribute].name)]=node.attributes[attribute].value}}}else{for(var attribute in node.attributes){if(typeof node.attributes[attribute].name!==typeof void 0&&"class"!=node.attributes[attribute].name&&"style"!=node.attributes[attribute].name&&"id"!=node.attributes[attribute].name&&node.attributes.hasOwnProperty(attribute)&&typeof node.attributes[attribute].value!==void 0&&null!=node.attributes[attribute].value&&""!=node.attributes[attribute].value){props[window.HaxStore.dashToCamel(node.attributes[attribute].name)]=node.attributes[attribute].value}}}let tag=node.tagName.toLowerCase();if(window.HaxStore.instance._isSandboxed&&"iframe"===tag){tag="webview"}let slotContent=window.HaxStore.getHAXSlot(node);if("a"===tag){props.innerText=slotContent}else if("p"===tag||"ol"===tag||"ul"===tag||"div"===tag){props.innerHTML=slotContent}let element={tag:tag,properties:props,content:slotContent};if(null!==eventName){element.eventName=eventName}return element};window.HaxStore.haxElementToNode=(tag,content,properties)=>{if(window.HaxStore.instance._isSandboxed&&"iframe"===tag){tag="webview"}var frag=document.createElement(tag);frag.innerHTML=content;var newNode=frag.cloneNode(!0);for(var property in properties){let attributeName=window.HaxStore.camelToDash(property);if(properties.hasOwnProperty(property)){if(!0===properties[property]){newNode.setAttribute(attributeName,properties[property])}else if(!1===properties[property]){newNode.removeAttribute(attributeName)}else if(null!=properties[property]&&properties[property].constructor===Array){if(!(frag.properties&&frag.properties[property]&&frag.properties[property].readOnly)){newNode.set(attributeName,properties[property])}}else if(null!=properties[property]&&properties[property].constructor===Object){if(!(frag.properties&&frag.properties[property]&&frag.properties[property].readOnly)){newNode.set(attributeName,properties[property])}}else{newNode.setAttribute(attributeName,properties[property])}}}return newNode};window.HaxStore.haxNodeToContent=node=>{if(window.HaxStore.instance.activeHaxBody.globalPreferences.haxDeveloperMode){console.log(node)}let prototype=Object.getPrototypeOf(node);if(typeof prototype.preProcessHaxNodeToContent!==typeof void 0){let clone=node.cloneNode(!0);node=prototype.preProcessHaxNodeToContent(clone)}let tag=node.tagName.toLowerCase();if(window.HaxStore.instance._isSandboxed&&"webview"===tag){tag="iframe"}var content="";content+="<"+tag;for(var props=window.HaxStore.instance.elementList[tag],propvals={},j=0,l=node.attributes.length;j<l;++j){var nodeName=node.attributes.item(j).nodeName,value=node.attributes.item(j).value;if("style"!=nodeName&&(typeof value===typeof Object||value.constructor===Array)){propvals[nodeName]=JSON.stringify(value).replace(/"/g,"&quot;")}else if(null!=value&&"null"!=value){if(!0===value||"true"===value){propvals[nodeName]=!0}else if(!(!1===value)){if("string"===typeof value&&""!==value){value=value.replace(/"/g,"&quot;");propvals[nodeName]=value}else if(""===value){if(""==value&&""!=node.attributes.item(j).value){value=node.attributes.item(j).value}propvals[nodeName]=value}else{propvals[nodeName]=value}}}}if(typeof node.properties!==typeof void 0){for(var j in node.properties){var nodeName=window.HaxStore.camelToDash(j),value=null;if(typeof node[j]!==typeof void 0){value=node[j]}if(!node.properties[j].readOnly&&value!==node.properties[j].value){if(null!=value&&(typeof value===typeof Object||value.constructor===Array)){propvals[nodeName]=JSON.stringify(value).replace(/"/g,"&quot;")}else if(null!=value&&"null"!=value){if(!0===value||"true"===value){propvals[nodeName]=!0}else if(!(!1===value)){if("string"===typeof value&&""!==value){value=value.replace(/"/g,"&quot;");propvals[nodeName]=value}else if(""===value){if(""==value&&""!=node.properties[j].value){value=node.properties[j].value}else if(""===value&&""==node.properties[j].value){}}else{propvals[nodeName]=value}}}}}}if(typeof props!==typeof void 0&&typeof props.saveOptions.unsetAttributes!==typeof void 0){for(var i in props.saveOptions.unsetAttributes){delete propvals[props.saveOptions.unsetAttributes[i]]}}let delProps=["inner-text","tabindex","guestinstance"];for(var delProp in delProps){if(typeof propvals[delProps[delProp]]!==typeof void 0){delete propvals[delProps[delProp]]}}if(typeof propvals.id!==typeof void 0&&""===propvals.id){delete propvals.id}for(var i in propvals){if(!0===propvals[i]){content+=" "+i}else{content+=" "+i+"=\""+propvals[i]+"\""}}if(["area","base","br","col","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"].includes(tag)){content+="/>"}else{content+=">"}if(typeof props===typeof void 0||!props.saveOptions.wipeSlot){let slotnodes=dom(node).getEffectiveChildNodes();if(0<slotnodes.length){for(var j=0,len2=slotnodes.length;j<len2;j++){if(typeof slotnodes[j].tagName!==typeof void 0){if(!window.HaxStore.HTMLPrimativeTest(slotnodes[j].tagName)&&"TEMPLATE"!==slotnodes[j].tagName){content+=window.HaxStore.haxNodeToContent(slotnodes[j])}else{slotnodes[j].setAttribute("data-editable",!1);slotnodes[j].removeAttribute("data-hax-ray");slotnodes[j].contentEditable=!1;content+=slotnodes[j].outerHTML}}else if(8===slotnodes[j].nodeType){content+="<!-- "+slotnodes[j].textContent+" -->"}else if(1!==slotnodes[j].nodeType&&typeof slotnodes[j].textContent!==typeof void 0&&"undefined"!==slotnodes[j].textContent){content+=slotnodes[j].textContent}}}}if("span"===tag){content+="</"+tag+">"}else if(!("hr"===tag||"br"===tag||"img"===tag)){content+="</"+tag+">"+"\n"}if(window.HaxStore.instance.activeHaxBody.globalPreferences.haxDeveloperMode){console.log(content)}if("function"===node.postProcesshaxNodeToContent){content=node.postProcesshaxNodeToContent(content)}return content};window.HaxStore.HTMLPrimativeTest=node=>{if(typeof node.tagName!==typeof void 0&&-1==node.tagName.indexOf("-")){return!0}return!1};window.HaxStore.getHAXSlot=node=>{let content="";var slotnodes=dom(node).children;if(0<slotnodes.length){for(var j=0,len2=slotnodes.length;j<len2;j++){if(typeof slotnodes[j].tagName!==typeof void 0){if(0<slotnodes[j].tagName.indexOf("-")){content+="  "+window.HaxStore.haxNodeToContent(slotnodes[j])+"\n"}else{content+="  "+slotnodes[j].outerHTML+"\n"}}else if(8===slotnodes[j].nodeType){content+="<!-- "+slotnodes[j].textContent+" -->"}else if(1!==slotnodes[j].nodeType&&typeof slotnodes[j].textContent!==typeof void 0&&"undefined"!==slotnodes[j].textContent){content+=slotnodes[j].textContent}}}return content};window.HaxStore.write=(prop,value,obj)=>{obj.fire("hax-store-write",{property:prop,value:value,owner:obj})};window.HaxStore.guessGizmoType=guess=>{if(typeof guess.source!==typeof void 0){if(-1!=guess.source.indexOf(".mp3")){return"audio"}else if(-1!=guess.source.indexOf(".png")||-1!=guess.source.indexOf(".jpg")||-1!=guess.source.indexOf(".jpeg")||-1!=guess.source.indexOf(".gif")){return"image"}else if(-1!=guess.source.indexOf(".pdf")){return"pdf"}else if(-1!=guess.source.indexOf(".svg")){return"svg"}else if(-1!=guess.source.indexOf(".csv")){return"csv"}else if("external"!=window.HaxStore.instance.getVideoType(guess.source)){return"video"}else{return"*"}}};window.HaxStore.guessGizmo=(guess,values,skipPropMatch=!1)=>{var matches=[];if(typeof guess!==typeof void 0){var store=window.HaxStore.instance;if(store.validGizmoTypes.includes(guess)){for(var gizmoposition in store.gizmoList){var gizmo=store.gizmoList[gizmoposition],props={},match=!1;if(gizmo.handles){for(var i=0;i<gizmo.handles.length;i++){if(guess===gizmo.handles[i].type||"*"===guess&&!match){for(var property in gizmo.handles[i]){if("type"!==property){if(typeof values[property]!==typeof void 0){match=!0;props[gizmo.handles[i][property]]=values[property]}}}if(match||skipPropMatch){matches.push(window.HaxStore.haxElementPrototype(gizmo,props,""))}}}}}}}return matches};window.HaxStore.getHaxAppStoreTargets=type=>{let targets=window.HaxStore.instance.appList.filter(app=>{if(typeof app.connection.operations.add!==typeof void 0){let add=app.connection.operations.add;if(typeof add.acceptsGizmoTypes!==typeof void 0&&add.acceptsGizmoTypes.includes(type)){return!0}}return!1});return targets};window.HaxStore.haxElementPrototype=(gizmo,properties,content="")=>{return{tag:gizmo.tag,properties:properties,content:content,gizmo:gizmo}};window.HaxStore.wipeSlot=(element,slot="")=>{if("*"===slot){while(null!==dom(element).firstChild){dom(element).removeChild(dom(element).firstChild)}}else{for(var i in dom(element).childNodes){if(typeof dom(element).childNodes[i]!==typeof void 0&&dom(element).childNodes[i].slot===slot){dom(element).removeChild(dom(element).childNodes[i])}}}};window.HaxStore.encapScript=html=>{if("function"===typeof html.replace){html=html.replace(/<script[\s\S]*?>/gi,"&lt;script&gt;");html=html.replace(/<\/script>/gi,"&lt;/script&gt;");html=html.replace(/<hax[\s\S]*?>/gi,"");html=html.replace(/<\/hax[\s\S]*?>/gi,"");html=html.replace(/<h-a-x[\s\S]*?>/gi,"");html=html.replace(/<\/h-a-x*?>/gi,"");html=html.replace(/<style[\s\S]*?>/gi,"&lt;style&gt;");html=html.replace(/<\/style>/gi,"&lt;/style&gt;");html=html.replace(/<template[\s\S]*?>[\s\S]*?&lt;script[\s\S]*?&gt;[\s\S]*?&lt;\/script&gt;/gi,function(match){match=match.replace("&lt;script&gt;","<script>");match=match.replace("&lt;/script&gt;","</script>");match=match.replace("&lt;style&gt;","<style>");match=match.replace("&lt;/style&gt;","</style>");return match})}return html};window.HaxStore.toast=(message,duration=4e3,classStyle="",closeText=null,eventCallback=null)=>{const evt=new CustomEvent("simple-toast-show",{bubbles:!0,cancelable:!0,detail:{text:message,duration:duration,classStyle:classStyle,closeText:closeText,eventCallback:eventCallback}});window.dispatchEvent(evt)};window.HaxStore.getSelection=()=>{if(window.HaxStore.instance.activeHaxBody.parentNode){if(window.HaxStore.instance.activeHaxBody.parentNode.getSelection){return window.HaxStore.instance.activeHaxBody.parentNode.getSelection()}else if(getRange(window.HaxStore.instance.activeHaxBody.parentNode)){return getRange(window.HaxStore.instance.activeHaxBody.parentNode)}}return window.getSelection()};window.HaxStore.getRange=()=>{let sel=window.HaxStore.getSelection();if(sel.getRangeAt&&sel.rangeCount){return sel.getRangeAt(0)}else if(sel){return sel}else;};