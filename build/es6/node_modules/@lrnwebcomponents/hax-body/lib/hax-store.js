import{LitElement,html,css}from"../../../lit-element/lit-element.js";import{setPassiveTouchGestures}from"../../../@polymer/polymer/lib/utils/settings.js";import{winEventsElement,getRange,encapScript,wipeSlot,stripMSWord}from"../../utils/utils.js";import{HAXElement}from"../../hax-body-behaviors/hax-body-behaviors.js";import{CodeSample}from"../../code-sample/code-sample.js";import"../../../@polymer/iron-ajax/iron-ajax.js";import"../../simple-toast/simple-toast.js";import"./hax-app.js";import"./hax-stax.js";import"./hax-blox.js";class HaxStore extends(winEventsElement(HAXElement(LitElement))){static get styles(){return[css`
        :host {
          display: none;
        }
      `]}render(){return html`
      <slot></slot>
      <undoer-element></undoer-element>
      <iron-ajax
        id="appstore"
        url="${this.appStore.url}"
        .params="${this.appStore.params}"
        method="GET"
        content-type="application/json"
        handle-as="json"
        @last-response-changed="${this.__appStoreDataChanged}"
      ></iron-ajax>
      <hal-9000
        id="hal"
        .responds-to="${this.voiceRespondsTo}"
        .debug="${this.voiceDebug}"
      ></hal-9000>
    `}__appStoreDataChanged(e){this.__appStoreData=e.detail.value}static get tag(){return"hax-store"}static get properties(){return{...super.properties,openDrawer:{type:Object},voiceDebug:{type:Boolean},voiceRespondsTo:{type:String,attribute:"voice-responses-to"},skipHAXConfirmation:{type:Boolean,reflect:!0,attribute:"skip-hax-confirmation"},storageData:{type:Object},haxAppPicker:{type:Object},haxStaxPicker:{type:Object},haxBloxPicker:{type:Object},haxManager:{type:Object},haxAutoloader:{type:Object},haxBodies:{type:Array},activePlaceHolder:{type:Object},activeHaxBody:{type:Object},appStore:{type:Object},haxToast:{type:Object},haxPanel:{type:Object},haxExport:{type:Object},haxPreferences:{type:Object},activeHaxElement:{type:Object},activeNode:{type:Object},activeContainerNode:{type:Object},sessionObject:{type:Object},editMode:{type:Boolean},canSupportUploads:{type:Boolean},skipExitTrap:{type:Boolean},gizmoList:{type:Array},elementList:{type:Object},appList:{type:Array},staxList:{type:Array},bloxList:{type:Array},globalPreferences:{type:Object},activeApp:{type:Object},validTagList:{type:Array},validGizmoTypes:{type:Array},_isSandboxed:{type:Boolean},__appStoreData:{type:Object},__ready:{type:Boolean},connectionRewrites:{type:Object}}}_storageDataChanged(newValue){newValue&&window.HaxStore.ready&&this.__storageDataProcessed&&(window.localStorage.getItem("haxConfirm")?window.localStorage.setItem("haxUserData",JSON.stringify(newValue)):window.sessionStorage.getItem("haxConfirm")&&window.sessionStorage.setItem("haxUserData",JSON.stringify(newValue)))}isTextElement(node){let tag;return null!=node&&node.tagName?tag=node.tagName.toLowerCase():null!=node&&node.tag&&(tag=node.tag.toLowerCase()),!!(tag&&this.validTagList.includes(tag)&&["p","ol","ul","li","a","h1","h2","h3","h4","h5","h6","strike","u","b","sub","sup","span","i","bold","em","strong","blockquote","code","figure"].includes(tag))}isGridPlateElement(node){let tag;return node&&node.tagName?tag=node.tagName.toLowerCase():node&&node.tag&&(tag=node.tag.toLowerCase()),!!(tag&&this.validTagList.includes(tag)&&["p","ol","ul","li","div","h1","h2","h3","h4","h5","h6","blockquote","code","figure","grid-plate"].includes(tag))}_appStoreChanged(newValue,oldValue){void 0!==newValue&&null!=newValue&&void 0!==oldValue&&(void 0===newValue.apps?this.shadowRoot.querySelector("#appstore").generateRequest():this.__appStoreData=newValue)}_loadAppStoreData(ready,appDataResponse,haxAutoloader){if(ready&&void 0!==appDataResponse&&null!=appDataResponse){var items={};if(void 0!==appDataResponse.autoloader)for(var i in appDataResponse.autoloader=Object.assign({},appDataResponse.autoloader),appDataResponse.autoloader){let CEname=i,CEimport=appDataResponse.autoloader[i];isNaN(CEname)||(CEname=appDataResponse.autoloader[i],CEimport=`@lrnwebcomponents/${CEname}/${CEname}.js`),this.validTagList.push(CEname),items[CEname]=CEimport}if(void 0!==appDataResponse.apps){var apps=appDataResponse.apps;for(i=0;i<apps.length;i++){let app=document.createElement("hax-app");app.data=apps[i],apps[i].connection.operations.add&&window.HaxStore.write("canSupportUploads",!0,this),window.HaxStore.instance.appendChild(app)}}if(void 0!==appDataResponse.stax){var staxs=appDataResponse.stax;for(i=0;i<staxs.length;i++){let stax=document.createElement("hax-stax");stax.data=staxs[i],window.HaxStore.instance.appendChild(stax)}}if(void 0!==appDataResponse.blox){var bloxs=appDataResponse.blox;for(i=0;i<bloxs.length;i++){let blox=document.createElement("hax-blox");blox.data=bloxs[i],window.HaxStore.instance.appendChild(blox)}}this.dispatchEvent(new CustomEvent("hax-store-app-store-loaded",{bubbles:!0,cancelable:!0,composed:!0,detail:!0})),this._handleDynamicImports(items,haxAutoloader)}}pathFromUrl(url){return url.substring(0,url.lastIndexOf("/")+1)}async _handleDynamicImports(items,haxAutoloader){const basePath=this.pathFromUrl(decodeURIComponent(import.meta.url));for(var i in items)if(window.customElements.get(i)){let CEClass=window.customElements.get(i);"function"==typeof CEClass.getHaxProperties?this.setHaxProperties(CEClass.getHaxProperties(),i):"function"==typeof CEClass.HAXWiring?this.setHaxProperties(CEClass.HAXWiring.getHaxProperties(),i):CEClass.haxProperties?this.setHaxProperties(CEClass.haxProperties,i):haxAutoloader.appendChild(document.createElement(i))}else await import(`${basePath}../../../${items[i]}`).then(response=>{for(var cVal in response){let CEClass=response[cVal];"function"==typeof CEClass.getHaxProperties?this.setHaxProperties(CEClass.getHaxProperties(),i):"function"==typeof CEClass.HAXWiring?this.setHaxProperties(CEClass.HAXWiring.getHaxProperties(),i):CEClass.haxProperties?this.setHaxProperties(CEClass.haxProperties,i):haxAutoloader.appendChild(document.createElement(i))}}).catch(error=>{console.warn(error)})}_editModeChanged(newValue){newValue&&this.globalPreferences.haxVoiceCommands?this.__hal.auto=!0:this.__hal.auto=!1}_globalPreferencesChanged(newValue,oldValue){if(this.__storageDataProcessed&&newValue&&void 0!==newValue.haxVoiceCommands&&window.HaxStore.ready){let storageData=this.storageData;storageData.globalPreferences=newValue,this.storageData=storageData,this._storageDataChanged(this.storageData),newValue.haxVoiceCommands&&this.editMode?this.__hal.auto=!0:this.__hal.auto=!1}}_haxConsentTap(e){window.localStorage.setItem("haxConfirm",!0),window.localStorage.setItem("haxUserData",JSON.stringify(this.storageData))}updated(changedProperties){let loadAppStoreData=!1;changedProperties.forEach((oldValue,propName)=>{"openDrawer"==propName&&this.openDrawersCallback(this[propName],oldValue),"appStore"==propName&&this._appStoreChanged(this[propName],oldValue),"globalPreferences"==propName&&this._globalPreferencesChanged(this[propName],oldValue),"editMode"==propName&&this._editModeChanged(this[propName],oldValue),["__ready","__appStoreData","haxAutoloader"].includes(propName)&&(loadAppStoreData=!0),["haxAutoloader","activeHaxBody","haxPanel","haxToast","haxExport","haxPreferences","haxManager","haxStaxPicker","haxBloxPicker","haxAppPicker"].includes(propName)&&this._storePiecesAllHere(this.haxAutoloader,this.activeHaxBody,this.haxPanel,this.haxToast,this.haxExport,this.haxPreferences,this.haxManager,this.haxStaxPicker,this.haxBloxPicker,this.haxAppPicker)}),loadAppStoreData&&this._loadAppStoreData(this.__ready,this.__appStoreData,this.haxAutoloader)}firstUpdated(changedProperties){if(import("../../hal-9000/hal-9000.js"),setTimeout(()=>{this.__storageDataProcessed=!0,this.storageData.globalPreferences&&window.HaxStore.write("globalPreferences",this.storageData.globalPreferences,this)},100),this.__hal=this.shadowRoot.querySelector("#hal"),this.skipHAXConfirmation&&(window.sessionStorage.setItem("haxConfirm",!0),window.localStorage.setItem("haxConfirm",!0)),window.sessionStorage.getItem("haxConfirm")||window.localStorage.getItem("haxConfirm"))if(window.sessionStorage.getItem("haxConfirm")&&!window.localStorage.getItem("haxConfirm"))try{let globalData=window.sessionStorage.getItem("haxUserData")?JSON.parse(window.sessionStorage.getItem("haxUserData")):{};this.storageData=globalData,this._storageDataChanged(this.storageData)}catch(e){}else try{let globalData=window.localStorage.getItem("haxUserData")?JSON.parse(window.localStorage.getItem("haxUserData")):{};this.storageData=globalData,this._storageDataChanged(this.storageData)}catch(e){}else{window.sessionStorage.setItem("haxConfirm",!0);let msg="\n    The HAX content editor keeps preferences in order to improve your experience.\n    This data is stored in your browser and is never sent anywhere.\n    Click to accept.\n    ";window.HaxStore.toast(msg,"-1","fit-bottom","I Accept","hax-consent-tap")}}_storePiecesAllHere(haxAutoloader,activeHaxBody,haxPanel,haxToast,haxExport,haxPreferences,haxManager,haxStaxPicker,haxBloxPicker,haxAppPicker){!this.__ready&&activeHaxBody&&haxAutoloader&&haxPanel&&haxToast&&haxExport&&haxPreferences&&haxManager&&haxStaxPicker&&haxBloxPicker&&haxAppPicker&&(this.dispatchEvent(new CustomEvent("hax-store-ready",{bubbles:!0,cancelable:!1,composed:!0,detail:!0})),window.HaxStore.ready=!0,this.__ready=!0,this._buildPrimitiveDefinitions(),this._initVoiceCommands(),this.__hal.commands={...this.voiceCommands})}_initVoiceCommands(){this.__voiceInit=!0,this.voiceCommands[`scroll up ${this.voiceRespondsTo}`]=()=>{window.scrollBy({top:-.5*window.innerHeight,left:0,behavior:"smooth"})},this.voiceCommands[`scroll (down) ${this.voiceRespondsTo}`]=()=>{window.scrollBy({top:.5*window.innerHeight,left:0,behavior:"smooth"})},this.voiceCommands[`hey ${this.voiceRespondsTo}`]=()=>{this.__hal.speak("Yeah what do you want")},this.voiceCommands[`${this.voiceRespondsTo} close`]=()=>{window.HaxStore.write("openDrawer",!1,this)}}addVoiceCommand(command,context,callback){command=command.replace(":name:",this.voiceRespondsTo).toLowerCase(),this.voiceCommands[command]=context[callback].bind(context),this.__voiceInit&&(this.__hal.commands={...this.voiceCommands})}_addVoiceCommand(e){this.addVoiceCommand(e.detail.command,e.detail.context,e.detail.callback)}_onBeforeUnload(e){if(!window.HaxStore.instance.skipExitTrap&&window.HaxStore.instance.editMode)return"Are you sure you want to leave? Your work will not be saved!"}_onPaste(e){if(window.HaxStore.instance.isTextElement(window.HaxStore.instance.activeNode)&&!window.HaxStore.instance.haxManager.opened){let pasteContent="";e.clipboardData||e.originalEvent.clipboardData?pasteContent=(e.originalEvent||e).clipboardData.getData("text/html"):window.clipboardData&&(pasteContent=window.clipboardData.getData("Text"));var mswTest=pasteContent.replace(/(class=(")?Mso[a-zA-Z]+(")?)/g,"");let wordPaste=!1,newContent="";pasteContent!=(mswTest=mswTest.replace("mso-style-",""))&&(wordPaste=!0),pasteContent=pasteContent.replace(/<span>\s*?<\/span>/g," "),pasteContent=pasteContent.replace(/<div/g,"<p"),pasteContent=pasteContent.replace(/<\/div>/g,"</p>"),pasteContent=stripMSWord(pasteContent);let haxElements=window.HaxStore.htmlToHaxElements(pasteContent);if(0===haxElements.length){if(!wordPaste)return!1;newContent=pasteContent}else{if(1===haxElements.length&&"p"===haxElements[0].tag)return!1;if(!this.isGridPlateElement(haxElements[0]))return!1;for(var i in haxElements){delete haxElements[i].properties.style,delete haxElements[i].properties.start,delete haxElements[i].properties.align;let node=window.HaxStore.haxElementToNode(haxElements[i].tag,haxElements[i].content.replace(/<span>&nbsp;<\/span>/g," ").trim(),haxElements[i].properties);newContent+=window.HaxStore.nodeToContent(node)}}e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();try{let range=window.HaxStore.getRange(),sel=window.HaxStore.getSelection(),newNodes=document.createElement("div");if(newNodes.innerHTML=newContent,range&&sel&&"function"==typeof range.deleteContents)for(range.deleteContents();newNodes.lastChild;)range.insertNode(newNodes.lastChild)}catch(e){console.warn(e)}}}__validTags(){return["p","div","span","table","caption","sup","sub","u","strike","tr","th","td","ol","ul","li","a","strong","kbd","em","i","b","hr","h1","h2","h3","h4","h5","h6","blockquote","code","figure","img","iframe","video","audio","section","grid-plate","template","webview"]}__validGizmoTypes(){return["data","video","audio","text","link","file","pdf","image","csv","doc","content","text","inline","*"]}constructor(){super(),this.__winEvents={"hax-register-properties":"_haxStoreRegisterProperties","hax-consent-tap":"_haxConsentTap",onbeforeunload:"_onBeforeUnload",paste:"_onPaste","hax-register-app":"_haxStoreRegisterApp","hax-register-stax":"_haxStoreRegisterStax","hax-register-blox":"_haxStoreRegisterBlox","hax-store-write":"_writeHaxStore","hax-register-core-piece":"_haxStorePieceRegistrationManager","hax-register-body":"_haxStoreRegisterBody","grid-plate-add-item":"haxInsertAnything","hax-insert-content":"_haxStoreInsertContent","hax-insert-content-array":"_haxStoreInsertMultiple","hax-add-voice-command":"_addVoiceCommand"},this.voiceRespondsTo="(worker)",this.voiceCommands={},this.skipHAXConfirmation=!1,this.storageData={},this.appStore={url:"",params:{}},this.haxBodies=[],this.activePlaceHolder=null,this.sessionObject={},this.editMode=!1,this.canSupportUploads=!1,this.skipExitTrap=!1,this.gizmoList=[],this.elementList={},this.appList=[],this.staxList=[],this.bloxList=[],this.globalPreferences={},this.activeApp={},this.connectionRewrites={},this.voiceDebug=!1,this.validTagList=this.__validTags(),this.validGizmoTypes=this.__validGizmoTypes();let test=document.createElement("webview");this._isSandboxed="function"==typeof test.reload,setPassiveTouchGestures(!0),import("./hax-store-dynamic.js"),null==window.HaxStore.instance&&(window.HaxStore.instance=this),this.haxToast=window.SimpleToast.requestAvailability(),document.body.style.setProperty("--hax-ui-headings","#d4ff77")}_buildPrimitiveDefinitions(){if(window.HaxStore.instance._isSandboxed){let webview={canScale:!0,canPosition:!0,canEditSource:!1,settings:{quick:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],advanced:[]}};this.setHaxProperties(webview,"webview")}this.setHaxProperties({canScale:!0,canPosition:!0,canEditSource:!0,gizmo:{title:"Basic iframe",description:"A basic iframe",icon:"icons:fullscreen",color:"grey",groups:["Content"],handles:[{type:"link",source:"src",height:"height",width:"width"}],meta:{author:"W3C"}},settings:{quick:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],advanced:[{attribute:"loading",title:"Loading method",description:"Whether or not to lazy load this",inputMethod:"select",options:{lazy:"Load when visible",auto:"Automatic"}}]}},"iframe");this.setHaxProperties({canScale:{min:10,step:5},canPosition:!0,canEditSource:!0,gizmo:{title:"Image",description:"A basic img tag",icon:"image:image",color:"grey",groups:["Image","Media"],handles:[{type:"link",source:"src"},{type:"image",source:"src",height:"height",width:"width"}],meta:{author:"W3C"}},settings:{quick:[{attribute:"alt",title:"Alt text",description:"Useful for screen readers and improved SEO.",inputMethod:"alt",icon:"accessibility"},{attribute:"height",title:"Height",description:"height in pixels of the item. Leave blank to respond to the natural resolution",inputMethod:"textfield",icon:"icons:swap-vert"}],configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"haxupload",icon:"link",required:!0,validationType:"url"},{attribute:"alt",title:"Alt text",description:"Useful for screen readers and improved SEO.",inputMethod:"alt",icon:"accessibility"},{attribute:"height",title:"Height",description:"height in pixels of the item. Leave blank to respond to the natural resolution",inputMethod:"textfield",icon:"icons:swap-vert"}],advanced:[{attribute:"loading",title:"Loading method",description:"Whether or not to lazy load this",inputMethod:"select",options:{lazy:"Load when visible",auto:"Automatic"}}]}},"img");this.setHaxProperties({canScale:!1,canPosition:!1,canEditSource:!0,gizmo:{title:"Basic link",description:"A basic a tag",icon:"icons:link",color:"grey",groups:["Link"],handles:[{type:"link",source:"href",title:"innerText",alt:"title"}],meta:{author:"W3C"}},settings:{quick:[{attribute:"href",title:"Link",description:"The URL for this video.",inputMethod:"textfield",icon:"icons:link",required:!0,validationType:"url"},{attribute:"title",title:"Title text",description:"Useful for screen readers and improved SEO.",inputMethod:"textfield",icon:"icons:accessibility"}],configure:[{attribute:"innerText",title:"Text",description:"Text of the link",inputMethod:"textfield",required:!0},{attribute:"href",title:"Link",description:"The URL for this video.",inputMethod:"haxupload",icon:"icons:link",required:!0,validationType:"url"},{attribute:"title",title:"Title text",description:"Useful for screen readers and improved SEO.",inputMethod:"textfield",icon:"icons:accessibility"},{attribute:"target",title:"Target",description:"Where to place the link.",inputMethod:"select",icon:"icons:launch",options:{"":"Same window",_blank:"New window",_top:"Top window",_parent:"Parent window"}}],advanced:[]}},"a");this.setHaxProperties({canScale:!1,canPosition:!1,canEditSource:!0,gizmo:{title:"Paragraph",description:"A basic text area",icon:"editor:short-text",color:"grey",groups:["Text"],handles:[{type:"content",content:""}],meta:{author:"W3C"}},settings:{quick:[],configure:[{slot:"",title:"Content",description:"Internal content",inputMethod:"code-editor",icon:"icons:code"}],advanced:[]}},"p");this.setHaxProperties({canScale:{min:25,step:25},canPosition:!1,canEditSource:!1,settings:{quick:[],configure:[],advanced:[]}},"hr"),this.setHaxProperties(CodeSample.haxProperties,CodeSample.tag)}_haxStorePieceRegistrationManager(e){e.detail&&e.detail.piece&&e.detail.object&&(this[e.detail.piece]=e.detail.object)}openDrawersCallback(active=!1,oldValue){let drawers=["haxManager","haxAppPicker","haxBloxPicker","haxStaxPicker","haxPreferences","haxExport"];for(var i in drawers)active===this[drawers[i]]?(active.open(),"haxManager"===drawers[i]?setTimeout(()=>{null!=active.querySelector("#activepage .iron-selected paper-input")&&active.querySelector("#activepage .iron-selected paper-input").focus();var evt=document.createEvent("UIEvents");evt.initUIEvent("resize",!0,!1,window,0),window.dispatchEvent(evt)},325):setTimeout(()=>{null!=active.querySelector("paper-checkbox,paper-input,textarea,paper-button")&&active.querySelector("paper-checkbox,paper-input,textarea,paper-button").focus();var evt=document.createEvent("UIEvents");evt.initUIEvent("resize",!0,!1,window,0),window.dispatchEvent(evt)},325)):this[drawers[i]].close()}_haxStoreInsertContent(e){if(e.detail){let details=e.detail;if(window.customElements.get(details.tag)){let prototype=Object.getPrototypeOf(document.createElement(details.tag));void 0!==prototype.preProcessHaxInsertContent&&(details=prototype.preProcessHaxInsertContent(details))}var properties={};if(void 0!==details.properties&&(properties=details.properties),properties.innerHTML&&(""==details.content&&(details.content=properties.innerHTML),delete properties.innerHTML),properties.innerText&&(""==details.content&&(details.content=properties.innerText),delete properties.innerText),this.activeHaxBody.__activeHover=null,details.replace&&details.replacement){let node=window.HaxStore.haxElementToNode(details.tag,details.content,properties);this.activePlaceHolder?(this.activeHaxBody.haxReplaceNode(this.activePlaceHolder,node,this.activePlaceHolder.parentNode),this.activePlaceHolder=null):this.activeHaxBody.haxReplaceNode(this.activeNode,node,this.activeNode.parentNode)}else if(void 0!==details.__type&&"inline"===details.__type){let node=window.HaxStore.haxElementToNode(details.tag,details.content,properties);null!==this.activePlaceHolder&&(this.activePlaceHolder.deleteContents(),this.activePlaceHolder.insertNode(node)),this.activePlaceHolder=null}else if(null!=this.activeContainerNode){let node=window.HaxStore.haxElementToNode(details.tag,details.content,properties);this.activeContainerNode&&"GRID-PLATE"===this.activeContainerNode.tagName?(null!=this.activeNode.getAttribute("slot")&&node.setAttribute("slot",this.activeNode.getAttribute("slot")),this.activeContainerNode.appendChild(node),this.activeHaxBody.shadowRoot.querySelector("#textcontextmenu").highlightOps=!1,this.activeHaxBody.__updateLockFocus=node,setTimeout(()=>{this.activeHaxBody.breakUpdateLock()},50)):this.activeHaxBody.haxInsert(details.tag,details.content,properties)}else this.activeHaxBody.haxInsert(details.tag,details.content,properties)}}haxInsertAnything(e){let haxElements=[];for(var i in window.HaxStore.instance.gizmoList)haxElements.push(window.HaxStore.haxElementPrototype(window.HaxStore.instance.gizmoList[i],e.detail.properties,""));window.HaxStore.instance.haxAppPicker.presentOptions(haxElements,"element","Add an element","gizmo")}_haxStoreInsertMultiple(e){if(e.detail){var properties;for(var i in e.detail)properties={},void 0!==e.detail[i].properties&&(properties=e.detail[i].properties),this.activeHaxBody.haxInsert(e.detail[i].tag,e.detail[i].content,properties,!1);setTimeout(()=>{this.activeHaxBody.breakUpdateLock()},300)}}_haxStoreRegisterBody(e){e.detail&&(this.haxBodies.push(e.detail),this.activeHaxBody=e.detail,window.HaxStore.write("activeHaxBody",this.activeHaxBody,this),window.HaxStore.write("editMode",this.editMode,this))}computePolyfillSafe(){return!(!document.head.createShadowRoot&&!document.head.attachShadow)||(console.warn("Shadow DOM missing, certain operations hidden"),!1)}_writeHaxStore(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&e.detail.owner&&(null==e.detail.value?this[e.detail.property]=null:"object"==typeof e.detail.value&&(this[e.detail.property]={}),this.globalPreferences&&this.globalPreferences.haxDeveloperMode&&console.warn(e.detail.property),this[e.detail.property]=e.detail.value,this.dispatchEvent(new CustomEvent("hax-store-property-updated",{bubbles:!0,composed:!0,cancelable:!1,detail:{property:e.detail.property,value:e.detail.value,owner:e.detail.owner}})))}_haxStoreRegisterApp(e){if(e.detail){if(e.detail.index=this.appList.length,this.appList=[...this.appList,e.detail],window.HaxStore.write("appList",this.appList,this),e.detail.connection&&e.detail.connection.protocol&&e.detail.connection.url){let preconnectlink=document.createElement("link");preconnectlink.rel="preconnect",preconnectlink.href=e.detail.connection.protocol+"://"+e.detail.connection.url,document.head.appendChild(preconnectlink)}void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target)}}_haxStoreRegisterStax(e){e.detail&&(e.detail.index=this.staxList.length,this.staxList=[...this.staxList,e.detail],window.HaxStore.write("staxList",this.staxList,this),void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target))}_haxStoreRegisterBlox(e){e.detail&&(e.detail.index=this.bloxList.length,this.bloxList=[...this.bloxList,e.detail],window.HaxStore.write("bloxList",this.bloxList,this),void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target))}_haxStoreRegisterProperties(e){if(e.detail&&e.detail.properties&&e.detail.tag){if(void 0===this.elementList[e.detail.tag]){let gizmo=e.detail.properties.gizmo;if(gizmo){gizmo.tag=e.detail.tag;let gizmos=this.gizmoList;gizmos.push(gizmo),window.HaxStore.write("gizmoList",gizmos,this)}this.elementList[e.detail.tag]=e.detail.properties,this.validTagList.find(element=>element===e.detail.tag)||this.validTagList.push(e.detail.tag)}void 0!==e.target.parentElement&&"HAX-AUTOLOADER"===e.target.parentElement.tagName&&this.haxAutoloader.removeChild(e.target)}}}window.customElements.define(HaxStore.tag,HaxStore),window.HaxStore=window.HaxStore||{},window.HaxStore.instance=null,window.HaxStore.requestAvailability=function(){return window.HaxStore.instance||(window.HaxStore.instance=document.createElement("hax-store"),document.body.appendChild(window.HaxStore.instance)),window.HaxStore.instance},window.HaxStore.toArray=obj=>Object.keys(obj).map((function(key){return obj[key]})),window.HaxStore.camelToDash=str=>str.replace(/\W+/g,"-").replace(/([a-z\d])([A-Z])/g,"$1-$2").toLowerCase(),window.HaxStore.dashToCamel=str=>str.replace(/-([a-z])/g,(function(g){return g[1].toUpperCase()})),window.HaxStore.htmlToHaxElements=html=>{let elements=[];const validTags=window.HaxStore.instance.validTagList;let fragment=document.createElement("div");fragment.innerHTML=html;const children=fragment.childNodes;for(var i=0;i<children.length;i++)void 0!==children[i].tagName&&validTags.includes(children[i].tagName.toLowerCase())&&elements.push(window.HaxStore.nodeToHaxElement(children[i],null));return elements},window.HaxStore.nodeToHaxElement=(node,eventName="insert-element")=>{if(!node)return null;var props={};let tmpProps;if(void 0!==node.style&&(props.style=node.getAttribute("style")),null!==props.style&&"null"!==props.style||delete props.style,void 0!==node.attributes.class&&(props.class=node.attributes.class.nodeValue.replace("hax-active","")),void 0!==node.attributes.id&&(props.id=node.getAttribute("id")),customElements.get(node.tagName.toLowerCase())&&(tmpProps=customElements.get(node.tagName.toLowerCase()).properties),void 0===tmpProps&&(tmpProps=node.__data),void 0!==tmpProps){for(var property in tmpProps)"class"!=property&&"style"!=property&&tmpProps.hasOwnProperty(property)&&void 0!==typeof node[property]&&null!=node[property]&&""!=node[property]?props[property]=node[property]:!1===node[property]&&(props[property]=node[property]);for(var attribute in node.attributes)void 0!==node.attributes[attribute].name&&"class"!=node.attributes[attribute].name&&"style"!=node.attributes[attribute].name&&"id"!=node.attributes[attribute].name&&node.attributes.hasOwnProperty(attribute)&&void 0!==typeof node.attributes[attribute].value&&null!=node.attributes[attribute].value&&""!=node.attributes[attribute].value&&!tmpProps.hasOwnProperty(window.HaxStore.dashToCamel(node.attributes[attribute].name))&&(props[window.HaxStore.dashToCamel(node.attributes[attribute].name)]=node.attributes[attribute].value)}else for(var attribute in node.attributes)void 0!==node.attributes[attribute].name&&"class"!=node.attributes[attribute].name&&"style"!=node.attributes[attribute].name&&"id"!=node.attributes[attribute].name&&node.attributes.hasOwnProperty(attribute)&&void 0!==typeof node.attributes[attribute].value&&null!=node.attributes[attribute].value&&""!=node.attributes[attribute].value&&(props[window.HaxStore.dashToCamel(node.attributes[attribute].name)]=node.attributes[attribute].value);let tag=node.tagName.toLowerCase();window.HaxStore.instance._isSandboxed&&"iframe"===tag&&(tag="webview");let slotContent=window.HaxStore.getHAXSlot(node);""==slotContent&&(slotContent=node.innerText),"a"===tag?props.innerText=slotContent:"p"!==tag&&"ol"!==tag&&"ul"!==tag&&"div"!==tag||(props.innerHTML=slotContent);let element={tag:tag,properties:props,content:slotContent};return null!==eventName&&(element.eventName=eventName),element},window.HaxStore.haxElementToNode=(tag,content,properties)=>{window.HaxStore.instance._isSandboxed&&"iframe"===tag&&(tag="webview");var frag=document.createElement(tag);frag.innerHTML=content;var newNode=frag.cloneNode(!0);for(var property in properties){let attributeName=window.HaxStore.camelToDash(property);properties.hasOwnProperty(property)&&(!0===properties[property]?newNode.setAttribute(attributeName,properties[property]):!1===properties[property]?newNode.removeAttribute(attributeName):null!=properties[property]&&properties[property].constructor===Array?frag.properties&&frag.properties[property]&&frag.properties[property].readOnly||(newNode.set?newNode.set(attributeName,properties[property]):newNode[attributeName]=[...properties[property]]):null!=properties[property]&&properties[property].constructor===Object?frag.properties&&frag.properties[property]&&frag.properties[property].readOnly||(newNode.set?newNode.set(attributeName,properties[property]):newNode[attributeName]={...properties[property]}):newNode.setAttribute(attributeName,properties[property]))}return newNode},window.HaxStore.nodeToContent=node=>{window.HaxStore.instance.activeHaxBody.globalPreferences.haxDeveloperMode&&console.warn(node);let prototype=Object.getPrototypeOf(node);if(void 0!==prototype.preProcessHaxNodeToContent){let clone=node.cloneNode(!0);node=prototype.preProcessHaxNodeToContent(clone)}let tag=node.tagName.toLowerCase();window.HaxStore.instance._isSandboxed&&"webview"===tag&&(tag="iframe");var content="";content+="<"+tag;for(var props=window.HaxStore.instance.elementList[tag],propvals={},j=0,l=node.attributes.length;j<l;++j){var nodeName=node.attributes.item(j).nodeName,value=node.attributes.item(j).value;"style"==nodeName||typeof value!=typeof Object&&value.constructor!==Array?null!=value&&"null"!=value&&(!0===value||"true"===value?propvals[nodeName]=!0:!1===value||("string"==typeof value&&""!==value?(value=value.replace(new RegExp('"',"g"),"&quot;"),propvals[nodeName]=value):""===value?(""==value&&""!=node.attributes.item(j).value&&(value=node.attributes.item(j).value),propvals[nodeName]=value):propvals[nodeName]=value)):propvals[nodeName]=JSON.stringify(value).replace(new RegExp('"',"g"),"&quot;")}let tmpProps;if(customElements.get(tag)&&(tmpProps=customElements.get(tag).properties),void 0===tmpProps&&(tmpProps=node.__data),void 0!==tmpProps)for(var j in tmpProps){nodeName=window.HaxStore.camelToDash(j),value=null;void 0!==node[j]&&(value=node[j]),tmpProps[j].readOnly||tmpProps[j].computed||value===tmpProps[j].value||(null==value||typeof value!=typeof Object&&value.constructor!==Array?null!=value&&"null"!=value&&(!0===value||"true"===value?propvals[nodeName]=!0:!1===value||("string"==typeof value&&""!==value?(value=value.replace(new RegExp('"',"g"),"&quot;"),propvals[nodeName]=value):""===value?""==value&&""!=tmpProps[j].value?value=tmpProps[j].value:""===value&&tmpProps[j].value:propvals[nodeName]=value)):propvals[nodeName]=JSON.stringify(value).replace(new RegExp('"',"g"),"&quot;"))}if(void 0!==props&&void 0!==props.saveOptions.unsetAttributes)for(var i in props.saveOptions.unsetAttributes)delete propvals[props.saveOptions.unsetAttributes[i]];let delProps=["inner-text","inner-html","tabindex","guestinstance"];for(var delProp in delProps)void 0!==propvals[delProps[delProp]]&&delete propvals[delProps[delProp]];for(var i in void 0!==propvals.id&&""===propvals.id&&delete propvals.id,propvals)!0===propvals[i]?content+=" "+i:content+=" "+i+'="'+propvals[i]+'"';if(["area","base","br","col","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"].includes(tag)?content+="/>":content+=">",void 0===props||!props.saveOptions.wipeSlot){let slotnodes=node.childNodes;if(slotnodes.length>0){j=0;for(var len2=slotnodes.length;j<len2;j++)void 0!==slotnodes[j].tagName?window.HaxStore.HTMLPrimativeTest(slotnodes[j].tagName)||"TEMPLATE"===slotnodes[j].tagName?(slotnodes[j].setAttribute("data-editable",!1),slotnodes[j].removeAttribute("data-hax-ray"),slotnodes[j].contentEditable=!1,content+=slotnodes[j].outerHTML):content+=window.HaxStore.nodeToContent(slotnodes[j]):8===slotnodes[j].nodeType?content+="\x3c!-- "+slotnodes[j].textContent+" --\x3e":1!==slotnodes[j].nodeType&&void 0!==slotnodes[j].textContent&&"undefined"!==slotnodes[j].textContent&&(content+=slotnodes[j].textContent)}}return"span"===tag?content+="</"+tag+">":"hr"===tag||"br"===tag||"img"===tag||(content+="</"+tag+">\n"),window.HaxStore.instance.activeHaxBody.globalPreferences.haxDeveloperMode&&console.warn(content),content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=(content=content.replace(/&nbsp;/gm," ")).replace(/ data-editable="(\s|.)*?"/gim,"")).replace(/ data-hax-ray="(\s|.)*?"/gim,"")).replace(/ class=""/gim,"")).replace(/ class="hax-active"/gim,"")).replace(/ contenteditable="(\s|.)*?"/gim,"")).replace(/<span style="(.*?)">/gim,"<span>")).replace(/<span>\s*?<\/span>/g," ")).replace(/<span><br\/><\/span>/gm,"")).replace(/<strong style="(.*?)">/gim,"<strong>")).replace(/<b style="(.*?)">/gim,"<b>")).replace(/<strike style="(.*?)">/gim,"<strike>")).replace(/<em style="(.*?)">/gim,"<em>")).replace(/<i style="(.*?)">/gim,"<i>")).replace(/<p>(\s*)<\/p>/gm,"<p></p>")).replace(/<p>&nbsp;<\/p>/gm,"<p></p>")).replace(/<p><br\/><\/p>/gm,"<p></p>")).replace(/<p><br><\/p>/gm,"<p></p>")).replace(/<\/p>(\s*)<p>/gm,"</p><p>")).split("\n\r").join("\n").split("\r").join("\n").split("\n\n").join("\n").split("\n\n").join("\n").split("\n\n").join("\n"),"function"===node.postProcesshaxNodeToContent&&(content=node.postProcesshaxNodeToContent(content)),content},window.HaxStore.HTMLPrimativeTest=node=>void 0!==node.tagName&&-1==node.tagName.indexOf("-"),window.HaxStore.getHAXSlot=node=>{if(window.HaxStore.instance.isTextElement(node))return node.innerHTML;let content="";var slotnodes=node.childNodes;if(slotnodes.length>0)for(var j=0,len2=slotnodes.length;j<len2;j++)void 0!==slotnodes[j].tagName?slotnodes[j].tagName.indexOf("-")>0?content+="  "+window.HaxStore.nodeToContent(slotnodes[j])+"\n":content+="  "+slotnodes[j].outerHTML+"\n":8===slotnodes[j].nodeType?content+="\x3c!-- "+slotnodes[j].textContent+" --\x3e":1!==slotnodes[j].nodeType&&void 0!==slotnodes[j].textContent&&"undefined"!==slotnodes[j].textContent&&(content+=slotnodes[j].textContent);return content},window.HaxStore.write=(prop,value,obj)=>{obj&&obj.dispatchEvent(new CustomEvent("hax-store-write",{composed:!0,bubbles:!0,cancelable:!1,detail:{property:prop,value:value,owner:obj}}))},window.HaxStore.guessGizmoType=guess=>{if(void 0!==guess.source)return-1!=guess.source.indexOf(".mp3")?"audio":-1!=guess.source.indexOf(".png")||-1!=guess.source.indexOf(".jpg")||-1!=guess.source.indexOf(".jpeg")||-1!=guess.source.indexOf(".gif")?"image":-1!=guess.source.indexOf(".pdf")?"pdf":-1!=guess.source.indexOf(".svg")?"svg":-1!=guess.source.indexOf(".csv")?"csv":"external"!=window.MediaBehaviors.Video.getVideoType(guess.source)?"video":"*"},window.HaxStore.guessGizmo=(guess,values,skipPropMatch=!1)=>{var matches=[];if(void 0!==guess){var store=window.HaxStore.instance;if(store.validGizmoTypes.includes(guess))for(var gizmoposition in store.gizmoList){var gizmo=store.gizmoList[gizmoposition],props={},match=!1;if(gizmo.handles)for(var i=0;i<gizmo.handles.length;i++)if(guess===gizmo.handles[i].type||"*"===guess&&!match){for(var property in gizmo.handles[i])"type"!==property&&void 0!==values[property]&&(match=!0,props[gizmo.handles[i][property]]=values[property]);(match||skipPropMatch)&&matches.push(window.HaxStore.haxElementPrototype(gizmo,props,""))}}}return matches},window.HaxStore.getHaxAppStoreTargets=type=>{return window.HaxStore.instance.appList.filter(app=>{if(void 0!==app.connection.operations.add){let add=app.connection.operations.add;if(void 0!==add.acceptsGizmoTypes&&add.acceptsGizmoTypes.includes(type))return!0}return!1})},window.HaxStore.haxElementPrototype=(gizmo,properties,content="")=>({tag:gizmo.tag,properties:properties,content:content,gizmo:gizmo}),window.HaxStore.wipeSlot=(element,slot="")=>{wipeSlot(element,slot)},window.HaxStore.encapScript=html=>encapScript(html),window.HaxStore.toast=(message,duration=4e3,classStyle="",closeText=null,eventCallback=null)=>{const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:message,duration:duration,classStyle:classStyle,closeText:closeText,eventCallback:eventCallback}});window.dispatchEvent(evt)},window.HaxStore.getSelection=()=>{if(window.HaxStore.instance.activeHaxBody.parentNode){if(window.HaxStore.instance.activeHaxBody.parentNode.getSelection)return window.HaxStore.instance.activeHaxBody.parentNode.getSelection();if(getRange(window.HaxStore.instance.activeHaxBody.parentNode))return getRange(window.HaxStore.instance.activeHaxBody.parentNode)}return window.getSelection()},window.HaxStore.getRange=()=>{let sel=window.HaxStore.getSelection();return sel.getRangeAt&&sel.rangeCount?sel.getRangeAt(0):sel||void 0};import{Undoer}from"../../../undoer/undoer.js";class UndoerElement extends HTMLElement{static get observedAttributes(){return["state"]}constructor(){super(),this.openDrawer=!1,this._root=this.attachShadow({mode:"open"}),this._selfAttributeChange=!0,window.setTimeout(()=>{this._selfAttributeChange=!1});const zero=this.getAttribute("state"),attr=this.hasAttribute("state");this._undoer=new Undoer(data=>{const{value:value,attr:attr}=data;this._updateAttribute(attr?value:null),this.dispatchEvent(new CustomEvent("state",{detail:value}))},{value:zero,attr:attr})}attributeChangedCallback(name,oldValue,newValue){"state"!==name||this._selfAttributeChange||this._internalSet(newValue,!0)}set state(value){if(!this.isConnected)throw new Error("can't push state while disconnected");const attr="string"==typeof value||"number"==typeof value;this._internalSet(value,attr)}get state(){const{value:value}=this._undoer.data;return value}_updateAttribute(value){this._selfAttributeChange=!0;try{value?this.setAttribute("state",value):this.removeAttribute("state")}finally{this._selfAttributeChange=!1}}_internalSet(value,attr){this._updateAttribute(attr?value:null),this._undoer.push({value:value,attr:attr},this._root)}}window.customElements.define("undoer-element",UndoerElement);export{HaxStore,UndoerElement};