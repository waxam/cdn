import{html,Polymer}from"../../../../@polymer/polymer/polymer-legacy.js";import{dom}from"../../../../@polymer/polymer/lib/legacy/polymer.dom.js";import*as async from"../../../../@polymer/polymer/lib/utils/async.js";import"../../../../@polymer/app-route/app-route.js";import"../../../../@polymer/iron-ajax/iron-ajax.js";import"../../../../@polymer/app-layout/app-toolbar/app-toolbar.js";import"../../../../@polymer/marked-element/marked-element.js";import"../../../../@polymer/iron-icon/iron-icon.js";import"../../../../@polymer/paper-dialog/paper-dialog.js";import"../../../../@polymer/paper-button/paper-button.js";import"../../../../@polymer/paper-badge/paper-badge.js";import"../../../../@polymer/paper-toast/paper-toast.js";import"../../../../@vaadin/vaadin-split-layout/vaadin-split-layout.js";import"../../../lrnsys-layout/lib/lrnsys-dialog.js";import"../../../lrnsys-button/lrnsys-button.js";import"../../../lrnsys-comment/lib/lrnsys-comment-list.js";import"../../../elmsln-loading/elmsln-loading.js";import"./lrnapp-studio-submission-object.js";import"./lrnapp-studio-submission-comments.js";import"./lrnapp-studio-submission-comment.js";Polymer({_template:html`
    <style>
      :host {
        display: block;
        position: relative;
      }

      p {
        font-size: 14px;
        line-height: 18px;
      }

      h1 {
        margin: 0;
        text-align: left;
      }

      iron-selector {
        line-height: 1em;
      }

      iron-selector lrnsys-button {
        display: inline-flex;
      }

      iron-image {
        margin: 0 0.5em;
      }

      lrnsys-dialog {
        display: inline;
      }

      .contain {
        width: 10em;
        height: 10em;
        background: #ddd;
      }

      .center {
        margin: auto;
        width: 100%;
      }

      .title {
        color: #222;
        font-size: 2rem;
        font-weight: 600;
        line-height: 2.5rem;
        padding: 0.25rem 0;
        white-space: nowrap;
        overflow-x: hidden;
        text-overflow: ellipsis;
        margin-top: 1rem;
        text-transform: uppercase;
        text-align: left;
      }

      .author {
        color: #555;
        font-size: 1rem;
        font-weight: 500;
        font-style: normal;
        line-height: 1rem;
        padding: 0.25rem 0 0.5rem 0;
        margin: 0;
        text-transform: capitalize;
      }

      .comments {
        text-align: right;
        margin: 0;
        font-size: 1.5em;
      }

      .submission-page-wrapper {
        padding: 0;
        --vaadin-split-layout-splitter: {
          min-width: 0.4em;
          background: var(--paper-amber-200);
        }
      }

      .submission-page {
        width: 70vw;
      }

      .submission-page-card {
        width: 100%;
        margin: 0;
        padding: 0 0 2em 1em;
      }

      .submission-comments {
        overflow-y: hidden;
        padding: 0;
        margin: 0;
      }

      elmsln-loading {
        position: absolute;
        display: none;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 10;
        align-items: flex-end;
        justify-content: center;
      }

      :host([saving]) elmsln-loading {
        display: block;
      }

      elmsln-loading {
        top: calc(50% - 5vmax);
        left: calc(50% - 5vmax);
        position: fixed;
        transform-origin: center center;
        width: 10vmax !important;
        height: 10vmax !important;
      }

      iron-pages {
        width: 100%;
      }

      paper-dialog {
        width: 50%;
        width: 50vmax;
        padding: 1em;
        z-index: 99999;
      }

      lrnapp-studio-submission-object {
        width: 100%;
      }

      .assignment-body {
        padding: 2em;
      }

      iron-icon {
        margin: 0.2em;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/edit"
      tail="{{tail}}"
      active="{{editPage}}"
    >
    </app-route>

    <iron-ajax
      id="ajaxRequest"
      auto=""
      url="[[reqUrl]]"
      method="GET"
      params="[[reqParams]]"
      content-type="application/json"
      handle-as="json"
      on-response="_handleResponse"
    ></iron-ajax>
    <!-- Update Submission Node -->
    <iron-ajax
      id="ajaxUpdateRequest"
      url="[[reqUrl]]"
      method="PUT"
      body="[[submission]]"
      params="[[reqParams]]"
      content-type="application/json"
      handle-as="json"
      on-response="_handleUpdateResponse"
    ></iron-ajax>
    <!-- Delete Submission Node -->
    <iron-ajax
      id="ajaxDeleteRequest"
      url="[[reqUrl]]"
      method="DELETE"
      params="[[reqParams]]"
      content-type="application/json"
      handle-as="json"
      on-response="_handleDeleteResponse"
    ></iron-ajax>

    <app-toolbar class="amber lighten-3" hidden\$="[[hideMenuBar]]">
      <template is="dom-if" if="[[showComments]]">
        <lrnsys-button
          on-tap="_backToStudio"
          icon="arrow-back"
          label="See in studio"
          hover-class="amber darken-4 white-text"
        ></lrnsys-button>
      </template>
      <template is="dom-if" if="[[!showComments]]">
        <lrnsys-button
          on-tap="_backToKanban"
          icon="arrow-back"
          label="Back to project management"
          hover-class="amber darken-4 white-text"
        ></lrnsys-button>
      </template>
      <div spacer="" main-title="">[[submission.attributes.title]]</div>
      <div spacer="">
        <lrnsys-dialog
          body-append=""
          header="[[submission.relationships.assignment.attributes.title]]"
        >
          <span slot="button"
            ><iron-icon icon="icons:assignment"></iron-icon>Assignment
            Details</span
          >
          <div class="assignment-body">
            <marked-element
              id="assignment-body"
              markdown="[[submission.relationships.assignment.attributes.body]]"
            ></marked-element>
          </div>
        </lrnsys-dialog>
      </div>
      <div>
        <paper-button
          id="comment-count"
          style="margin:0;padding:.25em;text-transform:none;"
        >
          <iron-icon icon="communication:forum"></iron-icon>
          [[submission.meta.comment_count]] Comments
        </paper-button>
        <paper-badge
          hidden\$="[[displayNewBadge(submission.meta.comment_new)]]"
          for="comment-count"
          label\$="[[submission.meta.comment_new]]"
        ></paper-badge>
      </div>
      <div hidden\$="[[editPage]]">
        <lrnsys-button
          on-tap="_setEditRoute"
          icon="create"
          label="Edit"
          hover-class="amber darken-4 white-text"
          hidden\$="[[!submission.meta.canUpdate]]"
        ></lrnsys-button>
      </div>
      <div hidden\$="[[!editPage]]">
        <lrnsys-button
          on-tap="_resetRoute"
          icon="cancel"
          label="Cancel"
          hover-class="amber darken-4 white-text"
          hidden\$="[[!submission.meta.canUpdate]]"
        ></lrnsys-button>
      </div>
    </app-toolbar>

    <vaadin-split-layout class="submission-page-wrapper">
      <div
        id="commentcolumn"
        class="submission-comments"
        style="min-width: 25%; max-width: 40%; width:30%;"
      >
        <template is="dom-if" if="[[showComments]]">
          <lrnsys-comment-list
            comment-ops-base="{{commentOpsBase}}"
            csrf-token="[[csrfToken]]"
            source-path="{{commentsUrl}}"
            create-stub-url="{{createStubUrl}}"
          ></lrnsys-comment-list>
        </template>
      </div>
      <div id="submissioncolumn" style="width:70%;">
        <lrnapp-studio-submission-object
          submission="{{submission}}"
          edit="[[editPage]]"
        ></lrnapp-studio-submission-object>
      </div>
      <iron-icon class="splitter-handle" icon="more-vert"></iron-icon>
    </vaadin-split-layout>

    <elmsln-loading></elmsln-loading>

    <paper-dialog
      id="deletedialog"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation"
      with-backdrop=""
    >
      <h2>Delete submission?</h2>
      <p>Are you sure you want to delete this submission?</p>
      <div class="buttons">
        <paper-button dialog-dismiss="">Cancel</paper-button>
        <paper-button dialog-confirm="" on-click="_submissionDeleteConfirmed"
          >Delete</paper-button
        >
      </div>
    </paper-dialog>
    <paper-dialog
      id="publishdialog"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation"
      with-backdrop=""
    >
      <h2>Ready to publish?</h2>
      <p>
        By publishing, the author of this submission will be able to view your
        feedback. Are you ready to publish?
      </p>
      <div class="buttons">
        <paper-button dialog-dismiss="">Cancel</paper-button>
        <paper-button dialog-confirm="" on-click="_submissionPublishConfirmed"
          >Yes Publish</paper-button
        >
      </div>
    </paper-dialog>

    <paper-toast id="toast"></paper-toast>
  `,is:"lrnapp-studio-submission-page",properties:{id:{type:String},hideMenuBar:{type:Boolean,value:!1},endPoint:{type:String},basePath:{type:String},csrfToken:{type:String},reqUrl:{type:String},reqParams:{type:Object},submission:{type:Object},commentsUrl:{type:String,computed:"_computeCommentsUrl(id, endPoint, csrfToken)"},createStubUrl:{type:String,computed:"_computeCommentsStubUrl(id, endPoint, csrfToken)"},commentOpsBase:{type:String,computed:"_computeCommentsOpsUrl(id, endPoint, csrfToken)"},editPage:{type:Boolean,reflectToAttribute:!0},saving:{type:Boolean,value:!1,notify:!0,reflectToAttribute:!0},showComments:{type:Boolean,computed:"_computeShowComments(submission)"}},observers:["_urlVarsChanged(id, endPoint)","_paramsChanged(csrfToken)","_bodyChanged(title)"],listeners:{submissionDeleteClicked:"_submissionDeleteClicked",submissionPublishClicked:"_submissionPublishClicked",submissionSaveDraftClicked:"_submissionSaveDraftClicked"},_backToStudio:function(){window.location.href=this.basePath+"lrnapp-open-studio"},_backToKanban:function(){window.location.href=this.basePath+"lrnapp-studio-kanban"},_setEditRoute:function(){this.set("route.path","edit");this.notifyPath("route.path")},_resetRoute:function(){this.set("route.path","");this.notifyPath("route.path")},displayNewBadge:function(count){if(0==count){return!0}return!1},_computeCommentsUrl:function(id,endPoint,csrfToken){return endPoint+"/api/submissions/"+id+"/comments?token="+csrfToken},_computeCommentsOpsUrl:function(id,endPoint){return endPoint+"/api/submissions/"+id+"/comments"},_computeCommentsStubUrl:function(id,endPoint,csrfToken){return endPoint+"/api/submissions/"+id+"/comments/create-stub?token="+csrfToken},_urlVarsChanged:function(id,endPoint){this.reqUrl=endPoint+"/api/submissions/"+id},_paramsChanged:function(csrfToken){var params=this.reqParams||{};params.token=csrfToken;this.reqParams=params},_handleResponse:function(data){if(data.detail.response.data){this.set("submission",[]);this.set("submission",data.detail.response.data);async.microTask.run(()=>{window.dispatchEvent(new Event("resize"))})}},_isReply:function(){this.thread=submission.relationships.comments.data.attributes.thread},_submissionSaveDraftClicked:function(){this.saving=!0;this.shadowRoot.querySelector("#ajaxUpdateRequest").generateRequest()},_submissionPublishClicked:function(){this.shadowRoot.querySelector("#publishdialog").open()},_submissionPublishConfirmed:function(){this.saving=!0;this.shadowRoot.querySelector("#ajaxUpdateRequest").generateRequest()},_submissionDeleteClicked:function(){this.shadowRoot.querySelector("#deletedialog").open()},_submissionDeleteConfirmed:function(){this.saving=!0;this.$.ajaxDeleteRequest.generateRequest()},_handleUpdateResponse:function(res){var root=this,status=res.detail.response.status,submission=res.detail.response.data;root.saving=!1;if(200===status){root.set("submission",{});root.set("submission",submission);root.set("route.path","");if("submission_ready"===submission.attributes.state){this.$.toast.show("Published!")}window.location.href=this.endPoint+"/submissions/"+submission.id}},_handleDeleteResponse:function(res){var root=this,status=res.detail.response.status;root.saving=!1;if(200===status){window.location.href=this.basePath+"lrnapp-studio-kanban?deletetoast"}},_computeShowComments:function(submission){try{var type=submission.meta.submissionType;if("critique"!==type&&"submission_ready"==submission.attributes.state){return!0}}catch(error){}return!1},_toArray:function(obj){if("object"===typeof obj&&null!==obj){return Object.keys(obj).map(function(key){return obj[key]})}return[]}});