import{html as e,PolymerElement as r}from"../../../../@polymer/polymer/polymer-element.js";import{afterNextRender as s}from"../../../../@polymer/polymer/lib/utils/render-status.js";import{dom as i}from"../../../../@polymer/polymer/lib/legacy/polymer.dom.js";import"../../../../@polymer/iron-ajax/iron-ajax.js";import"../../../../@polymer/paper-item/paper-item.js";import"../../../../@polymer/polymer/lib/elements/dom-if.js";import"../../../simple-modal/lib/simple-modal-template.js";import"../../../../@polymer/paper-listbox/paper-listbox.js";import"../../../../@polymer/polymer/lib/elements/dom-repeat.js";import"../../../../@polymer/paper-dropdown-menu/paper-dropdown-menu.js";import"../elmsln-base-deps.js";import"../../../../@polymer/app-layout/app-toolbar/app-toolbar.js";import"../../../../@polymer/iron-list/iron-list.js";import"../../../../@polymer/iron-pages/iron-pages.js";import"../../../../@polymer/paper-dialog/paper-dialog.js";import"../../../../@polymer/app-route/app-location.js";import"../../../../@polymer/app-route/app-route.js";import"../../../../@polymer/paper-button/paper-button.js";import"../../../../@polymer/paper-toast/paper-toast.js";import"../../../elmsln-loading/elmsln-loading.js";import"../../../lrndesign-course-banner/lrndesign-course-banner.js";import"../../../lrn-icon/lrn-icon.js";import"../../../lrnsys-button/lrnsys-button.js";import"../../../lrndesign-avatar/lrndesign-avatar.js";import"../../../lrnsys-layout/lib/lrnsys-dialog.js";import"../../../responsive-grid/lib/responsive-grid-col.js";import"../../../responsive-grid/lib/responsive-grid-row.js";import"../../../materializecss-styles/materializecss-styles.js";import"./lrnapp-cis-course-card.js";class LrnappCis extends r{static get template(){return e`
      <style include="materializecss-styles">
        :host {
          display: block;
          align-content: center;
        }
        #loading {
          width: 100%;
          z-index: 1000;
          opacity: 0.9;
          padding: 4em 0 0 0;
          text-align: center;
          align-content: center;
          justify-content: center;
          height: 100vh;
          position: absolute;
          background-color: white;
        }
        #dialog {
          width: 80vw;
        }
        iron-selector {
          line-height: 1em;
        }
        iron-selector lrnsys-button {
          display: inline-flex;
        }
        paper-button.coursecard-wrapper {
          margin: 0;
          padding: 0;
        }
        paper-button.coursecard-wrapper:focus {
          outline: blue solid 1px;
        }
        lrnapp-cis-course-card {
          padding: 0;
          margin: 1em;
          height: 15em;
          width: 14em;
        }
        .courses-grid {
          margin: 0 auto;
          width: 95%;
        }
        .iron-selected .display-mode {
          background-color: #ff6f00;
          color: white;
        }
        .iron-list-container {
          display: flex;
          flex-direction: column;
          min-height: 50vh;
        }
        iron-list {
          flex: 1 1 auto;
        }
        .dialog-header {
          height: unset !important;
          padding: 0 !important;
        }
        .course-dialog-heading.lrndesign-course-banner {
          font-size: 1em;
          height: 4em !important;
        }
        #coursedetails {
          margin-top: 1em;
        }
        #confirm {
          max-width: 400px;
          max-height: 300px;
        }
        .buttons {
          text-align: center;
        }
        .buttons paper-button {
          width: 10em;
          height: 4em;
        }
        .dialog-body {
          padding: 1em;
          font-size: 1.8em;
          text-align: center;
          margin: 0 auto;
        }
        .dialog-body lrn-icon.service-confirm-icon {
          width: 5em;
          height: 5em;
        }
        .dialog-body responsive-grid-col {
          height: 4.5em;
        }
        .dialog-body lrndesign-avatar.service-confirm-icon {
          display: inline-block;
        }
      </style>
      <iron-ajax
        auto=""
        url="[[sourcePath]]"
        params=""
        handle-as="json"
        last-response="{{_cisResponse}}"
        on-response="_handleResponse"
      ></iron-ajax>
      <iron-ajax
        url="[[courseDataPath]]"
        params="[[_courseDataParams]]"
        handle-as="json"
        id="courserequest"
        last-response="{{_courseResponse}}"
        on-response="_handleCourseResponse"
      ></iron-ajax>
      <iron-ajax
        url="[[makeServicePath]]"
        params=""
        handle-as="json"
        id="makeservice"
        last-response="{{_makeServiceResponse}}"
        on-response="_handleMakeServiceResponse"
      ></iron-ajax>
      <div id="loading">
        <elmsln-loading color="grey-text" size="large"></elmsln-loading>
        <h3>Loading..</h3>
      </div>
      <app-toolbar class="">
        <span main-title=""></span>
        <span
          top-item=""
          style="text-align:right;font-size:.5em;padding-right:1em;"
          >Displaying [[courses.length]] of [[originalCourses.length]]</span
        >
        <paper-dropdown-menu label="Course" hidden\$="[[!courses]]">
          <paper-listbox
            slot="dropdown-content"
            class="dropdown-content"
            selected="{{queryParams.course}}"
            attr-for-selected="item-id"
          >
            <paper-item>-- Any --</paper-item>
            <template
              is="dom-repeat"
              items="[[_toArray(originalCourses)]]"
              as="course"
            >
              <paper-item item-id="[[course.id]]"
                >[[course.attributes.name]]</paper-item
              >
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-dropdown-menu label="Program" hidden\$="[[!programs]]">
          <paper-listbox
            slot="dropdown-content"
            class="dropdown-content"
            selected="{{queryParams.program}}"
            attr-for-selected="item-id"
          >
            <paper-item>-- Any --</paper-item>
            <template
              is="dom-repeat"
              items="[[_toArray(programs)]]"
              as="program"
            >
              <paper-item item-id="[[program.id]]"
                >[[program.attributes.name]]</paper-item
              >
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-dropdown-menu label="Academic home" hidden\$="[[!academics]]">
          <paper-listbox
            slot="dropdown-content"
            class="dropdown-content"
            selected="{{queryParams.academic}}"
            attr-for-selected="item-id"
          >
            <paper-item>-- Any --</paper-item>
            <template
              is="dom-repeat"
              items="[[_toArray(academics)]]"
              as="academic"
            >
              <paper-item item-id="[[academic.id]]"
                >[[academic.attributes.name]]</paper-item
              >
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </app-toolbar>
      <div class="courses-grid">
        <iron-pages
          selected="{{data.page}}"
          attr-for-selected="name"
          fallback-selection="courses"
          role="main"
        >
          <div class="iron-list-container" name="courses">
            <iron-list id="ironlist" items="[[courses]]" as="course" grid="">
              <template>
                <paper-button
                  data-course-id\$="[[course.id]]"
                  class="coursecard-wrapper"
                  on-click="_loadCourseUrl"
                >
                  <lrnapp-cis-course-card
                    elevation="2"
                    data-course-id\$="[[course.id]]"
                    name="[[course.attributes.name]]"
                    image="[[course.attributes.image]]"
                    title="[[course.attributes.title]]"
                    color="[[course.attributes.color]]"
                  >
                  </lrnapp-cis-course-card>
                </paper-button>
              </template>
            </iron-list>
          </div>
        </iron-pages>
      </div>
      <app-location
        route="{{route}}"
        query-params="{{queryParams}}"
      ></app-location>
      <app-route
        route="{{route}}"
        pattern="[[endPoint]]/:page"
        data="{{data}}"
        tail="{{tail}}"
        query-params="{{queryParams}}"
      >
      </app-route>
      <paper-dialog id="dialog" with-backdrop>
        <h2>Course details</h2>
        <paper-dialog-scrollable>
          <div class="dialog-header">
            <lrndesign-course-banner
              image="[[activeCourse.attributes.image]]"
              name="[[activeCourse.attributes.name]]"
              title="[[activeCourse.attributes.title]]"
              color="[[activeCourse.attributes.color]] darken-4"
            >
            </lrndesign-course-banner>
          </div>
          <div>
            <div id="loadingCourse" class="loading">
              <h3>Loading..</h3>
              <elmsln-loading color="grey-text" size="large"></elmsln-loading>
            </div>
          </div>
          <div id="coursedetails">
            <responsive-grid-row gutter="5">
              <responsive-grid-col xl="6" lg="6" md="6" sm="12" xs="12">
                <div class="column">
                  <h4>Details</h4>
                  <ul>
                    <li
                      hidden\$="[[!activeCourse.relationships.academic.attributes.name]]"
                    >
                      Academic unit:
                      [[activeCourse.relationships.academic.attributes.name]]
                    </li>
                    <li
                      hidden\$="[[!activeCourse.relationships.program.attributes.name]]"
                    >
                      Program:
                      [[activeCourse.relationships.program.attributes.name]]
                    </li>
                  </ul>
                  <h4>Learning Network</h4>
                  <template
                    is="dom-repeat"
                    items="[[activeCourse.topology.Network]]"
                    as="service"
                  >
                    <template is="dom-if" if="[[!service._exists]]">
                      <lrnsys-button
                        raised=""
                        on-click="_makeService"
                        color="grey lighten-4"
                        icon-class="grey lighten-5"
                        data-machine-name\$="[[service.machine_name]]"
                      >
                        <lrn-icon
                          data-machine-name\$="[[service.machine_name]]"
                          icon="[[service.icon]]"
                          class="elmsln-hover-icon"
                        ></lrn-icon>
                        <span data-machine-name\$="[[service.machine_name]]"
                          >Make the [[service.title]] service</span
                        >
                      </lrnsys-button>
                    </template>
                    <template is="dom-if" if="[[service._exists]]">
                      <lrnsys-button
                        raised=""
                        href="[[service.url]]"
                        hover-class="[[service.color]] lighten-4"
                      >
                        <lrn-icon
                          icon="[[service.icon]]"
                          class="elmsln-hover-icon"
                        ></lrn-icon>
                        <span>[[service.title]]</span>
                      </lrnsys-button>
                    </template>
                  </template>
                </div>
              </responsive-grid-col>
              <responsive-grid-col xl="6" lg="6" md="6" sm="12" xs="12">
                <div class="column">
                  <h4>Operations</h4>
                  <template is="dom-if" if="[[activeCourse.meta.canUpdate]]">
                    <lrnsys-button
                      raised=""
                      href="[[activeCourse.uris.edit]]"
                      label="Edit"
                      hover-class="green lighten-4"
                      icon="create"
                    ></lrnsys-button>
                    <lrnsys-button
                      raised=""
                      href="[[activeCourse.uris.addOffering]]"
                      label="Add offering"
                      hover-class="amber lighten-3"
                      icon="icons:add"
                    ></lrnsys-button>
                  </template>
                  <lrnsys-button
                    raised=""
                    href="[[activeCourse.uris.offerings]]"
                    label="Offerings"
                    hover-class="amber lighten-4"
                    icon="social:people"
                  ></lrnsys-button>
                  <lrnsys-button
                    raised=""
                    href="[[activeCourse.uris.sync]]"
                    label="Sync Roster"
                    hover-class="amber lighten-4"
                    icon="notification:sync"
                  ></lrnsys-button>
                  <lrnsys-button
                    raised=""
                    href="[[activeCourse.uris.uri]]"
                    label="Course page (legacy)"
                    hover-class="brown lighten-4"
                    icon="delete"
                  ></lrnsys-button>
                  <template is="dom-if" if="[[activeCourse.meta.canDelete]]">
                    <div
                      style="padding: 1em;width: 100%;margin: .5em 0;display: block;background-color:#FF2222;color:#ffffff;border: 1px solid #222222;"
                    >
                      <h4>Danger zone</h4>
                      <lrnsys-button
                        raised=""
                        href="[[activeCourse.uris.delete]]"
                        label="Delete"
                        hover-class="red lighten-1"
                        color="red lighten-3"
                        icon="delete"
                      ></lrnsys-button>
                    </div>
                  </template>
                </div>
              </responsive-grid-col>
            </responsive-grid-row>
            <p>[[activeCourse.attributes.body]]</p>
          </div>
        </paper-dialog-scrollable>
      </paper-dialog>
      <lrnsys-dialog id="confirm">
        <div class="dialog-header" slot="header">
          Add this to the
          <strong>[[activeCourse.attributes.title]]</strong> network?
        </div>
        <div class="dialog-body">
          <responsive-grid-row gutter="5">
            <responsive-grid-col
              xl="3"
              lg="3"
              md="3"
              sm="3"
              xs="3"
            ></responsive-grid-col>
            <responsive-grid-col xl="1" lg="1" md="1" sm="1" xs="1"
              >Add</responsive-grid-col
            >
            <responsive-grid-col xl="2" lg="2" md="2" sm="2" xs="2"
              ><lrn-icon
                icon="[[_activeService.icon]]"
                class\$="[[_activeService.color]]-text elmsln-hover-icon service-confirm-icon"
              ></lrn-icon
            ></responsive-grid-col>
            <responsive-grid-col xl="3" lg="3" md="3" sm="3" xs="3"
              ><strong>[[_activeService.title]]</strong></responsive-grid-col
            >
            <responsive-grid-col
              xl="3"
              lg="3"
              md="3"
              sm="3"
              xs="3"
            ></responsive-grid-col>
          </responsive-grid-row>
          <responsive-grid-row gutter="5">
            <responsive-grid-col
              xl="3"
              lg="3"
              md="3"
              sm="3"
              xs="3"
            ></responsive-grid-col>
            <responsive-grid-col xl="1" lg="1" md="1" sm="1" xs="1"
              >To</responsive-grid-col
            >
            <responsive-grid-col xl="2" lg="2" md="2" sm="2" xs="2"
              ><lrndesign-avatar
                class="service-confirm-icon"
                label="[[activeCourse.attributes.name]]"
                jdenticon=""
                color="[[activeCourse.attributes.color]] darken-4"
              >
              </lrndesign-avatar
            ></responsive-grid-col>
            <responsive-grid-col xl="3" lg="3" md="3" sm="3" xs="3"
              ><strong
                >[[activeCourse.attributes.title]]</strong
              ></responsive-grid-col
            >
            <responsive-grid-col
              xl="3"
              lg="3"
              md="3"
              sm="3"
              xs="3"
            ></responsive-grid-col>
          </responsive-grid-row>
          <div style="margin-top:1em;">This will take a few moments.</div>
        </div>
        <div class="buttons">
          <paper-button
            raised=""
            dialog-confirm=""
            autofocus=""
            on-click="_confirmBuild"
            class="green"
            >Let's do it!</paper-button
          >
          <paper-button dialog-dismiss="" class="red-text"
            >Oops, go back.</paper-button
          >
        </div>
      </lrnsys-dialog>
      <paper-toast id="toast"></paper-toast>
    `}static get tag(){return"lrnapp-cis"}static get properties(){return{elmslnCourse:{type:String},elmslnSection:{type:String},basePath:{type:String},csrfToken:{type:String},endPoint:{type:String},_cisResponse:{type:Object},_courseResponse:{type:Object},_makeServiceResponse:{type:Object},courses:{type:Array,value:[],computed:"_coursesCompute(originalCourses, queryParams)"},originalCourses:{type:Array,value:[],notify:!0},programs:{type:Array,value:[]},academics:{type:Array,value:[]},sourcePath:{type:String},courseDataPath:{type:String},makeServicePath:{type:String},endPoint:{type:String,value:"/"},basePath:{type:String,value:"/"},activeCourse:{type:Array,value:null},queryParams:{type:Object,notify:!0}}}static get observers(){return["_routeChanged(route, endPoint)"]}_routeChanged(e,r){if("string"==typeof e.path){if("string"==typeof r&&(e.path.startsWith(r)||"/"==e.path))return;this.$.loading.hidden=!1,window.location.reload()}}_routeChange(e){var r=e.detail;void 0!==r.queryParams.course&&this.set("queryParams.course",r.queryParams.course),void 0!==r.queryParams.academic&&this.set("queryParams.academic",r.queryParams.academic),void 0!==r.queryParams.program&&this.set("queryParams.program",r.queryParams.program),void 0!==r.data.page&&this.set("data.page",r.data.page)}_toArray(e){return null==e?[]:Object.keys(e).map((function(r){return e[r]}))}_handleMakeServiceResponse(e){var r=this._makeServiceResponse;let s=this.__addServiceLinks(r.data.course);this.set("activeCourse",[]),this.set("activeCourse",s),this.$.toast.show(r.message)}_handleCourseResponse(e){var r=this._courseResponse.data.course;this.__addServiceLinks(r),this.set("activeCourse",[]),this.set("activeCourse",r),this.$.loadingCourse.hidden=!0}__addServiceLinks(e){for(var r in void 0===e.topology.Network&&(e.topology.Network={}),this.services)void 0===e.topology.Network[this.services[r].attributes.machine_name]&&(e.topology.Network[this.services[r].attributes.machine_name]={color:this.services[r].attributes.color,distro:this.services[r].attributes.distro,icon:this.services[r].attributes.icon,machine_name:this.services[r].attributes.machine_name,title:this.services[r].attributes.title,url:this.services[r].attributes.url,weight:this.services[r].attributes.weight,_exists:!1});return e.topology.Network=this._toArray(e.topology.Network),e.topology.Network.sort((function(e,r){return e.weight-r.weight})),e}_handleResponse(e){var r={},s={},i={},t={courses:[],programs:[],academics:[]},o=[],a=[],n=this._toArray(this._cisResponse.data.courses);this.set("services",this._toArray(this._cisResponse.data.services)),this.set("originalCourses",n);for(var l=0;l<n.length;l++)r=n[l],s=n[l].relationships.program,i=n[l].relationships.academic,t.programs[s.id]=s,t.academics[i.id]=i,t.courses[r.id]=r;t.programs.forEach((function(e){o.push(e)})),t.academics.forEach((function(e){a.push(e)})),this.$.loading.hidden=!0,this.set("academics",a),this.set("programs",o)}_makeService(e){let r=i(e).localTarget.getAttribute("data-machine-name");let s=this.activeCourse.topology.Network.filter(e=>e.machine_name===r);s.length>0?(s=s.pop(),this.$.makeservice.params={course:this.activeCourse.attributes.machine_name,service:s.machine_name},this._activeService=s,this.$.confirm.toggleDialog()):console.log("that was not a valid service..")}_confirmBuild(e){this.$.makeservice.generateRequest()}connectedCallback(){super.connectedCallback(),s(this,(function(){this.addEventListener("route-change",this._routeChange.bind(this))}))}disconnectedCallback(){this.removeEventListener("route-change",this._routeChange.bind(this)),super.disconnectedCallback()}_loadCourseUrl(e){this.$.loadingCourse.hidden=!1;var r=i(e).localTarget.getAttribute("data-course-id");let s=this.originalCourses.filter(e=>e.id===r);s.length>0&&(s=s.pop()),this.activeCourse=s,this._courseDataParams={id:this.activeCourse.id},this.$.courserequest.generateRequest(),this.$.dialog.toggle()}_coursesCompute(e,r){if(void 0===e)return[];const s=this;let i=[];return i=e.filter(e=>(void 0===s.queryParams.course||e.id===s.queryParams.course)&&((void 0===s.queryParams.program||e.relationships.program.id===s.queryParams.program)&&(void 0===s.queryParams.academic||e.relationships.academic.id===s.queryParams.academic))),setTimeout(()=>{this.$.ironlist.fire("iron-resize")},200),i}_attachDom(e){this.appendChild(e)}}window.customElements.define(LrnappCis.tag,LrnappCis);export{LrnappCis};