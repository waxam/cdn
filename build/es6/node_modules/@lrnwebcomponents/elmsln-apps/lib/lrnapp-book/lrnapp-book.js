import{html,Polymer}from"../../../../@polymer/polymer/polymer-legacy.js";import{dom}from"../../../../@polymer/polymer/lib/legacy/polymer.dom.js";import"../../../../@polymer/iron-icons/iron-icons.js";import"../../../../@polymer/iron-icons/hardware-icons.js";import"../../../../@polymer/paper-icon-button/paper-icon-button.js";import"../../../../@polymer/paper-styles/color.js";import"../../../paper-search/lib/paper-search-bar.js";import"../../../../@polymer/paper-tooltip/paper-tooltip.js";import"../../../../@polymer/paper-slider/paper-slider.js";import"../../../simple-toast/simple-toast.js";import"../../../../@polymer/app-layout/app-layout.js";import"../../../../@polymer/app-layout/app-drawer/app-drawer.js";import"../../../../@polymer/app-layout/app-header/app-header.js";import"../../../../@polymer/app-layout/app-toolbar/app-toolbar.js";import"../../../../@polymer/app-layout/app-scroll-effects/app-scroll-effects.js";import"../../../materializecss-styles/materializecss-styles.js";import"../../../lrndesign-stepper/lrndesign-stepper.js";import"../../../lrnsys-progress/lrnsys-progress.js";import"../../../elmsln-loading/elmsln-loading.js";import"../../../page-scroll-position/page-scroll-position.js";import"../../../material-progress/material-progress.js";import"../../../map-menu/map-menu.js";import"./lrnapp-book-progress-dashboard.js";Polymer({_template:html`
    <custom-style>
      <style is="custom-style" include="materializecss-styles">
        :host {
          display: block;
          font-size: 16px;
          box-sizing: content-box;
        }
        #toolbar {
          color: gray;
          background-color: white;
          padding: 0 8px;
          margin: 0;
          height: auto;
          box-sizing: content-box;
          transition: all 0.4s ease;
        }
        paper-button {
          padding: 0;
          margin: 0;
          min-width: 16px;
        }
        app-drawer {
          padding: 0;
          top: 0;
          bottom: 0;
          z-index: 1;
          position: absolute;
          box-sizing: content-box;
          --app-drawer-content-container: {
            background-color: #fafafa;
            padding: 0;
            border-right: 1px solid #c8c8c8;
            overflow-y: scroll;
            width: 300px !important;
            box-shadow: 0 76px 8px 0 rgba(0, 0, 0, 0.4);
            height: 100vh;
            top: 0;
            position: sticky;
          }
        }
        lrndesign-stepper-button {
          --lrndesign-stepper-btn-active: #f6f7f7;
        }
        lrndesign-stepper-button ::slotted(paper-button) {
          margin: 0;
          height: 48px;
        }
        lrndesign-stepper-button ::slotted(.title-container) {
          padding: 0;
          width: 100%;
          right: unset;
        }
        lrndesign-stepper-button ::slotted(.node-title) {
          font-size: 15px;
          line-height: 24px;
        }

        .loading {
          width: 100%;
          z-index: 1000;
          opacity: 0.9;
          text-align: center;
          align-content: space-around;
          justify-content: center;
          position: absolute;
          background-color: white;
          padding: 0;
          margin: 0;
          display: flex;
          margin: 0 auto;
          visibility: visible;
          transition: visibility 1s, opacity 1s ease;
        }
        .loading elmsln-loading {
          margin: 0 5em;
          display: inline-flex;
        }
        #bodyloading {
          height: 100%;
          display: flex;
          justify-content: center;
        }
        #bodyloading .loading,
        #bodyloading elmsln-loading {
          display: block;
          height: 5em;
        }
        .outline-title {
          margin-left: 0.5em;
          max-width: 50%;
        }
        .content-nav-buttons {
          top: 60%;
          position: fixed;
          opacity: 0.8;
          padding: 0 0.25em;
          height: 40%;
          padding-top: 15%;
          margin-top: -15%;
        }
        .content-nav-buttons:hover {
          opacity: 1;
        }
        .prev {
          left: 0;
          order: 1;
        }
        .next {
          right: 0;
          transition: right 0.2s ease;
          order: 2;
        }
        app-header {
          width: 100%;
          left: 0 !important;
          z-index: 2 !important;
          position: sticky !important;
        }
        app-header-layout {
          margin: 0;
          padding: 0;
          width: 100%;
        }
        .content-body {
          position: relative;
          padding: 0;
          margin: -3em 4em 5em 4em;
          font-size: 1.1em;
          transition: margin 0.4s ease, width 0.4s ease;
        }

        .content-nav-buttons paper-icon-button {
          width: 4em;
          height: 4em;
          opacity: 0.4;
          display: block;
          visibility: visible;
          transition: opacity 0.4s linear, visibility 1s linear,
            height 0.4s ease, width 0.4s ease;
        }
        .content-nav-buttons paper-icon-button:hover {
          opacity: 1;
        }
        paper-tooltip {
          --paper-tooltip-opacity: 0.96;
        }
        :host([drawer-opened]) .content-nav-buttons paper-icon-button {
          width: 2.5em;
          height: 2.5em;
        }
        :host([edit-mode]) .content-nav-buttons {
          opacity: 0;
          pointer-events: none;
          visibility: hidden;
        }
        .content-title {
          font-size: 1.4em;
          margin: 0;
          padding: 0.25em 0;
          background-color: white;
          top: 70px;
          position: sticky;
        }
        .content-current {
          min-height: 100vh;
        }
        .content-next {
          background-color: grey;
          opacity: 0.8;
        }
        #header {
          position: sticky;
          top: 0;
          left: 0;
          width: 100%;
          color: black;
          background-color: white;
          z-index: 2;
          padding: 0;
          margin: 0;
          opacity: 1;
          box-sizing: content-box;
          transition: all 0.4s ease;
        }
        app-drawer-layout {
          font-family: sans-serif;
        }
        :host {
          --app-drawer-width: 300px;
        }
        :host([full-width]) {
          --app-drawer-width: 0px;
        }
        :host([drawer-opened]) .prev,
        :host([edit-mode]) .prev {
          left: 19em;
        }
        .progress-container {
          width: 90%;
          padding: 0;
          margin: 0 0 0 1em;
          overflow: visible;
        }

        [main-title] {
          font-weight: lighter;
          padding: 0.6em 0 0 0;
          margin: 0;
          height: 3em;
          overflow-y: scroll;
        }
        [hidden] {
          visibility: hidden !important;
          opacity: 0 !important;
          display: block !important;
        }
        paper-search-bar[hidden] {
          display: none !important;
        }
        lrnsys-progress {
          margin-top: 0.5em;
          padding: 0.2em 0 0 0;
          box-sizing: content-box;
        }
        lrnsys-progress lrnsys-progress-circle {
          list-style-type: none;
          box-sizing: content-box;
        }

        #bookdrawercontent {
          overflow: scroll;
          visibility: visible;
          display: block;
          opacity: 1;
          transition: visibility 1s linear, opacity 1s linear;
        }
        @media (max-width: 1200px) {
          :host .content-body {
            font-size: 0.94em;
          }
        }
        @media (max-width: 960px) {
          :host .content-body {
            font-size: 0.92em;
          }
        }
        @media (max-width: 820px) {
          :host .content-body {
            font-size: 0.9em;
          }
        }
        @media (max-width: 700px) {
          :host .content-body {
            font-size: 0.9em;
          }
        }
        @media (max-width: 639px) {
          app-drawer-layout {
            top: 0;
          }
          [main-title] {
            font-size: 0.8em;
          }
          .content-title {
            font-size: 1.1em;
          }
          .outline-title {
            position: absolute !important;
            clip: rect(1px 1px 1px 1px); /* IE6, IE7 */
            clip: rect(1px, 1px, 1px, 1px);
            overflow: hidden;
            height: 1px;
          }
          :host .content-body {
            margin: 0 0.5em;
            font-size: 0.9em;
            width: 85%;
          }
          .content-nav-buttons {
            position: relative;
            display: flex;
            top: unset;
            padding: 0;
            opacity: 0.8;
            height: unset;
            margin: 0;
          }
          .content-nav {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            vertical-align: middle;
          }
          .next {
            right: unset;
          }
        }
        @media (max-width: 500px) {
          [main-title] {
            font-size: 0.7em;
          }
        }

        :host([edit-mode]) #header {
          background-color: var(--paper-grey-500);
        }
        :host([edit-mode]) #toolbar {
          opacity: 0.5;
        }
        .your-progress-button {
          padding-right: 1em;
        }
        #mapmenu {
          padding: 1em 0;
          overflow-x: hidden;
        }
        .course-title-drawer {
          font-size: 1.2em;
        }
        /**
         * Hide the slotted content during edit mode. This must be here to work.
         */
        :host([edit-mode]) #slot {
          display: none;
        }
      </style>
    </custom-style>
    <page-scroll-position value="{{scrollPosition}}"></page-scroll-position>
    <div id="anchor"></div>
    <!-- body where most of the heavy lifting happens -->
    <app-drawer-layout>
      <!-- LRNApp book we expect to navigate -->
      <app-drawer
        slot="drawer"
        id="bookdrawer"
        opened="{{drawerOpened}}"
        swipe-open=""
        transition-duration="300"
      >
        <div
          id="bookdrawercontent"
          style="height: 100%; overflow: auto;"
          hidden\$="[[!bookItems]]"
        >
          <paper-search-bar
            hide-filter-button=""
            hidden\$="[[!showSearch]]"
          ></paper-search-bar>
          <map-menu id="mapmenu" manifest="[[_routerManifest]]">
            <!-- Server response will populate this -->
          </map-menu>
        </div>
      </app-drawer>
      <app-header-layout>
        <app-header slot="header" id="header" shadow="" fixed="">
          <div id="outlineloading" class="loading">
            <elmsln-loading color="grey-text" size="medium"></elmsln-loading>
            <elmsln-loading color="grey-text" size="medium"></elmsln-loading>
            <elmsln-loading color="grey-text" size="medium"></elmsln-loading>
          </div>
          <app-toolbar id="toolbar" sticky="" class="tall">
            <div style="pointer-events: auto;" class="menu-btn-wrap">
              <paper-icon-button
                style="pointer-events: auto;"
                title="Content outline"
                id="menubutton"
                icon="menu"
                on-tap="toggleBook"
              ></paper-icon-button>
            </div>
            <div spacer="" class="outline-title">[[outlineTitle]]</div>
            <div spacer="" main-title="" style="pointer-events: auto;">
              <div class="progress-container">
                <lrnsys-progress
                  sound-finish="[[soundFinish]]"
                  sound="[[sound]]"
                  complete-sound="[[completeSound]]"
                  finished-sound="[[finishedSound]]"
                  title="The steps to complete this lesson"
                  id="progress"
                  active="{{activePage}}"
                  manifest="{{manifest}}"
                  progressive-unlock=""
                  size="small"
                ></lrnsys-progress>
              </div>
            </div>
            <!--
              <div class="your-progress-button">
                <lrnsys-dialog body-append modal on-tap="progressdashboardopen" header="Your progress" alt="Your progress">
                  <span slot="button"><iron-icon icon="av:equalizer"></iron-icon></span>
                  <div>
                    <lrnapp-book-progress-dashboard id="progressdashboard" source-path="[[progressDashboardPath]]" route-data="[[data]]"></lrnapp-book-progress-dashboard>
                  </div>
                </lrnsys-dialog>
              </div>
            -->
          </app-toolbar>
        </app-header>
        <div class="content-body">
          <div id="current" class="content-current">
            <h2 id="currenttitle" class="content-title">[[currentTitle]]</h2>
            <div id="bodyloading" class="loading">
              <elmsln-loading color="grey-text" size="large"></elmsln-loading>
              <h3 class="loading-text">Loading content..</h3>
            </div>
            <div id="contentcontainer">
              <div id="slot"><slot></slot></div>
            </div>
          </div>
        </div>
        <div class="content-nav">
          <div class="content-nav-buttons next">
            <paper-icon-button
              id="next"
              title="[[nextLabel]]"
              on-tap="_nextBtn"
              icon="hardware:keyboard-arrow-right"
              data-voicecommand="next page"
              hidden\$="[[!hasNextPage]]"
            ></paper-icon-button>
            <paper-tooltip
              for="next"
              position="left"
              offset="0"
              animation-delay="100"
            >
              [[nextLabel]]
            </paper-tooltip>
          </div>
          <div class="content-nav-buttons prev">
            <paper-icon-button
              id="prev"
              title="[[prevLabel]]"
              on-tap="_prevBtn"
              icon="hardware:keyboard-arrow-left"
              data-voicecommand="previous page"
              hidden\$="[[!hasPrevPage]]"
            ></paper-icon-button>
            <paper-tooltip
              for="prev"
              position="right"
              offset="0"
              animation-delay="100"
            >
              [[prevLabel]]
            </paper-tooltip>
          </div>
        </div>
      </app-header-layout>
    </app-drawer-layout>
  `,is:"lrnapp-book",behaviors:[HAXCMSBehaviors.Theme],properties:{progressDashboardPath:{type:String},showSearch:{type:Boolean,reflectToAttribute:!0,value:!1},sourcePath:{type:String},editMode:{type:Boolean,reflectToAttribute:!0,value:!1,notify:!0,observer:"_editModeChanged"},drawerOpened:{type:Boolean,value:!0,reflectToAttribute:!0},currentTitle:{type:String},outlineTitle:{type:String},bookTitle:{type:String,value:"Course outline"},soundFinish:{type:Boolean,value:!0},sound:{type:Boolean,value:!0},completeSound:{type:String,value:""},finishedSound:{type:String,value:""},scrollPosition:{type:Number,value:0,observer:"_scrollChanged"},activePage:{type:Number,value:0,observer:"_activePageChanged"},activeOutline:{type:Number,value:0,observer:"_activeOutlineChanged"},outlineItems:{type:Array,value:[],notify:!0,observer:"_outlineItemsChanged"},bookItems:{type:Array,notify:!0},itemResponses:{type:Array,value:[]},requestParams:{type:Object,notify:!0,value:{node:null}},pageParams:{type:Object,notify:!0,value:{load:!1}},outlineData:{type:Object,notify:!0},bookData:{type:Object,notify:!0},pageData:{type:Object,notify:!0},outlinePath:{type:String},bookPath:{type:String},pagePath:{type:String},hasPrevPage:{type:Boolean,notify:!0},prevLabel:{type:String},hasNextPage:{type:Boolean,notify:!0},nextLabel:{type:String},resetScroll:{type:Boolean,value:!1},currentPageData:{type:Object,value:{},observer:"_currentPageDataUpdated"},manifest:{type:Object,value:{},observer:"_manifestChanged"},rebuildOutline:{type:Boolean,value:!1},fullWidth:{type:Boolean,reflectToAttribute:!0,value:!1,observer:"_fullWidthChanged"},_routerManifest:{type:Object,value:{}}},ready:function(){this.setupHAXTheme(!0,this.$.contentcontainer);window.dispatchEvent(new CustomEvent("haxcms-router-manifest-subscribe",{detail:{callback:"_haxcmsRouterManifestSubscribeHandler",scope:this,setup:!0}}));window.SimpleToast.requestAvailability();this.$.bodyloading.hidden=!0;setTimeout(()=>{this._resetScroll()},500)},attached:function(){this.$.progress.addEventListener("node-percent-milestone",this.testMilestone.bind(this));this.$.mapmenu.addEventListener("link-clicked",this._menuItemClicked.bind(this))},detached:function(){this.setupHAXTheme(!1);this.$.progress.removeEventListener("node-percent-milestone",this.testMilestone.bind(this));this.$.mapmenu.removeEventListener("link-clicked",this._menuItemClicked.bind(this))},_haxcmsRouterManifestSubscribeHandler:function(e){this._routerManifest={};this._routerManifest=e.detail},_menuItemClicked:function(e){let i=this.manifest.items.findIndex(j=>j.id===e.detail.id);this.activePage=i},_fullWidthChanged:function(){this.updateStyles()},progressdashboardopen:function(){this.$.progressdashboard.showProgress=!0},_computePageUpdatePath:function(data,sourcePath){return sourcePath.replace("%",data.id)},_editModeChanged:function(newValue,oldValue){if(typeof newValue!==typeof void 0){if(!0===newValue){this.$.currenttitle.contentEditable=!0;this.resetScroll=!0;new CustomEvent("simple-toast-show",{bubbles:!0,cancelable:!0,detail:{text:"Editor mode active",duration:5e3}})}else{this.$.currenttitle.contentEditable=!1;this.resetScroll=!1;if(!0===oldValue){if(this.$.currenttitle.innerHTML!==this.currentPageData.title){this.currentPageData.title=this.$.currenttitle.innerHTML}const evt=new CustomEvent("simple-toast-show",{bubbles:!0,cancelable:!0,detail:{text:"Saved",duration:0}});this.dispatchEvent(evt)}}}},_activeOutlineChanged:function(newValue,oldValue){if(typeof newValue!==typeof void 0&&typeof oldValue!==typeof void 0){this.rebuildOutline=!0}},_resetScroll:function(){this.resetScroll=!0;this.scrollPosition=0;this.$.anchor.scrollIntoView({block:"start",behavior:"smooth",inline:"nearest"})},_activePageChanged:function(newValue,oldValue){if(typeof newValue!==typeof void 0){if(typeof this.outlineItems!==typeof void 0&&0<this.outlineItems.length){this.fire("json-outline-schema-active-item-changed",this.outlineItems[newValue])}if(typeof oldValue!==typeof void 0){}setTimeout(()=>{this.resetScroll=!1},1e3);if(0==newValue){this.hasPrevPage=!1}else{this.hasPrevPage=!0;if(typeof this.outlineItems!==typeof void 0){this.prevLabel=this.outlineItems[newValue-1].title}}if(typeof this.outlineItems!==typeof void 0&&newValue+1==this.outlineItems.length){this.hasNextPage=!1}else{this.hasNextPage=!0;if(typeof this.outlineItems!==typeof void 0){this.nextLabel=this.outlineItems[newValue+1].title}}}},_outlineItemsChanged:function(newValue){if(typeof newValue!==typeof void 0&&0!=newValue.length){if(0!=this.activePage){this.prevLabel=newValue[this.activePage-1].title}if(this.activePage+1!=newValue.length){this.nextLabel=newValue[this.activePage+1].title}}},testMilestone:function(e){if(75==e.detail.percentage){console.log("@todo preload the next page and present grayed out right of UI.")}},_scrollChanged:function(newValue){if(typeof this.outlineItems!==typeof void 0&&typeof this.outlineItems[this.activePage]!==typeof void 0&&newValue>this.outlineItems[this.activePage].metadata.value&&!this.resetScroll){if(75<=newValue){this.outlineItems[this.activePage].metadata.value=this.outlineItems[this.activePage].metadata.max;this.set("outlineItems."+this.activePage+".metadata.value",this.outlineItems[this.activePage].metadata.max)}else{this.outlineItems[this.activePage].metadata.value=newValue;this.set("outlineItems."+this.activePage+".metadata.value",newValue)}}},_nextBtn:function(){if(this.activePage<this.outlineItems.length-1){this.set("outlineItems."+this.activePage+".metadata.value",this.outlineItems[this.activePage].metadata.max);this.activePage=this.activePage+1}},_prevBtn:function(){if(0<this.activePage){this.activePage=this.activePage-1}},toggleBook:function(){this.$.bookdrawer.toggle();this.fullWidth=!this.$.bookdrawer.opened},_manifestChanged:function(newValue){if(typeof newValue!==typeof void 0){const items=newValue.items,outlineTitle=newValue.title;if(0!==this.activePage){this.activePage=0}this.set("outlineItems",[]);this.set("outlineItems",items);this.notifyPath("outlineItems.*");this.set("bookItems",[]);this.set("bookItems",items);this.notifyPath("bookItems.*");this.set("outlineTitle",outlineTitle);this.$.outlineloading.hidden=!0;this.pageParams.load=!0}},_currentPageDataUpdated:function(newValue){if(typeof newValue!==typeof void 0&&typeof newValue.content!==typeof void 0){this.set("currentTitle",newValue.title);this._resetScroll();this.$.bodyloading.hidden=!0;if(this.editMode&&!newValue.page.meta.canUpdate){this.editMode=!1}}},_toArray:function(obj){return Object.keys(obj).map(function(key){return obj[key]})}});