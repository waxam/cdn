(function(root,factory){"use strict";if("function"===typeof define&&define.amd){define([],function(){return root.annyang=factory(root)})}else if("object"===typeof module&&module.exports){module.exports=factory(root)}else{root.annyang=factory(root)}})("undefined"!==typeof window?window:this,function(root){"use strict";var annyang,SpeechRecognition=root.SpeechRecognition||root.webkitSpeechRecognition||root.mozSpeechRecognition||root.msSpeechRecognition||root.oSpeechRecognition;if(!SpeechRecognition){return null}var commandsList=[],recognition,callbacks={start:[],error:[],end:[],soundstart:[],result:[],resultMatch:[],resultNoMatch:[],errorNetwork:[],errorPermissionBlocked:[],errorPermissionDenied:[]},autoRestart,lastStartedAt=0,autoRestartCount=0,debugState=!1,debugStyle="font-weight: bold; color: #00f;",pauseListening=!1,isListening=!1,optionalParam=/\s*\((.*?)\)\s*/g,optionalRegex=/(\(\?:[^)]+\))\?/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#]/g,commandToRegExp=function(command){command=command.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^\\s]+)"}).replace(splatParam,"(.*?)").replace(optionalRegex,"\\s*$1?\\s*");return new RegExp("^"+command+"$","i")},invokeCallbacks=function(callbacks,...args){callbacks.forEach(function(callback){callback.callback.apply(callback.context,args)})},isInitialized=function(){return recognition!==void 0},logMessage=function(text,extraParameters){if(-1===text.indexOf("%c")&&!extraParameters){console.log(text)}else{console.log(text,extraParameters||debugStyle)}},initIfNeeded=function(){if(!isInitialized()){annyang.init({},!1)}},registerCommand=function(command,callback,originalPhrase){commandsList.push({command,callback,originalPhrase});if(debugState){logMessage("Command successfully loaded: %c"+originalPhrase,debugStyle)}},parseResults=function(results){invokeCallbacks(callbacks.result,results);var commandText;for(let i=0;i<results.length;i++){commandText=results[i].trim();if(debugState){logMessage("Speech recognized: %c"+commandText,debugStyle)}for(let j=0,l=commandsList.length;j<l;j++){var currentCommand=commandsList[j],result=currentCommand.command.exec(commandText);if(result){var parameters=result.slice(1);if(0==parameters.length){parameters=result}if(debugState){logMessage("command matched: %c"+currentCommand.originalPhrase,debugStyle);if(parameters.length){logMessage("with parameters",parameters)}}currentCommand.callback.apply(this,parameters);invokeCallbacks(callbacks.resultMatch,commandText,currentCommand.originalPhrase,results);return}}}invokeCallbacks(callbacks.resultNoMatch,results)};annyang={init:function(commands,resetCommands=!0){if(recognition&&recognition.abort){recognition.abort()}recognition=new SpeechRecognition;recognition.maxAlternatives=5;recognition.continuous="http:"===root.location.protocol;recognition.lang="en-US";recognition.onstart=function(){isListening=!0;invokeCallbacks(callbacks.start)};recognition.onsoundstart=function(){invokeCallbacks(callbacks.soundstart)};recognition.onerror=function(event){invokeCallbacks(callbacks.error,event);switch(event.error){case"network":invokeCallbacks(callbacks.errorNetwork,event);break;case"not-allowed":case"service-not-allowed":autoRestart=!1;if(200>new Date().getTime()-lastStartedAt){invokeCallbacks(callbacks.errorPermissionBlocked,event)}else{invokeCallbacks(callbacks.errorPermissionDenied,event)}break;}};recognition.onend=function(){isListening=!1;invokeCallbacks(callbacks.end);if(autoRestart){var timeSinceLastStart=new Date().getTime()-lastStartedAt;autoRestartCount+=1;if(0===autoRestartCount%10){if(debugState){logMessage("Speech Recognition is repeatedly stopping and starting. See http://is.gd/annyang_restarts for tips.")}}if(1e3>timeSinceLastStart){setTimeout(function(){annyang.start({paused:pauseListening})},1e3-timeSinceLastStart)}else{annyang.start({paused:pauseListening})}}};recognition.onresult=function(event){if(pauseListening){if(debugState){logMessage("Speech heard, but annyang is paused")}return!1}var SpeechRecognitionResult=event.results[event.resultIndex],results=[];for(let k=0;k<SpeechRecognitionResult.length;k++){results[k]=SpeechRecognitionResult[k].transcript}parseResults(results)};if(resetCommands){commandsList=[]}if(commands.length){this.addCommands(commands)}},start:function(options){initIfNeeded();options=options||{};if(options.paused!==void 0){pauseListening=!!options.paused}else{pauseListening=!1}if(options.autoRestart!==void 0){autoRestart=!!options.autoRestart}else{autoRestart=!0}if(options.continuous!==void 0){recognition.continuous=!!options.continuous}lastStartedAt=new Date().getTime();try{recognition.start()}catch(e){if(debugState){logMessage(e.message)}}},abort:function(){autoRestart=!1;autoRestartCount=0;if(isInitialized()){recognition.abort()}},pause:function(){pauseListening=!0},resume:function(){annyang.start()},debug:function(newState=!0){debugState=!!newState},setLanguage:function(language){initIfNeeded();recognition.lang=language},addCommands:function(commands){var cb;initIfNeeded();for(let phrase in commands){if(commands.hasOwnProperty(phrase)){cb=root[commands[phrase]]||commands[phrase];if("function"===typeof cb){registerCommand(commandToRegExp(phrase),cb,phrase)}else if("object"===typeof cb&&cb.regexp instanceof RegExp){registerCommand(new RegExp(cb.regexp.source,"i"),cb.callback,phrase)}else{if(debugState){logMessage("Can not register command: %c"+phrase,debugStyle)}continue}}}},removeCommands:function(commandsToRemove){if(commandsToRemove===void 0){commandsList=[]}else{commandsToRemove=Array.isArray(commandsToRemove)?commandsToRemove:[commandsToRemove];commandsList=commandsList.filter(command=>{for(let i=0;i<commandsToRemove.length;i++){if(commandsToRemove[i]===command.originalPhrase){return!1}}return!0})}},addCallback:function(type,callback,context){var cb=root[callback]||callback;if("function"===typeof cb&&callbacks[type]!==void 0){callbacks[type].push({callback:cb,context:context||this})}},removeCallback:function(type,callback){var compareWithCallbackParameter=function(cb){return cb.callback!==callback};for(let callbackType in callbacks){if(callbacks.hasOwnProperty(callbackType)){if(type===void 0||type===callbackType){if(callback===void 0){callbacks[callbackType]=[]}else{callbacks[callbackType]=callbacks[callbackType].filter(compareWithCallbackParameter)}}}}},isListening:function(){return isListening&&!pauseListening},getSpeechRecognizer:function(){return recognition},trigger:function(sentences){if(!annyang.isListening()){if(debugState){if(!isListening){logMessage("Cannot trigger while annyang is aborted")}else{logMessage("Speech heard, but annyang is paused")}}return}if(!Array.isArray(sentences)){sentences=[sentences]}parseResults(sentences)}};return annyang});