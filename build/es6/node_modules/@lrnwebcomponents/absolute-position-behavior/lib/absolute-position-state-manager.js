/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement}from"../../../lit-element/lit-element.js";import"../../../@polymer/iron-resizable-behavior/iron-resizable-behavior.js";window.AbsolutePositionStateManager=window.AbsolutePositionStateManager||{},window.AbsolutePositionStateManager.requestAvailability=()=>{if(!window.AbsolutePositionStateManager.instance){window.AbsolutePositionStateManager.instance=document.createElement("absolute-position-state-manager");let instance=window.AbsolutePositionStateManager.instance;document.body.appendChild(instance)}return window.AbsolutePositionStateManager.instance};class AbsolutePositionStateManager extends LitElement{static get tag(){return"absolute-position-state-manager"}static get properties(){return{elements:{type:Array},__observer:{type:Object},__timeout:{type:Object}}}constructor(){super(),this.elements=[],this.__timeout=!1,this.__observer=new MutationObserver(mutations=>this.checkMutations(mutations))}loadElement(el){this.elements.length<1&&(this.__observer.observe(document,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.updateElements(),document.addEventListener("load",this.updateElements),window.addEventListener("resize",this._handleResize)),this.elements.push(el),this.positionElement(el)}unloadElement(el){this.elements.filter(element=>element===el),this.elements.length<1&&this.removeEventListeners()}_handleResize(){this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(window.AbsolutePositionStateManager.instance.updateElements(),250)}checkMutations(mutations){let update=!1;mutations.forEach(mutation=>{update||(update=update||!("attributes"===mutation.type&&"style"===mutation.attributeName&&this.elements.includes(mutation.target)))}),update&&this.updateElements()}findTarget(el){let selector="#"+el.for,docQuery=1===document.querySelectorAll(selector).length?document.querySelector(selector):null,target=el.target||docQuery,ancestor=el;for(;void 0!==el.for&&null===target&&null!==ancestor&&ancestor!==document;)ancestor=ancestor.parentNode,11===ancestor.nodeType&&(ancestor=ancestor.host),target=ancestor?ancestor.querySelector(selector):null;return target}removeEventListeners(){this.__observer&&this.__observer.disconnect&&this.__observer.disconnect(),document.removeEventListener("load",this.updateElements),window.removeEventListener("resize",this._handleResize)}updateElements(){this.elements.forEach(element=>this.positionElement(element))}positionElement(el){let target=this.findTarget(el);if(!target||!el.offsetParent)return;let offset=el.offset,parentRect=el.offsetParent.getBoundingClientRect(),targetRect=target.getBoundingClientRect(),elRect=el.getBoundingClientRect(),vertical=position=>"left"!==position&&"right"!==position,fitToBounds=()=>{let pos1=vertical(el.position)?"left":"top",pos2=vertical(el.position)?"right":"bottom",getRect=rect=>vertical(el.position)?rect.width:rect.height,coord=targetRect[pos1]-getRect(elRect)/2+getRect(targetRect)/2,min=parentRect[pos1],max=parentRect[pos2]-getRect(elRect);return el.fitToVisibleBounds?Math.max(min,Math.min(max,coord))+"px":coord+"px"},getCoord=()=>"top"===el.position?targetRect.top-elRect.height-offset+"px":"left"===el.position?targetRect.left-elRect.width-offset+"px":targetRect[el.position]+offset+"px",isFit=position=>{let size=vertical(position)?elRect.height+offset:elRect.width+offset;return(position=>"left"===position||"top"===position)(position)?targetRect[position]-parentRect[position]>size:parentRect[position]-targetRect[position]>size},flip=!1!==el.fitToVisibleBounds&&!isFit(el.position),flipData={top:["bottom","left","right"],left:["right","top","bottom"],bottom:["top","right","left"],right:["left","bottom","top"]};flip&&isFit(flipData[el.position][0])?el.position=flipData[el.position][0]:flip&&isFit(flipData[el.position][1])?el.position=flipData[el.position][1]:flip&&isFit(flipData[el.position][2])?el.position=flipData[el.position][2]:(el.style.position="absolute",el.style.top=vertical(el.position)?getCoord():fitToBounds(),el.style.left=vertical(el.position)?fitToBounds():getCoord(),el.__positions={self:elRect,parent:parentRect,target:targetRect})}disconnectedCallback(){this.removeEventListeners(),super.disconnectedCallback()}}window.customElements.define(AbsolutePositionStateManager.tag,AbsolutePositionStateManager);export{AbsolutePositionStateManager};