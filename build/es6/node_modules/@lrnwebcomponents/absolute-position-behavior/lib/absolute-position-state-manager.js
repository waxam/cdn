/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement}from"../../../lit-element/lit-element.js";window.AbsolutePositionStateManager=window.AbsolutePositionStateManager||{},window.AbsolutePositionStateManager.requestAvailability=()=>{if(!window.AbsolutePositionStateManager.instance){window.AbsolutePositionStateManager.instance=document.createElement("absolute-position-state-manager");let instance=window.AbsolutePositionStateManager.instance;document.body.appendChild(instance)}return window.AbsolutePositionStateManager.instance};class AbsolutePositionStateManager extends LitElement{static get tag(){return"absolute-position-state-manager"}static get properties(){return{elements:{type:Array},__observer:{type:Object},__timeout:{type:Object}}}constructor(){super(),this.elements=[],this.__timeout=!1,this.__observer=new MutationObserver(mutations=>this.checkMutations(mutations))}loadElement(el){this.elements.length<1&&(this.__observer.observe(document,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.updateElements(),document.addEventListener("load",this.updateElements),window.addEventListener("resize",this._handleResize)),this.elements.push(el),el.style.top=0,el.style.left=0,this.positionElement(el)}unloadElement(el){this.elements.filter(element=>element===el),this.elements.length<1&&this.removeEventListeners()}_handleResize(){this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(window.AbsolutePositionStateManager.instance.updateElements(),250)}checkMutations(mutations){let update=!1;mutations.forEach(mutation=>{update||(update=update||!("attributes"===mutation.type&&"style"===mutation.attributeName&&this.elements.includes(mutation.target)))}),update&&this.updateElements()}findTarget(el){let selector="#"+el.for,target=el.target,ancestor=el;for(;void 0!==el.for&&null===target&&null!==ancestor&&ancestor!==document;)ancestor=ancestor.parentNode,11===ancestor.nodeType&&(ancestor=ancestor.host),target=ancestor?ancestor.querySelector(selector):null;return target}removeEventListeners(){this.__observer&&this.__observer.disconnect&&this.__observer.disconnect(),document.removeEventListener("load",this.updateElements),window.removeEventListener("resize",this._handleResize)}updateElements(){this.elements.forEach(element=>this.positionElement(element))}_getParentNode(node){let parent=node.parentNode;return null!=parent&&parent.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&(parent=parent.host),parent}positionElement(el){let target=this.findTarget(el),parent=el.offsetParent;if(!target||!parent)return;let offset=parseFloat(el.offset),w=document.body.getBoundingClientRect(),p=parent.getBoundingClientRect(),t=target.getBoundingClientRect(),e=el.getBoundingClientRect(),vertical=(pos=el.position)=>"left"!==pos&&"right"!==pos,setAlign=(v=vertical(el.position))=>{let pxToNum=px=>parseFloat(px.replace("px","")),min=v?pxToNum(el.style.left)-e.left:pxToNum(el.style.top)-e.top,startAt=v?"left":"top",distance=rect=>v?rect.width:rect.height,max=min+distance(w)-distance(e),align=min;return"end"===el.positionAlign?align+=t[startAt]-distance(e)+distance(t):"start"===el.positionAlign?align+=t[startAt]:align+=t[startAt]-distance(e)/2+distance(t)/2,el.fitToVisibleBounds?Math.max(min,Math.min(max,align))+"px":align+"px"},getCoord=(pos=el.position)=>{let pxToNum=px=>parseFloat(px.replace("px","")),adjust=vertical(pos)?pxToNum(el.style.top)-e.top:pxToNum(el.style.left)-e.left;return"top"===pos?t.top+adjust-e.height-offset+"px":"left"===pos?t.left+adjust-e.width-offset+"px":t[pos]+adjust+offset+"px"},isFit=(pos=el.position)=>{let distance=rect=>vertical(pos)?e.height+offset:e.width+offset;return((pos=el.position)=>"left"===pos||"top"===pos)(pos)?t[pos]-w[pos]>distance:w[pos]-t[pos]>distance},flip=!1!==el.fitToVisibleBounds&&!isFit(el.position),flipData={top:["bottom","left","right"],left:["right","top","bottom"],bottom:["top","right","left"],right:["left","bottom","top"]};el.style.position="absolute",flip&&isFit(flipData[el.position][0])?el.position=flipData[el.position][0]:flip&&isFit(flipData[el.position][1])?el.position=flipData[el.position][1]:flip&&isFit(flipData[el.position][2])?el.position=flipData[el.position][2]:(el.style.top=vertical(el.position)?getCoord():setAlign(),el.style.left=vertical(el.position)?setAlign():getCoord(),el.__positions={self:e,parent:p,target:t})}disconnectedCallback(){this.removeEventListeners(),super.disconnectedCallback()}}window.customElements.define(AbsolutePositionStateManager.tag,AbsolutePositionStateManager);export{AbsolutePositionStateManager};