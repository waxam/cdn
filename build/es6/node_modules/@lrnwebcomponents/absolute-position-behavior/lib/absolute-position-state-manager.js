import{html,PolymerElement}from"../../../@polymer/polymer/polymer-element.js";import"../../../@polymer/iron-resizable-behavior/iron-resizable-behavior.js";window.AbsolutePositionStateManager=window.AbsolutePositionStateManager||{},window.AbsolutePositionStateManager.requestAvailability=()=>(window.AbsolutePositionStateManager.instance||(window.AbsolutePositionStateManager.instance=document.createElement("absolute-position-state-manager"),document.body.appendChild(window.AbsolutePositionStateManager.instance)),window.AbsolutePositionStateManager.instance);class AbsolutePositionStateManager extends PolymerElement{static get tag(){return"absolute-position-state-manager"}static get properties(){return{els:{type:Array,value:[]}}}constructor(){super();if(!window.AbsolutePositionStateManager.instance)return window.AbsolutePositionStateManager.instance=this,this}connectedCallback(){super.connectedCallback()}loadElement(el){this.__on=void 0!==this.__on&&this.__on,this.els.push(el),this.positionElement(el),this.__on||this.addEventListeners(),this.__on=!0}unloadElement(el){this.els.filter(el=>el==el),this.__on=this.els>0,this.__on||this.removeEventListeners()}addEventListeners(){let root=this;root.__timeout=!1,root.updateElements(),document.addEventListener("load",root.updateElements()),window.addEventListener("resize",function(){clearTimeout(root.__timeout),root.__timeout=setTimeout(root.updateElements(),250)}),root.__observer=new MutationObserver(function(mutations){root.checkMutations(mutations)}),root.__observer.observe(document,{attributes:!0,childList:!0,subtree:!0,characterData:!0})}checkMutations(mutations){let update=!1;mutations.forEach(mutation=>{update||(update=update||!("attributes"===mutation.type&&"style"===mutation.attributeName&&this.els.includes(mutation.target)))}),update&&this.updateElements()}findTarget(el){let selector="#"+el.for,docQuery=1===document.querySelectorAll(selector).length?document.querySelector(selector):null,target=el.target||docQuery,ancestor=el;for(;void 0!==el.for&&null===target&&null!==ancestor&&ancestor!==document;)11===(ancestor=ancestor.parentNode).nodeType&&(ancestor=ancestor.host),target=ancestor?ancestor.querySelector(selector):null;return target}removeEventListeners(){let root=this;document.removeEventListener("load",root.updateElements()),window.removeEventListener("resize",function(){clearTimeout(root.__timeout),root.__timeout=setTimeout(root.updateElements(),250)}),root.__observer&&root.__observer.disconnect()}updateElements(){let root=this;root.els.forEach(el=>{root.positionElement(el)})}positionElement(el){let target=this.findTarget(el);if(!target||!el.offsetParent)return;let offset=el.offset,parentRect=el.offsetParent.getBoundingClientRect(),targetRect=target.getBoundingClientRect(),elRect=el.getBoundingClientRect(),vertical=position=>"left"!==position&&"right"!==position,fitToBounds=()=>{let pos1=vertical(el.position)?"left":"top",pos2=vertical(el.position)?"right":"bottom",getRect=rect=>vertical(el.position)?rect.width:rect.height,coord=targetRect[pos1]-getRect(elRect)/2+getRect(targetRect)/2,min=parentRect[pos1],max=parentRect[pos2]-getRect(elRect);return el.fitToVisibleBounds?Math.max(min,Math.min(max,coord))+"px":coord+"px"},getCoord=()=>"top"===el.position?targetRect.top-elRect.height-offset+"px":"left"===el.position?targetRect.left-elRect.width-offset+"px":targetRect[el.position]+offset+"px",isFit=position=>{let size=vertical(position)?elRect.height+offset:elRect.width+offset;return(position=>"left"===position||"top"===position)(position)?targetRect[position]-parentRect[position]>size:parentRect[position]-targetRect[position]>size},flip=!1!==el.fitToVisibleBounds&&!isFit(el.position),flipData={top:["bottom","left","right"],left:["right","top","bottom"],bottom:["top","right","left"],right:["left","bottom","top"]};flip&&isFit(flipData[el.position][0])?el.position=flipData[el.position][0]:flip&&isFit(flipData[el.position][1])?el.position=flipData[el.position][1]:flip&&isFit(flipData[el.position][2])?el.position=flipData[el.position][2]:(el.style.position="absolute",el.style.top=vertical(el.position)?getCoord():fitToBounds(),el.style.left=vertical(el.position)?fitToBounds():getCoord(),el.__positions={self:elRect,parent:parentRect,target:targetRect})}disconnectedCallback(){this.removeEventListeners(),super.disconnectedCallback()}}window.customElements.define(AbsolutePositionStateManager.tag,AbsolutePositionStateManager);export{AbsolutePositionStateManager};