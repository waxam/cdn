/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as t}from"../../../lit-element/lit-element.js";window.AbsolutePositionStateManager=window.AbsolutePositionStateManager||{},window.AbsolutePositionStateManager.requestAvailability=()=>{if(!window.AbsolutePositionStateManager.instance){window.AbsolutePositionStateManager.instance=document.createElement("absolute-position-state-manager");let t=window.AbsolutePositionStateManager.instance;document.body.appendChild(t)}return window.AbsolutePositionStateManager.instance};class AbsolutePositionStateManager extends t{static get tag(){return"absolute-position-state-manager"}static get properties(){return{elements:{type:Array},__observer:{type:Object},__timeout:{type:Object}}}constructor(){super(),this.elements=[],this.__timeout=!1,this.__observer=new MutationObserver(t=>this.checkMutations(t))}loadElement(t){this.elements.length<1&&(this.__observer.observe(document,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.updateElements(),document.addEventListener("load",this.updateElements),window.addEventListener("resize",this._handleResize)),this.elements.push(t),t.style.top=0,t.style.left=0,this.positionElement(t)}unloadElement(t){this.elements.filter(e=>e===t),this.elements.length<1&&this.removeEventListeners()}_handleResize(){this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(window.AbsolutePositionStateManager.instance.updateElements(),250)}checkMutations(t){let e=!1;t.forEach(t=>{e||(e=e||!("attributes"===t.type&&"style"===t.attributeName&&this.elements.includes(t.target)))}),e&&this.updateElements()}findTarget(t){let e="#"+t.for,o=t.target,i=t;for(;void 0!==t.for&&null===o&&null!==i&&null!==i.parentNode&&i!==document;)i=i.parentNode,11===i.nodeType&&(i=i.host),o=i?i.querySelector(e):null;return o}removeEventListeners(){this.__observer&&this.__observer.disconnect&&this.__observer.disconnect(),document.removeEventListener("load",this.updateElements),window.removeEventListener("resize",this._handleResize)}updateElements(){this.elements.forEach(t=>this.positionElement(t))}_getParentNode(t){let e=t.parentNode;return null!=e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&(e=e.host),e}positionElement(t){let e=this.findTarget(t),o=t.offsetParent;if(!e||!o)return;let i=parseFloat(t.offset),n=document.body.getBoundingClientRect(),s=o.getBoundingClientRect(),l=e.getBoundingClientRect(),a=t.getBoundingClientRect(),vertical=(e=t.position)=>"left"!==e&&"right"!==e,setAlign=(e=vertical(t.position))=>{let pxToNum=t=>parseFloat(t.replace("px","")),o=e?pxToNum(t.style.left)-a.left:pxToNum(t.style.top)-a.top,i=e?"left":"top",distance=t=>e?t.width:t.height,s=o+distance(n)-distance(a),r=o;return"end"===t.positionAlign?r+=l[i]-distance(a)+distance(l):"start"===t.positionAlign?r+=l[i]:r+=l[i]-distance(a)/2+distance(l)/2,t.fitToVisibleBounds?Math.max(o,Math.min(s,r))+"px":r+"px"},getCoord=(e=t.position)=>{let pxToNum=t=>parseFloat(t.replace("px","")),o=vertical(e)?pxToNum(t.style.top)-a.top:pxToNum(t.style.left)-a.left;return"top"===e?l.top+o-a.height-i+"px":"left"===e?l.left+o-a.width-i+"px":l[e]+o+i+"px"},isFit=(e=t.position)=>{let distance=t=>vertical(e)?a.height+i:a.width+i;return((e=t.position)=>"left"===e||"top"===e)(e)?l[e]-n[e]>distance:n[e]-l[e]>distance},r=!1!==t.fitToVisibleBounds&&!isFit(t.position),p={top:["bottom","left","right"],left:["right","top","bottom"],bottom:["top","right","left"],right:["left","bottom","top"]};t.style.position="absolute",r&&isFit(p[t.position][0])?t.position=p[t.position][0]:r&&isFit(p[t.position][1])?t.position=p[t.position][1]:r&&isFit(p[t.position][2])?t.position=p[t.position][2]:(t.style.top=vertical(t.position)?getCoord():setAlign(),t.style.left=vertical(t.position)?setAlign():getCoord(),t.__positions={self:a,parent:s,target:l})}disconnectedCallback(){this.removeEventListeners(),super.disconnectedCallback()}}window.customElements.define(AbsolutePositionStateManager.tag,AbsolutePositionStateManager);export{AbsolutePositionStateManager};