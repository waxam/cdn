import{html,PolymerElement}from"../../@polymer/polymer/polymer-element.js";import{getRange}from"./lib/shadows-safari.js";import"../../@polymer/iron-a11y-keys/iron-a11y-keys.js";import"../../@polymer/iron-icon/iron-icon.js";import"../../@polymer/iron-icons/iron-icons.js";import"../../@polymer/iron-icons/editor-icons.js";import"../json-outline-schema/json-outline-schema.js";class EditableOutline extends PolymerElement{static get template(){return html`
      <style>
        :host {
          display: block;
          font-family: "Noto Serif", serif;
        }

        :host([hidden]) {
          display: none;
        }

        .button-wrapper {
          background-color: white;
          position: absolute;
          display: block;
          justify-content: space-evenly;
          @apply --editable-outline-button-wrapper;
        }
        @media (max-width: 1000px) {
          .button-wrapper {
            position: relative;
            @apply --editable-outline-button-wrapper-mobile;
          }
        }
        button {
          height: 32px;
          font-size: 10px;
          margin: 0;
          padding: 0 8px;
        }

        #outline {
          padding-top: 44px;
          margin: 0;
        }
        ul,
        ol {
          font-size: 16px;
          line-height: 32px;
          padding-left: 32px;
          @apply --editable-outline-button-list;
        }
        li {
          font-size: 16px;
          line-height: 32px;
          padding: 4px;
          @apply --editable-outline-button-list-item;
        }

        li:focus,
        li:active,
        li:hover {
          background-color: #eeeeee;
          outline: 1px solid #cccccc;
          @apply --editable-outline-button-list-item-active;
        }

        iron-icon {
          pointer-events: none;
        }
      </style>
      <div class="button-wrapper">
        <button on-click="buttonEvents" id="add">
          <iron-icon icon="icons:add"></iron-icon> Add
        </button>
        <button on-click="buttonEvents" id="down">
          <iron-icon icon="icons:arrow-downward"></iron-icon> Move down
        </button>
        <button on-click="buttonEvents" id="up">
          <iron-icon icon="icons:arrow-upward"></iron-icon> Move up
        </button>
        <button on-click="buttonEvents" id="outdent">
          <iron-icon icon="editor:format-indent-decrease"></iron-icon> Outdent
        </button>
        <button on-click="buttonEvents" id="indent">
          <iron-icon icon="editor:format-indent-increase"></iron-icon> Indent
        </button>
        <button on-click="buttonEvents" id="duplicate">
          <iron-icon icon="icons:content-copy"></iron-icon> Duplicate
        </button>
      </div>
      <ul id="outline" contenteditable$="[[editMode]]">
        <li contenteditable="true"></li>
      </ul>

      <iron-a11y-keys
        target="[[__outlineNode]]"
        keys="shift+tab"
        on-keys-pressed="_tabBackKeyPressed"
        stop-keyboard-event-propagation
      ></iron-a11y-keys>
      <iron-a11y-keys
        target="[[__outlineNode]]"
        keys="tab"
        on-keys-pressed="_tabKeyPressed"
        stop-keyboard-event-propagation
      ></iron-a11y-keys>
    `}static get properties(){let props={items:{name:"items",type:Array,value:[],notify:!0},editMode:{name:"editMode",type:Boolean,notify:!0,observer:"_editModeChanged"},__outlineNode:{name:"__outlineNode",type:Object}};return super.properties&&(props=Object.assign(props,super.properties)),props}constructor(){super(),this.polyfillSafe=this.__computePolyfillSafe(),window.JSONOutlineSchema.requestAvailability()}static get tag(){return"editable-outline"}connectedCallback(){super.connectedCallback(),this.__outlineNode=this.$.outline,this._observer=new MutationObserver(this._observer.bind(this)),this._observer.observe(this.__outlineNode,{childList:!0,subtree:!0})}_observer(record){let reference;for(var index in record){let info=record[index];if(info.removedNodes.length>0&&this.__outdent){for(let i in info.removedNodes)reference&&info.removedNodes[i].tagName&&"LI"===info.removedNodes[i].tagName&&null!==info.removedNodes[i].getAttribute("data-jos-id")?(reference.setAttribute("data-jos-id",info.removedNodes[i].getAttribute("data-jos-id")),null!==info.removedNodes[i].getAttribute("data-jos-location")&&reference.setAttribute("data-jos-location",info.removedNodes[i].getAttribute("data-jos-location")),reference=null):"UL"===info.removedNodes[i].tagName&&info.removedNodes[i].firstChild&&"LI"===info.removedNodes[i].firstChild.tagName&&null!==info.removedNodes[i].firstChild.getAttribute("data-jos-id")&&(reference.setAttribute("data-jos-id",info.removedNodes[i].firstChild.getAttribute("data-jos-id")),null!==info.removedNodes[i].firstChild.getAttribute("data-jos-location")&&reference.setAttribute("data-jos-location",info.removedNodes[i].firstChild.getAttribute("data-jos-location")),reference=null);this.$.outline.firstChild||this.$.outline.appendChild(document.createElement("li"))}if(info.addedNodes.length>0)if(this.__outdent)for(let i in info.addedNodes)info.addedNodes[i].tagName&&"LI"===info.addedNodes[i].tagName&&(reference=info.addedNodes[i]);else if(!this.__blockScrub)for(let i in info.addedNodes)info.addedNodes[i].tagName&&window.JSONOutlineSchema.requestAvailability().scrubElementJOSData(info.addedNodes[i])}setTimeout(()=>{this.__blockScrub=!1,this.__outdent=!1,this.__indent=!1},100)}disconnectedCallback(){super.disconnectedCallback()}_editModeChanged(newValue,oldValue){}buttonEvents(e){switch(e.target.id){case"add":this._add(e);break;case"indent":this._indent();break;case"outdent":this._outdent();break;case"up":this._move("up");break;case"down":this._move("down");break;case"duplicate":this._duplicate()}}_duplicate(){try{let range=this.getDeepRange();if(void 0===range.commonAncestorContainer)return;let activeItem=range.commonAncestorContainer;if(null!=activeItem&&void 0!==activeItem.tagName||(activeItem=activeItem.parentNode),activeItem)if(null!==activeItem.nextElementSibling&&"UL"===activeItem.nextElementSibling.tagName){const clone2=activeItem.nextElementSibling.cloneNode(!0);activeItem.parentNode.insertBefore(clone2,activeItem.nextElementSibling.nextElementSibling);const clone=activeItem.cloneNode(!0);activeItem.parentNode.insertBefore(clone,activeItem.nextElementSibling.nextElementSibling)}else{const clone=activeItem.cloneNode(!0);activeItem.parentNode.insertBefore(clone,activeItem.nextElementSibling)}}catch(e){console.log(e)}}_move(direction){try{let range=this.getDeepRange();if(void 0===range.commonAncestorContainer)return;let activeItem=range.commonAncestorContainer;null!=activeItem&&void 0!==activeItem.tagName||(activeItem=activeItem.parentNode);let test=activeItem,valid=!1;for(;!valid&&test.parentNode;)"outline"===test.id&&(valid=!0),test=test.parentNode;valid&&activeItem&&("up"===direction?null!==activeItem.previousElementSibling&&(activeItem.nextElementSibling&&"UL"===activeItem.nextElementSibling.tagName?("UL"===activeItem.previousElementSibling.tagName&&(this.__blockScrub=!0,activeItem.parentNode.insertBefore(activeItem.previousElementSibling,activeItem.nextElementSibling.nextElementSibling)),this.__blockScrub=!0,activeItem.parentNode.insertBefore(activeItem.previousElementSibling,activeItem.nextElementSibling.nextElementSibling),activeItem.focus()):("UL"===activeItem.previousElementSibling.tagName&&(this.__blockScrub=!0,activeItem.parentNode.insertBefore(activeItem.previousElementSibling,activeItem.nextElementSibling)),this.__blockScrub=!0,activeItem.parentNode.insertBefore(activeItem.previousElementSibling,activeItem.nextElementSibling),activeItem.focus())):"down"===direction&&null!==activeItem.nextElementSibling&&(activeItem.nextElementSibling&&"UL"===activeItem.nextElementSibling.tagName&&null!==activeItem.nextElementSibling.nextElementSibling?("LI"===activeItem.nextElementSibling.nextElementSibling.tagName&&null!==activeItem.nextElementSibling.nextElementSibling.nextElementSibling&&"UL"===activeItem.nextElementSibling.nextElementSibling.nextElementSibling.tagName&&(this.__blockScrub=!0,activeItem.parentNode.insertBefore(activeItem.nextElementSibling.nextElementSibling,activeItem)),this.__blockScrub=!0,activeItem.parentNode.insertBefore(activeItem.nextElementSibling.nextElementSibling,activeItem),activeItem.focus()):"LI"===activeItem.nextElementSibling.tagName&&(null!==activeItem.nextElementSibling.nextElementSibling&&"UL"===activeItem.nextElementSibling.nextElementSibling.tagName&&(this.__blockScrub=!0,activeItem.parentNode.insertBefore(activeItem.nextElementSibling,activeItem)),this.__blockScrub=!0,activeItem.parentNode.insertBefore(activeItem.nextElementSibling,activeItem),activeItem.focus())))}catch(e){console.log(e)}}importJsonOutlineSchemaItems(){for(this.__blockScrub=!0;null!==this.$.outline.firstChild;)this.$.outline.removeChild(this.$.outline.firstChild);0===this.items.length&&this.set("items",window.JSONOutlineSchema.requestAvailability().items);let outline=window.JSONOutlineSchema.requestAvailability().itemsToNodes(this.items);for(;null!==outline.firstChild;)this.__blockScrub=!0,this.$.outline.appendChild(outline.firstChild);return outline}exportJsonOutlineSchemaItems(save=!1){return window.JSONOutlineSchema.requestAvailability().nodesToItems(this.$.outline,save)}_tabKeyPressed(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation());try{this._indent()}catch(e){}}_indent(){this.polyfillSafe&&(this.__indent=!0,this.__blockScrub=!0,document.execCommand("indent"))}_add(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.polyfillSafe&&document.execCommand("insertText",!1,"\n")}_tabBackKeyPressed(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation());try{this._outdent()}catch(e){}}_outdent(){this.polyfillSafe&&(this.__outdent=!0,this.__blockScrub=!0,document.execCommand("outdent"))}getDeepSelection(){return this.shadowRoot.getSelection?this.shadowRoot.getSelection():getRange(this.$.outline.parentNode)?getRange(this.$.outline.parentNode):window.getSelection()}getDeepRange(){let sel=this.getDeepSelection();return sel.getRangeAt&&sel.rangeCount?sel.getRangeAt(0):sel||void 0}__computePolyfillSafe(){return!(!document.head.createShadowRoot&&!document.head.attachShadow)||(console.log("Shadow DOM missing, certain operations hidden"),!1)}}window.customElements.define(EditableOutline.tag,EditableOutline);export{EditableOutline};