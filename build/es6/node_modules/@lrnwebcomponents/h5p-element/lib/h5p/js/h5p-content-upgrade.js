!function(r,e){var t,o,n,i={},a={};r(document).ready((function(){t=H5PAdminIntegration.libraryInfo;const e=r("#h5p-admin-container").html("");o=r('<ul class="content-upgrade-log"></ul>').appendTo(e),n=r("<div><p>"+t.message+"</p></div>").appendTo(e);var i=r(getVersionSelect(t.versions)).appendTo(n);r("<button/>",{class:"h5p-admin-upgrade-button",text:t.buttonLabel,click:function(){new ContentUpgrade(i.val())}}).appendTo(n)}));var getVersionSelect=function(r){var e="";for(var t in r)e+='<option value="'+t+'">'+r[t]+"</option>";if(""!==e)return e="<select>"+e+"</select>"};function Throbber(r){var e=H5PUtils.throbber(r);n.html("").append(e),this.setProgress=function(t){e.text(r+" "+t)}}function ContentUpgrade(r){var o=this;o.version=new e(t.versions[r]),o.version.libraryId=r,o.throbber=new Throbber(t.inProgress.replace("%ver",o.version)),o.started=(new Date).getTime(),o.io=0,o.working=0;var start=function(){o.nextBatch({libraryId:r,token:t.token})};void 0!==window.Worker?(o.initWorkers(),start()):o.loadScript(t.scriptBaseUrl+"/h5p-content-upgrade-process.js"+t.buster,start)}ContentUpgrade.prototype.initWorkers=function(){var r=this,o=void 0!==window.navigator&&window.navigator.hardwareConcurrency?window.navigator.hardwareConcurrency:4;r.workers=new Array(o);for(var n={done:function(e){r.workDone(e.id,e.params,this)},error:function(e){r.printError(e.err),r.workDone(e.id,null,this)},loadLibrary:function(t){var o=this;r.loadLibrary(t.name,new e(t.version),(function(r,e){r||o.postMessage({action:"libraryLoaded",library:e})}))}},i=0;i<o;i++)r.workers[i]=new Worker(t.scriptBaseUrl+"/h5p-content-upgrade-worker.js"+t.buster),r.workers[i].onmessage=function(r){void 0!==r.data.action&&n[r.data.action]&&n[r.data.action].call(this,r.data)}},ContentUpgrade.prototype.nextBatch=function(e){var o=this,n=(new Date).getTime();r.post(t.infoUrl,e,(function(r){if(o.io+=(new Date).getTime()-n,!(r instanceof Object))return o.setStatus(r);if(0===r.left){var e=(new Date).getTime()-o.started;return window.console&&console.log&&console.log("The upgrade process took "+e/1e3+" seconds. ("+Math.round(o.io/(e/100)*100)/100+" % IO)"),o.terminate(),o.setStatus(t.done)}o.left=r.left,o.token=r.token,o.processBatch(r.params,r.skipped)}))},ContentUpgrade.prototype.setStatus=function(r){n.html(r)},ContentUpgrade.prototype.processBatch=function(r,e){for(var t in this.upgraded={},this.skipped=e,this.parameters=r,this.ids=[],r)r.hasOwnProperty(t)&&this.ids.push(t);if(this.current=-1,void 0!==this.workers)for(var o=0;o<this.workers.length;o++)this.assignWork(this.workers[o]);else this.assignWork()},ContentUpgrade.prototype.assignWork=function(r){var o=this,n=o.ids[o.current+1];if(void 0===n)return!1;o.current++,o.working++,r?r.postMessage({action:"newJob",id:n,name:t.library.name,oldVersion:t.library.version,newVersion:o.version.toString(),params:o.parameters[n]}):new H5P.ContentUpgradeProcess(t.library.name,new e(t.library.version),o.version,o.parameters[n],n,(function loadLibrary(r,e,n){o.loadLibrary(r,e,(function(i,a){a.upgradesScript?o.loadScript(a.upgradesScript,(function(o){o&&(o=t.errorScript.replace("%lib",r+" "+e)),n(o,a)})):n(null,a)}))}),(function done(r,e){r&&(o.printError(r),e=null),o.workDone(n,e)}))},ContentUpgrade.prototype.workDone=function(r,e,o){this.working--,null===e?this.skipped.push(r):this.upgraded[r]=e,this.throbber.setProgress(Math.round((t.total-this.left+this.current)/(t.total/100))+" %"),!1===this.assignWork(o)&&0===this.working&&this.nextBatch({libraryId:this.version.libraryId,token:this.token,skipped:JSON.stringify(this.skipped),params:JSON.stringify(this.upgraded)})},ContentUpgrade.prototype.terminate=function(){if(this.workers)for(var r=0;r<this.workers.length;r++)this.workers[r].terminate()};var s={};ContentUpgrade.prototype.loadLibrary=function(e,o,n){var a=this,p=e+"/"+o.major+"/"+o.minor;if(!0===i[p])return void 0===s[p]?void(s[p]=[n]):void s[p].push(n);if(void 0===i[p]){var d=(new Date).getTime();i[p]=!0,r.ajax({dataType:"json",cache:!0,url:t.libraryBaseUrl+"/"+p}).fail((function(){a.io+=(new Date).getTime()-d,n(t.errorData.replace("%lib",e+" "+o))})).done((function(r){if(a.io+=(new Date).getTime()-d,i[p]=r,n(null,r),void 0!==s[p])for(var e=0;e<s[p].length;e++)s[p][e](null,r);delete s[p]}))}else n(null,i[p])},ContentUpgrade.prototype.loadScript=function(e,t){var o=this;if(void 0===a[e]){var n=(new Date).getTime();r.ajax({dataType:"script",cache:!0,url:e}).fail((function(){o.io+=(new Date).getTime()-n,t(!0)})).done((function(){a[e]=!0,o.io+=(new Date).getTime()-n,t()}))}else t()},ContentUpgrade.prototype.printError=function(e){switch(e.type){case"errorParamsBroken":e=t.errorContent.replace("%id",e.id)+" "+t.errorParamsBroken;break;case"libraryMissing":e=t.errorLibrary.replace("%lib",e.library);break;case"scriptMissing":e=t.errorScript.replace("%lib",e.library);break;case"errorTooHighVersion":e=t.errorContent.replace("%id",e.id)+" "+t.errorTooHighVersion.replace("%used",e.used).replace("%supported",e.supported);break;case"errorNotSupported":e=t.errorContent.replace("%id",e.id)+" "+t.errorNotSupported.replace("%used",e.used)}r("<li>"+t.error+"<br/>"+e+"</li>").appendTo(o)}}(H5P.jQuery,H5P.Version);