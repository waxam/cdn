import{html,PolymerElement}from"../../@polymer/polymer/polymer-element.js";import"../es-global-bridge/es-global-bridge.js";import"../../@polymer/iron-ajax/iron-ajax.js";class LrnCalendar extends PolymerElement{static get template(){return html`
      <style>
        :host {
          display: block;
        }
        lrn-calendar-date {
          display: inline-table;
          top: 0px;
        }
        paper-card {
          width: 14%;
          height: 20px;
          display: inline-table;
          padding: 0;
          margin: 0;
        }
        .calendar {
          color: var(--my-toolbar-title-color);
        }
        .header {
          padding-bottom: 15px;
        }
      </style>

      <div class="calendar">
        <div class="header">
          <div style="float: left">
            <paper-button raised type="button" on-click="monthView"
              >Month</paper-button
            >
            <paper-button raised type="button" on-click="weekView"
              >Week</paper-button
            >
          </div>
          <div style="float: right">
            <paper-button raised type="button" on-click="showDate"
              >Today</paper-button
            >
            <paper-button on-click="showPrev"
              ><iron-icon icon="arrow-back"></iron-icon
            ></paper-button>
            <paper-button on-click="showNext"
              ><iron-icon icon="arrow-forward"></iron-icon
            ></paper-button>
          </div>
          <div style="margin: 0 auto; width: 200px; text-align: center">
            <h2>[[getDisplayDate(date)]]</h2>
          </div>
        </div>

        <div class="calendarView" id="calView"></div>
      </div>
    `}static get tag(){return"lrn-calendar"}pathFromUrl(url){return url.substring(0,url.lastIndexOf("/")+1)}static get properties(){return{listOfEvents:{type:Array,value:[]},dateString:{type:String,observer:"_dateStringChanged"},date:{type:Date,value:new Date,observer:"_dateChanged"},view:{type:String,value:"month",observer:"_viewTypeChanged"},file:{type:String,reflectToAttribute:!0,observer:"_fileChanged"}}}_fileChanged(newValue,oldValue){void 0!==newValue&&this.__icalLoaded&&(this.loadFile(),this.getDateInfo(),this.createCalendar())}_viewTypeChanged(newValue,oldValue){void 0!==newValue&&void 0!==this.file&&this.__icalLoaded&&(this.getDateInfo(),this.createCalendar())}_dateChanged(newValue,oldValue){void 0!==newValue&&void 0!==this.file&&this.__icalLoaded&&(this.getDateInfo(),this.createCalendar())}_dateStringChanged(newValue,oldValue){void 0!==newValue&&""!=newValue&&this.__icalLoaded&&(this.date=new Date(newValue))}constructor(){super(),import("../../@polymer/paper-button/paper-button.js"),import("../../@polymer/iron-icons/iron-icons.js"),import("../../@polymer/iron-icon/iron-icon.js"),import("../../@polymer/paper-card/paper-card.js"),import("../../@polymer/paper-menu-button/paper-menu-button.js"),import("../../@polymer/paper-dropdown-menu/paper-dropdown-menu.js"),import("../lrnsys-layout/lrnsys-layout.js"),import("../lrnsys-layout/lib/lrnsys-drawer.js"),import("../lrnsys-layout/lib/lrnsys-dialog.js"),import("../lrnsys-layout/lib/lrnsys-collapselist.js"),import("../lrnsys-layout/lib/lrnsys-collapselist-item.js"),import("./lib/lrn-calendar-date.js");const location=`${this.pathFromUrl(decodeURIComponent(import.meta.url))}lib/ical.js/build/ical.js`;window.addEventListener("es-bridge-ical-loaded",this._icalLoaded.bind(this)),window.ESGlobalBridge.requestAvailability(),window.ESGlobalBridge.instance.load("ical",location)}disconnectedCallback(){super.disconnectedCallback(),window.removeEventListener("es-bridge-ical-loaded",this._icalLoaded.bind(this))}_icalLoaded(){this.__icalLoaded=!0,void 0!==this.file&&this.loadFile()}static get haxProperties(){return{canScale:!1,canPosition:!1,canEditSource:!1,gizmo:{title:"Calendar",description:"Present dates.",icon:"icons:today",color:"grey",groups:["Date"],handles:[{type:"ical",source:"file",date:"date"}],meta:{author:"ELMS:LN"}},settings:{quick:[{property:"file",title:"iCal feed",description:"Calendar feed to display",inputMethod:"textfield",icon:"link",required:!0}],configure:[{property:"file",title:"iCal feed",description:"Calendar feed to display",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"},{property:"view",title:"View calendar in week or month format",description:"week or month view",inputMethod:"select",options:{week:"Week",month:"Month"}},{property:"dateString",title:"Date: yyyy/mm/dd",description:"Date to display calendar",inputMethod:"datepicker"}],advanced:[]}}}loadFile(){this.startIndex=0,this.calendarText=this.readTextFile(this.file),this.listOfEvents=this.getEvents(this.date,this.calendarText),this.listOfEvents=this.sortByTime(this.listOfEvents)}showPrev(){if(this.startIndex=0,"month"==this.view)current=2==this.date.getMonth()&&this.date.getDate()>28?new Date(this.date.getFullYear(),this.date.getMonth()-1,28):new Date(this.date.getFullYear(),this.date.getMonth()-1,this.date.getDate()),this.date=current;else{var current=new Date(this.date.getFullYear(),this.date.getMonth(),this.date.getDate()-7);this.date=current}this.startMonth=this.date.getMonth()+1,this.getDateInfo(),this.createCalendar()}showNext(){if("month"==this.view)current=11==this.date.getMonth()?new Date(this.date.getFullYear()+1,0,this.date.getDate()):0==this.date.getMonth()&&this.date.getDate()>28?new Date(this.date.getFullYear(),this.date.getMonth()+1,28):new Date(this.date.getFullYear(),this.date.getMonth()+1,this.date.getDate()),this.date=current;else{var current=new Date(this.date.getFullYear(),this.date.getMonth(),this.date.getDate()+7);this.date=current}this.getDateInfo(),this.createCalendar()}showDate(){this.startIndex=0,this.date=new Date,this.getDateInfo(),this.createCalendar()}monthView(){this.view="month",this.startIndex=0,this.createCalendar()}weekView(){this.view="week",this.startIndex=0,this.createCalendar()}readTextFile(file){this.fileNotFound=!1;var rawFile=new XMLHttpRequest,allText="";return rawFile.open("GET",file,!1),rawFile.onreadystatechange=function(){4===rawFile.readyState&&(allText=200===rawFile.status||0==rawFile.status?rawFile.responseText:"Not Found")},rawFile.send(null),this.calendarText=allText,allText}createCalendar(){"month"!=this.view&&"week"!=this.view&&(this.view="month"),this.date.getFullYear()||(this.date=new Date),this.getDateInfo(),this.totalDays=7*this.numweeks,this.calendarText=this.readTextFile(this.file),this.calendarView=this.shadowRoot.querySelector("#calView");for(var days=1,elem=this.shadowRoot.querySelector("#calView").node,elemChildren=elem.childNodes;elemChildren[1];)elem.removeChild(elem.childNodes[1]);var initialDayofWeek=this.currentDayofWeek;if("week"==this.view){for(var dayCount=0;this.currentDayofWeek+dayCount<6;)dayCount+=1;this.totalDays=dayCount}if("month"==this.view&&(1==this.currentMonth||3==this.currentMonth||5==this.currentMonth||7==this.currentMonth||8==this.currentMonth||10==this.currentMonth||12==this.currentMonth?(this.totalDays=31,this.totalDays=this.totalDays-this.startDay+1):4==this.currentMonth||6==this.currentMonth||9==this.currentMonth||11==this.currentMonth?(this.totalDays=30,this.totalDays=this.totalDays-this.startDay+1):(this.totalDays=29,this.totalDays=this.totalDays-this.startDay)),this.newDate=new Date(this.currentYear+"/"+this.currentMonth+"/"+this.currentDate),"month"==this.view){for(;1!=this.currentDate;)days-=1,1==this.currentMonth&&1==this.currentDate?(this.currentYear=this.currentYear-1,this.currentMonth=12,this.currentDate=31,this.newDate=new Date(this.currentYear+"/"+this.currentMonth+"/"+this.currentDate)):(this.currentDate=this.currentDate-1,this.newDate=new Date(this.currentYear+"/"+this.currentMonth+"/"+this.currentDate),this.newDate.getDate()!=this.currentDate&&(0!=this.currentDate||2!=this.currentMonth&&4!=this.currentMonth&&6!=this.currentMonth&&8!=this.currentMonth&&9!=this.currentMonth&&11!=this.currentMonth&&1!=this.currentMonth||(this.newDate=new Date(this.currentYear+"/"+(this.currentMonth-1)+"/31"),this.currentDate=31),0!=this.currentDate||5!=this.currentMonth&&7!=this.currentMonth&&10!=this.currentMonth&&12!=this.currentMonth||(this.newDate=new Date(this.currentYear+"/"+(this.currentMonth-1)+"/30"),this.currentDate=30),0==this.currentDate&&3==this.currentMonth&&(this.newDate=new Date(this.currentYear+"/2/29"),this.currentDate=29,2==this.newDate.getMonth()&&(this.newDate=new Date(this.currentYear+"/2/28"),this.currentDate=28)),this.currentMonth=this.currentMonth-1)),0!=this.currentDayofWeek&&0!=initialDayofWeek||(this.currentDayofWeek=7,initialDayofWeek=-1),this.currentDayofWeek=this.currentDayofWeek-1;7==this.currentDayofWeek&&(this.currentDayofWeek=0)}for(;0!=this.currentDayofWeek;)days-=1,1==this.currentMonth&&1==this.currentDate?(this.currentYear=this.currentYear-1,this.currentMonth=12,this.currentDate=31,this.newDate=new Date(this.currentYear+"/"+this.currentMonth+"/"+this.currentDate)):(this.currentDate=this.currentDate-1,this.newDate=new Date(this.currentYear+"/"+this.currentMonth+"/"+this.currentDate),this.newDate.getDate()!=this.currentDate&&(0!=this.currentDate||2!=this.currentMonth&&4!=this.currentMonth&&6!=this.currentMonth&&8!=this.currentMonth&&9!=this.currentMonth&&11!=this.currentMonth&&1!=this.currentMonth||(this.newDate=new Date(this.currentYear+"/"+(this.currentMonth-1)+"/31"),this.currentDate=31),0!=this.currentDate||5!=this.currentMonth&&7!=this.currentMonth&&10!=this.currentMonth&&12!=this.currentMonth||(this.newDate=new Date(this.currentYear+"/"+(this.currentMonth-1)+"/30"),this.currentDate=30),0==this.currentDate&&3==this.currentMonth&&(this.newDate=new Date(this.currentYear+"/2/29"),this.currentDate=29,2==this.newDate.getMonth()&&(this.newDate=new Date(this.currentYear+"/2/28"),this.currentDate=28)),this.currentMonth=this.currentMonth-1)),this.currentDayofWeek=this.currentDayofWeek-1;(dynamicEl=document.createElement("lrn-calendar-date")).date=this.newDate,dynamicEl.firstWeek=!0,dynamicEl.style.width="14.25%",dynamicEl.style.display="inline-block",dynamicEl.setAttribute("id","date"),dynamicEl.view=this.view,this.date.getFullYear()===this.newDate.getFullYear()&&this.date.getMonth()===this.newDate.getMonth()&&this.date.getDate()===this.newDate.getDate()&&(dynamicEl.loadeddate=!0);var eventsOnDay=this.eventCheck(this.listOfEvents,this.newDate),sendEvent=this.createReturn(eventsOnDay);dynamicEl.events=sendEvent,dynamicEl.valid=!0,this.calendarView.appendChild(dynamicEl);for(var firstWeekCount=1;days<this.totalDays;){var dynamicEl;12==this.currentMonth&&31==this.currentDate?(this.currentYear=this.currentYear+1,this.currentMonth=1,this.currentDate=1,this.newDay=new Date(this.currentYear+"/"+this.currentMonth+"/"+this.currentDate)):(this.currentDate=this.currentDate+1,this.newDay=new Date(this.currentYear+"/"+this.currentMonth+"/"+this.currentDate),this.newDay.getDate()!=this.currentDate&&(1!=this.currentMonth&&3!=this.currentMonth&&5!=this.currentMonth&&7!=this.currentMonth&&8!=this.currentMonth&&10!=this.currentMonth&&12!=this.currentMonth||(this.newDay=new Date(this.currentYear+"/"+(this.currentMonth+1)+"/1")),this.currentDate=1,this.currentMonth=this.currentMonth+1)),(dynamicEl=document.createElement("lrn-calendar-date")).valid=!0,dynamicEl.setAttribute("id","date"),dynamicEl.date=this.newDay,dynamicEl.style.width="14.25%",dynamicEl.style.display="inline-block",dynamicEl.view=this.view,this.date.getFullYear()===this.newDay.getFullYear()&&this.date.getMonth()===this.newDay.getMonth()&&this.date.getDate()===this.newDay.getDate()&&(dynamicEl.loadeddate=!0);var eventsOnDayMain=this.eventCheck(this.listOfEvents,this.newDay),sendEventMain=this.createReturn(eventsOnDayMain);dynamicEl.events=sendEventMain,firstWeekCount<7&&(dynamicEl.firstWeek=!0),firstWeekCount+=1,dynamicEl.valid=!0,this.calendarView.appendChild(dynamicEl),(days+=1)==this.totalDays&&6!=this.newDay.getDay()&&(days-=1,1)}}getEvents(date,text){if("Not Found"==text)return"";var iCalendarData=text,jcalData=ICAL.parse(iCalendarData),vcalendar=new ICAL.Component(jcalData),displayEvents=(vcalendar.getFirstSubcomponent("vevent"),vcalendar.getAllSubcomponents("vevent").map(vevent=>(event=new ICAL.Event(vevent),event)));this.eventArray=[];for(var i=0;i<displayEvents.length;i++){this.createDate(displayEvents[i]);displayEvents[i].isRecurring()&&this.createRecurrence(displayEvents[i]),this.eventArray.push(displayEvents[i])}return this.eventArray}createRecurrence(events){events.getRecurrenceTypes().WEEKLY?this.createRepeatedEvent(events,156):events.getRecurrenceTypes().DAILY?this.createRepeatedEvent(events,720):events.getRecurrenceTypes().MONTHLY?this.createRepeatedEvent(events,36):events.getRecurrenceTypes().YEARLY&&this.createRepeatedEvent(events,10)}createRepeatedEvent(events,maxRepeat){var iter=events.iterator(events.startDate);let next,num=0;for(;(next=iter.next())&&num++<maxRepeat;){var newTest=new ICAL.Event;newTest.summary=events.summary,newTest.description=events.description,newTest.startDate=events.getOccurrenceDetails(next).startDate,newTest.endDate=events.getOccurrenceDetails(next).endDate;var locationString=String(events.location);newTest.location=locationString,newTest.startDate._time.day==events.startDate._time.day&&newTest.startDate._time.month==events.startDate._time.month&&newTest.startDate._time.year==events.startDate._time.year||this.eventArray.push(newTest)}}createDate(event){var year=event.startDate._time.year,month=event.startDate._time.month,day=event.startDate._time.day;return new Date(year+"/"+month+"/"+day)}eventCheck(events,date){for(var eventsOnDay=[],end=events.length,i=this.startIndex;i<end;i++){var startDay=this.createDate(events[i]);startDay.getTime()>date.getTime()&&(end=i,0!=i&&(this.startIndex=i-1)),startDay.getTime()==date.getTime()&&eventsOnDay.push(events[i])}return eventsOnDay}sortByTime(eventList){var swapped;do{swapped=!1;for(var i=0;i<eventList.length-1;i++)if(eventList[i].startDate>eventList[i+1].startDate){var temp=eventList[i];eventList[i]=eventList[i+1],eventList[i+1]=temp,swapped=!0}}while(swapped);return eventList}getDateInfo(){this.startMonth=this.date.getMonth()+1,this.startYear=this.date.getFullYear(),this.startDay=this.date.getDate(),this.startDayOfWeek=this.date.getDay(),this.currentDate=this.startDay,this.currentMonth=this.startMonth,this.currentYear=this.startYear,this.currentDayofWeek=this.startDayOfWeek}createReturn(event){for(var EventArray=[],i=0;i<event.length;i++)EventArray.push({event:event[i]});return EventArray}getDisplayDate(date){if("function"==typeof date.getMonth){var monthInt=date.getMonth();date.getDate();return["January","February","March","April","May","June","July","August","September","October","November","December"][monthInt]+" "+date.getFullYear()}return""}}window.customElements.define(LrnCalendar.tag,LrnCalendar);export{LrnCalendar};