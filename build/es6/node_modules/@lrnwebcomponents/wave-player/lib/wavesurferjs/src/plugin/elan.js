export default class ElanPlugin{static create(t){return{name:"elan",deferInit:!(!t||!t.deferInit)&&t.deferInit,params:t,instance:ElanPlugin}}Types={ALIGNABLE_ANNOTATION:"ALIGNABLE_ANNOTATION",REF_ANNOTATION:"REF_ANNOTATION"};constructor(t,e){if(this.data=null,this.params=t,this.container="string"==typeof t.container?document.querySelector(t.container):t.container,!this.container)throw Error("No container for ELAN")}init(){this.bindClick(),this.params.url&&this.load(this.params.url)}destroy(){this.container.removeEventListener("click",this._onClick),this.container.removeChild(this.table)}load(t){this.loadXML(t,(t=>{this.data=this.parseElan(t),this.render(),this.fireEvent("ready",this.data)}))}loadXML(t,e){const n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="document",n.send(),n.addEventListener("load",(t=>{e&&e(t.target.responseXML)}))}parseElan(t){const e=Array.prototype.forEach,n=Array.prototype.map,a={media:{},timeOrder:{},tiers:[],annotations:{},alignableAnnotations:[]},r=t.querySelector("HEADER"),i="milliseconds"==r.getAttribute("TIME_UNITS"),s=r.querySelector("MEDIA_DESCRIPTOR");a.media.url=s.getAttribute("MEDIA_URL"),a.media.type=s.getAttribute("MIME_TYPE");const o=t.querySelectorAll("TIME_ORDER TIME_SLOT"),l={};return e.call(o,(t=>{let e=parseFloat(t.getAttribute("TIME_VALUE"));i&&(e=Math.round(100*e)/1e5),l[t.getAttribute("TIME_SLOT_ID")]=e})),a.tiers=n.call(t.querySelectorAll("TIER"),(t=>({id:t.getAttribute("TIER_ID"),linguisticTypeRef:t.getAttribute("LINGUISTIC_TYPE_REF"),defaultLocale:t.getAttribute("DEFAULT_LOCALE"),annotations:n.call(t.querySelectorAll("REF_ANNOTATION, ALIGNABLE_ANNOTATION"),(t=>{const e={type:t.nodeName,id:t.getAttribute("ANNOTATION_ID"),ref:t.getAttribute("ANNOTATION_REF"),value:t.querySelector("ANNOTATION_VALUE").textContent.trim()};return this.Types.ALIGNABLE_ANNOTATION==e.type&&(e.start=l[t.getAttribute("TIME_SLOT_REF1")],e.end=l[t.getAttribute("TIME_SLOT_REF2")],a.alignableAnnotations.push(e)),a.annotations[e.id]=e,e}))}))),a.tiers.forEach((t=>{t.annotations.forEach((t=>{null!=t.ref&&(t.reference=a.annotations[t.ref])}))})),a.alignableAnnotations.sort(((t,e)=>{let n=t.start-e.start;return 0==n&&(n=e.end-t.end),n})),a.length=a.alignableAnnotations.length,a}render(){let t=this.data.tiers;this.params.tiers&&(t=t.filter((t=>t.id in this.params.tiers)));const e={};let n={};t.forEach(((t,a)=>{t.annotations.forEach((t=>{t.reference&&t.reference.type==this.Types.ALIGNABLE_ANNOTATION&&(t.reference.id in e||(e[t.ref]={}),e[t.ref][a]=t,n[a]=!0)}))})),n=Object.keys(n).sort(),this.renderedAlignable=this.data.alignableAnnotations.filter((t=>e[t.id]));const a=this.table=document.createElement("table");a.className="wavesurfer-annotations";const r=document.createElement("thead"),i=document.createElement("tr");r.appendChild(i),a.appendChild(r);const s=document.createElement("th");s.textContent="Time",s.className="wavesurfer-time",i.appendChild(s),n.forEach((e=>{const n=t[e],a=document.createElement("th");a.className="wavesurfer-tier-"+n.id,a.textContent=n.id,a.style.width=this.params.tiers[n.id],i.appendChild(a)}));const o=document.createElement("tbody");a.appendChild(o),this.renderedAlignable.forEach((a=>{const r=document.createElement("tr");r.id="wavesurfer-alignable-"+a.id,o.appendChild(r);const i=document.createElement("td");i.className="wavesurfer-time",i.textContent=a.start.toFixed(1)+"â€“"+a.end.toFixed(1),r.appendChild(i);const s=e[a.id];n.forEach((e=>{const n=t[e],i=document.createElement("td"),o=s[e];o&&(i.id="wavesurfer-annotation-"+o.id,i.dataset.ref=a.id,i.dataset.start=a.start,i.dataset.end=a.end,i.textContent=o.value),i.className="wavesurfer-tier-"+n.id,r.appendChild(i)}))})),this.container.innerHTML="",this.container.appendChild(a)}bindClick(){this._onClick=t=>{const e=t.target.dataset.ref;if(null!=e){const t=this.data.annotations[e];t&&this.fireEvent("select",t.start,t.end)}},this.container.addEventListener("click",this._onClick)}getRenderedAnnotation(t){let e;return this.renderedAlignable.some((n=>n.start<=t&&n.end>=t&&(e=n,!0))),e}getAnnotationNode(t){return document.getElementById("wavesurfer-alignable-"+t.id)}}