export default class MicrophonePlugin{static create(e){return{name:"microphone",deferInit:!(!e||!e.deferInit)&&e.deferInit,params:e,instance:MicrophonePlugin}}constructor(e,t){this.params=e,this.wavesurfer=t,this.active=!1,this.paused=!1,this.browser=this.detectBrowser(),this.reloadBufferFunction=e=>this.reloadBuffer(e);const promisifiedOldGUM=(e,t,i)=>{const r=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return r?new Promise(((t,i)=>{r.call(navigator,e,t,i)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=promisifiedOldGUM),this.constraints=this.params.constraints||{video:!1,audio:!0},this.bufferSize=this.params.bufferSize||4096,this.numberOfInputChannels=this.params.numberOfInputChannels||1,this.numberOfOutputChannels=this.params.numberOfOutputChannels||1,this._onBackendCreated=()=>{this.micContext=this.wavesurfer.backend.getAudioContext()}}init(){this.wavesurfer.on("backend-created",this._onBackendCreated),this.wavesurfer.backend&&this._onBackendCreated()}destroy(){this.paused=!0,this.wavesurfer.un("backend-created",this._onBackendCreated),this.stop()}start(){navigator.mediaDevices.getUserMedia(this.constraints).then((e=>this.gotStream(e))).catch((e=>this.deviceError(e)))}togglePlay(){this.active?(this.paused=!this.paused,this.paused?this.pause():this.play()):this.start()}play(){this.paused=!1,this.connect()}pause(){this.paused=!0,this.disconnect()}stop(){this.active&&(this.stopDevice(),this.wavesurfer.empty())}stopDevice(){if(this.active=!1,this.disconnect(),this.stream){if(("chrome"===this.browser.browser&&this.browser.version>=45||"firefox"===this.browser.browser&&this.browser.version>=44||"edge"===this.browser.browser)&&this.stream.getTracks)return void this.stream.getTracks().forEach((e=>e.stop()));this.stream.stop()}}connect(){void 0!==this.stream&&("edge"===this.browser.browser&&(this.localAudioBuffer=this.micContext.createBuffer(this.numberOfInputChannels,this.bufferSize,this.micContext.sampleRate)),this.mediaStreamSource=this.micContext.createMediaStreamSource(this.stream),this.levelChecker=this.micContext.createScriptProcessor(this.bufferSize,this.numberOfInputChannels,this.numberOfOutputChannels),this.mediaStreamSource.connect(this.levelChecker),this.levelChecker.connect(this.micContext.destination),this.levelChecker.onaudioprocess=this.reloadBufferFunction)}disconnect(){void 0!==this.mediaStreamSource&&this.mediaStreamSource.disconnect(),void 0!==this.levelChecker&&(this.levelChecker.disconnect(),this.levelChecker.onaudioprocess=void 0),void 0!==this.localAudioBuffer&&(this.localAudioBuffer=void 0)}reloadBuffer(e){if(!this.paused)if(this.wavesurfer.empty(),"edge"===this.browser.browser){let t,i;for(t=0,i=Math.min(this.localAudioBuffer.numberOfChannels,e.inputBuffer.numberOfChannels);t<i;t++)this.localAudioBuffer.getChannelData(t).set(e.inputBuffer.getChannelData(t));this.wavesurfer.loadDecodedBuffer(this.localAudioBuffer)}else this.wavesurfer.loadDecodedBuffer(e.inputBuffer)}gotStream(e){this.stream=e,this.active=!0,this.play(),this.fireEvent("deviceReady",e)}deviceError(e){this.fireEvent("deviceError",e)}extractVersion(e,t,i){const r=e.match(t);return r&&r.length>=i&&parseInt(r[i],10)}detectBrowser(){const e={browser:null,version:null,minVersion:null};return"undefined"!=typeof window&&window.navigator?navigator.mozGetUserMedia?(e.browser="firefox",e.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),e.minVersion=31,e):navigator.webkitGetUserMedia&&window.webkitRTCPeerConnection?(e.browser="chrome",e.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),e.minVersion=38,e):navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)?(e.browser="edge",e.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),e.minVersion=10547,e):(e.browser="Not a supported browser.",e):(e.browser="Not a supported browser.",e)}}