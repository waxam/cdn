class Region{constructor(e,t){this.wavesurfer=t,this.wrapper=t.drawer.wrapper,this.util=t.util,this.style=this.util.style,this.id=null==e.id?t.util.getId():e.id,this.start=Number(e.start)||0,this.end=null==e.end?this.start+4/this.wrapper.scrollWidth*this.wavesurfer.getDuration():Number(e.end),this.resize=void 0===e.resize||Boolean(e.resize),this.drag=void 0===e.drag||Boolean(e.drag),this.loop=Boolean(e.loop),this.color=e.color||"rgba(0, 0, 0, 0.1)",this.data=e.data||{},this.attributes=e.attributes||{},this.maxLength=e.maxLength,this.minLength=e.minLength,this._onRedraw=()=>this.updateRender(),this.scroll=!1!==e.scroll&&t.params.scrollParent,this.scrollSpeed=e.scrollSpeed||1,this.scrollThreshold=e.scrollThreshold||10,this.bindInOut(),this.render(),this.wavesurfer.on("zoom",this._onRedraw),this.wavesurfer.on("redraw",this._onRedraw),this.wavesurfer.fireEvent("region-created",this)}update(e){null!=e.start&&(this.start=Number(e.start)),null!=e.end&&(this.end=Number(e.end)),null!=e.loop&&(this.loop=Boolean(e.loop)),null!=e.color&&(this.color=e.color),null!=e.data&&(this.data=e.data),null!=e.resize&&(this.resize=Boolean(e.resize)),null!=e.drag&&(this.drag=Boolean(e.drag)),null!=e.maxLength&&(this.maxLength=Number(e.maxLength)),null!=e.minLength&&(this.minLength=Number(e.minLength)),null!=e.attributes&&(this.attributes=e.attributes),this.updateRender(),this.fireEvent("update"),this.wavesurfer.fireEvent("region-updated",this)}remove(){this.element&&(this.wrapper.removeChild(this.element),this.element=null,this.fireEvent("remove"),this.wavesurfer.un("zoom",this._onRedraw),this.wavesurfer.un("redraw",this._onRedraw),this.wavesurfer.fireEvent("region-removed",this))}play(){this.wavesurfer.play(this.start,this.end),this.fireEvent("play"),this.wavesurfer.fireEvent("region-play",this)}playLoop(){this.play(),this.once("out",(()=>this.playLoop()))}render(){const e=document.createElement("region");e.className="wavesurfer-region",e.title=this.formatTime(this.start,this.end),e.setAttribute("data-id",this.id);for(const t in this.attributes)e.setAttribute("data-region-"+t,this.attributes[t]);this.wrapper.scrollWidth;if(this.style(e,{position:"absolute",zIndex:2,height:"100%",top:"0px"}),this.resize){const t=e.appendChild(document.createElement("handle")),s=e.appendChild(document.createElement("handle"));t.className="wavesurfer-handle wavesurfer-handle-start",s.className="wavesurfer-handle wavesurfer-handle-end";const i={cursor:"col-resize",position:"absolute",left:"0px",top:"0px",width:"1%",maxWidth:"4px",height:"100%"};this.style(t,i),this.style(s,i),this.style(s,{left:"100%"})}this.element=this.wrapper.appendChild(e),this.updateRender(),this.bindEvents(e)}formatTime(e,t){return(e==t?[e]:[e,t]).map((e=>[Math.floor(e%3600/60),("00"+Math.floor(e%60)).slice(-2)].join(":"))).join("-")}getWidth(){return this.wavesurfer.drawer.width/this.wavesurfer.params.pixelRatio}updateRender(){const e=this.wavesurfer.getDuration(),t=this.getWidth();if(this.start<0&&(this.start=0,this.end=this.end-this.start),this.end>e&&(this.end=e,this.start=e-(this.end-this.start)),null!=this.minLength&&(this.end=Math.max(this.start+this.minLength,this.end)),null!=this.maxLength&&(this.end=Math.min(this.start+this.maxLength,this.end)),null!=this.element){const s=Math.round(this.start/e*t),i=Math.round(this.end/e*t)-s;this.style(this.element,{left:s+"px",width:i+"px",backgroundColor:this.color,cursor:this.drag?"move":"default"});for(const e in this.attributes)this.element.setAttribute("data-region-"+e,this.attributes[e]);this.element.title=this.formatTime(this.start,this.end)}}bindInOut(){this.firedIn=!1,this.firedOut=!1;const onProcess=e=>{!this.firedOut&&this.firedIn&&(this.start>=Math.round(100*e)/100||this.end<=Math.round(100*e)/100)&&(this.firedOut=!0,this.firedIn=!1,this.fireEvent("out"),this.wavesurfer.fireEvent("region-out",this)),!this.firedIn&&this.start<=e&&this.end>e&&(this.firedIn=!0,this.firedOut=!1,this.fireEvent("in"),this.wavesurfer.fireEvent("region-in",this))};this.wavesurfer.backend.on("audioprocess",onProcess),this.on("remove",(()=>{this.wavesurfer.backend.un("audioprocess",onProcess)})),this.on("out",(()=>{this.loop&&this.wavesurfer.play(this.start)}))}bindEvents(){this.element.addEventListener("mouseenter",(e=>{this.fireEvent("mouseenter",e),this.wavesurfer.fireEvent("region-mouseenter",this,e)})),this.element.addEventListener("mouseleave",(e=>{this.fireEvent("mouseleave",e),this.wavesurfer.fireEvent("region-mouseleave",this,e)})),this.element.addEventListener("click",(e=>{e.preventDefault(),this.fireEvent("click",e),this.wavesurfer.fireEvent("region-click",this,e)})),this.element.addEventListener("dblclick",(e=>{e.stopPropagation(),e.preventDefault(),this.fireEvent("dblclick",e),this.wavesurfer.fireEvent("region-dblclick",this,e)})),(this.drag||this.resize)&&(()=>{const e=this.wavesurfer.drawer.container,t=this.wavesurfer.getDuration(),s=this.scrollSpeed,i=this.scrollThreshold;let r,n,a,h,o,d,l,u=!1;const edgeScroll=e=>{if(!d||!a&&!o)return;let i=this.wrapper.scrollLeft+s*d;this.wrapper.scrollLeft=i=Math.min(h,Math.max(0,i));const n=this.wavesurfer.drawer.handleEvent(e)*t,l=n-r;r=n,a?this.onDrag(l):this.onResize(l,o),window.requestAnimationFrame((()=>{edgeScroll(e)}))},onDown=e=>{e.touches&&e.touches.length>1||(n=e.targetTouches?e.targetTouches[0].identifier:null,e.stopPropagation(),r=this.wavesurfer.drawer.handleEvent(e,!0)*t,h=this.wrapper.scrollWidth-this.wrapper.clientWidth,l=this.wrapper.getBoundingClientRect(),"handle"==e.target.tagName.toLowerCase()?o=e.target.classList.contains("wavesurfer-handle-start")?"start":"end":(a=!0,o=!1))},onUp=e=>{e.touches&&e.touches.length>1||((a||o)&&(a=!1,d=null,o=!1),u&&(u=!1,this.util.preventClick(),this.fireEvent("update-end",e),this.wavesurfer.fireEvent("region-update-end",this,e)))},onMove=s=>{if(!(s.touches&&s.touches.length>1)&&(!s.targetTouches||s.targetTouches[0].identifier==n)&&(a||o)){const n=r,h=this.wavesurfer.drawer.handleEvent(s)*t,c=h-r;if(r=h,this.drag&&a&&(u=u||!!c,this.onDrag(c)),this.resize&&o&&(u=u||!!c,this.onResize(c,o)),this.scroll&&e.clientWidth<this.wrapper.scrollWidth){if(a){const e=this.element.getBoundingClientRect();let t=e.left-l.left;h<n&&t>=0?d=-1:h>n&&t+e.width<=l.right&&(d=1),(-1===d&&t>i||1===d&&t+e.width<l.right-i)&&(d=null)}else{let e=s.clientX-l.left;d=e<=i?-1:e>=l.right-i?1:null}d&&edgeScroll(s)}}};this.element.addEventListener("mousedown",onDown),this.element.addEventListener("touchstart",onDown),this.wrapper.addEventListener("mousemove",onMove),this.wrapper.addEventListener("touchmove",onMove),document.body.addEventListener("mouseup",onUp),document.body.addEventListener("touchend",onUp),this.on("remove",(()=>{document.body.removeEventListener("mouseup",onUp),document.body.removeEventListener("touchend",onUp),this.wrapper.removeEventListener("mousemove",onMove),this.wrapper.removeEventListener("touchmove",onMove)})),this.wavesurfer.on("destroy",(()=>{document.body.removeEventListener("mouseup",onUp),document.body.removeEventListener("touchend",onUp)}))})()}onDrag(e){const t=this.wavesurfer.getDuration();this.end+e>t||this.start+e<0||this.update({start:this.start+e,end:this.end+e})}onResize(e,t){"start"==t?this.update({start:Math.min(this.start+e,this.end),end:Math.max(this.start+e,this.end)}):this.update({start:Math.min(this.end+e,this.start),end:Math.max(this.end+e,this.start)})}}export default class RegionsPlugin{static create(e){return{name:"regions",deferInit:!(!e||!e.deferInit)&&e.deferInit,params:e,staticProps:{initRegions(){console.warn('Deprecated initRegions! Use wavesurfer.initPlugins("regions") instead!'),this.initPlugin("regions")},addRegion(e){return this.initialisedPluginList.regions||this.initPlugin("regions"),this.regions.add(e)},clearRegions(){this.regions&&this.regions.clear()},enableDragSelection(e){this.initialisedPluginList.regions||this.initPlugin("regions"),this.regions.enableDragSelection(e)},disableDragSelection(){this.regions.disableDragSelection()}},instance:RegionsPlugin}}constructor(e,t){this.params=e,this.wavesurfer=t,this.util=t.util;Object.getOwnPropertyNames(this.util.Observer.prototype).forEach((e=>{Region.prototype[e]=this.util.Observer.prototype[e]})),this.wavesurfer.Region=Region,this.list={},this._onReady=()=>{this.wrapper=this.wavesurfer.drawer.wrapper,this.params.regions&&this.params.regions.forEach((e=>{this.add(e)})),this.params.dragSelection&&this.enableDragSelection(this.params)}}init(){this.wavesurfer.isReady&&this._onReady(),this.wavesurfer.on("ready",this._onReady)}destroy(){this.wavesurfer.un("ready",this._onReady),this.disableDragSelection(),this.clear()}add(e){const t=new this.wavesurfer.Region(e,this.wavesurfer);return this.list[t.id]=t,t.on("remove",(()=>{delete this.list[t.id]})),t}clear(){Object.keys(this.list).forEach((e=>{this.list[e].remove()}))}enableDragSelection(e){const t=e.slop||2,s=this.wavesurfer.drawer.container,i=!1!==e.scroll&&this.wavesurfer.params.scrollParent,r=e.scrollSpeed||1,n=e.scrollThreshold||10;let a,h,o,d,l,u,c,p=this.wavesurfer.getDuration(),v=0;const edgeScroll=e=>{if(!d||!u)return;let t=this.wrapper.scrollLeft+r*u;this.wrapper.scrollLeft=t=Math.min(h,Math.max(0,t));const s=this.wavesurfer.drawer.handleEvent(e);d.update({start:Math.min(s*p,o*p),end:Math.max(s*p,o*p)}),t<h&&t>0&&window.requestAnimationFrame((()=>{edgeScroll(e)}))},eventDown=e=>{e.touches&&e.touches.length>1||(p=this.wavesurfer.getDuration(),l=e.targetTouches?e.targetTouches[0].identifier:null,h=this.wrapper.scrollWidth-this.wrapper.clientWidth,c=this.wrapper.getBoundingClientRect(),a=!0,o=this.wavesurfer.drawer.handleEvent(e,!0),d=null,u=null)};this.wrapper.addEventListener("mousedown",eventDown),this.wrapper.addEventListener("touchstart",eventDown),this.on("disable-drag-selection",(()=>{this.wrapper.removeEventListener("touchstart",eventDown),this.wrapper.removeEventListener("mousedown",eventDown)}));const eventUp=e=>{e.touches&&e.touches.length>1||(a=!1,v=0,u=null,d&&(this.util.preventClick(),d.fireEvent("update-end",e),this.wavesurfer.fireEvent("region-update-end",d,e)),d=null)};this.wrapper.addEventListener("mouseup",eventUp),this.wrapper.addEventListener("touchend",eventUp),document.body.addEventListener("mouseup",eventUp),document.body.addEventListener("touchend",eventUp),this.on("disable-drag-selection",(()=>{document.body.removeEventListener("mouseup",eventUp),document.body.removeEventListener("touchend",eventUp),this.wrapper.removeEventListener("touchend",eventUp),this.wrapper.removeEventListener("mouseup",eventUp)}));const eventMove=r=>{if(!a)return;if(++v<=t)return;if(r.touches&&r.touches.length>1)return;if(r.targetTouches&&r.targetTouches[0].identifier!=l)return;d||(d=this.add(e||{}));const h=this.wavesurfer.drawer.handleEvent(r);if(d.update({start:Math.min(h*p,o*p),end:Math.max(h*p,o*p)}),i&&s.clientWidth<this.wrapper.scrollWidth){const e=r.clientX-c.left;u=e<=n?-1:e>=c.right-n?1:null,u&&edgeScroll(r)}};this.wrapper.addEventListener("mousemove",eventMove),this.wrapper.addEventListener("touchmove",eventMove),this.on("disable-drag-selection",(()=>{this.wrapper.removeEventListener("touchmove",eventMove),this.wrapper.removeEventListener("mousemove",eventMove)}))}disableDragSelection(){this.fireEvent("disable-drag-selection")}getCurrentRegion(){const e=this.wavesurfer.getCurrentTime();let t=null;return Object.keys(this.list).forEach((s=>{const i=this.list[s];i.start<=e&&i.end>=e&&(!t||i.end-i.start<t.end-t.start)&&(t=i)})),t}}