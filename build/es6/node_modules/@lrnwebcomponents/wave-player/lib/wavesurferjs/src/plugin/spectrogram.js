const FFT=function(t,e,a,s){switch(this.bufferSize=t,this.sampleRate=e,this.bandwidth=2/t*(e/2),this.sinTable=new Float32Array(t),this.cosTable=new Float32Array(t),this.windowValues=new Float32Array(t),this.reverseTable=new Uint32Array(t),this.peakBand=0,this.peak=0,a){case"bartlett":for(var r=0;r<t;r++)this.windowValues[r]=2/(t-1)*((t-1)/2-Math.abs(r-(t-1)/2));break;case"bartlettHann":for(r=0;r<t;r++)this.windowValues[r]=.62-.48*Math.abs(r/(t-1)-.5)-.38*Math.cos(2*Math.PI*r/(t-1));break;case"blackman":s=s||.16;for(r=0;r<t;r++)this.windowValues[r]=(1-s)/2-.5*Math.cos(2*Math.PI*r/(t-1))+s/2*Math.cos(4*Math.PI*r/(t-1));break;case"cosine":for(r=0;r<t;r++)this.windowValues[r]=Math.cos(Math.PI*r/(t-1)-Math.PI/2);break;case"gauss":s=s||.25;for(r=0;r<t;r++)this.windowValues[r]=Math.pow(Math.E,-.5*Math.pow((r-(t-1)/2)/(s*(t-1)/2),2));break;case"hamming":for(r=0;r<t;r++)this.windowValues[r]=(.54-.46)*Math.cos(2*Math.PI*r/(t-1));break;case"hann":case void 0:for(r=0;r<t;r++)this.windowValues[r]=.5*(1-Math.cos(2*Math.PI*r/(t-1)));break;case"lanczoz":for(r=0;r<t;r++)this.windowValues[r]=Math.sin(Math.PI*(2*r/(t-1)-1))/(Math.PI*(2*r/(t-1)-1));break;case"rectangular":for(r=0;r<t;r++)this.windowValues[r]=1;break;case"triangular":for(r=0;r<t;r++)this.windowValues[r]=2/t*(t/2-Math.abs(r-(t-1)/2));break;default:throw Error("No such window function '"+a+"'")}for(var i=1,h=t>>1;i<t;){for(r=0;r<i;r++)this.reverseTable[r+i]=this.reverseTable[r]+h;i<<=1,h>>=1}for(r=0;r<t;r++)this.sinTable[r]=Math.sin(-Math.PI/r),this.cosTable[r]=Math.cos(-Math.PI/r);this.calculateSpectrum=function(t){var e,a,s,r=this.bufferSize,i=this.cosTable,h=this.sinTable,l=this.reverseTable,n=new Float32Array(r),o=new Float32Array(r),c=2/this.bufferSize,f=Math.sqrt,p=new Float32Array(r/2),d=Math.floor(Math.log(r)/Math.LN2);if(Math.pow(2,d)!==r)throw"Invalid buffer size, must be a power of 2.";if(r!==t.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+r+" Buffer Size: "+t.length;for(var u,w,b,m,g,v,M,y,S=1,x=0;x<r;x++)n[x]=t[l[x]]*this.windowValues[l[x]],o[x]=0;for(;S<r;){u=i[S],w=h[S],b=1,m=0;for(var k=0;k<S;k++){for(x=k;x<r;)v=b*n[g=x+S]-m*o[g],M=b*o[g]+m*n[g],n[g]=n[x]-v,o[g]=o[x]-M,n[x]+=v,o[x]+=M,x+=S<<1;b=(y=b)*u-m*w,m=y*w+m*u}S<<=1}x=0;for(var T=r/2;x<T;x++)(s=c*f((e=n[x])*e+(a=o[x])*a))>this.peak&&(this.peakBand=x,this.peak=s),p[x]=s;return p}};export default class SpectrogramPlugin{static create(t){return{name:"spectrogram",deferInit:!(!t||!t.deferInit)&&t.deferInit,params:t,staticProps:{FFT},instance:SpectrogramPlugin}}constructor(t,e){this.params=t,this.wavesurfer=e,this.util=e.util,this.frequenciesDataUrl=t.frequenciesDataUrl,this._onScroll=t=>{this.updateScroll(t)},this._onReady=()=>{const a=this.drawer=e.drawer;if(this.container="string"==typeof t.container?document.querySelector(t.container):t.container,!this.container)throw Error("No container for WaveSurfer spectrogram");this.width=a.width,this.pixelRatio=this.params.pixelRatio||e.params.pixelRatio,this.fftSamples=this.params.fftSamples||e.params.fftSamples||512,this.height=this.fftSamples/2,this.noverlap=t.noverlap,this.windowFunc=t.windowFunc,this.alpha=t.alpha,this.createWrapper(),this.createCanvas(),this.render(),a.wrapper.addEventListener("scroll",this._onScroll),e.on("redraw",(()=>this.render()))}}init(){this.wavesurfer.isReady&&this._onReady(),this.wavesurfer.on("ready",this._onReady)}destroy(){this.unAll(),this.wavesurfer.un("ready",this._onReady),this.drawer.wrapper.removeEventListener("scroll",this._onScroll),this.wavesurfer=null,this.util=null,this.params=null,this.wrapper&&(this.wrapper.parentNode.removeChild(this.wrapper),this.wrapper=null)}createWrapper(){const t=this.container.querySelector("spectrogram");t&&this.container.removeChild(t);const e=this.wavesurfer.params;if(this.wrapper=document.createElement("spectrogram"),this.params.labels){const t=this.labelsEl=document.createElement("canvas");t.classList.add("spec-labels"),this.drawer.style(t,{left:0,position:"absolute",zIndex:9,height:this.height/this.pixelRatio+"px",width:55/this.pixelRatio+"px"}),this.wrapper.appendChild(t),this.loadLabels("rgba(68,68,68,0.5)","12px","10px","","#fff","#f7f7f7","center","#specLabels")}this.drawer.style(this.wrapper,{display:"block",position:"relative",userSelect:"none",webkitUserSelect:"none",height:this.height/this.pixelRatio+"px"}),(e.fillParent||e.scrollParent)&&this.drawer.style(this.wrapper,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.container.appendChild(this.wrapper),this.wrapper.addEventListener("click",(t=>{t.preventDefault();const e="offsetX"in t?t.offsetX:t.layerX;this.fireEvent("click",e/this.scrollWidth||0)}))}createCanvas(){const t=this.canvas=this.wrapper.appendChild(document.createElement("canvas"));this.spectrCc=t.getContext("2d"),this.util.style(t,{position:"absolute",zIndex:4})}render(){this.updateCanvasStyle(),this.frequenciesDataUrl?this.loadFrequenciesData(this.frequenciesDataUrl):this.getFrequencies(this.drawSpectrogram)}updateCanvasStyle(){const t=Math.round(this.width/this.pixelRatio)+"px";this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.width=t}drawSpectrogram(t,e){e.spectrCc,e.wavesurfer.backend.getDuration();const a=e.height,s=e.resample(t),r=e.buffer?2/e.buffer.numberOfChannels:1;let i,h;for(i=0;i<s.length;i++)for(h=0;h<s[i].length;h++){const t=255-s[i][h];e.spectrCc.fillStyle="rgb("+t+", "+t+", "+t+")",e.spectrCc.fillRect(i,a-h*r,1,r)}}getFrequencies(t){const e=this.fftSamples,a=this.buffer=this.wavesurfer.backend.buffer,s=a.getChannelData(0),r=a.length,i=a.sampleRate,h=[];if(!a)return void this.fireEvent("error","Web Audio buffer is not available");let l=this.noverlap;if(!l){const t=a.length/this.canvas.width;l=Math.max(0,Math.round(e-t))}const n=new FFT(e,i,this.windowFunc,this.alpha);Math.floor(r/(e-l));let o=0;for(;o+e<s.length;){const t=s.slice(o,o+e),a=n.calculateSpectrum(t),r=new Uint8Array(e/2);let i;for(i=0;i<e/2;i++)r[i]=Math.max(-255,45*Math.log10(a[i]));h.push(r),o+=e-l}t(h,this)}loadFrequenciesData(t){const e=this.util.ajax({url:t});return e.on("success",(t=>this.drawSpectrogram(JSON.parse(t),this))),e.on("error",(t=>this.fireEvent("error","XHR error: "+t.target.statusText))),e}freqType(t){return t>=1e3?(t/1e3).toFixed(1):Math.round(t)}unitType(t){return t>=1e3?"KHz":"Hz"}loadLabels(t,e,a,s,r,i,h,l){t=t||"rgba(68,68,68,0)",e=e||"12px",a=a||"10px",s=s||"Helvetica",r=r||"#fff",i=i||"#fff",h=h||"center",l=l||"#specLabels";const n=this.height||512,o=n/256*5,c=(this.wavesurfer.backend.ac.sampleRate/2-0)/o,f=this.labelsEl.getContext("2d");let p;for(this.labelsEl.height=this.height,this.labelsEl.width=55,f.fillStyle=t,f.fillRect(0,0,55,n),f.fill(),p=0;p<=o;p++){f.textAlign=h,f.textBaseline="middle";const t=0+c*p,l=(Math.round(t/(this.sampleRate/2)*this.fftSamples),this.freqType(t)),o=this.unitType(t),d=16,u=2;0==p?(f.fillStyle=i,f.font=a+" "+s,f.fillText(o,d+24,n+p-10),f.fillStyle=r,f.font=e+" "+s,f.fillText(l,d,n+p-10)):(f.fillStyle=i,f.font=a+" "+s,f.fillText(o,d+24,n-50*p+u),f.fillStyle=r,f.font=e+" "+s,f.fillText(l,d,n-50*p+u))}}updateScroll(t){this.wrapper&&(this.wrapper.scrollLeft=t.target.scrollLeft)}resample(t){const e=this.width,a=[],s=1/t.length,r=1/e;let i;for(i=0;i<e;i++){const e=new Array(t[0].length);let h;for(h=0;h<t.length;h++){const a=h*s,l=a+s,n=i*r,o=n+r,c=l<=n||o<=a?0:Math.min(Math.max(l,n),Math.max(o,a))-Math.max(Math.min(l,n),Math.min(o,a));let f;if(c>0)for(f=0;f<t[0].length;f++)null==e[f]&&(e[f]=0),e[f]+=c/r*t[h][f]}const l=new Uint8Array(t[0].length);let n;for(n=0;n<t[0].length;n++)l[n]=e[n];a.push(l)}return a}}