/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as e}from"../../../lit/index.js";window.A11yMediaStateManager=window.A11yMediaStateManager||{},window.A11yMediaStateManager.requestAvailability=()=>(window.A11yMediaStateManager.instance||(window.A11yMediaStateManager.instance=document.createElement("a11y-media-state-manager"),document.body.appendChild(window.A11yMediaStateManager.instance)),window.A11yMediaStateManager.instance);class A11yMediaStateManager extends e{static get tag(){return"a11y-media-state-manager"}static get properties(){return{...super.properties,players:{type:Array},activePlayer:{type:Object}}}constructor(){super(),this.players=[],this.__stickyManager=e=>this.setStickyPlayer(e.detail),this.__fullscreenManager=e=>this._handleFullscreen(e.detail),this.__scrollChecker=e=>setTimeout(this._checkScroll(),500),this.__playerLoader=e=>this.players.push(e.detail),window.A11yMediaStateManager.instance||(window.A11yMediaStateManager.instance=this)}checkConcurrentPlayers(){let e=this.activePlayer;this.players.forEach((t=>{e&&t!==e&&(t.fullscreen&&t.toggleFullscreen(!1),t.allowConcurrent&&e.allowConcurrent&&!e.fullscreen||t.pause())}))}setActivePlayer(e){this.activePlayer=e,this.checkConcurrentPlayers()}setStickyPlayer(e){this._getParentNode(e);e!==this.activePlayer&&void 0!==this.activePlayer&&null!==this.activePlayer&&this.activePlayer.toggleSticky(!1),this.setActivePlayer(e),setTimeout(this._checkScroll(),500)}_handleFullscreen(e){e&&e.fullscreen&&this.setActivePlayer(e)}_checkScroll(){if(this.__wait)return;this.__wait=!0;let e=window.pageYOffset,t=e+window.innerHeight;if(!this.activePlayer||this.activePlayer.fullscreen);else if(this.activePlayer.__playing){let a=this._getParentNode(this.activePlayer),i=a.offsetTop,r=a.offsetHeight,n=i+.8*r;i+.2*r>t||n<e?this.activePlayer.toggleSticky(!0):this.activePlayer.toggleSticky(!1)}else this.activePlayer.toggleSticky(!1);setTimeout((e=>this.__wait=!1),500)}_getParentNode(e){let t=e.parentNode;return null!=t&&t.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&(t=t.host),t}connectedCallback(){super.connectedCallback(),window.addEventListener("a11y-player-playing",this.__stickyManager),window.addEventListener("fullscreen-toggle",this._handleFullscreen),window.addEventListener("scroll",this.__scrollChecker),window.addEventListener("a11y-player",this.__playerLoader)}disconnectedCallback(){let e=this;window.removeEventListener("a11y-player",e.__playerLoader),window.removeEventListener("a11y-player-playing",e.__stickyManager),window.removeEventListener("fullscreen-toggle",e.__fullscreenManager),window.removeEventListener("scroll",e.__scrollChecker),super.disconnectedCallback()}}window.customElements.define(A11yMediaStateManager.tag,A11yMediaStateManager);export{A11yMediaStateManager};