/**
 * Copyright 2019 Penn State University
 * @license Apache-2.0, see License.md for full text.
 */
import{html as e,PolymerElement as t}from"../../../../@polymer/polymer/polymer-element.js";import{RichTextEditorButton as i}from"./rich-text-editor-button.js";import"../../../simple-tooltip/simple-tooltip.js";import"../../../../@polymer/iron-icons/iron-icons.js";import"../singletons/rich-text-editor-selection.js";import"../singletons/rich-text-editor-prompt.js";import"./rich-text-editor-button-styles.js";class RichTextEditorPromptButton extends i{constructor(){super()}static get properties(){return{editableSelection:{type:Boolean,value:!1},fields:{type:Array,value:[{property:"",title:"Text",description:"The inner text",inputMethod:"textfield"}]},inlineWidget:{name:"inlineWidget",type:Boolean,value:!1},tag:{name:"tag",type:String,value:"span"},value:{type:Object,value:{"":null,id:null}},__fields:{type:Array,value:[]},__oldValue:{name:"__oldValue",type:Object,value:null},__prompt:{name:"__prompt",type:Object,value:null},__selection:{name:"__selection",type:Object,value:null},__selectionContents:{name:"__selectionContents",type:Object,value:null}}}static get tag(){return"rich-text-editor-prompt-button"}ready(){super.ready();this.__prompt=window.RichTextEditorPrompt.requestAvailability(),this.__selection=window.RichTextEditorSelection.requestAvailability()}_buttonTap(e){e.preventDefault(),this.selectRange(),this.open()}getCleanValue(e){let t=this.value[e];return t&&"string"==typeof t&&(t=t.replace(/[\s\n\t]+/g," ").trim()),t}cancel(){this.value=this.__oldValue,this.confirm()}confirm(){this.updateSelection(),this.deselect()}deselect(){this.__prompt.clearTarget(""),this.__selection.normalize(),this.__selection.parentNode.insertBefore(this.__selectionContents,this.__selection),this.__selection.range.selectNode(this.__selectionContents),this.__selection.range.collapse(),this.__selection.hidden=!0}_editorChanged(e,t){let i=this,n=e?document.getElementById(e):null,l=t?document.getElementById(t):null;n&&n.addEventListener("click",e=>{i._editInlineWidget(n,e)},!0),l&&l.removeEventListener("click",e=>{i._editInlineWidget(l,e)},!0),super._editorChanged(e,t)}_editInlineWidget(e,t){return!(e.getAttribute("contenteditable")&&this.inlineWidget&&t.target.tagName&&t.target.tagName.toLowerCase()===this.tag)||(t.stopPropagation(),t.preventDefault(),this.selectWidget(t.target),this.open(),!1)}selectWidget(e){this.__selection.selectNode(e),this.__selectionContents=e}selectRange(){this.__selectionContents=this.__selection.expandSelection(this.tag)}open(){this.__selection.addHighlight(),this.updatePrompt(),this.__prompt.setTarget(this),this.dispatchEvent(new CustomEvent("select",{detail:this}))}updatePrompt(){this.__oldValue=this.value;let e=this.__selectionContents;this.__fields=[],e.normalize(),e.innerHTML.trim(),this.fields.forEach(t=>{this.__fields.push(t),t.property&&""!==t.property?this.value[t.property]=e?e.getAttribute(t.property):null:t.slot&&""!==t.slot?this.value[t.slot]=e&e.querySelector(t.slot)?e.querySelector(t.slot).innerHTML.replace(/[\s\n\t]+/g," ").trim():null:(this.value[""]=e?e.innerHTML.replace(/[\s\n\t]+/g," ").trim():"",this.__slotInputMethod||(this.__slotInputMethod=t.inputMethod),1===e.childNodes.length&&e.childNodes[0].nodeType!==Node.TEXT_NODE||e.childNodes.length>1?(t.hidden=!this.editableSelection,t.inputMethod="code-editor"):(t.inputMethod=this.__slotInputMethod,t.hidden=!1))})}updateSelection(){this.__selection.innerHTML="";let e=document.createTextNode(this.getCleanValue(""));this._getTagNeeded(this.value)?(e=document.createElement(this.tag),this.fields.forEach(t=>{if(t.property)e.setAttribute(t.property,this.getCleanValue(t.property));else if(t.slot&&""!==t.slot){let i=this.getCleanValue(t.slot);e.innerHTML+=`<span slot="${t.slot}">${i}</slot>`}else e.innerHTML+=`${this.getCleanValue("")}`})):e.innerHTML+=`${this.getCleanValue("")}`,this.__selectionContents=e,e&&this.__selection.appendChild(e)}_getTagNeeded(e){return e&&this.getCleanValue("")&&""!==this.getCleanValue("")}}window.customElements.define(RichTextEditorPromptButton.tag,RichTextEditorPromptButton);export{RichTextEditorPromptButton};