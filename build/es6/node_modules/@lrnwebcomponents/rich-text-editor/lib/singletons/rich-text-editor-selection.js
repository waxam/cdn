/**
 * Copyright 2019 Penn State University
 * @license Apache-2.0, see License.md for full text.
 */
import{html as e,PolymerElement as t}from"../../../../@polymer/polymer/polymer-element.js";import"../rich-text-editor-styles.js";class RichTextEditorSelection extends t{static get template(){return e`
      <style include="rich-text-editor-styles">
        :host {
          background-color: var(--rich-text-editor-selection-bg);
          @apply --rich-text-editor-content-selection;
        }
        :host([hidden]) {
          display: none;
        }
      </style>
      <slot></slot>
    `}static get properties(){return{editor:{type:Object,value:null},hidden:{type:Boolean,value:!0,reflectToAttribute:!0},observer:{type:Object,value:null},range:{type:Object,value:null,observer:"_updateToolbar"},toolbar:{type:Object,value:null}}}static get tag(){return"rich-text-editor-selection"}connectedCallback(){super.connectedCallback();let e=this;document.addEventListener("selectionchange",t=>{e.range=e.getRange()}),document.addEventListener("select-rich-text-editor-editor",t=>{e._editorChange(t)}),document.addEventListener("deselect-rich-text-editor-editor",t=>{e._editorChange(t)}),this.setAttribute("id",this._generateUUID())}disconnectedCallback(){super.disconnectedCallback();let e=this;document.removeEventListener("selectionchange",t=>{e.range=e.getRange()}),document.removeEventListener("select-rich-text-editor-editor",t=>{e._editorChange(t)}),document.removeEventListener("deselect-rich-text-editor-editor",t=>{e._editorChange(t)})}expandSelection(e=null,t=null){return this.selectAncestor(e)||this.wrap(t?document.createElement(t):null)}getRange(){let e=window.getSelection();return e.getRangeAt&&e.rangeCount?e.getRangeAt(0):e||void 0}addHighlight(){this.range.surroundContents(this),this.range.selectNode(this.firstChild),this.dispatchEvent(new CustomEvent("highlight",{detail:this})),this.hidden=!1}getRangeContents(){return this.range?this.range.cloneContents():null}selectAncestor(e=null){let t=null,getMatchingTag=t=>!t||!t.tagName||e&&t.tagName.toLowerCase()!==e.toLowerCase()?t.parentNode&&1===t.parentNode.childNodes.length?getMatchingTag(t.parentNode):null:t;if(this.range){let e=this.range.commonAncestorContainer;t=getMatchingTag(e),t&&this.range.selectNode(t)}return t}selectNode(e=null){if(e){if(!this.range){let e=window.getSelection();this.range=document.createRange(),e.removeAllRanges(),e.addRange(this.range)}this.range.selectNode(e)}}selectNodeContents(e=null){if(e){if(!this.range){let e=window.getSelection();this.range=document.createRange(),e.removeAllRanges(),e.addRange(this.range)}this.range.selectNodeContents(e)}}wrap(e){return e=e||document.createElement("span"),this.range.surroundContents(e),e}_editorChange(e,t=!1){let n=this,i=n.editor!==e.detail.editor,o=n.toolbar!==e.detail.toolbar;if(t||i||o){window.getSelection().removeAllRanges(),n.editor=e.detail.editor,n.toolbar=e.detail.toolbar,n.observer&&n.observer.disconnect(),!t&&e.detail.editor&&(n.observer=new MutationObserver(e=>{n.range=n.getRange()}),n.observer.observe(e.detail.editor,{attributes:!1,childList:!0,subtree:!0,characterData:!1}))}}_generateUUID(){let e=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return"rte-"+"ss-s-s-s-sss".replace(/s/g,e)}_updateToolbar(){this.toolbar&&(this.toolbar.range=this.range)}}window.customElements.define(RichTextEditorSelection.tag,RichTextEditorSelection);export{RichTextEditorSelection};window.RichTextEditorSelection={},window.RichTextEditorSelection.instance=null,window.RichTextEditorSelection.requestAvailability=function(){return null==window.RichTextEditorSelection.instance&&(window.RichTextEditorSelection.instance=document.createElement("rich-text-editor-selection"),document.body.appendChild(window.RichTextEditorSelection.instance)),window.RichTextEditorSelection.instance};