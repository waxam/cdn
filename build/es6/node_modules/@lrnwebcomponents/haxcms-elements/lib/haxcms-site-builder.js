import{html,Polymer}from"../../../@polymer/polymer/polymer-legacy.js";import{setPassiveTouchGestures}from"../../../@polymer/polymer/lib/utils/settings.js";import{dom}from"../../../@polymer/polymer/lib/legacy/polymer.dom.js";import{pathFromUrl}from"../../../@polymer/polymer/lib/utils/resolve-url.js";import*as async from"../../../@polymer/polymer/lib/utils/async.js";import"../../json-outline-schema/json-outline-schema.js";import"../../simple-toast/simple-toast.js";import"../../simple-modal/simple-modal.js";import"../../../@polymer/iron-ajax/iron-ajax.js";import"../../../@polymer/paper-progress/paper-progress.js";import{observable,decorate,computed}from"../../../mobx/lib/mobx.module.js";import{store}from"./haxcms-site-store.js";import"./haxcms-site-router.js";import"./haxcms-editor-builder.js";let HAXCMSSiteBuilder=Polymer({_template:html`
    <style>
      :host {
        display: block;
      }
      :host #slot {
        background-color: white;
        opacity: 0.2;
        transition: all 1s linear;
        visibility: hidden;
      }
      :host([loading]) #slot {
        opacity: 0.8;
      }
      :host([theme-loaded]) #slot {
        opacity: 1;
        visibility: visible;
      }
      paper-progress {
        display: block;
        width: 100%;
        --paper-progress-active-color: rgba(255, 255, 255, 0.5);
        --paper-progress-container-color: transparent;
      }
    </style>
    <haxcms-site-router base-uri="[[baseURI]]"></haxcms-site-router>
    <paper-progress
      hidden\$="[[!loading]]"
      value="100"
      indeterminate=""
      bottom-item=""
    ></paper-progress>
    <iron-ajax
      id="manifest"
      url="[[outlineLocation]][[file]][[__timeStamp]]"
      handle-as="json"
      debounce-duration="250"
      last-response="{{manifest}}"
    ></iron-ajax>
    <iron-ajax
      id="activecontent"
      url="[[outlineLocation]][[activeItem.location]][[__timeStamp]]"
      handle-as="text"
      loading="{{loading}}"
      debounce-duration="250"
      last-response="{{activeItemContent}}"
    ></iron-ajax>
    <div id="slot"><slot></slot></div>
  `,is:"haxcms-site-builder",properties:{queryParams:{type:Object},loading:{type:Boolean,value:!1,reflectToAttribute:!0},outlineLocation:{type:String,notify:!0,reflectToAttribute:!0},manifest:{type:Object,notify:!0,observer:"_manifestChanged"},themeElementName:{type:String,reflectToAttribute:!0,observer:"_themeNameChanged"},themeElement:{type:Object},themeData:{type:Object,value:{"simple-blog":"../../../@lrnwebcomponents/simple-blog/simple-blog.js","outline-player":"../../../@lrnwebcomponents/outline-player/outline-player.js","lrnapp-book":"../../../@lrnwebcomponents/elmsln-apps/lib/lrnapp-book/lrnapp-book.js","haxcms-dev-theme":"haxcms-dev-theme.js"}},__imported:{type:Object,value:{}},themeLoaded:{type:Boolean,reflectToAttribute:!0,value:!1},activeItem:{type:Object,notify:!0,observer:"_activeItemChanged"},activeItemContent:{type:String,notify:!0,observer:"_activeItemContentChanged"},file:{type:String,observer:"_fileChanged"},baseURI:{type:String}},created:function(){setPassiveTouchGestures(!0);window.JSONOutlineSchema.requestAvailability();window.SimpleModal.requestAvailability();window.SimpleToast.requestAvailability();window.addEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));window.addEventListener("haxcms-trigger-update-page",this._triggerUpdatedPage.bind(this));window.addEventListener("json-outline-schema-active-item-changed",this._setActiveItem.bind(this))},attached:function(){document.body.appendChild(document.createElement("haxcms-editor-builder"));async.microTask.run(()=>{if(window.cmsSiteEditor&&this.manifest){window.cmsSiteEditor.jsonOutlineSchema=this.manifest}})},detached:function(){window.removeEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));window.removeEventListener("haxcms-trigger-update-page",this._triggerUpdatedPage.bind(this));window.removeEventListener("json-outline-schema-active-item-changed",this._setActiveItem.bind(this))},_setActiveItem:function(e){this.set("activeItem",e.detail);this.notifyPath("activeItem.*");this.set("queryParams.page",e.detail.id);this.notifyPath("queryParams.page");var time=500;if(window.HaxStore&&window.HaxStore.ready){time=10}setTimeout(()=>{if(window.cmsSiteEditor.instance&&window.cmsSiteEditor.haxCmsSiteEditorUIElement){window.cmsSiteEditor.haxCmsSiteEditorUIElement.set("activeItem",this.activeItem)}},time)},_activeItemContentChanged:function(newValue){if(newValue){var html=newValue;if(null!==html){this.wipeSlot(this.themeElement,"*");html=this.encapScript(newValue);async.microTask.run(()=>{setTimeout(()=>{let frag=document.createRange().createContextualFragment(html);dom(this.themeElement).appendChild(frag);this.fire("json-outline-schema-active-body-changed",html)},50)});if(this.manifest.metadata.dynamicElementLoader){let tagsFound=this.findTagsInHTML(html);const basePath=pathFromUrl(decodeURIComponent(import.meta.url));for(var i in tagsFound){const tagName=tagsFound[i];if(this.manifest.metadata.dynamicElementLoader[tagName]&&!window.customElements.get(tagName)){import(`${basePath}../../../${this.manifest.metadata.dynamicElementLoader[tagName]}`).then(()=>{}).catch(error=>{console.log(error)})}}}}}},findTagsInHTML:function(html){let tags={},tag="";var matches=html.match(/<\/(\S*?)-(\S*?)>/g);for(var i in matches){tag=matches[i].replace("</","").replace(">","");tags[tag]=tag}return tags},encapScript:function(html){html=html.replace(/<script[\s\S]*?>/gi,"&lt;script&gt;");html=html.replace(/<\/script>/gi,"&lt;/script&gt;");html=html.replace(/<style[\s\S]*?>/gi,"&lt;style&gt;");html=html.replace(/<\/style>/gi,"&lt;/style&gt;");html=html.replace(/<template[\s\S]*?>[\s\S]*?&lt;script[\s\S]*?&gt;[\s\S]*?&lt;\/script&gt;/gi,function(match){match=match.replace("&lt;script&gt;","<script>");match=match.replace("&lt;/script&gt;","</script>");match=match.replace("&lt;style&gt;","<style>");match=match.replace("&lt;/style&gt;","</style>");return match});return html},_activeItemChanged:function(newValue){if(typeof newValue.id!==typeof void 0){this.__timeStamp="?"+Math.floor(Date.now()/1e3);this.$.activecontent.generateRequest()}else if(typeof newValue.id===typeof void 0){async.microTask.run(()=>{this.wipeSlot(this.themeElement,"*")});this.fire("json-outline-schema-active-body-changed",null)}},_triggerUpdatedData:function(){this.__timeStamp="?"+Math.floor(Date.now()/1e3);this.$.manifest.generateRequest()},_triggerUpdatedPage:function(){this.__timeStamp="?"+Math.floor(Date.now()/1e3);this.$.activecontent.generateRequest()},_fileChanged:function(newValue){if(typeof newValue!==typeof void 0){this.$.manifest.generateRequest()}},_manifestChanged:function(newValue){if(newValue){if(!newValue.metadata.dynamicElementLoader){newValue.metadata.dynamicElementLoader={"a11y-gif-player":"@lrnwebcomponents/a11y-gif-player/a11y-gif-player.js","citation-element":"@lrnwebcomponents/citation-element/citation-element.js","hero-banner":"@lrnwebcomponents/hero-banner/hero-banner.js","image-compare-slider":"@lrnwebcomponents/image-compare-slider/image-compare-slider.js","license-element":"@lrnwebcomponents/license-element/license-element.js","lrn-aside":"@lrnwebcomponents/lrn-aside/lrn-aside.js","lrn-calendar":"@lrnwebcomponents/lrn-calendar/lrn-calendar.js","lrn-math":"@lrnwebcomponents/lrn-math/lrn-math.js","lrn-table":"@lrnwebcomponents/lrn-table/lrn-table.js","lrn-vocab":"@lrnwebcomponents/lrn-vocab/lrn-vocab.js","lrndesign-blockquote":"@lrnwebcomponents/lrndesign-blockquote/lrndesign-blockquote.js","magazine-cover":"@lrnwebcomponents/magazine-cover/magazine-cover.js","media-behaviors":"@lrnwebcomponents/media-behaviors/media-behaviors.js","media-image":"@lrnwebcomponents/media-image/media-image.js","meme-maker":"@lrnwebcomponents/meme-maker/meme-maker.js","multiple-choice":"@lrnwebcomponents/multiple-choice/multiple-choice.js","paper-audio-player":"@lrnwebcomponents/paper-audio-player/paper-audio-player.js","person-testimonial":"@lrnwebcomponents/person-testimonial/person-testimonial.js","place-holder":"@lrnwebcomponents/place-holder/place-holder.js","q-r":"@lrnwebcomponents/q-r/q-r.js","full-width-image":"@lrnwebcomponents/full-width-image/full-width-image.js","self-check":"@lrnwebcomponents/self-check/self-check.js","simple-concept-network":"@lrnwebcomponents/simple-concept-network/simple-concept-network.js","stop-note":"@lrnwebcomponents/stop-note/stop-note.js","tab-list":"@lrnwebcomponents/tab-list/tab-list.js","task-list":"@lrnwebcomponents/task-list/task-list.js","video-player":"@lrnwebcomponents/video-player/video-player.js","wave-player":"@lrnwebcomponents/wave-player/wave-player.js","wikipedia-query":"@lrnwebcomponents/wikipedia-query/wikipedia-query.js"}}store.manifest=newValue;window.cmsSiteEditor.jsonOutlineSchema=newValue;this.themeElementName=newValue.metadata.theme;this.fire("json-outline-schema-changed",newValue)}},_themeNameChanged:function(newValue,oldValue){if(newValue&&oldValue){if(typeof window.cmsSiteEditor.instance.haxCmsSiteEditorElement!==typeof void 0){window.cmsSiteEditor.instance.appendChild(window.cmsSiteEditor.instance.haxCmsSiteEditorElement)}}if(newValue){this.themeLoaded=!1;var themeName=newValue;if(typeof this.themeData[themeName]===typeof void 0){console.log("HAXCMS developer: "+themeName+" is not a valid theme name");this.themeElementName="simple-blog";return!1}this.wipeSlot(this,"*");this.themeElement=document.createElement(themeName);this.themeElement.manifest=this.manifest;if(typeof this.__imported[themeName]!==typeof void 0){dom(this).appendChild(this.themeElement);this.themeLoaded=!0}else{try{import(pathFromUrl(decodeURIComponent(import.meta.url))+this.themeData[themeName]).then(()=>{dom(this).appendChild(this.themeElement);this.__imported[themeName]=themeName;this.themeLoaded=!0})}catch(err){dom(this).appendChild(this.themeElement);this.themeLoaded=!0}}}},wipeSlot:function(element,slot="*"){if("*"===slot){while(null!==dom(element).firstChild){dom(element).removeChild(dom(element).firstChild)}}else{for(var i in dom(element).childNodes){if(typeof dom(element).childNodes[i]!==typeof void 0&&dom(element).childNodes[i].slot===slot){dom(element).removeChild(dom(element).childNodes[i])}}}}});export{HAXCMSSiteBuilder};