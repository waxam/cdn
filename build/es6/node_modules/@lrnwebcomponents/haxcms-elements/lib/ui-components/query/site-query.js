import{html,PolymerElement}from"../../../../../@polymer/polymer/polymer-element.js";import{MutableData}from"../../../../../@polymer/polymer/lib/mixins/mutable-data.js";import{store}from"../../core/haxcms-site-store.js";import{autorun,toJS}from"../../../../../mobx/lib/mobx.module.js";Object.byString=function(o,s){s=s.replace(/\[(\w+)\]/g,".$1");s=s.replace(/^\./,"");for(var a=s.split("."),i=0,n=a.length,k;i<n;++i){k=a[i];if(k in o){o=o[k]}else{return}}return o};class SiteQuery extends MutableData(PolymerElement){static get tag(){return"site-query"}static get properties(){return{routerManifest:{type:Object},activeId:{type:String},result:{type:Array,notify:!0},__result:{type:Array,computed:"_computeResult(entity, conditions, sort, routerManifest, activeId, limit, startIndex, random, forceRebuild)",observer:"_noticeResultChange"},conditions:{type:Object,notify:!0,value:{}},sort:{type:Object,notify:!0,value:{order:"ASC"}},forceRebuild:{type:Boolean,notify:!0,value:!1},limit:{type:Number,value:0},startIndex:{type:Number,value:0},random:{type:Boolean,value:!1},entity:{type:String,value:"node"}}}_computeResult(entity,conditions,sorts,routerManifest,activeId,limit,startIndex,random){if(routerManifest&&routerManifest.items){var items=Object.assign([],toJS(routerManifest.items));if("node"!==entity){var newItems=[];for(var i in items){if(typeof Object.byString(items[i],entity)!==typeof void 0){let tmp,val=Object.byString(items[i],entity);if("object"===typeof val||"array"===typeof val){tmp=Object.assign([],Object.byString(items[i],entity))}else{tmp=val}if("object"===typeof tmp||"array"===typeof tmp){for(var i in tmp){if("object"===typeof tmp[i]||"array"===typeof tmp[i]){tmp[i]._node=Object.assign({},items[i]);newItems.push(tmp[i])}else{let tmp2={_node:Object.assign({},items[i]),value:tmp[i]};newItems.push(tmp2)}}}else{let tmp2={_node:Object.assign({},items[i]),value:tmp};newItems.push(tmp2)}}}items=Object.assign([],newItems)}if(conditions&&items){for(var i in conditions){items=items.filter(item=>{if("$activeId"===conditions[i]){if(Object.byString(item,i)!==activeId){return!1}return!0}else if("$firstId"===conditions[i]){if(Object.byString(item,i)!==items[0].id){return!1}return!0}else{if(Object.byString(item,i)!==conditions[i]){return!1}return!0}})}}if(sorts){for(var i in sorts){items.sort((item1,item2)=>{if("ASC"===sorts[i]){if(Object.byString(item1,i)<Object.byString(item2,i)){return-1}else if(Object.byString(item1,i)>Object.byString(item2,i)){return 1}else{return 0}}else{if(Object.byString(item1,i)>Object.byString(item2,i)){return-1}else if(Object.byString(item1,i)<Object.byString(item2,i)){return 1}else{return 0}}})}}if(random){items.sort(()=>{if(Math.random()<Math.random()){return-1}else if(Math.random()>Math.random()){return 1}else{return 0}})}if(0!==startIndex&&items.length>startIndex){while(0<startIndex){items.shift();startIndex--}}else if(items.length<startIndex){return[]}if(0!==limit){while(items.length>limit){items.pop()}}return items}return[]}_noticeResultChange(newValue){this.set("result",newValue);this.notifyPath("result")}connectedCallback(){super.connectedCallback();this.__disposer=autorun(()=>{this.routerManifest=Object.assign({},toJS(store.routerManifest))});this.__disposer2=autorun(()=>{this.activeId=toJS(store.activeId)})}disconnectedCallback(){super.disconnectedCallback();this.__disposer();this.__disposer2()}}window.customElements.define(SiteQuery.tag,SiteQuery);export{SiteQuery};