import{observable as e,decorate as t,computed as i,autorun as a,action as s,toJS as n}from"../../../../mobx/lib/mobx.module.js";import{varExists as d,varGet as r}from"../../../utils/utils.js";import{JsonOutlineSchema as o}from"../../../json-outline-schema/json-outline-schema.js";class Store{constructor(){this.location=null,this.jwt=null,this.editMode=!1,this.manifest=null,this.activeItemContent="",this.themeElement=null,this.activeId=null,this.userData={},this.cmsSiteEditor={instance:null},this.cmsSiteEditorBackend={instance:null},this.dashboardOpened=!1}loadManifest(e,t=null){if(null==t&&window&&(t=window),d(e,"metadata.siteName")){let t=r(e,"publishing.git",{});e.metadata.site={name:e.metadata.siteName,git:t,created:e.metadata.created,updated:e.metadata.updated},e.metadata.theme.variables={image:e.metadata.image,icon:e.metadata.icon,hexCode:e.metadata.hexCode,cssVariable:e.metadata.cssVariable},e.metadata.node={dynamicElementLoader:e.metadata.dynamicElementLoader,fields:e.metadata.fields},delete e.metadata.publishing,delete e.metadata.created,delete e.metadata.updated,delete e.metadata.siteName,delete e.metadata.image,delete e.metadata.icon,delete e.metadata.hexCode,delete e.metadata.cssVariable,delete e.metadata.dynamicElementLoader,delete e.metadata.fields}e.items.forEach((e,t,i)=>{e.slug||(i[t].slug=e.location.replace("pages/","").replace("/index.html",""))});var i=new o,a=i.itemsToNodes(e.items),s=i.nodesToItems(a),n=[];for(var c in s)n.push(e.items.find(e=>e.id===s[c].id));e.items=n,this.manifest=e,t.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:e}))}cmsSiteEditorAvailability(){return this.cmsSiteEditor.instance||(this.cmsSiteEditor.instance=document.createElement("haxcms-site-editor")),this.cmsSiteEditor.instance}get processedItems(){}_computeItems(e,t,i,a,s){if(s){let n,d=[],r=[];switch(s.items.forEach(e=>{e.parent||d.push(e)}),a){case"parent":n=s.items.find(e=>i===e.id),n&&(i=n.parent);break;case"ancestor":for(n=s.items.find(e=>i===e.id);n&&null!=n.parent;)n=s.items.find(e=>e.id==n.parent);n&&(i=n.id)}return d.forEach((a,s)=>{this._spiderChildren(a,r,e,t,i,!1)}),r}}_setChildren(e,t){const i=t.filter(t=>e.id===t.parent);e.children=i,e.children.length>0&&e.children.forEach(e=>{this._setChildren(e,t)})}get routerManifest(){const e=this.manifest;if(document.body.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:e})),e&&void 0!==e.items){let i=JSON.parse(window.localStorage.getItem("HAXCMSSystemData"));var t={};null==i&&(i={manifests:{}},i.manifests[e.id]={accessData:{}},window.localStorage.setItem("HAXCMSSystemData",JSON.stringify(i))),i&&void 0!==i.manifests&&void 0!==i.manifests[e.id]&&"undefined"!==i.manifests[e.id].accessData&&(t=i.manifests[e.id].accessData);let a=e.items.map(i=>{let a=null,s=null,n=e.items.find(e=>i.parent===e.id);n&&(a=n.location,s=n.slug);let d=i.metadata;void 0!==t[i.id]&&(d.accessData=t[i.id]);let r=i.location,o=i.slug;return Object.assign({},i,{parentLocation:a,parentSlug:s,location:r,slug:o,metadata:d})});if(a.forEach((e,t)=>{this._setChildren(e,a)}),!0===r(e,"metadata.site.settings.publishPagesOn",!1)){const filterHiddenParentsRecursive=e=>{if(!1===e.metadata.published)return!1;const t=a.find(t=>t.id===e.parent);return!t||filterHiddenParentsRecursive(t)};a=a.filter(e=>filterHiddenParentsRecursive(e))}return Object.assign({},e,{items:a,accessData:t})}}get siteTitle(){const e=this.manifest;return e&&e.title?e.title:""}get homeLink(){if(this.manifest){const e=this.manifest.items.find(e=>void 0!==e.id);if(e)return e.slug}return"/"}get activeItem(){let e=this.findItem(this.activeId);return e||null}get activeItemFields(){if(this.activeItem&&this.activeItem.metadata){let e={title:this.activeItem.title,description:this.activeItem.description,location:this.activeItem.location,slug:this.activeItem.slug,created:this.activeItem.metadata.created,updated:this.activeItem.metadata.created};if(this.activeItem.metadata.fields)return Object.assign({},e,this.activeItem.metadata.fields)}}get themeData(){if(this.manifest){var e={};return e=d(this.manifest,"metadata.theme")?this.manifest.metadata.theme:{"haxcms-basic-theme":{element:"haxcms-basic-theme",path:"@lrnwebcomponents/haxcms-elements/lib/core/themes/haxcms-basic-theme.js",name:"Basic theme",variables:{image:"assets/banner.jpg",icon:"icons:record-voice-over",hexCode:"#da004e",cssVariable:"pink"}}},this.activeItem&&d(this.activeItem,"metadata.theme")?this.activeItem.metadata.theme:e}}get activeManifestIndex(){if(this.manifest&&this.manifest.items&&this.activeId)for(var e in this.manifest.items)if(this.manifest.items[e].id===this.activeId)return parseInt(e);return-1}get activeRouterManifestIndex(){if(this.routerManifest&&this.routerManifest.items&&this.activeId)for(var e in this.routerManifest.items)if(this.routerManifest.items[e].id===this.activeId)return parseInt(e);return-1}get activeManifestIndexCounter(){return null!==this.activeManifestIndex?1+this.activeManifestIndex:0}get activeTitle(){return this.activeItem?this.activeItem.title:""}get parentTitle(){if(this.manifest&&this.activeItem){let e=this.manifest.items.find(e=>this.activeItem.parent===e.id);if(e)return e.title}return""}get isLoggedIn(){return!(!this.jwt||"null"==this.jwt)}get ancestorTitle(){if(this.manifest&&this.activeItem){let e=this.manifest.items.find(e=>this.activeItem.parent===e.id);for(;e&&null!=e.parent;)e=this.manifest.items.find(t=>t.id==e.parent);if(e)return e.title}return""}findItem(e){return this.manifest&&e?this.manifest.items.find(t=>t.id===e):null}spiderChildren(e,t,i,a,s,n,d){e.id===s||n?(n||(n=!0,!d&&e.indent>=i&&(i+=e.indent,a+=e.indent)),e.indent>=i&&e.indent<=a&&t.push(e),e.children.length>0&&e.children.forEach(e=>{this.spiderChildren(e,t,i,a,s,n,d)})):e.children.length>0&&e.children.forEach(e=>{this.spiderChildren(e,t,i,a,s,n,d)})}computeItems(e,t,i,a,s,n){if(s){let d,r=[],o=[];switch(s.items.forEach(e=>{e.parent||r.push(e)}),a){case"parent":d=s.items.find(e=>i===e.id),d&&(i=d.parent);break;case"ancestor":for(d=s.items.find(e=>i===e.id);d&&null!=d.parent;)d=s.items.find(e=>e.id==d.parent);d&&(i=d.id)}return s.items.forEach((a,s)=>{store.spiderChildren(a,o,e,t,i,!1,n)}),o}}}t(Store,{location:e.ref,editMode:e,jwt:e,dashboardOpened:e,userData:e,manifest:e,activeItemContent:e,themeElement:e,routerManifest:i,siteTitle:i,isLoggedIn:i,themeData:i,homeLink:i,activeId:e,activeItem:i,activeItemFields:i,activeManifestIndex:i,activeManifestIndexCounter:i,activeTitle:i,parentTitle:i,ancestorTitle:i,changeActiveItem:s.bound});export const store=new Store;window.HAXCMS=window.HAXCMS||{},window.HAXCMS.requestAvailability=()=>(window.HAXCMS.instance||(window.HAXCMS.instance=document.createElement("haxcms-site-store"),document.body.appendChild(window.HAXCMS.instance)),window.HAXCMS.instance),window.HAXCMS.requestAvailability();class HAXCMSSiteStore extends HTMLElement{constructor(){super(),this.storePieces={},this.store=store,this.source="",a(()=>{if(store.location&&store.location.route&&store.location.route.component){const e=store.location.route.name;store.manifest.items.filter(t=>t.id===e)&&(store.activeId=e)}}),a(()=>{const e=n(store.findItem(store.activeId));e&&document.body.dispatchEvent(new CustomEvent("json-outline-schema-active-item-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:e}))}),a(()=>{const e=n(store.editMode);window.HaxStore&&window.HaxStore.write&&(window.dispatchEvent(new CustomEvent("haxcms-edit-mode-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:e})),window.HaxStore.write("editMode",e,window.HaxStore.instance),window.HaxStore.instance&&window.HaxStore.instance.globalPreferences.haxVoiceCommands&&setTimeout(()=>{window.HaxStore.instance.__hal.auto=!0},10))})}getApplicationContext(){let e="";if("undefined"!=typeof DatArchive)e="beaker";else switch(window.HAXCMSContext){case"published":case"nodejs":case"php":case"11ty":case"demo":case"desktop":e=window.HAXCMSContext;break;default:e="php"}return e}static get tag(){return"haxcms-site-store"}static get observedAttributes(){return["source"]}set source(e){this[name]=e,e&&this.setAttribute("source",e)}get source(){return this.getAttribute("source")}attributeChangedCallback(e,t,i){"source"==e&&""!=i&&fetch(this[e]).then(e=>e.json()).then(e=>{this.store.loadManifest(e)}).catch(e=>{console.warn(e)})}}window.customElements.define(HAXCMSSiteStore.tag,HAXCMSSiteStore);export{HAXCMSSiteStore};