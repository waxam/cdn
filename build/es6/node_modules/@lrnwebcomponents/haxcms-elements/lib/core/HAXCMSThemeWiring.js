import{store}from"./haxcms-site-store.js";import{autorun,toJS}from"../../../../mobx/lib/mobx.module.js";import{microTask}from"../../../../@polymer/polymer/lib/utils/async.js";import{dom}from"../../../../@polymer/polymer/lib/legacy/polymer.dom.js";import{afterNextRender}from"../../../../@polymer/polymer/lib/utils/render-status.js";import{updateStyles}from"../../../../@polymer/polymer/lib/mixins/element-mixin.js";export const HAXCMSTheme=function(SuperClass){return class extends SuperClass{constructor(){super();this.HAXCMSThemeWiring=new HAXCMSThemeWiring(this)}static get properties(){return{editMode:{type:Boolean,reflectToAttribute:!0,notify:!0,observer:"_editModeChanged"},contentContainer:{type:Object,notify:!0,value:null,observer:"_contentContainerChanged"},_location:{type:Object,observer:"_locationChanged"}}}_editModeChanged(newValue){if(typeof newValue!==typeof void 0){microTask.run(()=>{window.dispatchEvent(new Event("resize"));updateStyles()})}}_contentContainerChanged(newValue,oldValue){if(newValue&&null===oldValue){this.HAXCMSThemeWiring.connect(this,newValue)}else if(newValue&&oldValue){this.HAXCMSThemeWiring.disconnect(this);this.HAXCMSThemeWiring.connect(this,newValue)}else if(oldValue&&null===newValue){this.HAXCMSThemeWiring.disconnect(this)}}_locationChanged(newValue){if(!newValue||"undefined"===typeof newValue.route)return;const name=newValue.route.name;if("home"===name||"404"===name){const firstItem=store.routerManifest.items.find(i=>"undefined"!==typeof i.id);if(firstItem){store.activeId=firstItem.id}}}connectedCallback(){super.connectedCallback();if(null===this.contentContainer){this.contentContainer=this.shadowRoot.querySelector("#contentcontainer")}this.__disposer=[];afterNextRender(this,function(){if(0===dom(this).getEffectiveChildNodes().length){let frag=document.createRange().createContextualFragment(store.activeItemContent);dom(this).appendChild(frag)}updateStyles();autorun(reaction=>{const __routerManifest=toJS(store.routerManifest);if(typeof __routerManifest.title!==typeof void 0){document.title=__routerManifest.title}if(typeof __routerManifest.metadata!==typeof void 0&&typeof __routerManifest.metadata.cssVariable!==typeof void 0){let ary=__routerManifest.metadata.cssVariable.replace("--simple-colors-default-theme-","").split("-");ary.pop();this.accentColor=ary.join("-");document.body.style.setProperty("--haxcms-color",__routerManifest.metadata.hexCode)}this.__disposer.push(reaction)});autorun(reaction=>{this._location=store.location;this.__disposer.push(reaction)})})}disconnectedCallback(){super.disconnectedCallback();delete this.contentContainer;for(var i in this.__disposer){this.__disposer[i].dispose()}}resetActive(){window.history.pushState(null,null,store.location.baseUrl);window.dispatchEvent(new PopStateEvent("popstate"));this.dispatchEvent(new CustomEvent("haxcms-active-item-changed",{bubbles:!0,composed:!0,cancelable:!0,detail:{}}))}}};class HAXCMSThemeWiring{constructor(element,load=!0){if(load){document.body.addEventListener("haxcms-edit-mode-changed",this._globalEditChanged.bind(element));document.body.addEventListener("haxcms-active-item-changed",this._activeItemUpdate.bind(element));document.body.addEventListener("haxcms-trigger-update",this._triggerUpdate.bind(element));if(null==window.localStorage.getItem("HAXCMSSystemData")){window.localStorage.setItem("HAXCMSSystemData",JSON.stringify({}))}}}connect(element,injector){if(typeof window.cmsSiteEditor!==typeof void 0){window.cmsSiteEditor.requestAvailability(element,injector)}}disconnect(element){document.body.removeEventListener("haxcms-active-item-changed",this._activeItemUpdate.bind(element));document.body.removeEventListener("haxcms-edit-mode-changed",this._globalEditChanged.bind(element));document.body.removeEventListener("haxcms-trigger-update",this._triggerUpdate.bind(element))}_globalEditChanged(e){this.editMode=e.detail}_activeItemUpdate(e){let newValue=e.detail;if(newValue&&typeof newValue.id!==typeof void 0){store.activeId=newValue.id;const evt=new CustomEvent("json-outline-schema-active-item-changed",{bubbles:!0,composed:!0,cancelable:!0,detail:newValue});this.dispatchEvent(evt);if(typeof newValue.title!==typeof void 0){document.title=store.routerManifest.title+" - "+newValue.title}else{document.title=store.routerManifest.title}}else{document.title=store.routerManifest.title}}_triggerUpdate(){this.dispatchEvent(new CustomEvent("haxcms-active-item-changed",{bubbles:!0,composed:!0,cancelable:!0,detail:{}}))}}export{HAXCMSThemeWiring};