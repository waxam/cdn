import{html,PolymerElement}from"../../../../../@polymer/polymer/polymer-element.js";import"../../../../beaker-broker/beaker-broker.js";import{pathFromUrl}from"../../../../../@polymer/polymer/lib/utils/resolve-url.js";class HAXCMSBackendBeaker extends PolymerElement{static get tag(){return"haxcms-backend-beaker"}static get template(){return html`
      <beaker-broker id="beaker"></beaker-broker>
    `}static get properties(){return{jwt:{type:String},manifest:{type:Object},activeItem:{type:Object}}}constructor(){super();afterNextRender(this,function(){document.body.addEventListener("jwt-token",this._jwtTokenFired.bind(this));document.body.addEventListener("haxcms-save-site-data",this.saveManifest.bind(this));document.body.addEventListener("haxcms-save-outline",this.saveOutline.bind(this));document.body.addEventListener("haxcms-save-node",this.saveNode.bind(this));document.body.addEventListener("haxcms-delete-node",this.deleteNode.bind(this));document.body.addEventListener("haxcms-create-node",this.createNode.bind(this));document.body.addEventListener("hax-app-picker-selection",this._appPicked.bind(this))})}disconnectedCallback(){document.body.removeEventListener("jwt-token",this._jwtTokenFired.bind(this));document.body.removeEventListener("haxcms-save-site-data",this.saveManifest.bind(this));document.body.removeEventListener("haxcms-save-outline",this.saveOutline.bind(this));document.body.removeEventListener("haxcms-save-node",this.saveNode.bind(this));document.body.removeEventListener("haxcms-delete-node",this.deleteNode.bind(this));document.body.removeEventListener("haxcms-create-node",this.createNode.bind(this));document.body.removeEventListener("hax-app-picker-selection",this._appPicked.bind(this));super.disconnectedCallback()}_appPicked(e){if("dat"===e.detail.connection.protocol){e.preventDefault();e.stopPropagation();let reader=new FileReader;reader.onload=event=>{let fileLocation="files/"+window.HaxStore.instance.haxManager.$.fileupload.files[0].name;this.$.beaker.write(fileLocation,event.target.result);window.HaxStore.instance.haxManager.$.url.value=fileLocation;window.HaxStore.instance.haxManager.newAssetConfigure()};reader.readAsArrayBuffer(window.HaxStore.instance.haxManager.$.fileupload.files[0])}}async saveNode(e){this.activeItem=e.detail;await this.$.beaker.write(this.activeItem.location,window.HaxStore.instance.activeHaxBody.haxToContent());window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("Page updated!");const evt=new CustomEvent("haxcms-trigger-update-node",{bubbles:!0,composed:!0,cancelable:!1,detail:!0});window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(evt)}async saveOutline(e){var _Mathfloor=Math.floor;this.manifest=window.cmsSiteEditor.instance.haxCmsSiteEditorElement.manifest;this.manifest.items=e.detail;this.manifest.items.forEach((element,index)=>{if(typeof element.location===typeof void 0){let id=this.generateResourceID("item-");element.id=id;element.location="pages/"+id+"/index.html";element.order=index;element.description="";element.metadata={created:_Mathfloor(Date.now()/1e3),updated:_Mathfloor(Date.now()/1e3)};this.$.beaker.archive.mkdir("pages/"+id);this.$.beaker.write("pages/"+id+"/index.html","<p>Ex uno Plures</p>");this.manifest.items[index]=element}});this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("Outline saved!");window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}async deleteNode(e){let page=e.detail.item;this.manifest=window.cmsSiteEditor.instance.haxCmsSiteEditorElement.manifest;this.manifest.items=e.detail;this.manifest.items.forEach((element,index)=>{if(element.id===page.id){this.splice("manifest.items",index,1)}});this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show(`${page.title} deleted`);window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}async createNode(e){var _Mathfloor2=Math.floor;let page=e.detail.values;this.manifest=window.cmsSiteEditor.instance.haxCmsSiteEditorElement.manifest;this.manifest.items=e.detail;this.manifest.items.forEach((element,index)=>{if(typeof element.location===typeof void 0){if(!page.id){page.id=this.generateResourceID("item-")}if(!page.location){page.location="pages/"+page.id+"/index.html"}let directory=page.location.replace("/index.html","");element.id=page.id;element.location=page.location;element.order=page.order;element.indent=page.indent;element.parent=page.parent;element.description=page.description;element.metadata.created=_Mathfloor2(Date.now()/1e3);element.metadata.updated=_Mathfloor2(Date.now()/1e3);this.$.beaker.archive.mkdir(directory);this.$.beaker.write(page.location,"<p>My great new content!</p>");this.set(`manifest.items.${index}`,element)}});this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show(`${page.title} created!`);window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}async saveManifest(e){this.manifest=e.detail;if("string"===typeof this.manifest.metadata.theme){const themeData={"haxcms-dev-theme":{element:"haxcms-dev-theme",path:"@lrnwebcomponents/haxcms-elements/lib/haxcms-dev-theme.js",name:"Developer theme"},"outline-player":{element:"outline-player",path:"@lrnwebcomponents/outline-player/outline-player.js",name:"Outline player"},"simple-blog":{element:"simple-blog",path:"@lrnwebcomponents/simple-blog/simple-blog.js",name:"Simple blog"}};if(themeData[this.manifest.metadata.theme]){this.manifest.metadata.theme=themeData[this.manifest.metadata.theme]}}await this.$.beaker.write("site.json",JSON.stringify(this.manifest,null,2));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.$.toast.show("Site details saved!");window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));window.cmsSiteEditor.instance.haxCmsSiteEditorElement.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}_jwtTokenFired(e){this.jwt=e.detail}generateResourceID(base=""){function idPart(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return base+idPart()+idPart()+"-"+idPart()+"-"+idPart()+"-"+idPart()+"-"+idPart()+idPart()+idPart()}async connectedCallback(){super.connectedCallback();let beaker=this.$.beaker;this.jwt=beaker.archive.url;var info=await beaker.archive.getInfo();if(null!=this.jwt&&"string"==typeof this.jwt&&info.isOwner){var appstore=JSON.parse((await beaker.read("appstore.json")));try{import(pathFromUrl(decodeURIComponent(import.meta.url))+`../haxcms-site-editor.js`).then(()=>{let haxCmsSiteEditorElement=document.createElement("haxcms-site-editor");haxCmsSiteEditorElement.jwt=this.jwt;haxCmsSiteEditorElement.appStore=appstore;window.cmsSiteEditor.instance.haxCmsSiteEditorElement=haxCmsSiteEditorElement;window.cmsSiteEditor.instance.appendTarget.appendChild(haxCmsSiteEditorElement)},()=>{})}catch(err){}}}}window.customElements.define(HAXCMSBackendBeaker.tag,HAXCMSBackendBeaker);export{HAXCMSBackendBeaker};