import{html,PolymerElement}from"../../../../@polymer/polymer/polymer-element.js";import{microTask}from"../../../../@polymer/polymer/lib/utils/async.js";import{store}from"./haxcms-site-store.js";import{autorun,toJS}from"../../../../mobx/lib/mobx.module.js";import{afterNextRender}from"../../../../@polymer/polymer/lib/utils/render-status.js";import{HAXWiring}from"../../../hax-body-behaviors/lib/HAXWiring.js";import"../../../simple-colors/simple-colors.js";import"../../../../@polymer/paper-fab/paper-fab.js";import"../../../../@polymer/paper-tooltip/paper-tooltip.js";import"../../../../@polymer/paper-button/paper-button.js";import"../../../../@polymer/iron-ajax/iron-ajax.js";import"../../../../@polymer/iron-icons/editor-icons.js";import"../../../jwt-login/jwt-login.js";import"../../../h-a-x/h-a-x.js";import"../../../simple-toast/simple-toast.js";import"../../../simple-modal/simple-modal.js";import"../../../hax-body/lib/hax-schema-form.js";class HAXCMSSiteEditor extends PolymerElement{static get tag(){return"haxcms-site-editor"}static get template(){return html`
      <style include="simple-colors">
        :host {
          display: block;
        }
        #editbutton {
          position: fixed;
          bottom: 0;
          right: 0;
          margin: 16px;
          padding: 2px;
          width: 40px;
          height: 40px;
          visibility: visible;
          opacity: 1;
          transition: all 0.4s ease;
          z-index: 1000;
        }
        #outlinebutton {
          position: fixed;
          bottom: 0;
          right: 46px;
          margin: 16px;
          padding: 2px;
          width: 40px;
          height: 40px;
          visibility: visible;
          opacity: 1;
          transition: all 0.4s ease;
          z-index: 1000;
        }
        :host([edit-mode]) #editbutton {
          width: 100%;
          z-index: 100;
          right: 0;
          bottom: 0;
          border-radius: 0;
          height: 80px;
          margin: 0;
          padding: 8px;
          background-color: var(--paper-blue-500) !important;
        }
        h-a-x {
          padding: 80px 40px;
          margin: auto;
          display: none;
        }
        :host([edit-mode]) h-a-x {
          display: block;
        }
      </style>
      <iron-ajax
        headers='{"Authorization": "Bearer [[jwt]]"}'
        id="nodeupdateajax"
        url="[[saveNodePath]]"
        method="[[method]]"
        body="[[updateNodeData]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleNodeResponse"
      ></iron-ajax>
      <iron-ajax
        headers='{"Authorization": "Bearer [[jwt]]"}'
        id="outlineupdateajax"
        url="[[saveOutlinePath]]"
        method="[[method]]"
        body="[[updateOutlineData]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleOutlineResponse"
      ></iron-ajax>
      <iron-ajax
        headers='{"Authorization": "Bearer [[jwt]]"}'
        id="getfieldsajax"
        url="[[getNodeFieldsPath]]"
        method="[[method]]"
        body="[[getFieldsData]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleGetFieldsResponse"
      ></iron-ajax>
      <iron-ajax
        headers='{"Authorization": "Bearer [[jwt]]"}'
        id="getsitefieldsajax"
        url="[[getSiteFieldsPath]]"
        method="[[method]]"
        body="[[getSiteFieldsData]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleGetSiteFieldsResponse"
      ></iron-ajax>
      <iron-ajax
        headers='{"Authorization": "Bearer [[jwt]]"}'
        id="manifestupdateajax"
        url="[[saveManifestPath]]"
        method="[[method]]"
        body="[[updateManifestData]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleManifestResponse"
      ></iron-ajax>
      <iron-ajax
        headers='{"Authorization": "Bearer [[jwt]]"}'
        id="publishajax"
        loading="{{publishing}}"
        url="[[publishSitePath]]"
        method="[[method]]"
        body="[[publishSiteData]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handlePublishResponse"
      ></iron-ajax>
      <iron-ajax
        headers='{"Authorization": "Bearer [[jwt]]"}'
        id="createajax"
        url="[[createNodePath]]"
        method="[[method]]"
        body="[[createData]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleCreateResponse"
        last-response="{{__createNodeResponse}}"
      ></iron-ajax>
      <iron-ajax
        headers='{"Authorization": "Bearer [[jwt]]"}'
        id="deleteajax"
        url="[[deleteNodePath]]"
        method="[[method]]"
        body="[[deleteData]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleDeleteResponse"
        last-response="{{__deleteNodeResponse}}"
      ></iron-ajax>
      <h-a-x app-store$="[[appStore]]" hide-panel-ops></h-a-x>
    `}static get properties(){return{method:{type:String,value:"POST"},jwt:{type:String},saveNodePath:{type:String},createNodePath:{type:String},deleteNodePath:{type:String},saveManifestPath:{type:String},publishSitePath:{type:String},publishing:{type:Boolean,observer:"_publishingChanged"},saveOutlinePath:{type:String},appStore:{type:Object},editMode:{type:Boolean,reflectToAttribute:!0,value:!1},updateNodeData:{type:Object,value:{}},deleteData:{type:Object,value:{}},createData:{type:Object,value:{}},publishSiteData:{type:Object,value:{}},updateManifestData:{type:Object,value:{}},updateOutlineData:{type:Object,value:{}},updateManifestData:{type:Object,value:{}},getFieldsData:{type:Object,value:{}},getSiteFieldsData:{type:Object,value:{}},activeItem:{type:Object,notify:!0,observer:"_activeItemChanged"},manifest:{type:Object,notify:!0,observer:"_manifestChanged"},getNodeFieldsPath:{type:String},getSiteFieldsPath:{type:String},getFieldsToken:{type:String}}}_attachDom(dom){this.appendChild(dom)}ready(){super.ready();this.__disposer=[];afterNextRender(this,function(){autorun(reaction=>{this.manifest=toJS(store.manifest);this.__disposer.push(reaction)});autorun(reaction=>{this.activeItem=toJS(store.activeItem);this.__disposer.push(reaction)});window.SimpleToast.requestAvailability();window.SimpleModal.requestAvailability();window.addEventListener("hax-store-ready",this._storeReadyToGo.bind(this));window.addEventListener("json-outline-schema-active-item-changed",this._newActiveItem.bind(this));window.addEventListener("json-outline-schema-active-body-changed",this._bodyChanged.bind(this));window.addEventListener("haxcms-save-outline",this.saveOutline.bind(this));window.addEventListener("haxcms-save-node",this.saveNode.bind(this));window.addEventListener("haxcms-save-node-details",this.saveNodeDetails.bind(this));window.addEventListener("haxcms-save-site-data",this.saveManifest.bind(this));window.addEventListener("haxcms-load-node-fields",this.loadNodeFields.bind(this));window.addEventListener("haxcms-load-site-fields",this.loadSiteFields.bind(this));window.addEventListener("haxcms-create-node",this.createNode.bind(this));window.addEventListener("haxcms-delete-node",this.deleteNode.bind(this));window.addEventListener("haxcms-publish-site",this.publishSite.bind(this));microTask.run(()=>{this.updateStyles();if(window.HaxStore.ready){this._storeReadyToGo({detail:!0})}});const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"You are logged in, edit tools shown."}});window.dispatchEvent(evt)})}disconnectedCallback(){for(var i in this.__disposer){this.__disposer[i].dispose()}window.removeEventListener("hax-store-ready",this._storeReadyToGo.bind(this));window.removeEventListener("haxcms-save-outline",this.saveOutline.bind(this));window.removeEventListener("haxcms-save-node",this.saveNode.bind(this));window.removeEventListener("haxcms-save-node-details",this.saveNodeDetails.bind(this));window.removeEventListener("haxcms-save-site-data",this.saveManifest.bind(this));window.removeEventListener("haxcms-publish-site",this.publishSite.bind(this));window.removeEventListener("json-outline-schema-active-item-changed",this._newActiveItem.bind(this));window.removeEventListener("json-outline-schema-active-body-changed",this._bodyChanged.bind(this));window.removeEventListener("haxcms-load-node-fields",this.loadNodeFields.bind(this));window.removeEventListener("haxcms-load-site-fields",this.loadSiteFields.bind(this));window.removeEventListener("haxcms-create-node",this.createNode.bind(this));window.removeEventListener("haxcms-delete-node",this.deleteNode.bind(this));super.disconnectedCallback()}loadNodeFields(e){this.__nodeFieldsInvoked=e.detail;this.set("getFieldsData.jwt",this.jwt);this.notifyPath("getFieldsData.jwt");this.set("getFieldsData.token",this.getFieldsToken);this.notifyPath("getFieldsData.token");this.set("getFieldsData.siteName",this.manifest.metadata.siteName);this.notifyPath("getFieldsData.siteName");this.set("getFieldsData.nodeId",this.activeItem.id);this.notifyPath("getFieldsData.nodeId");this.$.getfieldsajax.generateRequest()}loadSiteFields(e){this.__siteFieldsInvoked=e.detail;this.set("getSiteFieldsData.jwt",this.jwt);this.notifyPath("getSiteFieldsData.jwt");this.set("getSiteFieldsData.token",this.getFieldsToken);this.notifyPath("getSiteFieldsData.token");this.set("getSiteFieldsData.siteName",this.manifest.metadata.siteName);this.notifyPath("getSiteFieldsData.siteName");this.$.getsitefieldsajax.generateRequest()}_handleGetFieldsResponse(e){let wiring=new HAXWiring;this._haxSchema=wiring.prototypeHaxProperties();this._haxSchema.settings=e.detail.response.haxSchema;let values=e.detail.response.values,c=document.createElement("hax-schema-form");c.style.minWidth="50vw";for(var key in this._haxSchema.settings){let schema=wiring.getHaxJSONSchema(key,this._haxSchema);for(var i in schema.properties){if(values[i]){schema.properties[i].value=values[i]}}c.set(key+"Schema",schema)}this.__fieldsForm=c;let b1=document.createElement("paper-button");b1.raised=!0;let icon=document.createElement("iron-icon");icon.icon="icons:save";b1.appendChild(icon);b1.appendChild(document.createTextNode("Save fields"));b1.setAttribute("dialog-confirm","dialog-confirm");b1.addEventListener("click",this._saveFieldsTap.bind(this));let b2=document.createElement("paper-button");b2.appendChild(document.createTextNode("cancel"));b2.setAttribute("dialog-dismiss","dialog-dismiss");let b=document.createElement("div");b.style.position="absolute";b.style.bottom=0;b.style.left=0;b.style.right=0;b.style.zIndex=1e6;b.style.backgroundColor="#ddd";b.appendChild(b1);b.appendChild(b2);const evt=new CustomEvent("simple-modal-show",{bubbles:!0,composed:!0,cancelable:!1,detail:{title:"Edit "+store.activeTitle+" fields",elements:{content:c,buttons:b},invokedBy:this.__nodeFieldsInvoked,clone:!1}});window.dispatchEvent(evt)}_handleGetSiteFieldsResponse(e){let wiring=new HAXWiring;this._haxSchema=wiring.prototypeHaxProperties();this._haxSchema.settings=e.detail.response.haxSchema;let values=e.detail.response.values,h="";if(this.manifest.metadata.publishedLocation){h=document.createElement("a");h.setAttribute("tabindex","-1");h.setAttribute("href",this.manifest.metadata.publishedLocation);h.setAttribute("target","_blank");h.innerHTML="<paper-button raised style=\"text-transform:none;\">Access published version</paper-button>"}let c=document.createElement("hax-schema-form");c.style.minWidth="50vw";for(var key in this._haxSchema.settings){let schema=wiring.getHaxJSONSchema(key,this._haxSchema);for(var i in schema.properties){if(values[i]){schema.properties[i].value=values[i]}}c.set(key+"Schema",schema)}this.__siteFieldsForm=c;let b1=document.createElement("paper-button");b1.raised=!0;let icon=document.createElement("iron-icon");icon.icon="icons:save";b1.appendChild(icon);b1.appendChild(document.createTextNode("Save fields"));b1.setAttribute("dialog-confirm","dialog-confirm");b1.addEventListener("click",this._saveSiteFieldsTap.bind(this));let b2=document.createElement("paper-button");b2.appendChild(document.createTextNode("cancel"));b2.setAttribute("dialog-dismiss","dialog-dismiss");let icon2=document.createElement("iron-icon");icon2.icon="icons:cloud-upload";let b3=document.createElement("paper-button");b3.raised=!0;b3.appendChild(icon2);b3.appendChild(document.createTextNode("Publish"));b3.setAttribute("dialog-confirm","dialog-confirm");b3.addEventListener("click",this._publishTap.bind(this));b3.style.minWidth="100px";b3.style.backgroundColor=getComputedStyle(this).getPropertyValue("--haxcms-color");let b=document.createElement("div");b.style.position="absolute";b.style.bottom=0;b.style.left=0;b.style.right=0;b.style.zIndex=1e6;b.style.backgroundColor="#ddd";b.appendChild(b1);b.appendChild(b2);b.appendChild(b3);const evt=new CustomEvent("simple-modal-show",{bubbles:!0,composed:!0,cancelable:!1,detail:{title:"Edit site fields",elements:{header:h,content:c,buttons:b},invokedBy:this.__siteFieldsInvoked,clone:!1}});window.dispatchEvent(evt)}_publishTap(){this.dispatchEvent(new CustomEvent("haxcms-publish-site",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}_saveFieldsTap(){let values=this.__fieldsForm.value;values.id=this.activeItem.id;window.dispatchEvent(new CustomEvent("haxcms-save-node-details",{bubbles:!0,composed:!0,cancelable:!0,detail:values}));window.dispatchEvent(new CustomEvent("simple-modal-hide",{bubbles:!0,composed:!0,cancelable:!0,detail:{}}))}_saveSiteFieldsTap(){let values=this.__siteFieldsForm.value;window.dispatchEvent(new CustomEvent("haxcms-save-site-data",{bubbles:!0,composed:!0,cancelable:!0,detail:values}));window.dispatchEvent(new CustomEvent("simple-modal-hide",{bubbles:!0,composed:!0,cancelable:!0,detail:{}}))}createNode(e){if(e.detail.values){this.set("createData",{});this.set("createData",e.detail.values);this.notifyPath("createData.*");this.set("createData.siteName",this.manifest.metadata.siteName);this.notifyPath("createData.siteName");this.set("createData.jwt",this.jwt);this.notifyPath("createData.jwt");this.$.createajax.generateRequest();const evt=new CustomEvent("simple-modal-hide",{bubbles:!0,composed:!0,cancelable:!0,detail:{}});window.dispatchEvent(evt)}}_handleCreateResponse(){const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:`Created ${this.__createNodeResponse.title}!`,duration:3e3}});window.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}deleteNode(e){this.set("deleteData",{});this.set("deleteData.nodeId",e.detail.item.id);this.notifyPath("deleteData.nodeId");this.set("deleteData.siteName",this.manifest.metadata.siteName);this.notifyPath("deleteData.siteName");this.set("deleteData.jwt",this.jwt);this.notifyPath("deleteData.jwt");this.$.deleteajax.generateRequest();const evt=new CustomEvent("simple-modal-hide",{bubbles:!0,composed:!0,cancelable:!0,detail:{}});window.dispatchEvent(evt)}_handleDeleteResponse(){const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:`Deleted ${this.__deleteNodeResponse.title}`,duration:3e3}});this.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}_storeReadyToGo(event){if(event.detail){window.HaxStore.instance.connectionRewrites.appendJwt="jwt";window.HaxStore.instance.haxPanel.align="left";window.HaxStore.instance.haxPanel.hidePanelOps=!0}}_publishingChanged(newValue,oldValue){if(newValue){const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Publishing...",duration:0}});window.dispatchEvent(evt)}else if(!newValue&&oldValue){const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Publishing...",duration:3e3}});window.dispatchEvent(evt)}}_manifestChanged(newValue){if(this.activeItem&&newValue.metadata){window.HaxStore.instance.connectionRewrites.appendUploadEndPoint="siteName="+newValue.metadata.siteName+"&nodeId="+this.activeItem.id}}_newActiveItem(e){this.set("activeItem",e.detail);this.notifyPath("activeItem.*")}_activeItemChanged(newValue){if(newValue&&this.manifest){window.HaxStore.instance.connectionRewrites.appendUploadEndPoint="siteName="+this.manifest.metadata.siteName+"&nodeId="+newValue.id}}_handleNodeResponse(e){if("undefined"!==typeof e.detail.location&&this.activeItem.location!==e.detail.location){window.location(e.detail.location);window.history.pushState({},null,e.detail.location);window.dispatchEvent(new PopStateEvent("popstate"));const active=this.manifest.items.find(i=>{return i.id===e.detail.id});this.activeItem=active;this.dispatchEvent(new CustomEvent("json-outline-schema-active-item-changed",{bubbles:!0,composed:!0,cancelable:!0,detail:active}))}const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Page saved!",duration:4e3}});window.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}));this.dispatchEvent(new CustomEvent("haxcms-trigger-update-node",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}_handleOutlineResponse(){const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Outline saved!",duration:3e3}});window.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}_handleManifestResponse(){const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Site details saved!",duration:3e3}});this.dispatchEvent(evt);this.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}_handlePublishResponse(e){let data=e.detail.response,content=document.createElement("span");content.innerHTML=`
    <a href="${data.url}" target="_blank">
      <paper-button raised style="color:yellow;text-transform: none;font-weight: bold;">
      ${data.label}
      </paper-button>
    </a>`;const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:data.response,duration:1e4,slot:content.cloneNode(!0)}});window.dispatchEvent(evt)}saveNode(){this.set("updateNodeData",{});this.set("updateNodeData.siteName",this.manifest.metadata.siteName);this.notifyPath("updateNodeData.siteName");this.set("updateNodeData.body",window.HaxStore.instance.activeHaxBody.haxToContent());this.notifyPath("updateNodeData.body");this.set("updateNodeData.nodeId",this.activeItem.id);this.notifyPath("updateNodeData.nodeId");this.set("updateNodeData.jwt",this.jwt);this.notifyPath("updateNodeData.jwt");if(this.saveNodePath){this.$.nodeupdateajax.generateRequest()}}saveNodeDetails(e){this.set("updateNodeData",{});this.set("updateNodeData.siteName",this.manifest.metadata.siteName);this.notifyPath("updateNodeData.siteName");this.set("updateNodeData.nodeId",e.detail.id);this.notifyPath("updateNodeData.nodeId");this.set("updateNodeData.details",e.detail);this.notifyPath("updateNodeData.details");this.set("updateNodeData.jwt",this.jwt);this.notifyPath("updateNodeData.jwt");if(this.saveNodePath){this.$.nodeupdateajax.generateRequest()}}saveOutline(e){this.set("updateOutlineData.siteName",this.manifest.metadata.siteName);this.notifyPath("updateOutlineData.siteName");this.set("updateOutlineData.items",e.detail);this.notifyPath("updateOutlineData.items");this.set("updateOutlineData.jwt",this.jwt);this.notifyPath("updateOutlineData.jwt");if(this.saveOutlinePath){this.$.outlineupdateajax.generateRequest()}}saveManifest(e){let values=e.detail;if(values.cssVariable){values.hexCode=window.SimpleColorsUtilities.colors[values.cssVariable.replace("--simple-colors-default-theme-","").replace("-7","")][6]}this.set("updateManifestData.siteName",this.manifest.metadata.siteName);this.notifyPath("updateManifestData.siteName");this.set("updateManifestData.manifest",values);this.notifyPath("updateManifestData.manifest");this.set("updateManifestData.jwt",this.jwt);this.notifyPath("updateManifestData.jwt");if(this.saveManifestPath){this.$.manifestupdateajax.generateRequest()}}publishSite(){this.set("publishSiteData.siteName",this.manifest.metadata.siteName);this.notifyPath("publishSiteData.siteName");this.set("publishSiteData.jwt",this.jwt);this.notifyPath("publishSiteData.jwt");if(this.publishSitePath){this.$.publishajax.generateRequest()}}_bodyChanged(e){window.HaxStore.instance.activeHaxBody.importContent(e.detail)}}window.customElements.define(HAXCMSSiteEditor.tag,HAXCMSSiteEditor);export{HAXCMSSiteEditor};