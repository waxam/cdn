import{html,PolymerElement}from"../../../../@polymer/polymer/polymer-element.js";import{setPassiveTouchGestures}from"../../../../@polymer/polymer/lib/utils/settings.js";import{updateStyles}from"../../../../@polymer/polymer/lib/mixins/element-mixin.js";import{afterNextRender}from"../../../../@polymer/polymer/lib/utils/render-status.js";import{dom}from"../../../../@polymer/polymer/lib/legacy/polymer.dom.js";import{pathFromUrl}from"../../../../@polymer/polymer/lib/utils/resolve-url.js";import{microTask}from"../../../../@polymer/polymer/lib/utils/async.js";import{encapScript,findTagsInHTML,wipeSlot}from"../../../hax-body/lib/haxutils.js";import{autorun,toJS}from"../../../../mobx/lib/mobx.module.js";import{store}from"./haxcms-site-store.js";import"../../../../@polymer/iron-ajax/iron-ajax.js";import"../../../../@polymer/paper-progress/paper-progress.js";import"./haxcms-site-router.js";class HAXCMSSiteBuilder extends PolymerElement{static get tag(){return"haxcms-site-builder"}static get template(){return html`
      <style>
        :host {
          display: block;
        }
        :host #slot {
          transition: all 0.2s ease-in-out;
          background-color: var(--haxcms-color, white);
          opacity: 0.2;
          visibility: hidden;
        }
        :host([theme-loaded]) #slot {
          opacity: 1;
          visibility: visible;
        }
        paper-progress {
          display: block;
          width: 100%;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background-color: transparent;
          z-index: 1000;
          --paper-progress-active-color: var(
            --haxcms-color,
            rgba(255, 255, 255, 0.5)
          );
          --paper-progress-container-color: transparent;
        }
      </style>
      <haxcms-site-router base-uri="[[baseURI]]"></haxcms-site-router>
      <paper-progress hidden\$="[[!loading]]" indeterminate></paper-progress>
      <iron-ajax
        id="manifest"
        url="[[outlineLocation]][[file]][[__timeStamp]]"
        handle-as="json"
        last-response="{{manifest}}"
      ></iron-ajax>
      <iron-ajax
        id="activecontent"
        url="[[outlineLocation]][[activeItem.location]][[__timeStamp]]"
        handle-as="text"
        loading="{{loading}}"
        last-response="{{activeItemContent}}"
      ></iron-ajax>
      <div id="slot"><slot></slot></div>
    `}static get properties(){return{queryParams:{type:Object},loading:{type:Boolean,value:!1,reflectToAttribute:!0},outlineLocation:{type:String,notify:!0,reflectToAttribute:!0},manifest:{type:Object,notify:!0,observer:"_manifestChanged"},themeData:{type:Object,observer:"_themeChanged"},themeElement:{type:Object},__imported:{type:Object,value:{}},themeLoaded:{type:Boolean,reflectToAttribute:!0,value:!1},activeItem:{type:Object,notify:!0,observer:"_activeItemChanged"},activeItemContent:{type:String,notify:!0,observer:"_activeItemContentChanged"},file:{type:String,observer:"_fileChanged"},baseURI:{type:String}}}constructor(){super();setPassiveTouchGestures(!0);if(document.getElementById("haxcmsoutdatedfallback")){document.getElementById("haxcmsoutdatedfallback").style.display="none"}this.__disposer=[];autorun(reaction=>{this.themeData=toJS(store.themeData);this.__disposer.push(reaction)});autorun(reaction=>{this.activeItem=toJS(store.activeItem);this.__disposer.push(reaction)});this.__timeStamp=""}connectedCallback(){super.connectedCallback();afterNextRender(this,function(){this.dispatchEvent(new CustomEvent("haxcms-ready",{bubbles:!0,composed:!0,cancelable:!1,detail:this}));if(document.getElementById("haxcmsoutdatedfallback")){document.body.removeChild(document.getElementById("haxcmsoutdatedfallback"))}window.addEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));window.addEventListener("haxcms-trigger-update-node",this._triggerUpdatedNode.bind(this));const basePath=pathFromUrl(decodeURIComponent(import.meta.url));import(`${basePath}haxcms-editor-builder.js`).then(()=>{this.editorBuilder=document.createElement("haxcms-editor-builder");document.body.appendChild(this.editorBuilder);if("published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()){this.__timeStamp="?"+Math.floor(Date.now()/1e3)}}).catch(error=>{console.log(error)})})}disconnectedCallback(){window.removeEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this));window.removeEventListener("haxcms-trigger-update-node",this._triggerUpdatedNode.bind(this));for(var i in this.__disposer){this.__disposer[i].dispose()}super.disconnectedCallback()}_activeItemContentChanged(newValue){if(newValue){var html=newValue;if(null!==html){wipeSlot(this.themeElement,"*");html=encapScript(newValue);store.activeItemContent=html;microTask.run(()=>{setTimeout(()=>{let frag=document.createRange().createContextualFragment(html);dom(this.themeElement).appendChild(frag);this.dispatchEvent(new CustomEvent("json-outline-schema-active-body-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:html}));if(!window.HaxStore||!window.HaxStore.ready){setTimeout(()=>{if(store.cmsSiteEditor&&store.cmsSiteEditor.instance&&store.cmsSiteEditor.haxCmsSiteEditorUIElement){window.HaxStore.instance.activeHaxBody.importContent(html)}},1e3)}},5)});if(this.manifest.metadata.dynamicElementLoader){let tagsFound=findTagsInHTML(html);const basePath=pathFromUrl(decodeURIComponent(import.meta.url));for(var i in tagsFound){const tagName=tagsFound[i];if(this.manifest.metadata.dynamicElementLoader[tagName]&&!window.customElements.get(tagName)){import(`${basePath}../../../../${this.manifest.metadata.dynamicElementLoader[tagName]}`).then(()=>{}).catch(error=>{console.log(error)})}}}}}}_activeItemChanged(newValue,oldValue){if(newValue&&typeof newValue.id!==typeof void 0){this.set("queryParams.nodeId",newValue.id);this.notifyPath("queryParams.nodeId");if(this.editorBuilder&&"published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()){this.__timeStamp="?"+Math.floor(Date.now()/1e3)}this.$.activecontent.generateRequest()}else if(oldValue&&!newValue){this.dispatchEvent(new CustomEvent("json-outline-schema-active-body-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:null}))}}_triggerUpdatedData(){if(this.editorBuilder&&"published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()){this.__timeStamp="?"+Math.floor(Date.now()/1e3)}this.$.manifest.generateRequest()}_triggerUpdatedNode(){if(this.editorBuilder&&"published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()){this.__timeStamp="?"+Math.floor(Date.now()/1e3)}if(this.activeItem.location){this.$.activecontent.generateRequest()}}_fileChanged(newValue){if(typeof newValue!==typeof void 0){this.$.manifest.generateRequest()}}_manifestChanged(newValue){if(newValue&&newValue.metadata&&newValue.items){if(!newValue.metadata.dynamicElementLoader){newValue.metadata.dynamicElementLoader={"a11y-gif-player":"@lrnwebcomponents/a11y-gif-player/a11y-gif-player.js","citation-element":"@lrnwebcomponents/citation-element/citation-element.js","hero-banner":"@lrnwebcomponents/hero-banner/hero-banner.js","image-compare-slider":"@lrnwebcomponents/image-compare-slider/image-compare-slider.js","license-element":"@lrnwebcomponents/license-element/license-element.js","lrn-aside":"@lrnwebcomponents/lrn-aside/lrn-aside.js","lrn-calendar":"@lrnwebcomponents/lrn-calendar/lrn-calendar.js","lrn-math":"@lrnwebcomponents/lrn-math/lrn-math.js","lrn-table":"@lrnwebcomponents/lrn-table/lrn-table.js","lrn-vocab":"@lrnwebcomponents/lrn-vocab/lrn-vocab.js","lrndesign-blockquote":"@lrnwebcomponents/lrndesign-blockquote/lrndesign-blockquote.js","magazine-cover":"@lrnwebcomponents/magazine-cover/magazine-cover.js","media-behaviors":"@lrnwebcomponents/media-behaviors/media-behaviors.js","media-image":"@lrnwebcomponents/media-image/media-image.js","meme-maker":"@lrnwebcomponents/meme-maker/meme-maker.js","multiple-choice":"@lrnwebcomponents/multiple-choice/multiple-choice.js","paper-audio-player":"@lrnwebcomponents/paper-audio-player/paper-audio-player.js","person-testimonial":"@lrnwebcomponents/person-testimonial/person-testimonial.js","place-holder":"@lrnwebcomponents/place-holder/place-holder.js","q-r":"@lrnwebcomponents/q-r/q-r.js","full-width-image":"@lrnwebcomponents/full-width-image/full-width-image.js","self-check":"@lrnwebcomponents/self-check/self-check.js","simple-concept-network":"@lrnwebcomponents/simple-concept-network/simple-concept-network.js","stop-note":"@lrnwebcomponents/stop-note/stop-note.js","tab-list":"@lrnwebcomponents/tab-list/tab-list.js","task-list":"@lrnwebcomponents/task-list/task-list.js","video-player":"@lrnwebcomponents/video-player/video-player.js","wave-player":"@lrnwebcomponents/wave-player/wave-player.js","wikipedia-query":"@lrnwebcomponents/wikipedia-query/wikipedia-query.js"}}store.manifest=newValue;this.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:newValue}))}}_themeChanged(newValue,oldValue){if(newValue&&oldValue){if(store.cmsSiteEditor&&store.cmsSiteEditor.instance&&typeof store.cmsSiteEditor.instance.haxCmsSiteEditorElement!==typeof void 0){store.cmsSiteEditor.instance.appendChild(store.cmsSiteEditor.instance.haxCmsSiteEditorElement)}}if(newValue){this.themeLoaded=!1;let theme=newValue;wipeSlot(this,"*");this.themeElement=document.createElement(theme.element);if(typeof this.__imported[theme.element]!==typeof void 0){dom(this).appendChild(this.themeElement);this.themeLoaded=!0}else{try{import(pathFromUrl(decodeURIComponent(import.meta.url))+"../../../../"+newValue.path).then(()=>{dom(this).appendChild(this.themeElement);this.__imported[theme.element]=theme.element;this.themeLoaded=!0})}catch(err){dom(this).appendChild(this.themeElement);this.themeLoaded=!0}}setTimeout(()=>{updateStyles()},500)}}}window.customElements.define(HAXCMSSiteBuilder.tag,HAXCMSSiteBuilder);export{HAXCMSSiteBuilder};